<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FreshTrack Pro Documentation</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
      line-height: 1.6;
      color: #333;
    }
    h1, h2, h3 { color: #1a1a1a; margin-top: 2rem; }
    h1 { border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
    h2 { border-bottom: 1px solid #eee; padding-bottom: 0.3rem; }
    code { background: #f5f5f5; padding: 0.2em 0.4em; border-radius: 3px; }
    pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; border-radius: 5px; }
    pre code { background: none; padding: 0; }
    blockquote { border-left: 4px solid #ddd; margin: 0; padding-left: 1rem; color: #666; }
    table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
    th { background: #f5f5f5; }
    a { color: #0066cc; }
    hr { border: none; border-top: 1px solid #eee; margin: 2rem 0; }
    .page-break { page-break-after: always; }
    @media print {
      body { max-width: none; }
      .page-break { page-break-after: always; }
    }
  </style>
</head>
<body>
<p><h1>FreshTrack Pro Documentation</h1></p><p><h2>Complete System Documentation</h2></p><p>---</p><p><strong>Generated:</strong> 2026-01-12 02:24:44 UTC</p><p><strong>Version:</strong> 1.0</p><p>---</p><p>This document contains the complete documentation for the FreshTrack Pro
temperature monitoring and food safety compliance system.</p><p>---</p><p><div class="page-break"></div></p><p><a id="readme"></a></p><p><h1>FreshTrack Pro (FrostGuard)</h1></p><p><blockquote>Real-time Refrigeration Monitoring & Food Safety Compliance Platform</blockquote></p><p><h2>Overview</h2></p><p>FreshTrack Pro (internally codenamed <strong>FrostGuard</strong>) is a comprehensive IoT-based refrigeration monitoring platform designed for food service, healthcare, and retail organizations. The system provides real-time temperature monitoring, automated alerts, HACCP compliance tracking, and multi-level escalation notifications.</p><p><h3>Core Capabilities</h3></p><p><li><strong>Real-time Temperature Monitoring</strong>: Automated sensor readings via LoRa/TTN IoT network</li>
<li><strong>Alert & Escalation System</strong>: Multi-tier notifications (email, SMS, push) with configurable escalation policies</li>
<li><strong>HACCP Compliance</strong>: Audit trails, corrective action tracking, and compliance reporting</li>
<li><strong>Manual Temperature Logging</strong>: Offline-capable manual entry with automatic sync</li>
<li><strong>Multi-Tenant Architecture</strong>: Organization â†’ Site â†’ Area â†’ Unit hierarchy</li>
<li><strong>Equipment Health</strong>: Battery forecasting, calibration tracking, and connectivity monitoring</li></p><p><h3>What This System Is NOT</h3></p><p><li>Not a consumer/home refrigerator app</li>
<li>Not a general IoT platform</li>
<li>Not a food inventory/ordering system</li></p><p>---</p><p><h2>Goals & Use Cases</h2></p><p><h3>Primary Use Cases</h3></p><p><li><strong>Continuous Monitoring</strong>: Automated temperature readings every 5 minutes (configurable)</li>
<li><strong>Excursion Detection</strong>: Immediate alerts when temperatures exceed safe thresholds</li>
<li><strong>Compliance Documentation</strong>: Immutable audit trails for health inspections</li>
<li><strong>Shift Handoff</strong>: Staff can acknowledge and hand off alerts with notes</li>
<li><strong>Predictive Maintenance</strong>: Battery forecasts and calibration reminders</li></p><p><h3>Target Users</h3></p><p>| Persona | Role | Primary Tasks |
|---------|------|---------------|
| Food Safety Manager | Strategic oversight | Dashboard review, report generation, policy configuration |
| Operations Manager | Facilities management | Equipment monitoring, escalation setup, trend analysis |
| Kitchen Staff | Day-to-day operations | Manual logging, alert acknowledgment, unit status checks |
| IT Administrator | Technical setup | Sensor provisioning, TTN configuration, debugging |</p><p>---</p><p><h2>Tech Stack</h2></p><p><h3>Frontend</h3></p><p>| Technology | Version | Purpose |
|------------|---------|---------|
| React | 18.3.1 | UI framework |
| TypeScript | 5.8.3 | Type-safe JavaScript |
| Vite | 5.4.19 | Build tool and dev server |
| React Router | 6.30.1 | Client-side routing |
| TanStack Query | 5.83.0 | Server state management |
| React Hook Form | 7.61.1 | Form handling |
| Zod | 3.25.76 | Schema validation |
| Tailwind CSS | 3.4.17 | Utility-first styling |
| shadcn/ui | - | Component library (Radix-based) |
| Recharts | 2.15.4 | Data visualization |
| Framer Motion | 12.23.26 | Animations |
| Lucide React | 0.462.0 | Icons |</p><p><h3>Backend</h3></p><p>| Technology | Purpose |
|------------|---------|
| Supabase | PostgreSQL database, Auth, Edge Functions |
| Deno | Edge function runtime |
| PostgreSQL | 14.1 - Primary database |
| Row-Level Security (RLS) | Data access control |</p><p><h3>External Integrations</h3></p><p>| Service | Purpose |
|---------|---------|
| The Things Network (TTN) | LoRa sensor network |
| Stripe | Payment processing |
| Twilio | SMS alert delivery |</p><p><h3>Development Tools</h3></p><p>| Tool | Purpose |
|------|---------|
| Vitest | Unit testing |
| ESLint | Code linting |
| Workbox | PWA service workers |
| lovable-tagger | Deployment tagging |</p><p>---</p><p><h2>Repository Structure</h2></p><p><pre><code class="">freshtrack-pro/
â”œâ”€â”€ src/                          # Frontend React application
â”‚   â”œâ”€â”€ components/               # React components
â”‚   â”‚   â”œâ”€â”€ ui/                   # shadcn/ui base components
â”‚   â”‚   â”œâ”€â”€ alerts/               # Alert display components
â”‚   â”‚   â”œâ”€â”€ dashboard/            # Dashboard widgets
â”‚   â”‚   â”œâ”€â”€ settings/             # Settings panels
â”‚   â”‚   â”œâ”€â”€ unit/                 # Unit monitoring components
â”‚   â”‚   â”œâ”€â”€ ttn/                  # TTN-specific components
â”‚   â”‚   â”œâ”€â”€ health/               # System health components
â”‚   â”‚   â”œâ”€â”€ admin/                # Admin tools
â”‚   â”‚   â””â”€â”€ debug/                # Debug utilities
â”‚   â”œâ”€â”€ pages/                    # Route-level page components
â”‚   â”œâ”€â”€ hooks/                    # Custom React hooks
â”‚   â”œâ”€â”€ lib/                      # Utilities and configuration
â”‚   â”œâ”€â”€ types/                    # TypeScript type definitions
â”‚   â”œâ”€â”€ contexts/                 # React contexts
â”‚   â””â”€â”€ integrations/             # External service clients
â”œâ”€â”€ supabase/                     # Backend configuration
â”‚   â”œâ”€â”€ functions/                # Edge functions (Deno)
â”‚   â”‚   â”œâ”€â”€ _shared/              # Shared utilities
â”‚   â”‚   â”œâ”€â”€ process-unit-states/  # Alert engine (SSOT)
â”‚   â”‚   â”œâ”€â”€ process-escalations/  # Notification dispatch
â”‚   â”‚   â”œâ”€â”€ ttn-webhook/          # TTN data ingestion
â”‚   â”‚   â”œâ”€â”€ ingest-readings/      # Generic data ingestion
â”‚   â”‚   â””â”€â”€ [33 more functions]   # See API.md for full list
â”‚   â”œâ”€â”€ migrations/               # Database migrations
â”‚   â””â”€â”€ config.toml               # Supabase configuration
â”œâ”€â”€ docs/                         # Documentation (this folder)
â”œâ”€â”€ public/                       # Static assets
â”œâ”€â”€ scripts/                      # Build utilities
â””â”€â”€ [config files]                # vite, tailwind, tsconfig, etc.
</code></pre></p><p>---</p><p><h2>Running Locally</h2></p><p><h3>Prerequisites</h3></p><p><li>Node.js 18+ or Bun</li>
<li>Supabase CLI (for local backend)</li>
<li>Git</li></p><p><h3>Quick Start</h3></p><p><pre><code class="bash"><h1>Clone the repository</h1>
git clone <repository-url>
cd freshtrack-pro</p><p><h1>Install dependencies</h1>
npm install
<h1>or: bun install</h1></p><p><h1>Set up environment variables</h1>
cp .env.example .env
<h1>Edit .env with your Supabase credentials</h1></p><p><h1>Start development server</h1>
npm run dev
<h1>or: bun dev</h1>
</code></pre></p><p>The app will be available at <code>http://localhost:8080</code></p><p><h3>Environment Variables</h3></p><p>| Variable | Description |
|----------|-------------|
| <code>VITE_SUPABASE_URL</code> | Supabase project URL |
| <code>VITE_SUPABASE_PUBLISHABLE_KEY</code> | Supabase anon key (safe for client) |
| <code>VITE_SUPABASE_PROJECT_ID</code> | Supabase project ID |</p><p><h3>Running with Local Supabase</h3></p><p><pre><code class="bash"><h1>Start local Supabase</h1>
supabase start</p><p><h1>Run migrations</h1>
supabase db push</p><p><h1>Start edge functions</h1>
supabase functions serve
</code></pre></p><p>---</p><p><h2>Build & Deployment</h2></p><p><h3>Production Build</h3></p><p><pre><code class="bash"><h1>Build for production</h1>
npm run build
<h1>or: bun run build</h1></p><p><h1>Preview production build</h1>
npm run preview
</code></pre></p><p><h3>Deployment</h3></p><p>The application is configured for deployment via the Lovable platform. Production deployments are triggered automatically via git push.</p><p><h3>Build Outputs</h3></p><p><li><strong>dist/</strong>: Production bundle (optimized JS, CSS, assets)</li>
<li><strong>dist/sw.js</strong>: Service worker for PWA functionality</li>
<li><strong>dist/manifest.webmanifest</strong>: PWA manifest</li></p><p>---</p><p><h2>High-Level System Overview</h2></p><p><pre><code class="">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (React SPA)                      â”‚
â”‚  - Dashboard, Settings, Reports, Manual Logging                  â”‚
â”‚  - Offline-capable manual temperature logging                    â”‚
â”‚  - Real-time status updates via polling                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SUPABASE (Backend)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  PostgreSQL â”‚  â”‚ Edge Funcs  â”‚  â”‚    Auth     â”‚              â”‚
â”‚  â”‚  Database   â”‚  â”‚  (Deno)     â”‚  â”‚  (Supabase) â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                â”‚                                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                          â”‚                                   â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚              Edge Functions Pipeline                   â”‚   â”‚  â”‚
â”‚  â”‚  ingest-readings â†’ process-unit-states â†’ escalations   â”‚   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                      â–¼                      â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     TTN     â”‚       â”‚   Stripe    â”‚       â”‚   Twilio    â”‚
   â”‚  (Sensors)  â”‚       â”‚ (Payments)  â”‚       â”‚   (SMS)     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p><h3>Key Data Flow</h3></p><p><li><strong>Sensor Data Ingestion</strong>: TTN â†’ <code>ttn-webhook</code> â†’ <code>sensor_readings</code> table</li>
<li><strong>State Processing</strong>: <code>ingest-readings</code> â†’ <code>process-unit-states</code> â†’ creates/resolves alerts</li>
<li><strong>Notifications</strong>: <code>process-unit-states</code> â†’ <code>process-escalations</code> â†’ email/SMS/push</li>
<li><strong>Manual Logging</strong>: UI â†’ Supabase direct â†’ <code>manual_temperature_logs</code> table</li></p><p>---</p><p><h2>Documentation Index</h2></p><p>See <a href="#index">INDEX.md</a> for a complete navigation guide to all documentation.</p><p><h3>Quick Links</h3></p><p><li><a href="#architecture-architecture">Architecture Overview</a></li>
<li><a href="#engineering-api">API Reference</a></li>
<li><a href="#engineering-data_model">Data Model</a></li>
<li><a href="#product-user_flows">User Flows</a></li>
<li><a href="#product-pages">Page Documentation</a></li>
<li><a href="#engineering-integrations">Integrations Guide</a></li>
<li><a href="#glossary">Glossary</a></li></p><p>---</p><p><h2>Contributing</h2></p><p><li>Read the <a href="#knowledge">KNOWLEDGE.md</a> file for coding conventions and guidelines</li>
<li>Follow the existing patterns for components, hooks, and edge functions</li>
<li>Ensure all significant state changes are logged to <code>event_logs</code></li>
<li>Never duplicate alert creation logic - use <code>process-unit-states</code> as the single source of truth</li>
<li>Run tests before committing: <code>npm run test</code></li></p><p>---</p><p><h2>License</h2></p><p>Proprietary - All rights reserved.</p><p>
---</p><p><div class="page-break"></div></p><p><a id="index"></a></p><p><h1>FreshTrack Pro Documentation Index</h1></p><p><blockquote>Complete navigation guide to all project documentation</blockquote></p><p><strong>Last Updated:</strong> 2026-01-12 02:24:44 UTC
<strong>Total Documents:</strong> 49</p><p>---</p><p><h2>Quick Links</h2></p><p>| Document | Description |
|----------|-------------|
| <a href="#readme">README</a> | Project overview and quick start |
| <a href="#glossary">GLOSSARY</a> | Terminology and definitions |
| <a href="#ci_checklist">CI Checklist</a> | Documentation CI validation rules |</p><p>---
<h2>Executive Summary</h2></p><p>High-level overviews for stakeholders and decision-makers.</p><p>| Document | Description |
|----------|-------------|
| <a href="#executive-faq">FreshTrack Pro: Frequently Asked Questions</a> | Frequently asked questions |
| <a href="#executive-overview">FreshTrack Pro Overview</a> | What FreshTrack Pro is and does |
| <a href="#executive-system_at_a_glance">FreshTrack Pro: System at a Glance</a> | High-level system overview |
| <a href="#executive-user_journeys">FreshTrack Pro User Journeys</a> | Day-in-the-life scenarios |
| <a href="#executive-value_proposition">FreshTrack Pro Value Proposition</a> | Business value and benefits |</p><p><h2>Architecture</h2></p><p>System design, components, and technical decisions.</p><p>| Document | Description |
|----------|-------------|
| <a href="#architecture-architecture">FreshTrack Pro System Architecture</a> | System architecture and design |</p><p><h2>Product</h2></p><p>Pages, user flows, and product functionality.</p><p>| Document | Description |
|----------|-------------|
| <a href="#product-pages">FreshTrack Pro Pages Documentation</a> | All application pages and routes |
| <a href="#product-user_flows">FreshTrack Pro User Flows</a> | User interaction workflows |</p><p><h2>Engineering</h2></p><p>API, data model, integrations, and technical details.</p><p>| Document | Description |
|----------|-------------|
| <a href="#engineering-api">FreshTrack Pro API Documentation</a> | Edge functions and API endpoints |
| <a href="#engineering-data_model">FreshTrack Pro Data Model</a> | Database schema and relationships |
| <a href="#engineering-integrations">FreshTrack Pro Integrations</a> | External service integrations |
| <a href="#engineering-observability">FreshTrack Pro Observability</a> | Logging and monitoring |</p><p><h2>Onboarding</h2></p><p>Getting started guides for new team members.</p><p>| Document | Description |
|----------|-------------|
| <a href="#onboarding-common_tasks">Common Development Tasks</a> | How to do common tasks |
| <a href="#onboarding-debugging_guide">Debugging Guide</a> | Troubleshooting and debugging |
| <a href="#onboarding-getting_started">Getting Started with FreshTrack Pro</a> | Mental model for new developers |
| <a href="#onboarding-local_dev">Local Development Setup</a> | Development environment setup |
| <a href="#onboarding-repo_tour">Repository Tour</a> | Codebase walkthrough |</p><p><h2>Quality Assurance</h2></p><p>Testing strategy, coverage, and quality assurance.</p><p>| Document | Description |
|----------|-------------|
| <a href="#qa-coverage_map">Coverage Map</a> | Test coverage by feature |
| <a href="#qa-e2e_scenarios">End-to-End Test Scenarios</a> | End-to-end test scenarios |
| <a href="#qa-known_gaps">Known Test Coverage Gaps</a> | Coverage gaps and risks |
| <a href="#qa-manual_testing">Manual Testing Guide</a> | Manual QA checklists |
| <a href="#qa-test_strategy">Test Strategy</a> | Testing philosophy and approach |</p><p><h2>Security</h2></p><p>Security model, threats, and incident response.</p><p>| Document | Description |
|----------|-------------|
| <a href="#security-auth_model">Authentication & Authorization Model</a> | Authentication and authorization |
| <a href="#security-data_protection">Data Protection</a> | Encryption and data handling |
| <a href="#security-incident_response">Incident Response</a> | Security incident procedures |
| <a href="#security-security_overview">Security Overview</a> | Security principles and controls |
| <a href="#security-threat_model">Threat Model</a> | Threats and mitigations |</p><p><h2>Operations</h2></p><p>Monitoring, alerting, and operational procedures.</p><p>| Document | Description |
|----------|-------------|
| <a href="#operations-alerting">Alerting</a> | Alert conditions and escalation |
| <a href="#operations-dashboards">Dashboards</a> | Monitoring dashboards |
| <a href="#operations-logging">Logging</a> | Log sources and debugging |
| <a href="#operations-metrics_overview">Metrics Overview</a> | System metrics and thresholds |
| <a href="#operations-runbooks">Runbooks</a> | Operational procedures |</p><p><h2>Diagrams</h2></p><p>Visual representations and flowcharts.</p><p>| Document | Description |
|----------|-------------|
| <a href="#diagrams-container_diagram">Container Diagram</a> | Container architecture |
| <a href="#diagrams-page_diagrams">Page Diagrams</a> | Page component diagrams |
| <a href="#diagrams-sequences">Sequence Diagrams</a> | Sequence diagrams |
| <a href="#diagrams-state_machines">State Machines</a> | State machine diagrams |
| <a href="#diagrams-system_context">System Context Diagram</a> | System context diagram |</p><p><h2>Charts</h2></p><p>Data models and entity relationships.</p><p>| Document | Description |
|----------|-------------|
| <a href="#charts-er_diagram">Entity-Relationship Diagram</a> | Entity relationship diagram |
| <a href="#charts-flowcharts">Flowcharts</a> | Process flowcharts |</p><p><h2>General</h2></p><p>General documentation and guides.</p><p>| Document | Description |
|----------|-------------|
| <a href="#emulator_quick_start">Emulator Quick Start - TTN Integration</a> | Emulator quick start |
| <a href="#emulator_ttn_integration">Emulator TTN Integration Guide</a> | TTN emulator integration |
| <a href="#readme">FreshTrack Pro (FrostGuard)</a> | Project overview |
| <a href="#ttn_production_setup">TTN Production Secrets Setup</a> | Production TTN setup |
| <a href="#ttn_setup">The Things Network (TTN) Setup Guide</a> | TTN configuration guide |
| <a href="#deprecations">FrostGuard Deprecations</a> | Deprecated features |
| <a href="#system-map">FrostGuard System Map</a> | System component map |</p><p>---</p><p><h2>Document Relationships</h2></p><p><h3>Core Documentation Flow</h3></p><p><pre><code class="">Executive Overview     â†’  Architecture  â†’  Engineering Details
        â†“                      â†“                   â†“
   Value Prop           System Design        API & Data Model
        â†“                      â†“                   â†“
   User Journeys         Diagrams            Integrations
</code></pre></p><p><h3>Key Cross-References</h3></p><p>| If you need... | Start with... | Then see... |
|----------------|---------------|-------------|
| System understanding | <a href="#architecture-architecture">Architecture</a> | <a href="#diagrams-system_context">System Context</a> |
| User flows | <a href="#product-user_flows">User Flows</a> | <a href="#diagrams-sequences">Sequences</a> |
| Data structures | <a href="#engineering-data_model">Data Model</a> | <a href="#charts-er_diagram">ER Diagram</a> |
| Getting started | <a href="#onboarding-getting_started">Getting Started</a> | <a href="#onboarding-local_dev">Local Dev</a> |
| Security review | <a href="#security-security_overview">Security Overview</a> | <a href="#security-threat_model">Threat Model</a> |
| Operations | <a href="#operations-metrics_overview">Metrics</a> | <a href="#operations-runbooks">Runbooks</a> |</p><p>---</p><p><h2>Documentation Pipeline</h2></p><p>This index is automatically generated. To regenerate:</p><p><pre><code class="bash">npm run docs:build
</code></pre></p><p>To validate documentation:</p><p><pre><code class="bash">npm run docs:lint
</code></pre></p><p>To run the complete pipeline:</p><p><pre><code class="bash">npm run docs:all
</code></pre></p><p>See <a href="#ci_checklist">CI_CHECKLIST.md</a> for documentation standards and validation rules.</p><p>
---</p><p><div class="page-break"></div></p><p><a id="executive-overview"></a></p><p><h1>FreshTrack Pro Overview</h1></p><p><blockquote>Refrigeration Monitoring & Food Safety Compliance Platform</blockquote></p><p>---</p><p><h2>What is FreshTrack Pro?</h2></p><p>FreshTrack Pro is a <strong>smart refrigeration monitoring platform</strong> that automatically tracks temperatures in commercial refrigerators, freezers, and cold storage units. When something goes wrongâ€”like a door left open or a cooling system failureâ€”the system immediately alerts the right people before food spoils or safety violations occur.</p><p>Think of it as a <strong>24/7 watchdog for your cold chain</strong> that never takes a break, never forgets to check, and always keeps a perfect record for inspectors.</p><p>---</p><p><h2>The Problem We Solve</h2></p><p>Every year, businesses lose billions of dollars to:</p><p>| Problem | Impact |
|---------|--------|
| <strong>Spoiled inventory</strong> | A single freezer failure can destroy $10,000+ in product overnight |
| <strong>Health code violations</strong> | Fines, closures, and reputation damage from failed inspections |
| <strong>Manual logging burden</strong> | Staff waste hours on paper temperature logs that are error-prone |
| <strong>Late discovery</strong> | Problems found hours or days after they started, when it's too late |
| <strong>Compliance gaps</strong> | Missing or incomplete records during health inspections |</p><p><strong>FreshTrack Pro eliminates these problems</strong> by automating temperature monitoring, alerting, and compliance documentation.</p><p>---</p><p><h2>Who Uses FreshTrack Pro?</h2></p><p>FreshTrack Pro is designed for organizations that need to maintain strict temperature control:</p><p>| Industry | Use Cases |
|----------|-----------|
| <strong>Restaurants & Food Service</strong> | Walk-in coolers, freezers, prep stations |
| <strong>Grocery & Retail</strong> | Display cases, storage, receiving areas |
| <strong>Healthcare</strong> | Vaccine storage, blood banks, pharmaceutical storage |
| <strong>Food Manufacturing</strong> | Production lines, raw material storage, shipping |
| <strong>Hospitality</strong> | Hotel kitchens, event catering, banquet facilities |
| <strong>Education</strong> | School cafeterias, university dining halls |</p><p>---</p><p><h2>Key Capabilities</h2></p><p><h3>1. Continuous Monitoring</h3>
Wireless sensors check temperatures every 5 minutes (configurable) and transmit readings automatically. No manual checks required.</p><p><h3>2. Instant Alerts</h3>
When temperatures go out of range, the system immediately notifies the right people via:
<li>Email</li>
<li>Text message (SMS)</li>
<li>Mobile push notifications</li></p><p>Alerts escalate to managers and supervisors if not acknowledged within configurable timeframes.</p><p><h3>3. Compliance Ready</h3>
<li><strong>Automatic audit trails</strong> that record every reading, alert, and action</li>
<li><strong>HACCP-compliant</strong> documentation for health inspections</li>
<li><strong>One-click reports</strong> showing compliance history for any time period</li>
<li><strong>Corrective action tracking</strong> to document how issues were resolved</li></p><p><h3>4. Multi-Location Management</h3>
Manage all your locations from a single dashboard:
<li>Organization â†’ Sites â†’ Areas â†’ Individual Units</li>
<li>Centralized monitoring across cities, states, or countries</li>
<li>Role-based access so staff only see what they need</li></p><p><h3>5. Offline-Ready Manual Logging</h3>
When sensors aren't available, staff can log temperatures manually from any mobile deviceâ€”even without internet connection. Logs sync automatically when connectivity returns.</p><p><h3>6. Equipment Health Insights</h3>
<li><strong>Battery life forecasting</strong> for wireless sensors</li>
<li><strong>Connectivity monitoring</strong> to catch communication issues early</li>
<li><strong>Calibration reminders</strong> to ensure sensor accuracy</li></p><p>---</p><p><h2>At a Glance</h2></p><p>| Feature | Description |
|---------|-------------|
| <strong>Monitoring</strong> | 24/7 automated temperature tracking |
| <strong>Alerting</strong> | Multi-channel, escalating notifications |
| <strong>Compliance</strong> | HACCP/FDA-ready documentation and reports |
| <strong>Access</strong> | Web and mobile apps, works on any device |
| <strong>Scale</strong> | From 1 unit to thousands across multiple locations |
| <strong>Deployment</strong> | Cloud-based, no servers to maintain |</p><p>---</p><p><h2>What FreshTrack Pro Is NOT</h2></p><p>To set clear expectations:</p><p><li><strong>Not a consumer product</strong> â€” Designed for commercial/industrial use, not home refrigerators</li>
<li><strong>Not an inventory system</strong> â€” Tracks temperatures, not what's inside</li>
<li><strong>Not hardware-only</strong> â€” Requires subscription for monitoring service</li></p><p>---</p><p><h2>Next Steps</h2></p><p><li><a href="#value_proposition">Value Proposition</a> â€” Why FreshTrack Pro matters</li>
<li><a href="#system_at_a_glance">System at a Glance</a> â€” How it works</li>
<li><a href="#user_journeys">User Journeys</a> â€” Day in the life with FreshTrack Pro</li>
<li><a href="#faq">FAQ</a> â€” Common questions answered</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="executive-value_proposition"></a></p><p><h1>FreshTrack Pro Value Proposition</h1></p><p><blockquote>The business case for automated refrigeration monitoring</blockquote></p><p>---</p><p><h2>The Bottom Line</h2></p><p><strong>FreshTrack Pro pays for itself by preventing a single spoilage event.</strong></p><p>A typical walk-in freezer failure can destroy $10,000â€“$50,000 in inventory. A health code violation can result in fines, forced closures, and lasting reputation damage. FreshTrack Pro provides 24/7 protection for a fraction of what one incident would cost.</p><p>---</p><p><h2>Business Value</h2></p><p><h3>1. Prevent Costly Losses</h3></p><p>| Scenario | Without FreshTrack Pro | With FreshTrack Pro |
|----------|------------------------|---------------------|
| Freezer fails at 2 AM | Discovered at 6 AM opening. $15,000 inventory lost. | Alert sent immediately. Manager responds. $0 lost. |
| Door left ajar overnight | Product quality compromised. Partial loss. | Alert sent after 20 min grace period. Staff responds. |
| Slow cooling system decline | Not noticed until catastrophic failure. | Temperature trend detected. Preventive maintenance scheduled. |</p><p><strong>ROI Example</strong>: One prevented incident = 12â€“24 months of subscription cost avoided.</p><p>---</p><p><h3>2. Reduce Labor Costs</h3></p><p>| Task | Manual Process | With FreshTrack Pro |
|------|----------------|---------------------|
| Temperature logging | 15â€“30 min/day per location | Automatic |
| Log organization | Paper filing, retrieval | Digital, searchable |
| Report generation | Hours compiling spreadsheets | One-click export |
| Inspector prep | Hunting for records | Ready in seconds |</p><p><strong>Savings</strong>: 5â€“10 hours per week in staff time across a typical multi-unit operation.</p><p>---</p><p><h3>3. Pass Inspections with Confidence</h3></p><p>Health inspectors want to see:
<li>Consistent temperature records</li>
<li>Evidence of monitoring</li>
<li>Documentation of corrective actions</li></p><p>FreshTrack Pro provides:
<li><strong>Complete, unbroken temperature history</strong> â€” no gaps, no missing logs</li>
<li><strong>Timestamped alerts</strong> showing immediate response to issues</li>
<li><strong>Corrective action records</strong> documenting what was done and when</li>
<li><strong>Professional reports</strong> ready to print or share digitally</li></p><p><strong>Result</strong>: Faster inspections. Fewer citations. Better scores.</p><p>---</p><p><h3>4. Protect Your Reputation</h3></p><p>In the age of social media, one foodborne illness outbreak can devastate a brand. FreshTrack Pro helps you:</p><p><li><strong>Prove due diligence</strong> â€” comprehensive monitoring records</li>
<li><strong>Respond faster</strong> â€” catch problems before customers are affected</li>
<li><strong>Demonstrate commitment</strong> â€” visible evidence of food safety investment</li></p><p>---</p><p><h2>Competitive Differentiators</h2></p><p><h3>What Sets FreshTrack Pro Apart</h3></p><p>| Feature | FreshTrack Pro | Traditional Solutions |
|---------|----------------|----------------------|
| <strong>Multi-location dashboard</strong> | Single view of all sites | Separate systems per location |
| <strong>Escalating alerts</strong> | Auto-escalate if not acknowledged | Single notification, easy to miss |
| <strong>Offline manual logging</strong> | Works without internet | Requires connectivity |
| <strong>Hierarchical configuration</strong> | Set rules at org/site/unit level | One-size-fits-all settings |
| <strong>Modern interface</strong> | Mobile-first, intuitive | Desktop-focused, dated |
| <strong>Compliance-ready reports</strong> | HACCP/FDA formatted | Manual formatting required |</p><p><h3>Why Customers Choose Us</h3></p><p><li><strong>Reliability First</strong> â€” Built for mission-critical monitoring where failures matter</li>
<li><strong>Flexible Alerting</strong> â€” Configure exactly who gets notified, when, and how</li>
<li><strong>True Multi-Site Support</strong> â€” Designed from day one for organizations with multiple locations</li>
<li><strong>Modern Technology</strong> â€” Cloud-native platform that's always up to date</li>
<li><strong>Responsive Support</strong> â€” Real people who understand food safety</li></p><p>---</p><p><h2>Pricing That Makes Sense</h2></p><p>| Plan | Monthly | Sensors | Key Features |
|------|---------|---------|--------------|
| <strong>Starter</strong> | $29 | Up to 5 | Basic monitoring, email alerts |
| <strong>Pro</strong> | $79 | Up to 25 | + SMS alerts, advanced reports |
| <strong>HACCP</strong> | $199 | Up to 100 | + Full compliance suite, audit tools |
| <strong>Enterprise</strong> | Custom | Unlimited | Custom integrations, dedicated support |</p><p><strong>No long-term contracts required.</strong> Cancel anytime.</p><p>---</p><p><h2>Who Benefits?</h2></p><p><h3>For Executives</h3>
<li><strong>Risk reduction</strong> â€” Minimize exposure to spoilage, fines, and liability</li>
<li><strong>Operational visibility</strong> â€” See all locations at a glance</li>
<li><strong>Cost control</strong> â€” Predictable subscription vs. unpredictable losses</li></p><p><h3>For Operations Managers</h3>
<li><strong>Peace of mind</strong> â€” Know you'll be alerted to problems immediately</li>
<li><strong>Trend analysis</strong> â€” Spot equipment issues before they become failures</li>
<li><strong>Staff accountability</strong> â€” See who acknowledged what and when</li></p><p><h3>For Frontline Staff</h3>
<li><strong>Simple interface</strong> â€” Quick logging, clear status indicators</li>
<li><strong>Mobile-friendly</strong> â€” Works on any phone or tablet</li>
<li><strong>Clear alerts</strong> â€” Know exactly what needs attention</li></p><p><h3>For Compliance Teams</h3>
<li><strong>Audit-ready records</strong> â€” Everything documented automatically</li>
<li><strong>Gap-free history</strong> â€” Continuous monitoring = complete records</li>
<li><strong>Easy reporting</strong> â€” Generate inspector-ready reports in seconds</li></p><p>---</p><p><h2>The Cost of NOT Acting</h2></p><p>Consider what happens without automated monitoring:</p><p>| Risk | Potential Cost |
|------|----------------|
| Single freezer failure | $10,000â€“$50,000 in lost inventory |
| Health code violation | $500â€“$10,000 in fines |
| Forced closure | $5,000â€“$50,000/day in lost revenue |
| Foodborne illness lawsuit | $100,000+ in legal costs |
| Brand damage | Immeasurable |</p><p><strong>FreshTrack Pro subscription</strong>: A few hundred dollars per month.</p><p><strong>The math is simple.</strong></p><p>---</p><p><h2>Next Steps</h2></p><p>Ready to protect your cold chain?</p><p><li><strong>See a demo</strong> â€” Watch FreshTrack Pro in action</li>
<li><strong>Start a trial</strong> â€” Free 14-day trial, no credit card required</li>
<li><strong>Talk to sales</strong> â€” Custom solutions for enterprise needs</li></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#overview">Overview</a> â€” What FreshTrack Pro is</li>
<li><a href="#system_at_a_glance">System at a Glance</a> â€” How it works</li>
<li><a href="#user_journeys">User Journeys</a> â€” Day in the life</li>
<li><a href="#faq">FAQ</a> â€” Common questions</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="executive-system_at_a_glance"></a></p><p><h1>FreshTrack Pro: System at a Glance</h1></p><p><blockquote>A simple look at how FreshTrack Pro works</blockquote></p><p>---</p><p><h2>How It Works (The Simple Version)</h2></p><p>FreshTrack Pro is like having a tireless employee who:
<li><strong>Checks every refrigerator</strong> every 5 minutes</li>
<li><strong>Records every reading</strong> automatically</li>
<li><strong>Calls you immediately</strong> if something is wrong</li>
<li><strong>Keeps perfect records</strong> for inspectors</li></p><p>All of this happens automatically, 24 hours a day, 7 days a week.</p><p>---</p><p><h2>The Three Parts of FreshTrack Pro</h2></p><p><pre><code class="mermaid">graph LR
    subgraph "1. SENSORS"
        S[Wireless Sensors<br/>in your equipment]
    end</p><p>    subgraph "2. CLOUD PLATFORM"
        C[FreshTrack Pro<br/>processes data &<br/>sends alerts]
    end</p><p>    subgraph "3. YOUR TEAM"
        T[Dashboard, Mobile App<br/>& Notifications]
    end</p><p>    S -->|"Temperature<br/>readings"| C
    C -->|"Alerts &<br/>reports"| T
</code></pre></p><p><h3>1. Wireless Sensors</h3>
Small devices placed inside refrigerators, freezers, and cold storage units that:
<li>Measure temperature continuously</li>
<li>Send readings wirelessly (no cables needed)</li>
<li>Run for years on a single battery</li></p><p><h3>2. Cloud Platform</h3>
The "brain" of FreshTrack Pro that:
<li>Receives all sensor readings</li>
<li>Compares temperatures to your safe limits</li>
<li>Sends alerts when something is wrong</li>
<li>Stores all data securely for compliance</li></p><p><h3>3. Your Team's Access</h3>
How you and your team interact with FreshTrack Pro:
<li><strong>Web Dashboard</strong> â€” Full view of all locations from any computer</li>
<li><strong>Mobile App</strong> â€” Check status and respond to alerts from anywhere</li>
<li><strong>Notifications</strong> â€” Email, text, and push alerts when action is needed</li></p><p>---</p><p><h2>The Alert Flow</h2></p><p>What happens when a temperature problem occurs:</p><p><pre><code class="mermaid">graph TD
    A[Sensor detects<br/>temperature out of range] --> B[System confirms<br/>it's not a false alarm]
    B --> C[Alert sent to<br/>primary contacts]
    C --> D{Acknowledged<br/>within time limit?}
    D -->|Yes| E[Issue tracked<br/>until resolved]
    D -->|No| F[Alert escalates to<br/>managers/supervisors]
    F --> G[Process repeats<br/>until acknowledged]
    E --> H[Resolution logged<br/>for compliance]
    G --> H
</code></pre></p><p><strong>Key Points:</strong>
<li>Alerts aren't sent for brief fluctuations (like when someone opens a door)</li>
<li>If the first person doesn't respond, alerts automatically escalate</li>
<li>Everything is documented for your records</li></p><p>---</p><p><h2>Your Organization Structure</h2></p><p>FreshTrack Pro mirrors how your business is organized:</p><p><pre><code class="mermaid">graph TD
    O[Your Organization] --> S1[Site: Downtown Location]
    O --> S2[Site: Airport Location]
    O --> S3[Site: Mall Location]</p><p>    S1 --> A1[Area: Main Kitchen]
    S1 --> A2[Area: Storage Room]</p><p>    A1 --> U1[Unit: Walk-in Cooler]
    A1 --> U2[Unit: Prep Freezer]
    A2 --> U3[Unit: Dry Storage Fridge]
</code></pre></p><p><strong>Benefits of this structure:</strong>
<li>Set rules at any level (organization-wide, per-site, or per-unit)</li>
<li>Give staff access to only their locations</li>
<li>Roll up reporting by site, region, or entire organization</li></p><p>---</p><p><h2>What Gets Tracked</h2></p><p>| Data Point | How It's Captured |
|------------|-------------------|
| <strong>Temperature</strong> | Automatic sensor readings every 5 minutes |
| <strong>Door events</strong> | Sensors detect when doors open/close |
| <strong>Sensor health</strong> | Battery levels and signal strength |
| <strong>Alerts</strong> | When triggered, who responded, how long to resolve |
| <strong>Manual logs</strong> | Staff entries for backup or verification |
| <strong>Changes</strong> | Who changed settings, when, and what |</p><p><strong>All data is stored securely and never deleted</strong> â€” available for compliance audits at any time.</p><p>---</p><p><h2>The Dashboard at a Glance</h2></p><p>When you log in, you see:</p><p>| Section | What It Shows |
|---------|---------------|
| <strong>Status Overview</strong> | Green/yellow/red indicators for every unit |
| <strong>Active Alerts</strong> | Any issues needing immediate attention |
| <strong>Recent Activity</strong> | Latest readings and events |
| <strong>Quick Actions</strong> | Log temperature, acknowledge alerts, generate reports |</p><p><strong>Color Coding:</strong>
<li>ğŸŸ¢ <strong>Green</strong> â€” Everything normal</li>
<li>ğŸŸ¡ <strong>Yellow/Orange</strong> â€” Needs attention (warning)</li>
<li>ğŸ”´ <strong>Red</strong> â€” Immediate action required (critical)</li>
<li>âš« <strong>Gray</strong> â€” Offline or no data</li></p><p>---</p><p><h2>Security & Reliability</h2></p><p>| Concern | How FreshTrack Pro Addresses It |
|---------|--------------------------------|
| <strong>Data Security</strong> | All data encrypted, stored in secure cloud infrastructure |
| <strong>Access Control</strong> | Role-based permissions â€” staff only see what they need |
| <strong>Uptime</strong> | Cloud platform designed for 99.9%+ availability |
| <strong>Data Backup</strong> | Automatic backups, no data loss |
| <strong>Compliance</strong> | Meets HACCP, FDA, and industry standards |</p><p>---</p><p><h2>Integration Points</h2></p><p>FreshTrack Pro can work with:</p><p>| Integration | Purpose |
|-------------|---------|
| <strong>Email systems</strong> | Alert delivery |
| <strong>SMS/Text messaging</strong> | Critical alerts to phones |
| <strong>Payment processing</strong> | Subscription billing |</p><p><em>Enterprise customers can discuss additional integrations.</em></p><p>---</p><p><h2>Summary</h2></p><p>FreshTrack Pro is a complete, end-to-end solution:</p><p><li><strong>Sensors</strong> collect data from your equipment</li>
<li><strong>Cloud platform</strong> analyzes data and sends alerts</li>
<li><strong>Web & mobile apps</strong> give you visibility and control</li>
<li><strong>Automatic documentation</strong> keeps you compliant</li></p><p>No servers to maintain. No software to install. Just protection for your cold chain.</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#overview">Overview</a> â€” What FreshTrack Pro is</li>
<li><a href="#value_proposition">Value Proposition</a> â€” Why it matters</li>
<li><a href="#user_journeys">User Journeys</a> â€” Day in the life</li>
<li><a href="#faq">FAQ</a> â€” Common questions</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="executive-user_journeys"></a></p><p><h1>FreshTrack Pro User Journeys</h1></p><p><blockquote>A day in the life with FreshTrack Pro</blockquote></p><p>---</p><p><h2>Meet Your Team</h2></p><p>Before we explore the journeys, let's introduce the people who use FreshTrack Pro:</p><p>| Person | Role | What They Care About |
|--------|------|---------------------|
| <strong>Alex</strong> | Food Safety Manager | Compliance, inspections, protecting the business |
| <strong>Jordan</strong> | Operations Manager | Equipment health, costs, staff efficiency |
| <strong>Sam</strong> | Kitchen Lead | Getting work done, responding quickly to issues |
| <strong>Morgan</strong> | Regional Director | Multi-site oversight, big-picture trends |</p><p>---</p><p><h2>Journey 1: Getting Started (Onboarding)</h2></p><p><h3>Day 1: Alex Sets Up FreshTrack Pro</h3></p><p><strong>9:00 AM</strong> â€” Alex receives an email that FreshTrack Pro is ready. She clicks the link and creates her account in under a minute.</p><p><strong>9:05 AM</strong> â€” The setup wizard walks her through adding her organization. She enters:
<li>Company name: "Fresh Bites Restaurant Group"</li>
<li>First location: "Downtown Flagship"</li></p><p><strong>9:10 AM</strong> â€” Alex adds the areas within her location:
<li>Main Kitchen</li>
<li>Walk-in Cooler</li>
<li>Freezer Storage</li></p><p><strong>9:15 AM</strong> â€” For each refrigeration unit, Alex sets:
<li>A name everyone will recognize ("Prep Station Fridge")</li>
<li>Temperature limits (35Â°F to 40Â°F for coolers)</li>
<li>Who should be notified if there's a problem</li></p><p><strong>9:30 AM</strong> â€” The IT team installs the wireless sensors inside each unit. They simply stick to the wallâ€”no wiring needed.</p><p><strong>9:45 AM</strong> â€” Within minutes, Alex sees the first temperature readings appearing on her dashboard. Green status lights confirm everything is working.</p><p><strong>10:00 AM</strong> â€” Alex invites Jordan (Operations) and Sam (Kitchen Lead) to the system. Each gets a role-appropriate view.</p><p><blockquote><strong>Outcome</strong>: In less than an hour, FreshTrack Pro is monitoring all refrigeration units and the whole team has access.</blockquote></p><p>---</p><p><h2>Journey 2: A Normal Day (Daily Monitoring)</h2></p><p><h3>Morning: Jordan Checks the Dashboard</h3></p><p><strong>6:30 AM</strong> â€” Jordan arrives and opens FreshTrack Pro on his phone before even entering the building.</p><p><strong>The dashboard shows:</strong>
<li>âœ… All units green across 3 locations</li>
<li>ğŸ“Š Overnight temperature graphs look stable</li>
<li>ğŸ”‹ One sensor battery at 15% (reminder to replace this week)</li></p><p><strong>6:35 AM</strong> â€” Jordan feels confident everything is fine. No calls from staff overnight means the system is working.</p><p><h3>Midday: Sam Logs a Manual Check</h3></p><p><strong>11:00 AM</strong> â€” As part of HACCP requirements, Sam does a visual verification of the walk-in cooler using a handheld thermometer.</p><p><strong>11:02 AM</strong> â€” Sam pulls out his phone, opens FreshTrack Pro, and:
<li>Taps "Log Temperature"</li>
<li>Selects "Walk-in Cooler"</li>
<li>Enters "38Â°F"</li>
<li>Adds note: "Visual check - all product properly stored"</li>
<li>Taps "Save"</li></p><p><strong>Done in 30 seconds.</strong> The reading is now permanently recorded with Sam's name and timestamp.</p><p><h3>Afternoon: Alex Prepares for a Vendor Meeting</h3></p><p><strong>2:00 PM</strong> â€” A food supplier asks for temperature records as part of their audit requirements.</p><p><strong>2:05 PM</strong> â€” Alex opens FreshTrack Pro, goes to Reports, and:
<li>Selects "Temperature Log Report"</li>
<li>Chooses last 30 days</li>
<li>Selects the receiving area cooler</li>
<li>Clicks "Export PDF"</li></p><p><strong>2:06 PM</strong> â€” A professional, complete report downloads. Alex emails it to the vendor.</p><p><blockquote><strong>Outcome</strong>: Normal operations require just a few minutes of interaction with FreshTrack Pro. Everything else is automatic.</blockquote></p><p>---</p><p><h2>Journey 3: Responding to an Alert</h2></p><p><h3>Late Night: Something Goes Wrong</h3></p><p><strong>11:47 PM</strong> â€” A walk-in freezer compressor fails. Temperature begins rising.</p><p><strong>11:52 PM</strong> â€” Temperature crosses the alert threshold (above 0Â°F). FreshTrack Pro confirms this isn't a brief fluctuation.</p><p><strong>11:53 PM</strong> â€” FreshTrack Pro sends:
<li>ğŸ“± Push notification to Sam's phone</li>
<li>ğŸ“§ Email to Sam</li>
<li>ğŸ“± Text message to Sam</li></p><p><strong>11:55 PM</strong> â€” Sam's phone buzzes. She sees:</p><p><blockquote><strong>ALERT: Downtown - Walk-in Freezer</strong></blockquote>
<blockquote>Temperature: 8Â°F (Limit: 0Â°F)</blockquote>
<blockquote>Rising for 5 minutes</blockquote>
<blockquote><strong>[Acknowledge]</strong> <strong>[View Details]</strong></blockquote></p><p><strong>11:56 PM</strong> â€” Sam taps "Acknowledge" and adds a note: "Checking now."</p><p><strong>11:58 PM</strong> â€” Sam arrives at the freezer and finds the compressor has stopped. She calls the emergency HVAC service.</p><p><h3>The Escalation That Didn't Happen</h3></p><p><strong>If Sam hadn't responded</strong>, FreshTrack Pro would have:
<li><strong>12:08 PM</strong> (15 min later) â€” Escalated to Jordan (Operations Manager)</li>
<li><strong>12:23 PM</strong> (30 min later) â€” Escalated to Alex (Food Safety Manager)</li></p><p>But because Sam acknowledged immediately, the right person was already handling it.</p><p><h3>Resolution</h3></p><p><strong>12:30 AM</strong> â€” HVAC technician arrives and restarts the compressor.</p><p><strong>1:00 AM</strong> â€” Temperature returns to normal range. FreshTrack Pro automatically marks the alert as resolved.</p><p><strong>1:01 AM</strong> â€” Sam opens the app and documents the corrective action:
<li>"Compressor failed, HVAC called immediately"</li>
<li>"Tech identified loose connection"</li>
<li>"No product affected - temp never exceeded 15Â°F"</li></p><p><blockquote><strong>Outcome</strong>: A potentially catastrophic freezer failure was caught and resolved before any inventory was lost. Complete documentation exists for compliance records.</blockquote></p><p>---</p><p><h2>Journey 4: Health Inspection Day</h2></p><p><h3>Morning: The Inspector Arrives</h3></p><p><strong>9:15 AM</strong> â€” A health inspector arrives unannounced at the Downtown location.</p><p><strong>9:20 AM</strong> â€” The inspector asks: "Can I see your temperature logs for the past 90 days?"</p><p><strong>9:21 AM</strong> â€” Alex opens FreshTrack Pro on her tablet and:
<li>Goes to Reports</li>
<li>Selects "Compliance Report"</li>
<li>Sets date range to past 90 days</li>
<li>Clicks "Generate"</li></p><p><strong>9:22 AM</strong> â€” The report appears showing:
<li>âœ… 12,960 automatic temperature readings</li>
<li>âœ… 180 manual verification logs</li>
<li>âœ… 3 alerts (all acknowledged within 5 minutes)</li>
<li>âœ… 3 documented corrective actions</li>
<li>âœ… Zero gaps in monitoring</li></p><p><strong>9:25 AM</strong> â€” The inspector reviews the report. Everything is organized, timestamped, and complete.</p><p><strong>Inspector's Comment</strong>: "This is exactly what we want to see. Wish more restaurants had systems like this."</p><p><blockquote><strong>Outcome</strong>: What used to be a stressful scramble through paper logs is now a 2-minute report generation. Perfect records, every time.</blockquote></p><p>---</p><p><h2>Journey 5: Multi-Location Oversight</h2></p><p><h3>Weekly: Morgan Reviews All Sites</h3></p><p><strong>Monday 8:00 AM</strong> â€” Morgan, the Regional Director, opens FreshTrack Pro to review all 12 locations.</p><p><strong>The Regional Dashboard shows:</strong>
<li>ğŸŸ¢ 10 locations all green</li>
<li>ğŸŸ¡ 1 location with a warning (sensor battery low)</li>
<li>ğŸ”´ 1 location had a critical alert over the weekend (since resolved)</li></p><p><strong>8:05 AM</strong> â€” Morgan drills into the location that had the critical alert:
<li><strong>What happened</strong>: Freezer door was propped open for cleaning</li>
<li><strong>How long</strong>: 35 minutes</li>
<li><strong>Who responded</strong>: Kitchen manager acknowledged within 8 minutes</li>
<li><strong>Resolution</strong>: Door closed, temperature recovered, no product affected</li></p><p><strong>8:10 AM</strong> â€” Morgan sends a quick message to that location's manager reminding them about the door-propping policy.</p><p><strong>8:15 AM</strong> â€” Morgan generates a weekly summary report for the executive team showing:
<li>Total alerts across all locations: 7</li>
<li>Average response time: 6 minutes</li>
<li>Equipment issues requiring maintenance: 2</li>
<li>Compliance score: 99.2%</li></p><p><blockquote><strong>Outcome</strong>: Regional oversight that used to require site visits and phone calls now takes 15 minutes from anywhere.</blockquote></p><p>---</p><p><h2>Journey 6: Long-Term Insights</h2></p><p><h3>Quarterly: Alex Analyzes Trends</h3></p><p><strong>End of Quarter</strong> â€” Alex uses FreshTrack Pro to prepare for the quarterly operations review.</p><p><strong>Insights from the data:</strong></p><p>| Finding | Action |
|---------|--------|
| Unit 3 shows slowly rising baseline temperature | Schedule compressor inspection before failure |
| Friday evening has most door-open alerts | Adjust stocking schedule to reduce door time |
| Location B has 40% more alerts than others | Investigate â€” older equipment? Training issue? |
| Battery replacements needed Q2 | Order sensors now for proactive replacement |</p><p><strong>Alex's Report to Leadership:</strong>
<li>"We've prevented an estimated $45,000 in potential spoilage this quarter"</li>
<li>"Response time improved from 12 minutes to 6 minutes average"</li>
<li>"Zero compliance gaps identified"</li>
<li>"Recommending equipment upgrade at Location B"</li></p><p><blockquote><strong>Outcome</strong>: FreshTrack Pro data drives operational improvements and justifies equipment investments with hard numbers.</blockquote></p><p>---</p><p><h2>Summary: The FreshTrack Pro Difference</h2></p><p>| Before FreshTrack Pro | With FreshTrack Pro |
|----------------------|---------------------|
| Paper logs, clipboards, filing cabinets | Digital, searchable, always accessible |
| Problems discovered hours or days later | Alerts within minutes |
| Scrambling for records during inspections | Reports generated in seconds |
| No visibility across locations | Single dashboard for everything |
| Reactive maintenance after failures | Proactive insights prevent failures |
| Hope and luck | Confidence and control |</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#overview">Overview</a> â€” What FreshTrack Pro is</li>
<li><a href="#value_proposition">Value Proposition</a> â€” Why it matters</li>
<li><a href="#system_at_a_glance">System at a Glance</a> â€” How it works</li>
<li><a href="#faq">FAQ</a> â€” Common questions</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="executive-faq"></a></p><p><h1>FreshTrack Pro: Frequently Asked Questions</h1></p><p><blockquote>Answers to common executive and stakeholder questions</blockquote></p><p>---</p><p><h2>General Questions</h2></p><p><h3>What exactly is FreshTrack Pro?</h3></p><p>FreshTrack Pro is a cloud-based system that automatically monitors temperatures in commercial refrigerators, freezers, and cold storage. It uses wireless sensors to track conditions 24/7, sends alerts when problems occur, and maintains complete records for compliance purposes.</p><p><h3>Who is FreshTrack Pro designed for?</h3></p><p>FreshTrack Pro is built for any organization that needs to maintain strict temperature control:
<li>Restaurants and food service operations</li>
<li>Grocery stores and supermarkets</li>
<li>Healthcare facilities (vaccine storage, blood banks)</li>
<li>Food manufacturing and distribution</li>
<li>Hotels and hospitality</li>
<li>Schools and universities</li></p><p><h3>How is this different from a simple thermometer?</h3></p><p>A thermometer tells you the temperature right now. FreshTrack Pro:
<li>Monitors <strong>continuously</strong> (every 5 minutes, 24/7)</li>
<li><strong>Alerts you immediately</strong> when something goes wrong</li>
<li><strong>Keeps permanent records</strong> of all readings</li>
<li><strong>Escalates</strong> to managers if staff don't respond</li>
<li><strong>Generates reports</strong> for compliance and inspections</li></p><p>---</p><p><h2>Security & Data Protection</h2></p><p><h3>Is our data secure?</h3></p><p>Yes. FreshTrack Pro employs enterprise-grade security:</p><p>| Security Measure | Description |
|------------------|-------------|
| <strong>Encryption</strong> | All data encrypted in transit and at rest |
| <strong>Access Control</strong> | Role-based permissions â€” users only see what they need |
| <strong>Cloud Infrastructure</strong> | Hosted on enterprise-grade cloud platforms |
| <strong>Compliance</strong> | Designed to meet HACCP, FDA, and industry standards |
| <strong>Audit Logging</strong> | All access and changes are logged |</p><p><h3>Who can see our data?</h3></p><p>Only people you authorize. FreshTrack Pro uses role-based access:
<li><strong>Owners/Admins</strong> â€” Full access to all data and settings</li>
<li><strong>Managers</strong> â€” Access to their locations and reports</li>
<li><strong>Staff</strong> â€” Access to log temperatures and acknowledge alerts</li></p><p>No one outside your organization can see your data.</p><p><h3>Where is our data stored?</h3></p><p>Data is stored in secure cloud infrastructure with:
<li>Automatic backups</li>
<li>Geographic redundancy</li>
<li>99.9%+ uptime guarantee</li></p><p><h3>Can data be deleted?</h3></p><p>For compliance reasons, temperature data and audit logs are retained permanently and cannot be deleted. This ensures complete records for inspections and liability protection.</p><p>---</p><p><h2>Reliability & Uptime</h2></p><p><h3>What happens if the internet goes down?</h3></p><p><strong>Sensors continue to work.</strong> They store readings locally and sync when connectivity returns.</p><p><strong>Manual logging works offline.</strong> Staff can log temperatures on their phones even without internet â€” data syncs automatically when connection is restored.</p><p><strong>You'll know about outages.</strong> The system alerts you if a sensor stops communicating, so you can investigate.</p><p><h3>What is your uptime guarantee?</h3></p><p>FreshTrack Pro is designed for 99.9%+ availability. Our cloud infrastructure is:
<li>Distributed across multiple data centers</li>
<li>Automatically monitored 24/7</li>
<li>Designed with no single point of failure</li></p><p><h3>What if a sensor fails?</h3></p><p>Sensors are designed for years of reliable operation, but if one fails:
<li>You'll receive a "sensor offline" alert</li>
<li>Manual logging can cover the gap</li>
<li>Replacement sensors are available for quick swap</li></p><p>---</p><p><h2>Implementation & Deployment</h2></p><p><h3>How long does it take to get started?</h3></p><p>Most organizations are up and running in a single day:
<li><strong>Account setup</strong>: 10 minutes</li>
<li><strong>Location configuration</strong>: 15-30 minutes per site</li>
<li><strong>Sensor installation</strong>: 5-10 minutes per unit (just stick to wall)</li>
<li><strong>Staff training</strong>: 15-30 minutes</li></p><p><h3>Do we need to hire IT staff?</h3></p><p>No. FreshTrack Pro is fully managed:
<li>No servers to maintain</li>
<li>No software to install or update</li>
<li>No database administration required</li>
<li>Support available if you need help</li></p><p><h3>What equipment do we need?</h3></p><p><strong>From FreshTrack Pro:</strong>
<li>Wireless temperature sensors (included or purchased)</li>
<li>Gateway device to connect sensors to internet (1 per location)</li></p><p><strong>You provide:</strong>
<li>Internet connection at each location</li>
<li>Smartphones/tablets/computers for staff access</li></p><p><h3>Can we add more locations later?</h3></p><p>Yes. Adding a new location takes minutes:
<li>Create the location in the dashboard</li>
<li>Install sensors</li>
<li>Configure alert settings</li>
<li>Invite local staff</li></p><p>---</p><p><h2>Costs & Pricing</h2></p><p><h3>How much does FreshTrack Pro cost?</h3></p><p>| Plan | Monthly Cost | Sensors Included | Best For |
|------|--------------|------------------|----------|
| <strong>Starter</strong> | $29 | Up to 5 | Single small location |
| <strong>Pro</strong> | $79 | Up to 25 | Multi-unit locations |
| <strong>HACCP</strong> | $199 | Up to 100 | Compliance-focused operations |
| <strong>Enterprise</strong> | Custom | Unlimited | Large organizations |</p><p><em>Prices are per organization. Additional sensors available for purchase.</em></p><p><h3>Are there long-term contracts?</h3></p><p>No long-term contracts required. Service is month-to-month, cancel anytime.</p><p><h3>What's included in the subscription?</h3></p><p><li>Unlimited users</li>
<li>All software features and updates</li>
<li>Cloud storage for all data</li>
<li>Email and in-app notifications</li>
<li>Standard support</li></p><p><em>SMS alerts and advanced features available in Pro plan and above.</em></p><p><h3>What about hardware costs?</h3></p><p>Sensors can be:
<li><strong>Purchased outright</strong> â€” One-time cost, you own them</li>
<li><strong>Included in Enterprise plans</strong> â€” Talk to sales</li></p><p>Gateway devices are typically one-time purchases per location.</p><p>---</p><p><h2>Compliance & Reporting</h2></p><p><h3>Does FreshTrack Pro meet HACCP requirements?</h3></p><p>Yes. FreshTrack Pro provides:
<li>Continuous temperature monitoring</li>
<li>Automatic record-keeping with timestamps</li>
<li>Corrective action documentation</li>
<li>Audit-ready reports</li></p><p><h3>What about FDA requirements?</h3></p><p>FreshTrack Pro is designed to support FDA Food Safety Modernization Act (FSMA) compliance with:
<li>Complete temperature history</li>
<li>Traceability of all records</li>
<li>Evidence of monitoring and response</li></p><p><h3>Can we generate reports for inspectors?</h3></p><p>Yes. One-click reports include:
<li>Temperature logs for any time period</li>
<li>Alert history and response times</li>
<li>Corrective actions taken</li>
<li>Compliance summaries</li></p><p>Reports export as professional PDFs ready to share with inspectors.</p><p><h3>How long are records kept?</h3></p><p>All records are retained permanently:
<li>Temperature readings</li>
<li>Alert history</li>
<li>Corrective actions</li>
<li>Audit logs</li></p><p>This ensures complete compliance documentation for any past period.</p><p>---</p><p><h2>Support & Maintenance</h2></p><p><h3>What support is available?</h3></p><p>| Support Type | Availability |
|--------------|--------------|
| <strong>Help documentation</strong> | 24/7 online |
| <strong>Email support</strong> | Business hours, typically 24-hour response |
| <strong>Phone support</strong> | Available for Pro and above plans |
| <strong>Dedicated success manager</strong> | Enterprise plans |</p><p><h3>How are updates handled?</h3></p><p>FreshTrack Pro is cloud-based, so:
<li>Updates are automatic</li>
<li>No downtime required</li>
<li>You always have the latest features</li>
<li>No action needed from your team</li></p><p><h3>What if we have problems?</h3></p><p><li>Check the in-app help center</li>
<li>Email support team</li>
<li>For urgent issues, call the support line (Pro+ plans)</li></p><p>Enterprise customers have dedicated support contacts.</p><p>---</p><p><h2>Technical Questions (Non-Technical Answers)</h2></p><p><h3>How do the sensors communicate?</h3></p><p>Sensors use <strong>LoRa wireless technology</strong> â€” a long-range, low-power radio signal designed for sensors. Benefits:
<li>Works through walls and across large facilities</li>
<li>Battery life of 2+ years</li>
<li>No need for WiFi in each refrigerator</li></p><p><h3>Do sensors need WiFi?</h3></p><p>The sensors themselves don't use WiFi. They communicate with a small gateway device that does need an internet connection. One gateway typically covers an entire location.</p><p><h3>Can this work with our existing thermometers?</h3></p><p>FreshTrack Pro uses its own sensors for automated monitoring. However:
<li>Staff can log readings from any thermometer manually</li>
<li>Existing sensors can sometimes be integrated (ask sales)</li></p><p><h3>Does it work with our POS or inventory system?</h3></p><p>Standard FreshTrack Pro operates independently. Enterprise customers can discuss integration options with our team.</p><p>---</p><p><h2>Competitive Questions</h2></p><p><h3>Why FreshTrack Pro over alternatives?</h3></p><p>| Feature | FreshTrack Pro | Traditional Solutions |
|---------|----------------|----------------------|
| Multi-location dashboard | âœ… Built-in | Often extra cost |
| Escalating alerts | âœ… Automatic | Usually manual |
| Offline capability | âœ… Yes | Rarely |
| Modern interface | âœ… Mobile-first | Often dated |
| HACCP reports | âœ… One-click | Manual work |
| No servers needed | âœ… Cloud-native | Often on-premise |</p><p><h3>Can I try before I buy?</h3></p><p>Yes. We offer a 14-day free trial with full functionality. No credit card required to start.</p><p>---</p><p><h2>Getting Started</h2></p><p><h3>How do I sign up?</h3></p><p><li>Visit our website</li>
<li>Click "Start Free Trial"</li>
<li>Create your account</li>
<li>Follow the setup wizard</li></p><p><h3>Can I see a demo first?</h3></p><p>Absolutely. Contact our sales team for a personalized demo showing FreshTrack Pro with your specific use cases.</p><p><h3>Who should I contact for enterprise needs?</h3></p><p>For organizations with 10+ locations or specialized requirements, contact our enterprise sales team for a customized solution and pricing.</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#overview">Overview</a> â€” What FreshTrack Pro is</li>
<li><a href="#value_proposition">Value Proposition</a> â€” Why it matters</li>
<li><a href="#system_at_a_glance">System at a Glance</a> â€” How it works</li>
<li><a href="#user_journeys">User Journeys</a> â€” Day in the life</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="architecture-architecture"></a></p><p><h1>FreshTrack Pro System Architecture</h1></p><p><blockquote>Complete system architecture documentation</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#frontend-architecture">Frontend Architecture</a></li>
<li><a href="#backend-architecture">Backend Architecture</a></li>
<li><a href="#database-architecture">Database Architecture</a></li>
<li><a href="#authentication--authorization">Authentication & Authorization</a></li>
<li><a href="#third-party-integrations">Third-Party Integrations</a></li>
<li><a href="#environment-separation">Environment Separation</a></li>
<li><a href="#security-boundaries">Security Boundaries</a></li>
<li><a href="#diagrams">Diagrams</a></li></p><p>---</p><p><h2>Architecture Overview</h2></p><p>FreshTrack Pro follows a modern Jamstack architecture with:
<li><strong>React SPA</strong> for the frontend</li>
<li><strong>Supabase</strong> for backend (PostgreSQL + Edge Functions + Auth)</li>
<li><strong>Event-driven processing</strong> for sensor data and alerts</li>
<li><strong>Multi-tenant isolation</strong> via Row-Level Security</li></p><p><h3>Architectural Principles</h3></p><p><li><strong>Single Source of Truth (SSOT)</strong></li>
   - <code>process-unit-states</code> is the only service that creates/resolves alerts
   - <code>process-escalations</code> is the only service that sends notifications
   - <code>get_effective_alert_rules</code> RPC resolves the cascade logic</p><p><li><strong>Event-Driven Processing</strong></li>
   - Sensor data triggers state evaluation
   - State changes trigger notifications
   - All actions are logged for audit</p><p><li><strong>Hierarchical Configuration</strong></li>
   - Settings cascade: Organization â†’ Site â†’ Area â†’ Unit
   - Lower levels override higher levels</p><p><li><strong>Offline-First for Critical Operations</strong></li>
   - Manual temperature logging works offline
   - IndexedDB for local storage with sync</p><p>---</p><p><h2>Frontend Architecture</h2></p><p><h3>Technology Stack</h3></p><p>| Layer | Technology | Purpose |
|-------|------------|---------|
| Framework | React 18.3.1 | UI components and state |
| Routing | React Router 6.30.1 | Client-side navigation |
| State | TanStack Query 5.83.0 | Server state management |
| Forms | React Hook Form + Zod | Form handling and validation |
| Styling | Tailwind CSS 3.4.17 | Utility-first CSS |
| Components | shadcn/ui (Radix) | Accessible component library |
| Build | Vite 5.4.19 | Fast development and bundling |</p><p><h3>Component Architecture</h3></p><p><pre><code class="">src/
â”œâ”€â”€ pages/              # Route-level components (23 pages)
â”‚   â”œâ”€â”€ Dashboard.tsx   # Main monitoring view
â”‚   â”œâ”€â”€ Settings.tsx    # Multi-tab configuration
â”‚   â””â”€â”€ ...
â”œâ”€â”€ components/         # Reusable components (112+ files)
â”‚   â”œâ”€â”€ ui/             # shadcn base components (43)
â”‚   â”œâ”€â”€ settings/       # Settings panels
â”‚   â”œâ”€â”€ unit/           # Unit monitoring
â”‚   â”œâ”€â”€ alerts/         # Alert display
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hooks/              # Custom React hooks (25)
â”‚   â”œâ”€â”€ useUnitStatus.ts
â”‚   â”œâ”€â”€ useAlertRules.ts
â”‚   â””â”€â”€ ...
â”œâ”€â”€ lib/                # Utilities and config
â”‚   â”œâ”€â”€ alertConfig.ts
â”‚   â”œâ”€â”€ statusConfig.ts
â”‚   â””â”€â”€ ...
â”œâ”€â”€ contexts/           # React contexts
â”‚   â”œâ”€â”€ DebugContext.tsx
â”‚   â””â”€â”€ TTNConfigContext.tsx
â””â”€â”€ integrations/       # External service clients
    â””â”€â”€ supabase/
</code></pre></p><p><h3>State Management Pattern</h3></p><p><pre><code class="mermaid">graph LR
    A[Server State] -->|TanStack Query| B[React Components]
    C[Form State] -->|React Hook Form| B
    D[URL State] -->|React Router| B
    E[Theme State] -->|next-themes| B
    F[Debug State] -->|React Context| B
</code></pre></p><p><h3>Key Patterns</h3></p><p><li><strong>Query Keys</strong>: Structured for cache invalidation</li>
   <pre><code class="typescript">   ['units', unitId]
   ['alerts', { organizationId, status: 'active' }]
   ['alert-rules', { unitId }]
   </code></pre></p><p><li><strong>Component Composition</strong>: Use shadcn components as building blocks</li>
<li><strong>Config Objects</strong>: Centralized status/alert configuration in <code>lib/</code></li></p><p>---</p><p><h2>Backend Architecture</h2></p><p><h3>Edge Functions Overview</h3></p><p>The backend consists of 33 Deno-based edge functions organized by purpose:</p><p>#### Data Ingestion (3 functions)
| Function | Purpose | Trigger |
|----------|---------|---------|
| <code>ttn-webhook</code> | Receive TTN uplink messages | HTTP POST from TTN |
| <code>ingest-readings</code> | Generic sensor data ingestion | HTTP POST |
| <code>sensor-simulator</code> | Generate test data | HTTP POST |</p><p>#### Alert Processing (2 functions)
| Function | Purpose | Trigger |
|----------|---------|---------|
| <code>process-unit-states</code> | Evaluate unit states, create/resolve alerts | Called after ingestion |
| <code>process-escalations</code> | Send notifications per policy | Called after state changes |</p><p>#### TTN Management (12 functions)
| Function | Purpose |
|----------|---------|
| <code>ttn-bootstrap</code> | Auto-configure webhooks |
| <code>ttn-manage-application</code> | Create/update TTN apps |
| <code>ttn-provision-device</code> | Register sensors with TTN |
| <code>ttn-provision-gateway</code> | Register gateways with TTN |
| <code>ttn-provision-org</code> | Provision org in TTN |
| <code>ttn-provision-worker</code> | Background provisioning |
| <code>ttn-list-devices</code> | List TTN devices |
| <code>ttn-gateway-preflight</code> | Validate gateway permissions |
| <code>ttn-deprovision-worker</code> | Cleanup deprovisioned devices |
| <code>update-ttn-webhook</code> | Update webhook config |
| <code>manage-ttn-settings</code> | TTN settings CRUD |
| <code>sync-ttn-settings</code> | Sync from emulator |</p><p>#### User & Data Management (6 functions)
| Function | Purpose |
|----------|---------|
| <code>user-sync-emitter</code> | User sync events |
| <code>cleanup-user-sensors</code> | User data cleanup |
| <code>update-sensor-assignment</code> | Sensor assignment |
| <code>account-deletion-jobs</code> | GDPR deletion |
| <code>export-temperature-logs</code> | Compliance data export |
| <code>check-password-breach</code> | Password security |</p><p>#### Billing (3 functions)
| Function | Purpose |
|----------|---------|
| <code>stripe-checkout</code> | Create checkout sessions |
| <code>stripe-portal</code> | Customer portal access |
| <code>stripe-webhook</code> | Handle Stripe events |</p><p>#### Utilities (7 functions)
| Function | Purpose |
|----------|---------|
| <code>health-check</code> | System health monitoring |
| <code>check-slug-available</code> | Org slug validation |
| <code>send-sms-alert</code> | Twilio SMS delivery |
| <code>org-state-api</code> | Pull-based state API |
| <code>fetch-org-state</code> | Org TTN state |
| <code>emulator-sync</code> | Emulator integration |
| <code>run-simulator-heartbeats</code> | Simulated heartbeats |</p><p><h3>Data Processing Pipeline</h3></p><p><pre><code class="mermaid">graph TD
    A[Sensor] -->|LoRa| B[TTN]
    B -->|Webhook| C[ttn-webhook]
    D[Simulator] --> E[sensor-simulator]
    F[Manual Entry] --> G[Frontend]</p><p>    C --> H[sensor_readings]
    E --> H
    G --> I[manual_temperature_logs]</p><p>    H --> J[ingest-readings]
    J --> K[process-unit-states]
    K --> L[alerts table]
    K --> M[unit status update]
    L --> N[process-escalations]
    N --> O[Email/SMS/Push]
</code></pre></p><p><h3>Function Security</h3></p><p>| Security Level | Functions | Auth Method |
|----------------|-----------|-------------|
| Public | Health check endpoints | None |
| User Auth | Most API endpoints | JWT (Supabase Auth) |
| Internal Only | process-unit-states, process-escalations | INTERNAL_API_KEY header |
| Webhook | ttn-webhook, stripe-webhook | Webhook secret |</p><p>---</p><p><h2>Database Architecture</h2></p><p><h3>PostgreSQL 14.1 on Supabase</h3></p><p>The database contains 60+ tables organized by domain:</p><p>#### Hierarchy Tables
<pre><code class="">organizations
    â””â”€â”€ sites
        â””â”€â”€ areas
            â””â”€â”€ units
</code></pre></p><p>#### Core Tables by Domain</p><p>| Domain | Tables |
|--------|--------|
| Hierarchy | organizations, sites, areas, units |
| Sensors | lora_sensors, gateways, devices (legacy), sensor_readings |
| Alerts | alerts, alert_rules, alert_rules_history |
| Notifications | notification_policies, notification_events, escalation_contacts |
| Compliance | corrective_actions, calibration_records, event_logs |
| TTN | ttn_connections, ttn_provisioning_queue, ttn_provisioning_logs |
| Users | profiles, user_roles, user_sync_log |
| Billing | subscriptions, invoices |</p><p><h3>Row-Level Security (RLS)</h3></p><p>All tables enforce RLS policies based on:
<li>User's organization membership (<code>user_roles</code>)</li>
<li>Data ownership chain (units â†’ areas â†’ sites â†’ organizations)</li></p><p>Example policy pattern:
<pre><code class="sql">-- Users can only see units in their organization
CREATE POLICY "Users can view org units" ON units
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN sites s ON s.organization_id = ur.organization_id
      JOIN areas a ON a.site_id = s.id
      WHERE a.id = units.area_id
      AND ur.user_id = auth.uid()
    )
  );
</code></pre></p><p><h3>Key RPC Functions</h3></p><p>| Function | Purpose |
|----------|---------|
| <code>get_effective_alert_rules(p_unit_id)</code> | Resolve cascaded alert rules |
| <code>get_effective_notification_policy(...)</code> | Resolve cascaded notification policy |
| <code>create_organization_with_owner(...)</code> | Atomic org creation |
| <code>user_belongs_to_org(...)</code> | Access check |
| <code>has_role(...)</code> | Role authorization |
| <code>enqueue_deprovision_jobs_for_unit(...)</code> | TTN cleanup queue |</p><p>---</p><p><h2>Authentication & Authorization</h2></p><p><h3>Authentication Flow</h3></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant A as Auth Page
    participant S as Supabase Auth
    participant D as Database</p><p>    U->>A: Email/Password
    A->>S: signInWithPassword()
    S->>S: Validate credentials
    S->>D: Create session
    D-->>S: Session token
    S-->>A: JWT + Refresh token
    A->>U: Redirect to /dashboard
</code></pre></p><p><h3>Session Management</h3>
<li>JWT tokens via Supabase Auth</li>
<li>Automatic token refresh</li>
<li>Session stored in localStorage</li></p><p><h3>Authorization Model</h3></p><p>| Role | Capabilities |
|------|--------------|
| <code>owner</code> | Full org control, billing, user management |
| <code>manager</code> | Settings, alerts, reports |
| <code>operator</code> | Manual logging, alert acknowledgment |
| <code>viewer</code> | Read-only dashboard access |</p><p><h3>Permission Checks</h3></p><p><pre><code class="typescript">// Frontend hook
const { hasRole } = useUserRole();
if (hasRole('manager')) { /<em> show settings </em>/ }</p><p>// Backend RPC
SELECT has_role(auth.uid(), 'manager', org_id);
</code></pre></p><p>---</p><p><h2>Third-Party Integrations</h2></p><p><h3>The Things Network (TTN)</h3></p><p><strong>Purpose</strong>: LoRa sensor network connectivity</p><p><strong>Architecture</strong>:
<li>Per-organization TTN Application</li>
<li>Webhook-based uplink reception</li>
<li>Device provisioning via TTN API</li></p><p><strong>Data Flow</strong>:
<pre><code class="">Sensor â†’ LoRa Gateway â†’ TTN â†’ ttn-webhook â†’ Database
</code></pre></p><p><strong>Configuration</strong>: Stored in <code>ttn_connections</code> table per organization</p><p><h3>Stripe</h3></p><p><strong>Purpose</strong>: Subscription billing</p><p><strong>Architecture</strong>:
<li>Checkout sessions for new subscriptions</li>
<li>Customer portal for management</li>
<li>Webhook for event processing</li></p><p><strong>Plans</strong>:
| Plan | Price | Sensors | Features |
|------|-------|---------|----------|
| Starter | $29/mo | 5 | Basic monitoring |
| Pro | $79/mo | 25 | SMS alerts |
| HACCP | $199/mo | 100 | Compliance reports |
| Enterprise | Custom | Unlimited | Custom features |</p><p><h3>Twilio</h3></p><p><strong>Purpose</strong>: SMS alert delivery</p><p><strong>Usage</strong>: Called by <code>process-escalations</code> for critical alerts</p><p>---</p><p><h2>Environment Separation</h2></p><p><h3>Environments</h3></p><p>| Environment | Purpose | Database | Edge Functions |
|-------------|---------|----------|----------------|
| Local | Development | Local Supabase | <code>supabase functions serve</code> |
| Staging | Testing | Staging project | Deployed |
| Production | Live users | Production project | Deployed |</p><p><h3>Environment Variables</h3></p><p><strong>Frontend (Vite)</strong>:
<pre><code class="env">VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbG...
VITE_SUPABASE_PROJECT_ID=xxx
</code></pre></p><p><strong>Edge Functions</strong>:
<pre><code class="env">SUPABASE_URL=<auto-injected>
SUPABASE_SERVICE_ROLE_KEY=<auto-injected>
INTERNAL_API_KEY=<secret>
TTN_API_KEY=<per-org in database>
STRIPE_SECRET_KEY=<secret>
STRIPE_WEBHOOK_SECRET=<secret>
TWILIO_ACCOUNT_SID=<secret>
TWILIO_AUTH_TOKEN=<secret>
</code></pre></p><p><h3>Configuration Management</h3></p><p><li><strong>supabase/config.toml</strong>: Edge function settings</li>
<li><strong>Database</strong>: Organization-specific settings (TTN credentials)</li>
<li><strong>Secrets</strong>: Managed via Supabase dashboard</li></p><p>---</p><p><h2>Security Boundaries</h2></p><p><h3>Network Security</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Public Internet"
        U[Users]
        TTN[TTN Cloud]
        S[Stripe]
    end</p><p>    subgraph "Supabase Edge"
        EF[Edge Functions]
        GW[API Gateway]
    end</p><p>    subgraph "Supabase Core"
        AUTH[Auth]
        DB[(PostgreSQL)]
        ST[Storage]
    end</p><p>    U --> GW
    TTN --> EF
    S --> EF
    GW --> AUTH
    GW --> DB
    EF --> DB
</code></pre></p><p><h3>Data Security</h3></p><p>| Data Type | Protection |
|-----------|------------|
| User passwords | Bcrypt hash (Supabase Auth) |
| TTN API keys | Encrypted at rest in database |
| Webhook secrets | Hashed for comparison |
| Session tokens | JWT with expiration |
| Sensitive logs | Masked before logging |</p><p><h3>Input Validation</h3></p><p><li><strong>Frontend</strong>: Zod schemas in <code>lib/validation.ts</code></li>
<li><strong>Backend</strong>: Zod validation in edge functions</li>
<li><strong>Database</strong>: CHECK constraints and triggers</li></p><p><h3>Security Best Practices</h3></p><p><li><strong>Never expose service role key</strong> to frontend</li>
<li><strong>Use RLS</strong> for all data access</li>
<li><strong>Validate internal API keys</strong> for scheduled functions</li>
<li><strong>Constant-time comparison</strong> for webhook secrets</li>
<li><strong>Log without sensitive data</strong> (mask phone numbers, keys)</li></p><p>---</p><p><h2>Diagrams</h2></p><p><h3>System Context Diagram</h3></p><p>See: <a href="#diagrams-system_context">SYSTEM_CONTEXT.md</a></p><p><h3>Container Diagram</h3></p><p>See: <a href="#diagrams-container_diagram">CONTAINER_DIAGRAM.md</a></p><p><h3>C4 Context (Embedded)</h3></p><p><pre><code class="mermaid">C4Context
    title System Context Diagram - FreshTrack Pro</p><p>    Person(user, "Food Safety User", "Monitors refrigeration units")
    Person(admin, "IT Administrator", "Configures sensors and TTN")</p><p>    System(freshtrack, "FreshTrack Pro", "Refrigeration monitoring platform")</p><p>    System_Ext(ttn, "The Things Network", "LoRa network infrastructure")
    System_Ext(stripe, "Stripe", "Payment processing")
    System_Ext(twilio, "Twilio", "SMS delivery")
    System_Ext(email, "Email Service", "Supabase built-in")</p><p>    Rel(user, freshtrack, "Uses", "HTTPS")
    Rel(admin, freshtrack, "Configures", "HTTPS")
    Rel(freshtrack, ttn, "Receives sensor data", "Webhook")
    Rel(freshtrack, stripe, "Processes payments", "API")
    Rel(freshtrack, twilio, "Sends SMS", "API")
    Rel(freshtrack, email, "Sends email", "SMTP")
</code></pre></p><p><h3>Container Diagram (Embedded)</h3></p><p><pre><code class="mermaid">C4Container
    title Container Diagram - FreshTrack Pro</p><p>    Person(user, "User", "")</p><p>    Container(spa, "React SPA", "React, TypeScript", "Single-page application")
    Container(edge, "Edge Functions", "Deno", "Serverless backend")
    ContainerDb(db, "PostgreSQL", "Supabase", "Primary database")
    Container(auth, "Auth Service", "Supabase Auth", "User authentication")</p><p>    System_Ext(ttn, "TTN", "")
    System_Ext(stripe, "Stripe", "")
    System_Ext(twilio, "Twilio", "")</p><p>    Rel(user, spa, "Uses", "HTTPS")
    Rel(spa, edge, "API calls", "HTTPS")
    Rel(spa, db, "Direct queries", "Supabase JS")
    Rel(spa, auth, "Auth", "Supabase JS")
    Rel(edge, db, "Queries", "Service Role")
    Rel(ttn, edge, "Webhooks", "HTTPS")
    Rel(stripe, edge, "Webhooks", "HTTPS")
    Rel(edge, twilio, "SMS", "API")
</code></pre></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#engineering-data_model">DATA_MODEL.md</a> - Database schema details</li>
<li><a href="#engineering-api">API.md</a> - Edge function documentation</li>
<li><a href="#engineering-integrations">INTEGRATIONS.md</a> - Third-party integration guides</li>
<li><a href="#engineering-observability">OBSERVABILITY.md</a> - Logging and monitoring</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="product-pages"></a></p><p><h1>FreshTrack Pro Pages Documentation</h1></p><p><blockquote>Comprehensive documentation for all routes, pages, and UI components</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#route-overview">Route Overview</a></li>
<li><a href="#public-pages">Public Pages</a></li>
<li><a href="#authentication-pages">Authentication Pages</a></li>
<li><a href="#core-application-pages">Core Application Pages</a></li>
<li><a href="#admin-pages">Admin Pages</a></li>
<li><a href="#utility-pages">Utility Pages</a></li></p><p>---</p><p><h2>Route Overview</h2></p><p>| Route | Page Component | Purpose | Auth Required |
|-------|----------------|---------|---------------|
| <code>/</code> | <code>Index.tsx</code> | Landing page | No |
| <code>/auth</code> | <code>Auth.tsx</code> | Sign in/Sign up | No |
| <code>/auth/callback</code> | <code>AuthCallback.tsx</code> | OAuth callback | No |
| <code>/dashboard</code> | <code>Dashboard.tsx</code> | Main monitoring view | Yes |
| <code>/organization</code> | <code>OrganizationDashboard.tsx</code> | Organization overview | Yes |
| <code>/onboarding</code> | <code>Onboarding.tsx</code> | Initial setup flow | Yes |
| <code>/sites</code> | <code>Sites.tsx</code> | Site listing | Yes |
| <code>/sites/:siteId</code> | <code>SiteDetail.tsx</code> | Site details | Yes |
| <code>/sites/:siteId/areas/:areaId</code> | <code>AreaDetail.tsx</code> | Area details | Yes |
| <code>/units/:unitId</code> | <code>UnitDetail.tsx</code> | Unit monitoring | Yes |
| <code>/manual-log</code> | <code>ManualLog.tsx</code> | Manual temperature entry | Yes |
| <code>/alerts</code> | <code>Alerts.tsx</code> | Alert management | Yes |
| <code>/reports</code> | <code>Reports.tsx</code> | Compliance reports | Yes |
| <code>/settings</code> | <code>Settings.tsx</code> | Multi-tab settings | Yes |
| <code>/inspector</code> | <code>Inspector.tsx</code> | Debug inspection | Yes |
| <code>/pilot-setup</code> | <code>PilotSetup.tsx</code> | Pilot program setup | Yes |
| <code>/events</code> | <code>EventHistory.tsx</code> | Audit event log | Yes |
| <code>/admin/recently-deleted</code> | <code>RecentlyDeleted.tsx</code> | Soft-deleted items | Yes |
| <code>/admin/ttn-cleanup</code> | <code>TTNCleanup.tsx</code> | TTN management | Yes |
| <code>/admin/data-maintenance</code> | <code>DataMaintenance.tsx</code> | Database maintenance | Yes |
| <code>/admin/health</code> | <code>HealthDashboard.tsx</code> | System health | Yes |
| <code>/account-deleted</code> | <code>AccountDeleted.tsx</code> | Deletion confirmation | No |
| <code><em></code> | <code>NotFound.tsx</code> | 404 handler | No |</p><p>---</p><p><h2>Public Pages</h2></p><p><h3>Landing Page (<code>/</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Index.tsx</code></p><p><strong>Purpose</strong>: Marketing landing page for unauthenticated users, redirects authenticated users to dashboard.</p><p><strong>Layout</strong>:
<li>Hero section with value proposition</li>
<li>Feature highlights</li>
<li>Pricing information</li>
<li>Call-to-action buttons</li></p><p><strong>State Machine</strong>:
<pre><code class="">[Loading] â†’ (check auth)
   â”œâ”€ authenticated â†’ [Redirect to /dashboard]
   â””â”€ unauthenticated â†’ [Render Landing]
</code></pre></p><p><strong>API Calls</strong>:
<li><code>supabase.auth.getSession()</code> - Check authentication status</li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#landing-page">Landing Page Diagram</a></p><p>---</p><p><h2>Authentication Pages</h2></p><p><h3>Auth Page (<code>/auth</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Auth.tsx</code></p><p><strong>Purpose</strong>: User authentication (sign in and sign up).</p><p><strong>Layout</strong>:
<li>Tabbed interface: Sign In / Sign Up</li>
<li>Email/password form</li>
<li>Social auth options (if configured)</li>
<li>Password requirements display</li></p><p><strong>Preconditions</strong>: User is not authenticated</p><p><strong>State Machine</strong>:
<pre><code class="">[Idle] â†’ (submit form)
   â†’ [Submitting] â†’ (success)
      â”œâ”€ sign in â†’ [Redirect to /dashboard]
      â””â”€ sign up â†’ [Redirect to /onboarding]
   â†’ [Error] â†’ (retry) â†’ [Idle]
</code></pre></p><p><strong>Data Dependencies</strong>:
<li>None (creates new session)</li></p><p><strong>API Calls</strong>:
<li><code>supabase.auth.signInWithPassword()</code> - Sign in</li>
<li><code>supabase.auth.signUp()</code> - Sign up</li>
<li><code>supabase.functions.invoke('check-password-breach')</code> - Password validation</li></p><p><strong>Error States</strong>:
<li>Invalid credentials</li>
<li>Email already registered</li>
<li>Password requirements not met</li>
<li>Network error</li></p><p><strong>Files Involved</strong>:
<li><code>src/pages/Auth.tsx</code></li>
<li><code>src/hooks/useAuthAndOnboarding.ts</code></li>
<li><code>src/lib/validation.ts</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#auth-page">Auth Page Diagram</a></p><p>---</p><p><h3>Auth Callback (<code>/auth/callback</code>)</h3></p><p><strong>File</strong>: <code>src/pages/AuthCallback.tsx</code></p><p><strong>Purpose</strong>: Handle OAuth callback and magic link authentication.</p><p><strong>State Machine</strong>:
<pre><code class="">[Processing] â†’ (validate token)
   â”œâ”€ valid â†’ [Redirect to /dashboard or /onboarding]
   â””â”€ invalid â†’ [Redirect to /auth with error]
</code></pre></p><p>---</p><p><h2>Core Application Pages</h2></p><p><h3>Dashboard (<code>/dashboard</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Dashboard.tsx</code></p><p><strong>Purpose</strong>: Main monitoring view showing all units across all sites with their status.</p><p><strong>Layout</strong>:
| Section | Content |
|---------|---------|
| Header | Organization name, notification dropdown, theme toggle |
| Sidebar | Navigation links (Sites, Alerts, Reports, Settings) |
| Main | Unit cards grouped by site/area |
| Widgets | Low battery alerts, offline sensors |</p><p><strong>Preconditions</strong>:
<li>User authenticated</li>
<li>User belongs to an organization</li>
<li>Organization has completed onboarding</li></p><p><strong>State Machine</strong>:
<pre><code class="">[Loading] â†’ (fetch data)
   â”œâ”€ success â†’ [Ready]
   â”œâ”€ no org â†’ [Redirect to /onboarding]
   â””â”€ error â†’ [Error State]</p><p>[Ready] â†’ (unit status changes) â†’ [Ready]
       â†’ (refresh) â†’ [Loading]
</code></pre></p><p><strong>Data Dependencies</strong>:
| Data | Source | Query Key |
|------|--------|-----------|
| Organization | <code>organizations</code> | <code>['organization', orgId]</code> |
| Sites | <code>sites</code> | <code>['sites', { organizationId }]</code> |
| Areas | <code>areas</code> | <code>['areas', { siteId }]</code> |
| Units | <code>units</code> | <code>['units', { organizationId }]</code> |
| Active Alerts | <code>alerts</code> | <code>['alerts', { status: 'active' }]</code> |
| Sensors | <code>lora_sensors</code> | <code>['lora-sensors', { organizationId }]</code> |</p><p><strong>API Calls</strong>:
<li>Supabase direct queries via TanStack Query</li>
<li>Real-time subscriptions for unit status updates</li></p><p><strong>Actions</strong>:
| Action | Description | Side Effects |
|--------|-------------|--------------|
| Navigate to unit | Click unit card | Route to <code>/units/:unitId</code> |
| Quick log temp | "Log Temp" button | Opens <code>LogTempModal</code> |
| Acknowledge alert | Click acknowledge | Updates alert status |</p><p><strong>Error States</strong>:
<li>Failed to load organization</li>
<li>Failed to load units</li>
<li>No units configured</li></p><p><strong>Recovery</strong>:
<li>Retry button for failed queries</li>
<li>Link to Settings for configuration</li></p><p><strong>Files Involved</strong>:
<li><code>src/pages/Dashboard.tsx</code></li>
<li><code>src/components/DashboardLayout.tsx</code></li>
<li><code>src/components/dashboard/LowBatteryWidget.tsx</code></li>
<li><code>src/hooks/useUnitStatus.ts</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#dashboard">Dashboard Diagram</a></p><p>---</p><p><h3>Organization Dashboard (<code>/organization</code>)</h3></p><p><strong>File</strong>: <code>src/pages/OrganizationDashboard.tsx</code></p><p><strong>Purpose</strong>: High-level organization overview with aggregated statistics.</p><p><strong>Layout</strong>:
<li>Organization header with branding</li>
<li>Summary statistics (total units, active alerts, compliance score)</li>
<li>Site overview cards</li>
<li>Quick actions</li></p><p><strong>Data Dependencies</strong>:
<li>Organization details</li>
<li>Site summaries</li>
<li>Alert counts</li>
<li>Compliance metrics</li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#organization-dashboard">Organization Dashboard Diagram</a></p><p>---</p><p><h3>Onboarding (<code>/onboarding</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Onboarding.tsx</code></p><p><strong>Purpose</strong>: Guide new users through initial organization setup.</p><p><strong>Layout</strong>:
<li>Step-by-step wizard</li>
<li>Progress indicator</li>
<li>Form sections for each step</li></p><p><strong>Steps</strong>:
<li>Organization details (name, slug)</li>
<li>First site creation</li>
<li>First area creation</li>
<li>First unit creation</li>
<li>Sensor setup (optional)</li></p><p><strong>State Machine</strong>:
<pre><code class="">[Step 1: Org] â†’ (submit) â†’ [Step 2: Site]
                         â†’ [Step 3: Area]
                         â†’ [Step 4: Unit]
                         â†’ [Step 5: Sensor]
                         â†’ [Complete] â†’ [Redirect to /dashboard]
</code></pre></p><p><strong>API Calls</strong>:
<li><code>create_organization_with_owner()</code> RPC</li>
<li><code>create_site_for_org()</code> RPC</li>
<li><code>create_area_for_site()</code> RPC</li>
<li><code>create_unit_for_area()</code> RPC</li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#onboarding">Onboarding Diagram</a></p><p>---</p><p><h3>Sites List (<code>/sites</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Sites.tsx</code></p><p><strong>Purpose</strong>: List all sites in the organization.</p><p><strong>Layout</strong>:
<li>Site cards with address and status summary</li>
<li>Add site button</li>
<li>Filter/search options</li></p><p><strong>Data Dependencies</strong>:
<li><code>sites</code> table</li>
<li>Unit counts per site</li>
<li>Alert counts per site</li></p><p><strong>Actions</strong>:
<li>Navigate to site detail</li>
<li>Create new site</li>
<li>Edit site</li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#sites">Sites Page Diagram</a></p><p>---</p><p><h3>Site Detail (<code>/sites/:siteId</code>)</h3></p><p><strong>File</strong>: <code>src/pages/SiteDetail.tsx</code></p><p><strong>Purpose</strong>: Detailed view of a single site with its areas and units.</p><p><strong>URL Parameters</strong>: <code>siteId</code> (UUID)</p><p><strong>Layout</strong>:
| Section | Content |
|---------|---------|
| Header | Site name, address, breadcrumb |
| Areas List | Collapsible area sections |
| Units Grid | Unit cards within each area |
| Gateways | Site gateway status |
| Settings | Site-level configuration |</p><p><strong>Data Dependencies</strong>:
<li>Site details</li>
<li>Areas within site</li>
<li>Units within areas</li>
<li>Gateway status</li></p><p><strong>Actions</strong>:
<li>Add area</li>
<li>Add unit</li>
<li>Configure site settings</li>
<li>Manage gateways</li></p><p><strong>Files Involved</strong>:
<li><code>src/pages/SiteDetail.tsx</code></li>
<li><code>src/components/site/SiteComplianceSettings.tsx</code></li>
<li><code>src/components/site/SiteGatewaysCard.tsx</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#site-detail">Site Detail Diagram</a></p><p>---</p><p><h3>Area Detail (<code>/sites/:siteId/areas/:areaId</code>)</h3></p><p><strong>File</strong>: <code>src/pages/AreaDetail.tsx</code></p><p><strong>Purpose</strong>: Detailed view of a single area with its units.</p><p><strong>URL Parameters</strong>: <code>siteId</code>, <code>areaId</code> (UUIDs)</p><p><strong>Layout</strong>:
<li>Breadcrumb navigation</li>
<li>Unit cards</li>
<li>Area settings</li>
<li>Add unit button</li></p><p><strong>Data Dependencies</strong>:
<li>Area details</li>
<li>Units in area</li>
<li>Site (for breadcrumb)</li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#area-detail">Area Detail Diagram</a></p><p>---</p><p><h3>Unit Detail (<code>/units/:unitId</code>)</h3></p><p><strong>File</strong>: <code>src/pages/UnitDetail.tsx</code></p><p><strong>Purpose</strong>: Comprehensive view of a refrigeration unit with temperature history, alerts, and settings.</p><p><strong>URL Parameters</strong>: <code>unitId</code> (UUID)</p><p><strong>Layout</strong>:
| Section | Component |
|---------|-----------|
| Header | Unit name, status badge, breadcrumb |
| Current Status | Temperature, last reading time, status indicator |
| Alert Banner | Active alerts with acknowledge/resolve actions |
| Temperature Chart | Historical temperature graph |
| Sensors | Assigned sensors with battery/signal status |
| Settings | Temperature thresholds, manual log settings |
| History | Recent readings and events |</p><p><strong>Preconditions</strong>:
<li>Unit exists and is accessible to user</li></p><p><strong>State Machine</strong>:
<pre><code class="">[Loading] â†’ (fetch)
   â”œâ”€ success â†’ [Ready]
   â”‚     â”œâ”€ has alerts â†’ [Show Alert Banner]
   â”‚     â”œâ”€ temp in range â†’ [Normal Display]
   â”‚     â””â”€ temp out of range â†’ [Warning Display]
   â””â”€ not found â†’ [404]</p><p>[Ready] â†’ (new reading) â†’ [Update Display]
       â†’ (alert change) â†’ [Update Banner]
       â†’ (settings change) â†’ [Refresh]
</code></pre></p><p><strong>Data Dependencies</strong>:
| Data | Source | Query Key |
|------|--------|-----------|
| Unit | <code>units</code> | <code>['units', unitId]</code> |
| Sensors | <code>lora_sensors</code> | <code>['lora-sensors', { unitId }]</code> |
| Readings | <code>sensor_readings</code> | <code>['sensor-readings', { unitId }]</code> |
| Alerts | <code>alerts</code> | <code>['alerts', { unitId }]</code> |
| Alert Rules | <code>alert_rules</code> RPC | <code>['alert-rules', { unitId }]</code> |</p><p><strong>API Calls</strong>:
<li><code>get_effective_alert_rules()</code> RPC</li>
<li>Direct table queries via Supabase</li></p><p><strong>Actions</strong>:
| Action | Component | Side Effects |
|--------|-----------|--------------|
| Log temperature | <code>LogTempModal</code> | Insert to <code>manual_temperature_logs</code> |
| Acknowledge alert | <code>UnitAlertsBanner</code> | Update <code>alerts.acknowledged_at</code> |
| Change thresholds | <code>UnitSettingsSection</code> | Update <code>units</code> |
| Assign sensor | <code>AssignSensorToUnitDialog</code> | Update <code>lora_sensors.unit_id</code> |</p><p><strong>Error States</strong>:
<li>Unit not found (404)</li>
<li>Failed to load readings</li>
<li>Failed to load alerts</li></p><p><strong>Files Involved</strong>:
<li><code>src/pages/UnitDetail.tsx</code></li>
<li><code>src/components/unit/UnitAlertsBanner.tsx</code></li>
<li><code>src/components/unit/UnitSensorsCard.tsx</code></li>
<li><code>src/components/unit/BatteryHealthCard.tsx</code></li>
<li><code>src/components/unit/DeviceReadinessCard.tsx</code></li>
<li><code>src/components/unit/LastKnownGoodCard.tsx</code></li>
<li><code>src/components/unit/UnitAlertThresholdsSection.tsx</code></li>
<li><code>src/components/unit/UnitSettingsSection.tsx</code></li>
<li><code>src/components/unit/AssignSensorToUnitDialog.tsx</code></li>
<li><code>src/hooks/useUnitStatus.ts</code></li>
<li><code>src/hooks/useUnitAlerts.ts</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#unit-detail">Unit Detail Diagram</a></p><p>---</p><p><h3>Manual Log (<code>/manual-log</code>)</h3></p><p><strong>File</strong>: <code>src/pages/ManualLog.tsx</code></p><p><strong>Purpose</strong>: Quick manual temperature logging interface with offline support.</p><p><strong>Layout</strong>:
<li>Unit selector (hierarchical: Site â†’ Area â†’ Unit)</li>
<li>Temperature input</li>
<li>Notes field</li>
<li>Submit button</li>
<li>Offline indicator</li></p><p><strong>Preconditions</strong>:
<li>User authenticated</li>
<li>At least one unit exists</li></p><p><strong>State Machine</strong>:
<pre><code class="">[Select Unit] â†’ (unit selected) â†’ [Enter Temperature]
                                â†’ (submit) â†’ [Submitting]
   â”Œâ”€ online â”€â”¬â”€ success â†’ [Success Toast] â†’ [Select Unit]
   â”‚          â””â”€ error â†’ [Error Toast] â†’ [Enter Temperature]
   â””â”€ offline â†’ [Queue Locally] â†’ [Success Toast] â†’ [Select Unit]</p><p>[Offline Queue] â†’ (online) â†’ [Sync] â†’ [Queue Empty]
</code></pre></p><p><strong>Data Dependencies</strong>:
<li>Sites, areas, units (for selector)</li>
<li>Offline queue (IndexedDB)</li></p><p><strong>API Calls</strong>:
<li>Insert to <code>manual_temperature_logs</code></li>
<li><code>src/lib/offlineStorage.ts</code> for offline queue</li></p><p><strong>Offline Behavior</strong>:
<li>Logs stored in IndexedDB</li>
<li>Automatic sync when connection restored</li>
<li>Pending count indicator</li></p><p><strong>Files Involved</strong>:
<li><code>src/pages/ManualLog.tsx</code></li>
<li><code>src/components/LogTempModal.tsx</code></li>
<li><code>src/lib/offlineStorage.ts</code></li>
<li><code>src/hooks/useOfflineSync.ts</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#manual-log">Manual Log Diagram</a></p><p>---</p><p><h3>Alerts (<code>/alerts</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Alerts.tsx</code></p><p><strong>Purpose</strong>: Centralized alert management with filtering and bulk actions.</p><p><strong>Layout</strong>:
| Section | Content |
|---------|---------|
| Filters | Status, severity, type, date range |
| Alert List | Sortable table with alert details |
| Detail Panel | Selected alert details |</p><p><strong>State Machine</strong>:
<pre><code class="">[Loading] â†’ (fetch) â†’ [Ready]</p><p>[Ready] â†’ (filter change) â†’ [Filtering] â†’ [Ready]
       â†’ (select alert) â†’ [Detail View]
       â†’ (acknowledge) â†’ [Updating] â†’ [Ready]
       â†’ (resolve) â†’ [Updating] â†’ [Ready]
</code></pre></p><p><strong>Data Dependencies</strong>:
<li><code>alerts</code> table with filters</li>
<li>Related units, sites, areas</li></p><p><strong>Actions</strong>:
| Action | Description |
|--------|-------------|
| Filter by status | Show active/acknowledged/resolved |
| Filter by severity | Show warning/critical |
| Acknowledge | Mark alert as seen |
| Resolve | Close alert |
| View unit | Navigate to unit detail |</p><p><strong>Files Involved</strong>:
<li><code>src/pages/Alerts.tsx</code></li>
<li><code>src/components/alerts/AlertRow.tsx</code></li>
<li><code>src/lib/alertConfig.ts</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#alerts">Alerts Page Diagram</a></p><p>---</p><p><h3>Reports (<code>/reports</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Reports.tsx</code></p><p><strong>Purpose</strong>: Generate and export compliance reports.</p><p><strong>Layout</strong>:
<li>Report type selector</li>
<li>Date range picker</li>
<li>Unit/site filter</li>
<li>Generate button</li>
<li>Report preview</li>
<li>Export options (PDF, CSV)</li></p><p><strong>Report Types</strong>:
| Report | Description |
|--------|-------------|
| Temperature Log | All readings for period |
| Excursion Report | All temperature excursions |
| Compliance Summary | HACCP compliance metrics |
| Corrective Actions | Actions taken for violations |</p><p><strong>Data Dependencies</strong>:
<li><code>sensor_readings</code></li>
<li><code>manual_temperature_logs</code></li>
<li><code>alerts</code></li>
<li><code>corrective_actions</code></li></p><p><strong>API Calls</strong>:
<li><code>export-temperature-logs</code> edge function</li></p><p><strong>Files Involved</strong>:
<li><code>src/pages/Reports.tsx</code></li>
<li><code>src/components/reports/ComplianceReportCard.tsx</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#reports">Reports Page Diagram</a></p><p>---</p><p><h3>Settings (<code>/settings</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Settings.tsx</code></p><p><strong>Purpose</strong>: Multi-tab settings interface for organization configuration.</p><p><strong>Layout</strong>: Tabbed interface with the following tabs:</p><p>#### General Tab
<li>Organization name and branding</li>
<li>Timezone settings</li>
<li>Compliance mode selection</li></p><p>#### Alert Rules Tab
<li>Default temperature thresholds</li>
<li>Offline detection settings</li>
<li>Manual log requirements</li></p><p><strong>Component</strong>: <code>AlertRulesEditor.tsx</code>, <code>AlertRulesScopedEditor.tsx</code></p><p>#### Notification Policies Tab
<li>Per-alert-type notification configuration</li>
<li>Escalation timing settings</li>
<li>Quiet hours</li></p><p><strong>Component</strong>: <code>NotificationPolicyEditor.tsx</code>, <code>AlertTypePolicyCard.tsx</code></p><p>#### Sensors Tab
<li>LoRa sensor inventory</li>
<li>Add/edit/remove sensors</li>
<li>Provisioning status</li></p><p><strong>Component</strong>: <code>SensorManager.tsx</code>, <code>AddSensorDialog.tsx</code>, <code>EditSensorDialog.tsx</code></p><p>#### Gateways Tab
<li>LoRa gateway inventory</li>
<li>Add/edit/remove gateways</li>
<li>Connection status</li></p><p><strong>Component</strong>: <code>GatewayManager.tsx</code>, <code>AddGatewayDialog.tsx</code>, <code>EditGatewayDialog.tsx</code></p><p>#### TTN Connection Tab
<li>TTN credentials</li>
<li>Webhook configuration</li>
<li>Provisioning logs</li></p><p><strong>Component</strong>: <code>TTNConnectionSettings.tsx</code>, <code>TTNCredentialsPanel.tsx</code>, <code>TTNProvisioningLogs.tsx</code></p><p>#### Billing Tab
<li>Current plan</li>
<li>Usage metrics</li>
<li>Invoice history</li>
<li>Upgrade/downgrade</li></p><p><strong>Component</strong>: <code>BillingTab.tsx</code>, <code>PlanCard.tsx</code>, <code>InvoiceHistory.tsx</code></p><p>#### Account Tab
<li>User profile</li>
<li>Password change</li>
<li>Account deletion</li></p><p><strong>State Machine</strong>:
<pre><code class="">[Loading] â†’ (fetch settings) â†’ [Ready]</p><p>[Ready] â†’ (change setting) â†’ [Saving] â†’ [Ready]
       â†’ (error) â†’ [Error Toast] â†’ [Ready]
       â†’ (switch tab) â†’ [Ready]
</code></pre></p><p><strong>Files Involved</strong>:
<li><code>src/pages/Settings.tsx</code></li>
<li><code>src/components/settings/</em>.tsx</code> (20+ components)</li>
<li><code>src/hooks/useAlertRules.ts</code></li>
<li><code>src/hooks/useNotificationPolicies.ts</code></li>
<li><code>src/hooks/useLoraSensors.ts</code></li>
<li><code>src/hooks/useGateways.ts</code></li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#settings">Settings Page Diagram</a></p><p>---</p><p><h3>Event History (<code>/events</code>)</h3></p><p><strong>File</strong>: <code>src/pages/EventHistory.tsx</code></p><p><strong>Purpose</strong>: Audit trail viewer for all system events.</p><p><strong>Layout</strong>:
<li>Filterable event list</li>
<li>Event type icons</li>
<li>Timestamp display</li>
<li>Event details expandable</li></p><p><strong>Data Dependencies</strong>:
<li><code>event_logs</code> table</li></p><p><strong>Filters</strong>:
<li>Event type (alert, temperature, configuration, user)</li>
<li>Severity (info, warning, error)</li>
<li>Date range</li>
<li>Actor (user, system)</li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#event-history">Event History Diagram</a></p><p>---</p><p><h2>Admin Pages</h2></p><p><h3>Health Dashboard (<code>/admin/health</code>)</h3></p><p><strong>File</strong>: <code>src/pages/HealthDashboard.tsx</code></p><p><strong>Purpose</strong>: System health monitoring and diagnostics.</p><p><strong>Layout</strong>:
| Section | Content |
|---------|---------|
| Overall Status | Aggregate health indicator |
| Edge Functions | Per-function health checks |
| Database | Connection status |
| TTN | Webhook status |</p><p><strong>Components</strong>:
<li><code>HealthCheckList.tsx</code></li>
<li><code>HealthStatusBadge.tsx</code></li>
<li><code>HealthStatusCard.tsx</code></li>
<li><code>OverallHealthSummary.tsx</code></li></p><p><strong>API Calls</strong>:
<li><code>health-check</code> edge function</li>
<li>Database connectivity check</li></p><p><strong>Diagram Reference</strong>: <a href="#diagrams-page_diagrams#health-dashboard">Health Dashboard Diagram</a></p><p>---</p><p><h3>TTN Cleanup (<code>/admin/ttn-cleanup</code>)</h3></p><p><strong>File</strong>: <code>src/pages/TTNCleanup.tsx</code></p><p><strong>Purpose</strong>: Manage TTN device cleanup and deprovisioning.</p><p><strong>Actions</strong>:
<li>View pending cleanup jobs</li>
<li>Trigger manual cleanup</li>
<li>View cleanup history</li></p><p>---</p><p><h3>Data Maintenance (<code>/admin/data-maintenance</code>)</h3></p><p><strong>File</strong>: <code>src/pages/DataMaintenance.tsx</code></p><p><strong>Purpose</strong>: Database maintenance operations.</p><p><strong>Actions</strong>:
<li>Find orphan organizations</li>
<li>Cleanup old data</li>
<li>Repair data integrity</li></p><p>---</p><p><h3>Recently Deleted (<code>/admin/recently-deleted</code>)</h3></p><p><strong>File</strong>: <code>src/pages/RecentlyDeleted.tsx</code></p><p><strong>Purpose</strong>: View and restore soft-deleted items.</p><p><strong>Layout</strong>:
<li>List of deleted items by type</li>
<li>Restore button</li>
<li>Permanent delete option</li></p><p>---</p><p><h3>Inspector (<code>/inspector</code>)</h3></p><p><strong>File</strong>: <code>src/pages/Inspector.tsx</code></p><p><strong>Purpose</strong>: Debug tool for examining organization data.</p><p><strong>Features</strong>:
<li>View raw database records</li>
<li>Examine sensor states</li>
<li>Check TTN configuration</li>
<li>Debug alerts</li></p><p>---</p><p><h3>Pilot Setup (<code>/pilot-setup</code>)</h3></p><p><strong>File</strong>: <code>src/pages/PilotSetup.tsx</code></p><p><strong>Purpose</strong>: Configuration interface for pilot program participants.</p><p>---</p><p><h2>Utility Pages</h2></p><p><h3>Account Deleted (<code>/account-deleted</code>)</h3></p><p><strong>File</strong>: <code>src/pages/AccountDeleted.tsx</code></p><p><strong>Purpose</strong>: Confirmation page shown after account deletion.</p><p><strong>Layout</strong>:
<li>Confirmation message</li>
<li>Link to sign up again</li></p><p>---</p><p><h3>Not Found (<code><em></code>)</h3></p><p><strong>File</strong>: <code>src/pages/NotFound.tsx</code></p><p><strong>Purpose</strong>: 404 error page for unknown routes.</p><p><strong>Layout</strong>:
<li>Error message</li>
<li>Link to dashboard/home</li></p><p>---</p><p><h2>Page Diagrams Reference</h2></p><p>All page-specific diagrams are located in <a href="#diagrams-page_diagrams">PAGE_DIAGRAMS.md</a>.</p><p>| Page | Diagram Section |
|------|-----------------|
| Dashboard | <a href="#diagrams-page_diagrams#dashboard">#dashboard</a> |
| Unit Detail | <a href="#diagrams-page_diagrams#unit-detail">#unit-detail</a> |
| Alerts | <a href="#diagrams-page_diagrams#alerts">#alerts</a> |
| Settings | <a href="#diagrams-page_diagrams#settings">#settings</a> |
| Manual Log | <a href="#diagrams-page_diagrams#manual-log">#manual-log</a> |
| Reports | <a href="#diagrams-page_diagrams#reports">#reports</a> |
| Auth | <a href="#diagrams-page_diagrams#auth-page">#auth-page</a> |</p><p>
---</p><p><div class="page-break"></div></p><p><a id="product-user_flows"></a></p><p><h1>FreshTrack Pro User Flows</h1></p><p><blockquote>End-to-end user journey documentation for major workflows</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#authentication-flows">Authentication Flows</a></li>
<li><a href="#setup--onboarding-flows">Setup & Onboarding Flows</a></li>
<li><a href="#monitoring-flows">Monitoring Flows</a></li>
<li><a href="#alert-management-flows">Alert Management Flows</a></li>
<li><a href="#configuration-flows">Configuration Flows</a></li>
<li><a href="#compliance-flows">Compliance Flows</a></li></p><p>---</p><p><h2>Authentication Flows</h2></p><p><h3>Flow 1: New User Registration</h3></p><p><strong>Name</strong>: User Sign Up and Onboarding</p><p><strong>Goal</strong>: New user creates account and sets up their organization</p><p><strong>Actors</strong>:
<li>Primary: New User (Food Safety Manager)</li>
<li>System: FreshTrack Pro, Supabase Auth</li></p><p><strong>Preconditions</strong>:
<li>User has a valid email address</li>
<li>User is not already registered</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to <code>/auth</code> | Displays sign up form |
| 2 | User | Enters email, password | Validates input (Zod schema) |
| 3 | System | Checks password breach | <code>check-password-breach</code> edge function |
| 4 | User | Clicks "Create Account" | Shows loading state |
| 5 | System | Creates auth user | Supabase Auth <code>signUp()</code> |
| 6 | System | Creates profile record | Database trigger |
| 7 | System | Redirects to <code>/onboarding</code> | |
| 8 | User | Enters organization name | Validates slug availability |
| 9 | User | Completes onboarding steps | Creates org, site, area, unit |
| 10 | System | Redirects to <code>/dashboard</code> | Shows empty dashboard |</p><p><strong>APIs and Data Touched</strong>:
<li><code>supabase.auth.signUp()</code> - Creates auth user</li>
<li><code>check-password-breach</code> - Validates password</li>
<li><code>check-slug-available</code> - Validates org slug</li>
<li><code>create_organization_with_owner()</code> RPC - Creates org</li>
<li>Tables: <code>auth.users</code>, <code>profiles</code>, <code>organizations</code>, <code>user_roles</code>, <code>sites</code>, <code>areas</code>, <code>units</code></li></p><p><strong>Failure Modes</strong>:
| Failure | Cause | Recovery |
|---------|-------|----------|
| Email already exists | Duplicate registration | Show error, suggest sign in |
| Password too weak | Requirements not met | Show requirements, allow retry |
| Network error | Connection issue | Retry button |
| Slug taken | Org name conflict | Suggest alternative |</p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#user-registration">See SEQUENCES.md#user-registration</a></p><p>---</p><p><h3>Flow 2: Returning User Sign In</h3></p><p><strong>Name</strong>: User Authentication</p><p><strong>Goal</strong>: Existing user signs in to access their organization</p><p><strong>Actors</strong>:
<li>Primary: Returning User</li>
<li>System: FreshTrack Pro, Supabase Auth</li></p><p><strong>Preconditions</strong>:
<li>User has a registered account</li>
<li>User knows their credentials</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to <code>/auth</code> | Displays sign in form |
| 2 | User | Enters email, password | |
| 3 | User | Clicks "Sign In" | Shows loading state |
| 4 | System | Validates credentials | Supabase Auth |
| 5 | System | Creates session | JWT token stored |
| 6 | System | Loads organization | Fetches user's org |
| 7 | System | Redirects to <code>/dashboard</code> | Shows dashboard |</p><p><strong>APIs and Data Touched</strong>:
<li><code>supabase.auth.signInWithPassword()</code> - Authenticates</li>
<li>Tables: <code>profiles</code>, <code>user_roles</code>, <code>organizations</code></li></p><p><strong>Failure Modes</strong>:
| Failure | Cause | Recovery |
|---------|-------|----------|
| Invalid credentials | Wrong email/password | Show error, retry |
| Account disabled | Admin action | Contact support |
| Session expired | Token timeout | Re-authenticate |</p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#user-sign-in">See SEQUENCES.md#user-sign-in</a></p><p>---</p><p><h2>Setup & Onboarding Flows</h2></p><p><h3>Flow 3: TTN Sensor Setup</h3></p><p><strong>Name</strong>: Configure TTN Connection and Add Sensors</p><p><strong>Goal</strong>: IT Administrator connects TTN and provisions sensors</p><p><strong>Actors</strong>:
<li>Primary: IT Administrator</li>
<li>System: FreshTrack Pro, The Things Network</li></p><p><strong>Preconditions</strong>:
<li>Organization exists</li>
<li>User has admin/owner role</li>
<li>TTN account exists with application</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | Admin | Navigates to <code>/settings</code> â†’ TTN tab | Displays TTN setup wizard |
| 2 | Admin | Enters TTN Application ID | Validates format |
| 3 | Admin | Enters TTN API Key | |
| 4 | System | Validates API key permissions | <code>ttn-gateway-preflight</code> |
| 5 | System | Stores encrypted credentials | Saves to <code>ttn_connections</code> |
| 6 | System | Configures TTN webhook | <code>ttn-bootstrap</code> |
| 7 | Admin | Clicks "Add Sensor" | Opens sensor dialog |
| 8 | Admin | Enters DevEUI, name, type | |
| 9 | System | Queues provisioning job | <code>ttn_provisioning_queue</code> |
| 10 | System | Provisions device in TTN | <code>ttn-provision-device</code> |
| 11 | System | Updates sensor status | Shows "active" when receiving data |</p><p><strong>APIs and Data Touched</strong>:
<li><code>ttn-gateway-preflight</code> - Validates TTN credentials</li>
<li><code>ttn-bootstrap</code> - Configures webhook</li>
<li><code>ttn-provision-device</code> - Registers device in TTN</li>
<li>Tables: <code>ttn_connections</code>, <code>lora_sensors</code>, <code>ttn_provisioning_queue</code>, <code>ttn_provisioning_logs</code></li></p><p><strong>Failure Modes</strong>:
| Failure | Cause | Recovery |
|---------|-------|----------|
| Invalid API key | Wrong key or insufficient permissions | Show required permissions, retry |
| Webhook setup failed | TTN API error | Manual webhook setup instructions |
| Device already exists | DevEUI registered elsewhere | Remove from TTN console first |
| Provisioning timeout | TTN slow response | Retry via provisioning logs |</p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#ttn-setup-flow">See SEQUENCES.md#ttn-setup-flow</a></p><p>---</p><p><h3>Flow 4: Add New Unit</h3></p><p><strong>Name</strong>: Create Refrigeration Unit</p><p><strong>Goal</strong>: User adds a new monitored refrigeration unit</p><p><strong>Actors</strong>:
<li>Primary: Manager or Owner</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>Organization, site, and area exist</li>
<li>User has manager or owner role</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to area page | Displays area with existing units |
| 2 | User | Clicks "Add Unit" | Opens unit creation dialog |
| 3 | User | Enters unit name | |
| 4 | User | Sets temperature thresholds | High limit, low limit (optional) |
| 5 | User | Configures check-in interval | Default 5 minutes |
| 6 | User | Clicks "Create" | Shows loading |
| 7 | System | Creates unit record | <code>create_unit_for_area()</code> RPC |
| 8 | System | Creates default alert rules | Inherited from org/site |
| 9 | System | Redirects to unit page | Shows empty unit |
| 10 | User | Assigns sensor (optional) | Opens sensor assignment dialog |</p><p><strong>APIs and Data Touched</strong>:
<li><code>create_unit_for_area()</code> RPC</li>
<li>Tables: <code>units</code>, <code>alert_rules</code></li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#add-unit">See SEQUENCES.md#add-unit</a></p><p>---</p><p><h2>Monitoring Flows</h2></p><p><h3>Flow 5: Temperature Reading Ingestion</h3></p><p><strong>Name</strong>: Sensor Data Processing</p><p><strong>Goal</strong>: System receives and processes sensor temperature reading</p><p><strong>Actors</strong>:
<li>System: TTN, FreshTrack Pro Edge Functions</li></p><p><strong>Preconditions</strong>:
<li>Sensor is provisioned and active</li>
<li>Sensor is assigned to a unit</li>
<li>TTN webhook is configured</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | Sensor | Transmits temperature via LoRa | |
| 2 | TTN Gateway | Receives and forwards | |
| 3 | TTN | Decodes payload | |
| 4 | TTN | Calls webhook | POST to <code>ttn-webhook</code> |
| 5 | System | Validates webhook secret | Per-org secret check |
| 6 | System | Looks up sensor by DevEUI | Scoped to org |
| 7 | System | Inserts reading | <code>sensor_readings</code> table |
| 8 | System | Updates unit state | <code>last_reading_at</code>, <code>last_temp_reading</code> |
| 9 | System | Triggers state processing | Calls <code>process-unit-states</code> |
| 10 | System | Evaluates thresholds | Checks temp limits |
| 11 | System | Creates/resolves alerts | If threshold exceeded |
| 12 | System | Triggers notifications | Calls <code>process-escalations</code> |</p><p><strong>APIs and Data Touched</strong>:
<li><code>ttn-webhook</code> - Receives TTN uplink</li>
<li><code>process-unit-states</code> - Evaluates state</li>
<li><code>process-escalations</code> - Sends notifications</li>
<li>Tables: <code>sensor_readings</code>, <code>units</code>, <code>alerts</code>, <code>notification_events</code></li></p><p><strong>Failure Modes</strong>:
| Failure | Cause | Recovery |
|---------|-------|----------|
| Invalid webhook secret | Misconfigured TTN | Check TTN webhook config |
| Unknown device | Sensor not registered | Register sensor first |
| Database error | Connection issue | TTN retries automatically |</p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#temperature-reading-flow">See SEQUENCES.md#temperature-reading-flow</a></p><p>---</p><p><h3>Flow 6: Manual Temperature Logging</h3></p><p><strong>Name</strong>: Manual Temperature Entry</p><p><strong>Goal</strong>: Staff logs temperature reading manually when sensor unavailable</p><p><strong>Actors</strong>:
<li>Primary: Kitchen Staff</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>User is authenticated</li>
<li>User has operator role or higher</li>
<li>Unit exists</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to <code>/manual-log</code> | Displays unit selector |
| 2 | User | Selects site â†’ area â†’ unit | Hierarchical selection |
| 3 | User | Enters temperature reading | Validates range |
| 4 | User | Adds notes (optional) | |
| 5 | User | Clicks "Log Temperature" | Shows loading |
| 6 | System | Checks connectivity | |
| 7a | Online | Saves to database | <code>manual_temperature_logs</code> |
| 7b | Offline | Saves to IndexedDB | Local queue |
| 8 | System | Shows success toast | |
| 9 | System | Clears form | Ready for next log |
| 10 | Offlineâ†’Online | Syncs queued logs | Background sync |</p><p><strong>APIs and Data Touched</strong>:
<li>Direct insert to <code>manual_temperature_logs</code></li>
<li><code>src/lib/offlineStorage.ts</code> for IndexedDB</li>
<li><code>event_logs</code> for audit trail</li></p><p><strong>Failure Modes</strong>:
| Failure | Cause | Recovery |
|---------|-------|----------|
| Network offline | No connection | Queue locally, sync later |
| Invalid temperature | Out of range | Show validation error |
| Sync failure | Server error | Retry automatically |</p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#manual-logging-flow">See SEQUENCES.md#manual-logging-flow</a></p><p>---</p><p><h3>Flow 7: Dashboard Monitoring</h3></p><p><strong>Name</strong>: Real-time Unit Status Monitoring</p><p><strong>Goal</strong>: User monitors all units from dashboard</p><p><strong>Actors</strong>:
<li>Primary: Food Safety Manager</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>User is authenticated</li>
<li>Organization has units configured</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to <code>/dashboard</code> | Fetches all units |
| 2 | System | Displays unit cards | Shows status, temp, last reading |
| 3 | System | Applies status styling | Green/orange/red based on status |
| 4 | User | Scans for issues | Identifies warning/alarm states |
| 5 | User | Clicks unit card | Navigates to unit detail |
| 6 | System | Polls for updates | Refreshes data periodically |</p><p><strong>APIs and Data Touched</strong>:
<li>Supabase direct queries: <code>units</code>, <code>alerts</code>, <code>lora_sensors</code></li>
<li><code>useUnitStatus</code> hook for status computation</li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#dashboard-monitoring">See SEQUENCES.md#dashboard-monitoring</a></p><p>---</p><p><h2>Alert Management Flows</h2></p><p><h3>Flow 8: Alert Acknowledgment</h3></p><p><strong>Name</strong>: Acknowledge Active Alert</p><p><strong>Goal</strong>: User acknowledges they've seen an alert and are responding</p><p><strong>Actors</strong>:
<li>Primary: Manager or Operator</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>Active alert exists</li>
<li>User has permission to acknowledge</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | System | Displays alert notification | Push/email/SMS |
| 2 | User | Clicks notification or navigates to alerts | Shows alert list |
| 3 | User | Clicks "Acknowledge" button | Opens acknowledge dialog |
| 4 | User | Enters notes (optional) | Describes action being taken |
| 5 | User | Confirms acknowledgment | |
| 6 | System | Updates alert record | Sets <code>acknowledged_at</code>, <code>acknowledged_by</code> |
| 7 | System | Logs event | Audit trail entry |
| 8 | System | Stops escalation timer | No further escalation |</p><p><strong>APIs and Data Touched</strong>:
<li>Update <code>alerts</code> table</li>
<li>Insert <code>event_logs</code></li></p><p><strong>Failure Modes</strong>:
| Failure | Cause | Recovery |
|---------|-------|----------|
| Alert already resolved | Condition cleared | Show info message |
| Permission denied | Wrong role | Show error |</p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#alert-acknowledgment">See SEQUENCES.md#alert-acknowledgment</a></p><p>---</p><p><h3>Flow 9: Temperature Excursion Detection</h3></p><p><strong>Name</strong>: Temperature Alert Creation and Resolution</p><p><strong>Goal</strong>: System detects temperature excursion and creates alert</p><p><strong>Actors</strong>:
<li>System: FreshTrack Pro Edge Functions</li></p><p><strong>Preconditions</strong>:
<li>Unit has active sensor</li>
<li>Temperature thresholds configured</li></p><p><strong>Steps</strong>:</p><p>| Step | System | Action |
|------|--------|--------|
| 1 | <code>ttn-webhook</code> | Receives temperature reading |
| 2 | <code>process-unit-states</code> | Compares to thresholds |
| 3 | Detection | Temp > high limit OR < low limit |
| 4 | State Change | Unit status â†’ <code>excursion</code> |
| 5 | Alert Creation | Creates <code>temp_excursion</code> alert |
| 6 | Timer Start | Begins confirm time countdown |
| 7 | Confirm Wait | If temp stays out of range for confirm time |
| 8 | Escalation | Status â†’ <code>alarm_active</code>, severity â†’ <code>critical</code> |
| 9 | Notification | <code>process-escalations</code> sends alerts |
| 10 | Resolution (if temp returns) | Status â†’ <code>restoring</code> â†’ <code>ok</code> |
| 11 | Alert Resolved | Alert status â†’ <code>resolved</code> |</p><p><strong>State Transitions</strong>:
<pre><code class="">ok â†’ excursion â†’ alarm_active â†’ restoring â†’ ok
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p><strong>APIs and Data Touched</strong>:
<li><code>process-unit-states</code> - State evaluation</li>
<li><code>process-escalations</code> - Notifications</li>
<li>Tables: <code>units</code>, <code>alerts</code>, <code>notification_events</code>, <code>event_logs</code></li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#excursion-detection">See SEQUENCES.md#excursion-detection</a></p><p>---</p><p><h3>Flow 10: Alert Escalation</h3></p><p><strong>Name</strong>: Unacknowledged Alert Escalation</p><p><strong>Goal</strong>: System escalates alert to additional contacts when not acknowledged</p><p><strong>Actors</strong>:
<li>System: FreshTrack Pro Edge Functions</li></p><p><strong>Preconditions</strong>:
<li>Active alert exists</li>
<li>Alert not acknowledged within escalation period</li>
<li>Escalation contacts configured</li></p><p><strong>Steps</strong>:</p><p>| Step | System | Action |
|------|--------|--------|
| 1 | Alert Created | Level 1 notification sent |
| 2 | Timer | Escalation period expires |
| 3 | Check | Alert still not acknowledged |
| 4 | Level Up | Increment <code>escalation_level</code> |
| 5 | Notify | Send to level 2 contacts |
| 6 | Repeat | Continue until max level or acknowledged |</p><p><strong>APIs and Data Touched</strong>:
<li><code>process-escalations</code> edge function</li>
<li>Tables: <code>alerts</code>, <code>escalation_contacts</code>, <code>notification_events</code></li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#alert-escalation">See SEQUENCES.md#alert-escalation</a></p><p>---</p><p><h2>Configuration Flows</h2></p><p><h3>Flow 11: Configure Alert Thresholds</h3></p><p><strong>Name</strong>: Modify Temperature Thresholds</p><p><strong>Goal</strong>: Manager adjusts temperature limits for a unit</p><p><strong>Actors</strong>:
<li>Primary: Manager or Owner</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>User has manager or owner role</li>
<li>Unit exists</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to unit detail | Shows unit page |
| 2 | User | Opens settings section | Displays threshold form |
| 3 | User | Modifies high/low limits | Validates input |
| 4 | User | Clicks "Save" | Shows loading |
| 5 | System | Updates unit record | <code>units</code> table |
| 6 | System | Logs change | <code>event_logs</code> and <code>alert_rules_history</code> |
| 7 | System | Shows success toast | |</p><p><strong>APIs and Data Touched</strong>:
<li>Update <code>units</code> table</li>
<li>Insert <code>alert_rules_history</code> if cascade level changed</li>
<li>Insert <code>event_logs</code></li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#configure-thresholds">See SEQUENCES.md#configure-thresholds</a></p><p>---</p><p><h3>Flow 12: Configure Notification Policy</h3></p><p><strong>Name</strong>: Set Up Notification Preferences</p><p><strong>Goal</strong>: Configure how alerts trigger notifications</p><p><strong>Actors</strong>:
<li>Primary: Manager or Owner</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>User has manager or owner role</li>
<li>Organization exists</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to <code>/settings</code> â†’ Notifications | Displays policy editor |
| 2 | User | Selects alert type | Shows current policy |
| 3 | User | Toggles notification channels | Email, SMS, Push |
| 4 | User | Sets escalation timing | Minutes between escalations |
| 5 | User | Configures quiet hours (optional) | Time ranges |
| 6 | User | Clicks "Save" | Shows loading |
| 7 | System | Updates policy | <code>notification_policies</code> table |
| 8 | System | Shows success toast | |</p><p><strong>APIs and Data Touched</strong>:
<li>Update <code>notification_policies</code> table</li>
<li><code>get_effective_notification_policy()</code> RPC for cascade</li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#configure-notifications">See SEQUENCES.md#configure-notifications</a></p><p>---</p><p><h2>Compliance Flows</h2></p><p><h3>Flow 13: Generate Compliance Report</h3></p><p><strong>Name</strong>: Export HACCP Compliance Report</p><p><strong>Goal</strong>: Generate compliance documentation for health inspection</p><p><strong>Actors</strong>:
<li>Primary: Food Safety Manager</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>Organization has compliance mode set</li>
<li>Temperature data exists for period</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Navigates to <code>/reports</code> | Displays report options |
| 2 | User | Selects report type | Compliance summary |
| 3 | User | Sets date range | Start and end dates |
| 4 | User | Selects units/sites | Filter scope |
| 5 | User | Clicks "Generate" | Shows loading |
| 6 | System | Aggregates data | Queries readings, alerts |
| 7 | System | Displays preview | Shows report content |
| 8 | User | Clicks "Export PDF" | Triggers download |
| 9 | System | Generates PDF | <code>export-temperature-logs</code> function |</p><p><strong>APIs and Data Touched</strong>:
<li><code>export-temperature-logs</code> edge function</li>
<li>Tables: <code>sensor_readings</code>, <code>manual_temperature_logs</code>, <code>alerts</code>, <code>corrective_actions</code></li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#generate-report">See SEQUENCES.md#generate-report</a></p><p>---</p><p><h3>Flow 14: Document Corrective Action</h3></p><p><strong>Name</strong>: Record Corrective Action for Excursion</p><p><strong>Goal</strong>: Document steps taken to address temperature violation</p><p><strong>Actors</strong>:
<li>Primary: Manager or Operator</li>
<li>System: FreshTrack Pro</li></p><p><strong>Preconditions</strong>:
<li>Temperature excursion occurred</li>
<li>Alert exists (active or resolved)</li></p><p><strong>Steps</strong>:</p><p>| Step | Actor | Action | System Response |
|------|-------|--------|-----------------|
| 1 | User | Views alert detail | Shows alert info |
| 2 | User | Clicks "Add Corrective Action" | Opens form |
| 3 | User | Describes root cause | Text input |
| 4 | User | Describes action taken | Required field |
| 5 | User | Describes preventive measures | Optional |
| 6 | User | Uploads photos (optional) | File upload |
| 7 | User | Clicks "Save" | Shows loading |
| 8 | System | Creates record | <code>corrective_actions</code> table |
| 9 | System | Links to alert | <code>alert_id</code> foreign key |
| 10 | System | Logs event | Audit trail |</p><p><strong>APIs and Data Touched</strong>:
<li>Insert <code>corrective_actions</code> table</li>
<li>Insert <code>event_logs</code></li></p><p><strong>Sequence Diagram</strong>: <a href="#diagrams-sequences#corrective-action">See SEQUENCES.md#corrective-action</a></p><p>---</p><p><h2>Flow Diagrams Reference</h2></p><p>All sequence diagrams are located in <a href="#diagrams-sequences">SEQUENCES.md</a>.</p><p>| Flow | Diagram Section |
|------|-----------------|
| User Registration | <a href="#diagrams-sequences#user-registration">#user-registration</a> |
| User Sign In | <a href="#diagrams-sequences#user-sign-in">#user-sign-in</a> |
| TTN Setup | <a href="#diagrams-sequences#ttn-setup-flow">#ttn-setup-flow</a> |
| Temperature Reading | <a href="#diagrams-sequences#temperature-reading-flow">#temperature-reading-flow</a> |
| Manual Logging | <a href="#diagrams-sequences#manual-logging-flow">#manual-logging-flow</a> |
| Alert Acknowledgment | <a href="#diagrams-sequences#alert-acknowledgment">#alert-acknowledgment</a> |
| Excursion Detection | <a href="#diagrams-sequences#excursion-detection">#excursion-detection</a> |
| Alert Escalation | <a href="#diagrams-sequences#alert-escalation">#alert-escalation</a> |</p><p>
---</p><p><div class="page-break"></div></p><p><a id="engineering-api"></a></p><p><h1>FreshTrack Pro API Documentation</h1></p><p><blockquote>Complete documentation for all Edge Functions and RPC endpoints</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#overview">Overview</a></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#data-ingestion-functions">Data Ingestion Functions</a></li>
<li><a href="#alert-processing-functions">Alert Processing Functions</a></li>
<li><a href="#ttn-management-functions">TTN Management Functions</a></li>
<li><a href="#user--data-management-functions">User & Data Management Functions</a></li>
<li><a href="#billing-functions">Billing Functions</a></li>
<li><a href="#utility-functions">Utility Functions</a></li>
<li><a href="#database-rpc-functions">Database RPC Functions</a></li>
<li><a href="#error-handling">Error Handling</a></li></p><p>---</p><p><h2>Overview</h2></p><p><h3>Function Location</h3></p><p>All edge functions are located in <code>supabase/functions/</code> with shared utilities in <code>supabase/functions/_shared/</code>.</p><p><h3>Base URL</h3></p><p><pre><code class="">https://<project-id>.supabase.co/functions/v1/<function-name>
</code></pre></p><p><h3>Common Headers</h3></p><p>| Header | Required | Description |
|--------|----------|-------------|
| <code>Authorization</code> | Varies | <code>Bearer <JWT></code> for user-authenticated requests |
| <code>Content-Type</code> | Yes | <code>application/json</code> |
| <code>X-Internal-API-Key</code> | Some | Internal API key for scheduled/internal calls |
| <code>X-Webhook-Secret</code> | Some | Per-org webhook secret for TTN/Stripe |</p><p>---</p><p><h2>Authentication</h2></p><p><h3>Authentication Methods</h3></p><p>| Method | Used By | How |
|--------|---------|-----|
| JWT (Supabase Auth) | User-facing endpoints | <code>Authorization: Bearer <token></code> |
| Internal API Key | Scheduled functions | <code>X-Internal-API-Key: <key></code> |
| Webhook Secret | External webhooks | <code>X-Webhook-Secret: <secret></code> |
| Service Role | Internal calls | Auto-injected by Supabase |</p><p><h3>JWT Authentication</h3></p><p><pre><code class="typescript">// Frontend: Token added automatically by Supabase client
const { data } = await supabase.functions.invoke('function-name', {
  body: { /</em> payload <em>/ }
});
</code></pre></p><p><h3>Internal API Key Validation</h3></p><p><pre><code class="typescript">// Edge function validation
import { validateInternalApiKey, unauthorizedResponse } from "../_shared/validation.ts";</p><p>const apiKeyResult = validateInternalApiKey(req);
if (!apiKeyResult.valid) {
  return unauthorizedResponse(apiKeyResult.error, corsHeaders);
}
</code></pre></p><p>---</p><p><h2>Data Ingestion Functions</h2></p><p><h3><code>ttn-webhook</code></h3></p><p><strong>Purpose</strong>: Receive sensor uplink messages from The Things Network</p><p><strong>File</strong>: <code>supabase/functions/ttn-webhook/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Per-organization webhook secret (<code>X-Webhook-Secret</code>)</p><p><strong>Request Body</strong> (TTN Uplink Format):
<pre><code class="json">{
  "end_device_ids": {
    "device_id": "sensor-001",
    "application_ids": { "application_id": "freshtrack-org-abc" },
    "dev_eui": "0004A30B001C1234"
  },
  "uplink_message": {
    "decoded_payload": {
      "temperature": 38.5,
      "humidity": 65,
      "battery": 98,
      "door_open": false
    },
    "rx_metadata": [{
      "gateway_ids": { "gateway_id": "gw-001" },
      "rssi": -75,
      "snr": 8.5
    }],
    "received_at": "2026-01-12T10:30:00Z"
  }
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "success": true,
  "sensor_id": "uuid",
  "reading_id": "uuid",
  "temperature": 38.5,
  "unit_id": "uuid"
}
</code></pre></p><p><strong>Status Codes</strong>:
| Code | Meaning |
|------|---------|
| 200 | Successfully processed |
| 202 | Accepted but not processed (unknown device) |
| 401 | Invalid webhook secret |</p><p><strong>Notes</strong>:
<li>Returns 202 for unknown devices to prevent TTN retries</li>
<li>Validates webhook secret via <code>lookupOrgByWebhookSecret()</code></li>
<li>Triggers <code>process-unit-states</code> after successful ingestion</li></p><p>---</p><p><h3><code>ingest-readings</code></h3></p><p><strong>Purpose</strong>: Vendor-agnostic sensor data ingestion endpoint</p><p><strong>File</strong>: <code>supabase/functions/ingest-readings/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "unit_id": "uuid",
  "temperature": 38.5,
  "humidity": 65,
  "source": "sensor",
  "recorded_at": "2026-01-12T10:30:00Z"
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "success": true,
  "reading_id": "uuid"
}
</code></pre></p><p>---</p><p><h3><code>sensor-simulator</code></h3></p><p><strong>Purpose</strong>: Generate simulated sensor data for testing</p><p><strong>File</strong>: <code>supabase/functions/sensor-simulator/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "organization_id": "uuid",
  "unit_id": "uuid",
  "temperature_range": { "min": 35, "max": 40 },
  "interval_seconds": 300
}
</code></pre></p><p>---</p><p><h2>Alert Processing Functions</h2></p><p><h3><code>process-unit-states</code></h3></p><p><strong>Purpose</strong>: SINGLE SOURCE OF TRUTH for alert creation and resolution</p><p><strong>File</strong>: <code>supabase/functions/process-unit-states/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key (<code>X-Internal-API-Key</code>)</p><p><strong>Request Body</strong>: None (processes all active units)</p><p><strong>Response</strong>:
<pre><code class="json">{
  "success": true,
  "stateChanges": 5,
  "newAlerts": 2,
  "changes": [
    {
      "unitId": "uuid",
      "from": "ok",
      "to": "excursion",
      "reason": "Temperature 45Â°F above limit"
    }
  ]
}
</code></pre></p><p><strong>Processing Logic</strong>:
<li>Fetches all active units</li>
<li>Computes missed check-ins</li>
<li>Evaluates temperature thresholds</li>
<li>Creates/resolves alerts</li>
<li>Updates unit status</li>
<li>Logs state changes to <code>event_logs</code></li>
<li>Triggers <code>process-escalations</code> for new alerts</li></p><p><strong>Alert Types Created</strong>:
<li><code>temp_excursion</code> - Temperature out of range</li>
<li><code>monitoring_interrupted</code> - Sensor offline</li>
<li><code>suspected_cooling_failure</code> - Door closed but temp not recovering</li></p><p>---</p><p><h3><code>process-escalations</code></h3></p><p><strong>Purpose</strong>: SINGLE SOURCE OF TRUTH for notification dispatch</p><p><strong>File</strong>: <code>supabase/functions/process-escalations/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "alert_ids": ["uuid1", "uuid2"]
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "success": true,
  "notifications_sent": 3
}
</code></pre></p><p><strong>Processing Logic</strong>:
<li>Looks up effective notification policy</li>
<li>Determines notification channels (email, SMS, push)</li>
<li>Sends notifications via appropriate service</li>
<li>Records delivery in <code>notification_events</code></li>
<li>Updates alert <code>last_notified_at</code></li></p><p>---</p><p><h2>TTN Management Functions</h2></p><p><h3><code>ttn-bootstrap</code></h3></p><p><strong>Purpose</strong>: Auto-configure TTN webhook for organization</p><p><strong>File</strong>: <code>supabase/functions/ttn-bootstrap/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT (user authenticated)</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "organization_id": "uuid"
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "success": true,
  "webhook_id": "freshtrack-webhook-abc"
}
</code></pre></p><p>---</p><p><h3><code>ttn-provision-device</code></h3></p><p><strong>Purpose</strong>: Register sensor in TTN</p><p><strong>File</strong>: <code>supabase/functions/ttn-provision-device/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "sensor_id": "uuid",
  "dev_eui": "0004A30B001C1234",
  "join_eui": "0000000000000000",
  "app_key": "ABC123..."
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "success": true,
  "ttn_device_id": "dev-abc123"
}
</code></pre></p><p>---</p><p><h3><code>ttn-provision-gateway</code></h3></p><p><strong>Purpose</strong>: Register gateway in TTN</p><p><strong>File</strong>: <code>supabase/functions/ttn-provision-gateway/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "gateway_id": "uuid",
  "eui": "B827EBFFFE123456",
  "name": "Warehouse Gateway",
  "frequency_plan": "US_902_928"
}
</code></pre></p><p>---</p><p><h3><code>ttn-gateway-preflight</code></h3></p><p><strong>Purpose</strong>: Validate TTN API key permissions before gateway operations</p><p><strong>File</strong>: <code>supabase/functions/ttn-gateway-preflight/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "organization_id": "uuid",
  "api_key": "NNSXS.xxxxx..."
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "valid": true,
  "permissions": {
    "can_write_gateways": true,
    "can_write_devices": true
  }
}
</code></pre></p><p>---</p><p><h3><code>ttn-list-devices</code></h3></p><p><strong>Purpose</strong>: List devices from TTN application</p><p><strong>File</strong>: <code>supabase/functions/ttn-list-devices/index.ts</code></p><p><strong>Method</strong>: <code>GET</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Query Parameters</strong>:
<li><code>organization_id</code> (required)</li></p><p><strong>Response</strong>:
<pre><code class="json">{
  "devices": [
    {
      "device_id": "sensor-001",
      "dev_eui": "0004A30B001C1234",
      "name": "Walk-in Cooler Sensor"
    }
  ]
}
</code></pre></p><p>---</p><p><h3><code>ttn-manage-application</code></h3></p><p><strong>Purpose</strong>: Create or update TTN application</p><p><strong>File</strong>: <code>supabase/functions/ttn-manage-application/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p>---</p><p><h3><code>ttn-provision-org</code></h3></p><p><strong>Purpose</strong>: Provision organization in TTN</p><p><strong>File</strong>: <code>supabase/functions/ttn-provision-org/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p>---</p><p><h3><code>ttn-provision-worker</code></h3></p><p><strong>Purpose</strong>: Background worker for processing provisioning queue</p><p><strong>File</strong>: <code>supabase/functions/ttn-provision-worker/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p><strong>Trigger</strong>: Scheduled (cron) or manual</p><p>---</p><p><h3><code>ttn-deprovision-worker</code></h3></p><p><strong>Purpose</strong>: Background worker for device deprovisioning</p><p><strong>File</strong>: <code>supabase/functions/ttn-deprovision-worker/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p>---</p><p><h3><code>update-ttn-webhook</code></h3></p><p><strong>Purpose</strong>: Update TTN webhook configuration</p><p><strong>File</strong>: <code>supabase/functions/update-ttn-webhook/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p>---</p><p><h3><code>manage-ttn-settings</code></h3></p><p><strong>Purpose</strong>: CRUD operations for TTN settings</p><p><strong>File</strong>: <code>supabase/functions/manage-ttn-settings/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p>---</p><p><h3><code>sync-ttn-settings</code></h3></p><p><strong>Purpose</strong>: Sync TTN settings from emulator</p><p><strong>File</strong>: <code>supabase/functions/sync-ttn-settings/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p>---</p><p><h3><code>org-state-api</code></h3></p><p><strong>Purpose</strong>: Pull-based API for organization TTN state</p><p><strong>File</strong>: <code>supabase/functions/org-state-api/index.ts</code></p><p><strong>Method</strong>: <code>GET</code></p><p><strong>Authentication</strong>: API Key</p><p>---</p><p><h3><code>fetch-org-state</code></h3></p><p><strong>Purpose</strong>: Fetch current organization TTN state</p><p><strong>File</strong>: <code>supabase/functions/fetch-org-state/index.ts</code></p><p><strong>Method</strong>: <code>GET</code></p><p><strong>Authentication</strong>: JWT</p><p>---</p><p><h2>User & Data Management Functions</h2></p><p><h3><code>user-sync-emitter</code></h3></p><p><strong>Purpose</strong>: Emit user sync events (triggered by database)</p><p><strong>File</strong>: <code>supabase/functions/user-sync-emitter/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Service Role (database trigger)</p><p>---</p><p><h3><code>cleanup-user-sensors</code></h3></p><p><strong>Purpose</strong>: Clean up sensor data when user is removed</p><p><strong>File</strong>: <code>supabase/functions/cleanup-user-sensors/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p>---</p><p><h3><code>update-sensor-assignment</code></h3></p><p><strong>Purpose</strong>: Assign/unassign sensor to unit</p><p><strong>File</strong>: <code>supabase/functions/update-sensor-assignment/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "sensor_id": "uuid",
  "unit_id": "uuid",
  "is_primary": true
}
</code></pre></p><p>---</p><p><h3><code>account-deletion-jobs</code></h3></p><p><strong>Purpose</strong>: Process account deletion requests (GDPR compliance)</p><p><strong>File</strong>: <code>supabase/functions/account-deletion-jobs/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p>---</p><p><h3><code>export-temperature-logs</code></h3></p><p><strong>Purpose</strong>: Export compliance data for reporting</p><p><strong>File</strong>: <code>supabase/functions/export-temperature-logs/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "organization_id": "uuid",
  "start_date": "2026-01-01",
  "end_date": "2026-01-31",
  "unit_ids": ["uuid1", "uuid2"],
  "format": "csv"
}
</code></pre></p><p><strong>Response</strong>: CSV or JSON data</p><p>---</p><p><h3><code>check-password-breach</code></h3></p><p><strong>Purpose</strong>: Check password against breach databases</p><p><strong>File</strong>: <code>supabase/functions/check-password-breach/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: None (public)</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "password": "user_password"
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "breached": false
}
</code></pre></p><p>---</p><p><h3><code>check-slug-available</code></h3></p><p><strong>Purpose</strong>: Check if organization slug is available</p><p><strong>File</strong>: <code>supabase/functions/check-slug-available/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "slug": "my-restaurant"
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "available": true
}
</code></pre></p><p>---</p><p><h2>Billing Functions</h2></p><p><h3><code>stripe-checkout</code></h3></p><p><strong>Purpose</strong>: Create Stripe checkout session</p><p><strong>File</strong>: <code>supabase/functions/stripe-checkout/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "plan_id": "pro",
  "organization_id": "uuid"
}
</code></pre></p><p><strong>Response</strong>:
<pre><code class="json">{
  "checkout_url": "https://checkout.stripe.com/..."
}
</code></pre></p><p>---</p><p><h3><code>stripe-portal</code></h3></p><p><strong>Purpose</strong>: Create Stripe customer portal session</p><p><strong>File</strong>: <code>supabase/functions/stripe-portal/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: JWT</p><p><strong>Response</strong>:
<pre><code class="json">{
  "portal_url": "https://billing.stripe.com/..."
}
</code></pre></p><p>---</p><p><h3><code>stripe-webhook</code></h3></p><p><strong>Purpose</strong>: Handle Stripe webhook events</p><p><strong>File</strong>: <code>supabase/functions/stripe-webhook/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Stripe webhook signature</p><p><strong>Events Handled</strong>:
<li><code>checkout.session.completed</code></li>
<li><code>customer.subscription.created</code></li>
<li><code>customer.subscription.updated</code></li>
<li><code>customer.subscription.deleted</code></li>
<li><code>invoice.paid</code></li>
<li><code>invoice.payment_failed</code></li></p><p>---</p><p><h2>Utility Functions</h2></p><p><h3><code>health-check</code></h3></p><p><strong>Purpose</strong>: System health monitoring</p><p><strong>File</strong>: <code>supabase/functions/health-check/index.ts</code></p><p><strong>Method</strong>: <code>GET</code></p><p><strong>Authentication</strong>: None (public)</p><p><strong>Response</strong>:
<pre><code class="json">{
  "status": "healthy",
  "timestamp": "2026-01-12T10:30:00Z",
  "checks": {
    "database": "ok",
    "ttn_webhook": "ok"
  }
}
</code></pre></p><p>---</p><p><h3><code>send-sms-alert</code></h3></p><p><strong>Purpose</strong>: Send SMS via Twilio</p><p><strong>File</strong>: <code>supabase/functions/send-sms-alert/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p><strong>Request Body</strong>:
<pre><code class="json">{
  "to": "+15551234567",
  "message": "Alert: Walk-in Cooler temperature at 48Â°F"
}
</code></pre></p><p>---</p><p><h3><code>run-simulator-heartbeats</code></h3></p><p><strong>Purpose</strong>: Generate simulated device heartbeats</p><p><strong>File</strong>: <code>supabase/functions/run-simulator-heartbeats/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p>---</p><p><h3><code>emulator-sync</code></h3></p><p><strong>Purpose</strong>: Sync with external emulator</p><p><strong>File</strong>: <code>supabase/functions/emulator-sync/index.ts</code></p><p><strong>Method</strong>: <code>POST</code></p><p><strong>Authentication</strong>: Internal API Key</p><p>---</p><p><h2>Database RPC Functions</h2></p><p><h3><code>get_effective_alert_rules</code></h3></p><p><strong>Purpose</strong>: Resolve cascaded alert rules for a unit</p><p><strong>Signature</strong>:
<pre><code class="sql">get_effective_alert_rules(p_unit_id UUID) RETURNS JSON
</code></pre></p><p><strong>Usage</strong>:
<pre><code class="typescript">const { data } = await supabase.rpc('get_effective_alert_rules', {
  p_unit_id: unitId
});
</code></pre></p><p><strong>Returns</strong>: Merged alert rules with cascade priority (Unit > Site > Org)</p><p>---</p><p><h3><code>get_effective_notification_policy</code></h3></p><p><strong>Purpose</strong>: Resolve cascaded notification policy</p><p><strong>Signature</strong>:
<pre><code class="sql">get_effective_notification_policy(
  p_unit_id UUID,
  p_alert_type TEXT
) RETURNS JSON
</code></pre></p><p>---</p><p><h3><code>create_organization_with_owner</code></h3></p><p><strong>Purpose</strong>: Create organization and assign owner role atomically</p><p><strong>Signature</strong>:
<pre><code class="sql">create_organization_with_owner(
  p_name TEXT,
  p_slug TEXT,
  p_owner_id UUID
) RETURNS UUID
</code></pre></p><p>---</p><p><h3><code>user_belongs_to_org</code></h3></p><p><strong>Purpose</strong>: Check if user belongs to organization</p><p><strong>Signature</strong>:
<pre><code class="sql">user_belongs_to_org(p_user_id UUID, p_org_id UUID) RETURNS BOOLEAN
</code></pre></p><p>---</p><p><h3><code>has_role</code></h3></p><p><strong>Purpose</strong>: Check if user has specific role in organization</p><p><strong>Signature</strong>:
<pre><code class="sql">has_role(p_user_id UUID, p_role TEXT, p_org_id UUID) RETURNS BOOLEAN
</code></pre></p><p>---</p><p><h3><code>create_site_for_org</code></h3></p><p><strong>Purpose</strong>: Create site with proper hierarchy</p><p><strong>Signature</strong>:
<pre><code class="sql">create_site_for_org(
  p_org_id UUID,
  p_name TEXT,
  p_address TEXT
) RETURNS UUID
</code></pre></p><p>---</p><p><h3><code>create_area_for_site</code></h3></p><p><strong>Purpose</strong>: Create area within site</p><p><strong>Signature</strong>:
<pre><code class="sql">create_area_for_site(
  p_site_id UUID,
  p_name TEXT
) RETURNS UUID
</code></pre></p><p>---</p><p><h3><code>create_unit_for_area</code></h3></p><p><strong>Purpose</strong>: Create unit within area</p><p><strong>Signature</strong>:
<pre><code class="sql">create_unit_for_area(
  p_area_id UUID,
  p_name TEXT,
  p_temp_limit_high NUMERIC,
  p_temp_limit_low NUMERIC
) RETURNS UUID
</code></pre></p><p>---</p><p><h3><code>enqueue_deprovision_jobs_for_unit</code></h3></p><p><strong>Purpose</strong>: Queue TTN deprovisioning when unit is deleted</p><p><strong>Signature</strong>:
<pre><code class="sql">enqueue_deprovision_jobs_for_unit(p_unit_id UUID) RETURNS VOID
</code></pre></p><p>---</p><p><h3><code>soft_delete_organization</code></h3></p><p><strong>Purpose</strong>: Soft delete organization and cascade</p><p><strong>Signature</strong>:
<pre><code class="sql">soft_delete_organization(p_org_id UUID) RETURNS VOID
</code></pre></p><p>---</p><p><h3><code>find_orphan_organizations</code></h3></p><p><strong>Purpose</strong>: Find organizations without owners</p><p><strong>Signature</strong>:
<pre><code class="sql">find_orphan_organizations() RETURNS TABLE(id UUID, name TEXT)
</code></pre></p><p>---</p><p><h2>Error Handling</h2></p><p><h3>Standard Error Response</h3></p><p><pre><code class="json">{
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": {}
}
</code></pre></p><p><h3>Common Error Codes</h3></p><p>| Code | HTTP Status | Meaning |
|------|-------------|---------|
| <code>UNAUTHORIZED</code> | 401 | Missing or invalid authentication |
| <code>FORBIDDEN</code> | 403 | Insufficient permissions |
| <code>NOT_FOUND</code> | 404 | Resource not found |
| <code>VALIDATION_ERROR</code> | 400 | Invalid request body |
| <code>RATE_LIMITED</code> | 429 | Too many requests |
| <code>INTERNAL_ERROR</code> | 500 | Server error |</p><p><h3>Retry Behavior</h3></p><p>| Scenario | Retry |
|----------|-------|
| Network error | Yes, with exponential backoff |
| 5xx error | Yes, up to 3 times |
| 4xx error | No (fix request) |
| Timeout | Yes, once |</p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#integrations">INTEGRATIONS.md</a> - Third-party service configuration</li>
<li><a href="#data_model">DATA_MODEL.md</a> - Database schema</li>
<li><a href="#charts-flowcharts">FLOWCHARTS.md</a> - Visual process flows</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="engineering-data_model"></a></p><p><h1>FreshTrack Pro Data Model</h1></p><p><blockquote>Complete database schema documentation</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#overview">Overview</a></li>
<li><a href="#entity-relationships">Entity Relationships</a></li>
<li><a href="#hierarchy-tables">Hierarchy Tables</a></li>
<li><a href="#sensor-tables">Sensor Tables</a></li>
<li><a href="#alert-tables">Alert Tables</a></li>
<li><a href="#notification-tables">Notification Tables</a></li>
<li><a href="#compliance-tables">Compliance Tables</a></li>
<li><a href="#ttn-tables">TTN Tables</a></li>
<li><a href="#user-tables">User Tables</a></li>
<li><a href="#billing-tables">Billing Tables</a></li>
<li><a href="#system-tables">System Tables</a></li>
<li><a href="#enums">Enums</a></li>
<li><a href="#rls-policies">RLS Policies</a></li></p><p>---</p><p><h2>Overview</h2></p><p><h3>Database</h3></p><p><li><strong>Engine</strong>: PostgreSQL 14.1</li>
<li><strong>Platform</strong>: Supabase</li>
<li><strong>Schema</strong>: <code>public</code></li>
<li><strong>Total Tables</strong>: 60+</li>
<li><strong>Migrations</strong>: 100+ files in <code>supabase/migrations/</code></li></p><p><h3>Type Definitions</h3></p><p>Auto-generated TypeScript types: <code>src/integrations/supabase/types.ts</code></p><p><h3>Key Patterns</h3></p><p><li><strong>UUID Primary Keys</strong>: All tables use UUID <code>id</code> columns</li>
<li><strong>Timestamps</strong>: <code>created_at</code>, <code>updated_at</code> on most tables</li>
<li><strong>Soft Delete</strong>: <code>deleted_at</code>, <code>deleted_by</code> on hierarchy tables</li>
<li><strong>Audit Trail</strong>: <code>event_logs</code> for significant changes</li>
<li><strong>RLS</strong>: Row-Level Security on all user-accessible tables</li></p><p>---</p><p><h2>Entity Relationships</h2></p><p>See <a href="#charts-er_diagram">ER_DIAGRAM.md</a> for visual diagram.</p><p><h3>Core Hierarchy</h3></p><p><pre><code class="">organizations (tenant)
    â”‚
    â”œâ”€â”€ sites (physical location)
    â”‚       â”‚
    â”‚       â””â”€â”€ areas (zone/room)
    â”‚               â”‚
    â”‚               â””â”€â”€ units (refrigeration unit)
    â”‚                       â”‚
    â”‚                       â”œâ”€â”€ lora_sensors (assigned)
    â”‚                       â”œâ”€â”€ sensor_readings
    â”‚                       â”œâ”€â”€ manual_temperature_logs
    â”‚                       â””â”€â”€ alerts
    â”‚
    â”œâ”€â”€ lora_sensors (inventory)
    â”œâ”€â”€ gateways (inventory)
    â”œâ”€â”€ ttn_connections
    â””â”€â”€ user_roles
</code></pre></p><p>---</p><p><h2>Hierarchy Tables</h2></p><p><h3><code>organizations</code></h3></p><p><strong>Purpose</strong>: Top-level tenant entity</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>name</code> | TEXT | Organization name |
| <code>slug</code> | TEXT | URL-safe identifier (unique) |
| <code>compliance_mode</code> | ENUM | <code>HACCP</code>, <code>FDA</code>, <code>GENERAL</code> |
| <code>timezone</code> | TEXT | IANA timezone |
| <code>temp_unit</code> | TEXT | <code>fahrenheit</code> or <code>celsius</code> |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |
| <code>deleted_at</code> | TIMESTAMP | Soft delete marker |
| <code>deleted_by</code> | UUID | User who deleted |</p><p><strong>Indexes</strong>:
<li><code>organizations_slug_key</code> (unique)</li></p><p>---</p><p><h3><code>sites</code></h3></p><p><strong>Purpose</strong>: Physical location within organization</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK to organizations |
| <code>name</code> | TEXT | Site name |
| <code>address</code> | TEXT | Physical address |
| <code>timezone</code> | TEXT | Site timezone override |
| <code>is_active</code> | BOOLEAN | Active status |
| <code>sort_order</code> | INTEGER | Display order |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |
| <code>deleted_at</code> | TIMESTAMP | Soft delete |
| <code>deleted_by</code> | UUID | |</p><p><strong>Relationships</strong>:
<li><code>organization_id</code> â†’ <code>organizations.id</code></li></p><p>---</p><p><h3><code>areas</code></h3></p><p><strong>Purpose</strong>: Logical zone within a site</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>site_id</code> | UUID | FK to sites |
| <code>name</code> | TEXT | Area name |
| <code>description</code> | TEXT | Optional description |
| <code>is_active</code> | BOOLEAN | Active status |
| <code>sort_order</code> | INTEGER | Display order |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |
| <code>deleted_at</code> | TIMESTAMP | |
| <code>deleted_by</code> | UUID | |</p><p><strong>Relationships</strong>:
<li><code>site_id</code> â†’ <code>sites.id</code></li></p><p>---</p><p><h3><code>units</code></h3></p><p><strong>Purpose</strong>: Monitored refrigeration unit</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>area_id</code> | UUID | FK to areas |
| <code>name</code> | TEXT | Unit name |
| <code>status</code> | TEXT | Current status (ok, excursion, etc.) |
| <code>temp_limit_high</code> | NUMERIC | High temperature threshold |
| <code>temp_limit_low</code> | NUMERIC | Low temperature threshold (optional) |
| <code>temp_hysteresis</code> | NUMERIC | Hysteresis buffer |
| <code>last_temp_reading</code> | NUMERIC | Cached last temperature |
| <code>last_reading_at</code> | TIMESTAMP | Last sensor reading time |
| <code>last_checkin_at</code> | TIMESTAMP | Last check-in time |
| <code>checkin_interval_minutes</code> | INTEGER | Expected reading interval |
| <code>last_manual_log_at</code> | TIMESTAMP | Last manual log time |
| <code>manual_log_cadence</code> | INTEGER | Manual log interval (seconds) |
| <code>door_state</code> | TEXT | <code>open</code>, <code>closed</code>, <code>unknown</code> |
| <code>door_last_changed_at</code> | TIMESTAMP | Door state change time |
| <code>door_open_grace_minutes</code> | INTEGER | Door open grace period |
| <code>confirm_time_door_closed</code> | INTEGER | Confirm time (door closed) |
| <code>confirm_time_door_open</code> | INTEGER | Confirm time (door open) |
| <code>last_status_change</code> | TIMESTAMP | Status change time |
| <code>sensor_reliable</code> | BOOLEAN | Sensor reliability flag |
| <code>is_active</code> | BOOLEAN | Active status |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |
| <code>deleted_at</code> | TIMESTAMP | |
| <code>deleted_by</code> | UUID | |</p><p><strong>Relationships</strong>:
<li><code>area_id</code> â†’ <code>areas.id</code></li></p><p><strong>Indexes</strong>:
<li><code>units_area_id_idx</code></li>
<li><code>units_status_idx</code></li></p><p>---</p><p><h2>Sensor Tables</h2></p><p><h3><code>lora_sensors</code></h3></p><p><strong>Purpose</strong>: LoRa sensor inventory and assignment</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | Owner organization |
| <code>site_id</code> | UUID | Assigned site (optional) |
| <code>unit_id</code> | UUID | Assigned unit (optional) |
| <code>name</code> | TEXT | Sensor name |
| <code>dev_eui</code> | TEXT | Device EUI (normalized) |
| <code>ttn_device_id</code> | TEXT | TTN device ID |
| <code>ttn_application_id</code> | TEXT | TTN application |
| <code>sensor_type</code> | ENUM | Sensor type |
| <code>status</code> | ENUM | <code>pending</code>, <code>joining</code>, <code>active</code>, <code>offline</code>, <code>fault</code> |
| <code>is_primary</code> | BOOLEAN | Primary sensor for unit |
| <code>battery_level</code> | NUMERIC | Battery percentage |
| <code>signal_strength</code> | INTEGER | RSSI |
| <code>last_seen_at</code> | TIMESTAMP | Last data received |
| <code>last_join_at</code> | TIMESTAMP | Last TTN join |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p><strong>Relationships</strong>:
<li><code>organization_id</code> â†’ <code>organizations.id</code></li>
<li><code>site_id</code> â†’ <code>sites.id</code></li>
<li><code>unit_id</code> â†’ <code>units.id</code></li></p><p><strong>Indexes</strong>:
<li><code>lora_sensors_dev_eui_idx</code></li>
<li><code>lora_sensors_organization_id_idx</code></li>
<li><code>lora_sensors_unit_id_idx</code></li></p><p>---</p><p><h3><code>gateways</code></h3></p><p><strong>Purpose</strong>: LoRa gateway inventory</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | Owner organization |
| <code>site_id</code> | UUID | Assigned site |
| <code>name</code> | TEXT | Gateway name |
| <code>eui</code> | TEXT | Gateway EUI |
| <code>status</code> | ENUM | <code>pending</code>, <code>online</code>, <code>offline</code>, <code>maintenance</code> |
| <code>ttn_gateway_id</code> | TEXT | TTN gateway ID |
| <code>frequency_plan</code> | TEXT | Frequency plan |
| <code>last_seen_at</code> | TIMESTAMP | Last seen |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p><strong>Relationships</strong>:
<li><code>organization_id</code> â†’ <code>organizations.id</code></li>
<li><code>site_id</code> â†’ <code>sites.id</code></li></p><p>---</p><p><h3><code>sensor_readings</code></h3></p><p><strong>Purpose</strong>: Raw sensor data</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>unit_id</code> | UUID | FK to units |
| <code>lora_sensor_id</code> | UUID | FK to lora_sensors |
| <code>device_id</code> | UUID | FK to devices (legacy) |
| <code>temperature</code> | NUMERIC | Temperature reading |
| <code>humidity</code> | NUMERIC | Humidity reading |
| <code>battery_level</code> | NUMERIC | Battery at time of reading |
| <code>signal_strength</code> | INTEGER | Signal strength |
| <code>door_open</code> | BOOLEAN | Door state |
| <code>source</code> | TEXT | <code>ttn</code>, <code>simulator</code>, <code>manual</code> |
| <code>recorded_at</code> | TIMESTAMP | Reading timestamp |
| <code>created_at</code> | TIMESTAMP | Insert time |</p><p><strong>Relationships</strong>:
<li><code>unit_id</code> â†’ <code>units.id</code></li>
<li><code>lora_sensor_id</code> â†’ <code>lora_sensors.id</code></li></p><p><strong>Indexes</strong>:
<li><code>sensor_readings_unit_id_recorded_at_idx</code></li>
<li><code>sensor_readings_lora_sensor_id_idx</code></li></p><p>---</p><p><h3><code>manual_temperature_logs</code></h3></p><p><strong>Purpose</strong>: User-entered temperature readings</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>unit_id</code> | UUID | FK to units |
| <code>temperature</code> | NUMERIC | Logged temperature |
| <code>notes</code> | TEXT | Optional notes |
| <code>logged_by</code> | UUID | User who logged |
| <code>logged_at</code> | TIMESTAMP | Log timestamp |
| <code>created_at</code> | TIMESTAMP | |</p><p><strong>Relationships</strong>:
<li><code>unit_id</code> â†’ <code>units.id</code></li>
<li><code>logged_by</code> â†’ <code>profiles.id</code></li></p><p>---</p><p><h3><code>door_events</code></h3></p><p><strong>Purpose</strong>: Door open/close events</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>unit_id</code> | UUID | FK to units |
| <code>state</code> | TEXT | <code>open</code> or <code>closed</code> |
| <code>occurred_at</code> | TIMESTAMP | Event time |
| <code>source</code> | TEXT | Event source |
| <code>metadata</code> | JSONB | Additional data |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h2>Alert Tables</h2></p><p><h3><code>alerts</code></h3></p><p><strong>Purpose</strong>: Active and historical alerts</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>site_id</code> | UUID | FK |
| <code>area_id</code> | UUID | FK |
| <code>unit_id</code> | UUID | FK |
| <code>alert_type</code> | ENUM | Alert type |
| <code>severity</code> | ENUM | <code>warning</code>, <code>critical</code> |
| <code>status</code> | ENUM | <code>triggered</code>, <code>acknowledged</code>, <code>resolved</code> |
| <code>title</code> | TEXT | Alert title |
| <code>message</code> | TEXT | Alert message |
| <code>temp_reading</code> | NUMERIC | Temperature at trigger |
| <code>temp_limit</code> | NUMERIC | Threshold that was exceeded |
| <code>source</code> | TEXT | <code>sensor</code>, <code>system</code> |
| <code>triggered_at</code> | TIMESTAMP | Trigger time |
| <code>first_active_at</code> | TIMESTAMP | First active time |
| <code>acknowledged_at</code> | TIMESTAMP | Acknowledgment time |
| <code>acknowledged_by</code> | UUID | User who acknowledged |
| <code>acknowledgment_notes</code> | TEXT | Acknowledgment notes |
| <code>resolved_at</code> | TIMESTAMP | Resolution time |
| <code>resolved_by</code> | UUID | User or <code>system</code> |
| <code>escalation_level</code> | INTEGER | Current escalation level |
| <code>last_notified_at</code> | TIMESTAMP | Last notification time |
| <code>next_escalation_at</code> | TIMESTAMP | Next escalation time |
| <code>escalation_steps_sent</code> | JSONB | Sent escalation steps |
| <code>metadata</code> | JSONB | Additional data |
| <code>ack_required</code> | BOOLEAN | Requires acknowledgment |
| <code>created_at</code> | TIMESTAMP | |</p><p><strong>Relationships</strong>:
<li>All hierarchy FKs</li></p><p><strong>Indexes</strong>:
<li><code>alerts_unit_id_status_idx</code></li>
<li><code>alerts_organization_id_status_idx</code></li>
<li><code>alerts_triggered_at_idx</code></li></p><p>---</p><p><h3><code>alert_rules</code></h3></p><p><strong>Purpose</strong>: Configurable alert thresholds</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | Org-level rule |
| <code>site_id</code> | UUID | Site-level rule |
| <code>unit_id</code> | UUID | Unit-level rule |
| <code>offline_warning_missed_checkins</code> | INTEGER | Warning threshold |
| <code>offline_critical_missed_checkins</code> | INTEGER | Critical threshold |
| <code>offline_trigger_multiplier</code> | NUMERIC | Multiplier |
| <code>offline_trigger_additional_minutes</code> | INTEGER | Additional minutes |
| <code>manual_interval_minutes</code> | INTEGER | Manual log interval |
| <code>manual_grace_minutes</code> | INTEGER | Grace period |
| <code>manual_log_missed_checkins_threshold</code> | INTEGER | Threshold |
| <code>door_open_warning_minutes</code> | INTEGER | Door warning |
| <code>door_open_critical_minutes</code> | INTEGER | Door critical |
| <code>door_open_max_mask_minutes_per_day</code> | INTEGER | Max mask time |
| <code>excursion_confirm_minutes_door_closed</code> | INTEGER | Confirm time |
| <code>excursion_confirm_minutes_door_open</code> | INTEGER | Confirm time |
| <code>max_excursion_minutes</code> | INTEGER | Max excursion |
| <code>expected_reading_interval_seconds</code> | INTEGER | Expected interval |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p><strong>Notes</strong>:
<li>Only one of <code>organization_id</code>, <code>site_id</code>, <code>unit_id</code> should be set</li>
<li>Use <code>get_effective_alert_rules()</code> RPC for cascade resolution</li></p><p>---</p><p><h3><code>alert_rules_history</code></h3></p><p><strong>Purpose</strong>: Audit trail for alert rule changes</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>alert_rules_id</code> | UUID | FK to alert_rules |
| <code>organization_id</code> | UUID | Scope |
| <code>site_id</code> | UUID | Scope |
| <code>unit_id</code> | UUID | Scope |
| <code>action</code> | TEXT | <code>create</code>, <code>update</code>, <code>delete</code> |
| <code>changes</code> | JSONB | Changed fields |
| <code>changed_by</code> | UUID | User |
| <code>changed_at</code> | TIMESTAMP | |
| <code>note</code> | TEXT | Optional note |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h2>Notification Tables</h2></p><p><h3><code>notification_policies</code></h3></p><p><strong>Purpose</strong>: Per-alert-type notification configuration</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | Scope |
| <code>site_id</code> | UUID | Scope |
| <code>unit_id</code> | UUID | Scope |
| <code>alert_type</code> | ENUM | Alert type |
| <code>enabled</code> | BOOLEAN | Policy enabled |
| <code>channels</code> | JSONB | <code>{email: true, sms: false, push: true}</code> |
| <code>escalation_minutes</code> | INTEGER[] | Escalation intervals |
| <code>quiet_start</code> | TIME | Quiet hours start |
| <code>quiet_end</code> | TIME | Quiet hours end |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>escalation_contacts</code></h3></p><p><strong>Purpose</strong>: Contacts for alert escalation</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>site_id</code> | UUID | FK (optional) |
| <code>name</code> | TEXT | Contact name |
| <code>email</code> | TEXT | Email address |
| <code>phone</code> | TEXT | Phone (E.164) |
| <code>escalation_level</code> | INTEGER | Level (1, 2, 3...) |
| <code>is_active</code> | BOOLEAN | Active status |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>notification_events</code></h3></p><p><strong>Purpose</strong>: Record of notification attempts</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>alert_id</code> | UUID | FK to alerts |
| <code>channel</code> | TEXT | <code>email</code>, <code>sms</code>, <code>push</code> |
| <code>recipient</code> | TEXT | Email/phone |
| <code>status</code> | TEXT | <code>pending</code>, <code>sent</code>, <code>failed</code> |
| <code>sent_at</code> | TIMESTAMP | Send time |
| <code>error_message</code> | TEXT | Error if failed |
| <code>metadata</code> | JSONB | Additional data |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>sms_alert_log</code></h3></p><p><strong>Purpose</strong>: SMS delivery log</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>alert_id</code> | UUID | FK to alerts |
| <code>phone_number</code> | TEXT | Recipient (masked) |
| <code>message</code> | TEXT | Message content |
| <code>twilio_sid</code> | TEXT | Twilio message SID |
| <code>status</code> | TEXT | Delivery status |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h2>Compliance Tables</h2></p><p><h3><code>corrective_actions</code></h3></p><p><strong>Purpose</strong>: HACCP corrective action documentation</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>unit_id</code> | UUID | FK to units |
| <code>alert_id</code> | UUID | FK to alerts (optional) |
| <code>action_taken</code> | TEXT | Description of action |
| <code>root_cause</code> | TEXT | Root cause analysis |
| <code>preventive_measures</code> | TEXT | Future prevention |
| <code>photo_urls</code> | TEXT[] | Photo evidence |
| <code>created_by</code> | UUID | User |
| <code>completed_at</code> | TIMESTAMP | Completion time |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>calibration_records</code></h3></p><p><strong>Purpose</strong>: Sensor calibration history</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>device_id</code> | UUID | FK to devices |
| <code>reference_temp</code> | NUMERIC | Reference thermometer |
| <code>measured_temp</code> | NUMERIC | Sensor reading |
| <code>offset_applied</code> | NUMERIC | Calibration offset |
| <code>performed_by</code> | UUID | User |
| <code>calibrated_at</code> | TIMESTAMP | |
| <code>next_calibration_due</code> | TIMESTAMP | |
| <code>notes</code> | TEXT | |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>event_logs</code></h3></p><p><strong>Purpose</strong>: Comprehensive audit trail</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>site_id</code> | UUID | FK (optional) |
| <code>unit_id</code> | UUID | FK (optional) |
| <code>event_type</code> | TEXT | Event type code |
| <code>category</code> | TEXT | <code>alert</code>, <code>temperature</code>, <code>configuration</code>, <code>user</code> |
| <code>severity</code> | TEXT | <code>info</code>, <code>warning</code>, <code>error</code> |
| <code>title</code> | TEXT | Human-readable title |
| <code>event_data</code> | JSONB | Event details |
| <code>actor_id</code> | UUID | User or system |
| <code>actor_type</code> | TEXT | <code>user</code>, <code>system</code> |
| <code>created_at</code> | TIMESTAMP | |</p><p><strong>Indexes</strong>:
<li><code>event_logs_organization_id_created_at_idx</code></li>
<li><code>event_logs_unit_id_idx</code></li>
<li><code>event_logs_event_type_idx</code></li></p><p>---</p><p><h2>TTN Tables</h2></p><p><h3><code>ttn_connections</code></h3></p><p><strong>Purpose</strong>: Per-organization TTN credentials</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK (unique) |
| <code>application_id</code> | TEXT | TTN application ID |
| <code>api_key</code> | TEXT | Encrypted API key |
| <code>webhook_secret</code> | TEXT | Webhook secret (hashed) |
| <code>cluster</code> | TEXT | TTN cluster (e.g., <code>eu1</code>) |
| <code>webhook_url</code> | TEXT | Configured webhook URL |
| <code>is_configured</code> | BOOLEAN | Setup complete |
| <code>last_sync_at</code> | TIMESTAMP | Last sync |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>ttn_provisioning_queue</code></h3></p><p><strong>Purpose</strong>: Device provisioning job queue</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>sensor_id</code> | UUID | FK to lora_sensors |
| <code>gateway_id</code> | UUID | FK to gateways |
| <code>action</code> | TEXT | <code>provision</code>, <code>deprovision</code> |
| <code>status</code> | TEXT | <code>pending</code>, <code>processing</code>, <code>complete</code>, <code>failed</code> |
| <code>attempts</code> | INTEGER | Retry count |
| <code>last_error</code> | TEXT | Error message |
| <code>processed_at</code> | TIMESTAMP | |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>ttn_provisioning_logs</code></h3></p><p><strong>Purpose</strong>: Provisioning history</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>queue_id</code> | UUID | FK to queue |
| <code>organization_id</code> | UUID | FK |
| <code>action</code> | TEXT | Action performed |
| <code>success</code> | BOOLEAN | Success flag |
| <code>response</code> | JSONB | API response |
| <code>error</code> | TEXT | Error if failed |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>ttn_deprovision_jobs</code></h3></p><p><strong>Purpose</strong>: Deprovisioning job tracking</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>sensor_id</code> | UUID | FK |
| <code>dev_eui</code> | TEXT | Device EUI |
| <code>status</code> | TEXT | Job status |
| <code>created_at</code> | TIMESTAMP | |
| <code>processed_at</code> | TIMESTAMP | |</p><p>---</p><p><h2>User Tables</h2></p><p><h3><code>profiles</code></h3></p><p><strong>Purpose</strong>: User account information</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key (= auth.users.id) |
| <code>email</code> | TEXT | Email address |
| <code>full_name</code> | TEXT | Display name |
| <code>phone</code> | TEXT | Phone number |
| <code>avatar_url</code> | TEXT | Profile picture |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>user_roles</code></h3></p><p><strong>Purpose</strong>: Role-based access control</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>user_id</code> | UUID | FK to profiles |
| <code>organization_id</code> | UUID | FK to organizations |
| <code>role</code> | ENUM | <code>owner</code>, <code>manager</code>, <code>operator</code>, <code>viewer</code> |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p><strong>Unique</strong>: <code>(user_id, organization_id)</code></p><p>---</p><p><h2>Billing Tables</h2></p><p><h3><code>subscriptions</code></h3></p><p><strong>Purpose</strong>: Stripe subscription records</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>stripe_subscription_id</code> | TEXT | Stripe ID |
| <code>stripe_customer_id</code> | TEXT | Stripe customer |
| <code>plan_id</code> | TEXT | Plan identifier |
| <code>status</code> | TEXT | Subscription status |
| <code>current_period_start</code> | TIMESTAMP | |
| <code>current_period_end</code> | TIMESTAMP | |
| <code>cancel_at</code> | TIMESTAMP | |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>invoices</code></h3></p><p><strong>Purpose</strong>: Billing invoice records</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>stripe_invoice_id</code> | TEXT | Stripe ID |
| <code>amount</code> | INTEGER | Amount in cents |
| <code>status</code> | TEXT | Invoice status |
| <code>paid_at</code> | TIMESTAMP | |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h2>System Tables</h2></p><p><h3><code>org_sync_state</code></h3></p><p><strong>Purpose</strong>: Emulator sync state tracking</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | FK |
| <code>last_sync_at</code> | TIMESTAMP | |
| <code>sync_version</code> | INTEGER | |
| <code>state_hash</code> | TEXT | |
| <code>created_at</code> | TIMESTAMP | |
| <code>updated_at</code> | TIMESTAMP | |</p><p>---</p><p><h3><code>account_deletion_jobs</code></h3></p><p><strong>Purpose</strong>: GDPR deletion job tracking</p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>user_id</code> | UUID | User to delete |
| <code>organization_id</code> | UUID | |
| <code>status</code> | TEXT | Job status |
| <code>current_step</code> | TEXT | Current step |
| <code>steps_completed</code> | JSONB | Completed steps |
| <code>error_message</code> | TEXT | |
| <code>completed_at</code> | TIMESTAMP | |
| <code>created_at</code> | TIMESTAMP | |</p><p>---</p><p><h2>Enums</h2></p><p><h3><code>alert_type</code></h3></p><p><pre><code class="sql">CREATE TYPE alert_type AS ENUM (
  'temp_excursion',
  'monitoring_interrupted',
  'door_open',
  'low_battery',
  'sensor_fault',
  'suspected_cooling_failure',
  'calibration_due',
  'missed_manual_entry'
);
</code></pre></p><p><h3><code>alert_severity</code></h3></p><p><pre><code class="sql">CREATE TYPE alert_severity AS ENUM (
  'warning',
  'critical'
);
</code></pre></p><p><h3><code>alert_status</code></h3></p><p><pre><code class="sql">CREATE TYPE alert_status AS ENUM (
  'triggered',
  'acknowledged',
  'resolved'
);
</code></pre></p><p><h3><code>app_role</code></h3></p><p><pre><code class="sql">CREATE TYPE app_role AS ENUM (
  'owner',
  'manager',
  'operator',
  'viewer'
);
</code></pre></p><p><h3><code>compliance_mode</code></h3></p><p><pre><code class="sql">CREATE TYPE compliance_mode AS ENUM (
  'HACCP',
  'FDA',
  'GENERAL'
);
</code></pre></p><p><h3><code>lora_sensor_type</code></h3></p><p><pre><code class="sql">CREATE TYPE lora_sensor_type AS ENUM (
  'temperature',
  'temperature_humidity',
  'door',
  'combo',
  'contact'
);
</code></pre></p><p><h3><code>lora_sensor_status</code></h3></p><p><pre><code class="sql">CREATE TYPE lora_sensor_status AS ENUM (
  'pending',
  'joining',
  'active',
  'offline',
  'fault'
);
</code></pre></p><p><h3><code>gateway_status</code></h3></p><p><pre><code class="sql">CREATE TYPE gateway_status AS ENUM (
  'pending',
  'online',
  'offline',
  'maintenance'
);
</code></pre></p><p>---</p><p><h2>RLS Policies</h2></p><p><h3>Common Pattern</h3></p><p><pre><code class="sql">-- Users can only access their organization's data
CREATE POLICY "Organization members can view" ON table_name
  FOR SELECT
  USING (
    organization_id IN (
      SELECT organization_id FROM user_roles
      WHERE user_id = auth.uid()
    )
  );
</code></pre></p><p><h3>Table-Specific Policies</h3></p><p>| Table | Policy | Description |
|-------|--------|-------------|
| <code>organizations</code> | org_member | User in org via user_roles |
| <code>sites</code> | org_member | Org owns site |
| <code>areas</code> | site_member | Site â†’ Org chain |
| <code>units</code> | area_member | Area â†’ Site â†’ Org chain |
| <code>alerts</code> | org_member | Org owns alert |
| <code>sensor_readings</code> | unit_member | Unit â†’ Area â†’ Site â†’ Org chain |
| <code>lora_sensors</code> | org_member | Org owns sensor |</p><p><h3>Role-Based Policies</h3></p><p><pre><code class="sql">-- Only managers and owners can modify
CREATE POLICY "Managers can update" ON units
  FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid()
        AND organization_id = (
          SELECT organization_id FROM sites s
          JOIN areas a ON a.site_id = s.id
          WHERE a.id = units.area_id
        )
        AND role IN ('owner', 'manager')
    )
  );
</code></pre></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#charts-er_diagram">ER_DIAGRAM.md</a> - Visual entity-relationship diagram</li>
<li><a href="#api">API.md</a> - RPC function documentation</li>
<li><a href="#architecture-architecture">ARCHITECTURE.md</a> - Database architecture</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="engineering-integrations"></a></p><p><h1>FreshTrack Pro Integrations</h1></p><p><blockquote>Third-party service integration documentation</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#the-things-network-ttn">The Things Network (TTN)</a></li>
<li><a href="#stripe">Stripe</a></li>
<li><a href="#twilio">Twilio</a></li>
<li><a href="#supabase-auth">Supabase Auth</a></li>
<li><a href="#environment-variables">Environment Variables</a></li></p><p>---</p><p><h2>The Things Network (TTN)</h2></p><p><h3>Overview</h3></p><p>The Things Network provides LoRaWAN infrastructure for sensor connectivity. FreshTrack Pro integrates with TTN for:
<li>Device registration and provisioning</li>
<li>Webhook-based data ingestion</li>
<li>Gateway management</li></p><p><h3>Architecture</h3></p><p><pre><code class="">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     LoRa      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     HTTPS     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sensor    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Gateway   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     TTN     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                                                              Webhook
                                                                   â”‚
                                                                   â–¼
                                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                            â”‚ ttn-webhook â”‚
                                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p><h3>Per-Organization Model</h3></p><p>Each organization has its own:
<li>TTN Application</li>
<li>API Key</li>
<li>Webhook Secret</li></p><p>Stored in <code>ttn_connections</code> table with:
<li>Encrypted API key</li>
<li>Hashed webhook secret</li></p><p><h3>Setup Process</h3></p><p>#### 1. Prerequisites</p><p><li>TTN account at <a href="https://console.thethingsnetwork.org/">console.thethingsnetwork.org</a></li>
<li>TTN Application created</li>
<li>API Key with required permissions</li></p><p>#### 2. Required API Key Permissions</p><p>The TTN API key must have:</p><p>| Permission | Purpose |
|------------|---------|
| <code>applications:read</code> | Read application info |
| <code>applications:write</code> | Update application |
| <code>devices:read</code> | List devices |
| <code>devices:write</code> | Create/update devices |
| <code>gateways:read</code> | List gateways |
| <code>gateways:write</code> | Create/update gateways (if managing gateways) |</p><p>#### 3. Configuration Steps</p><p><li><strong>In FreshTrack Pro Settings â†’ TTN Tab</strong>:</li>
   - Enter TTN Application ID
   - Enter TTN API Key
   - Click "Validate & Connect"</p><p><li><strong>System automatically</strong>:</li>
   - Validates API key permissions (<code>ttn-gateway-preflight</code>)
   - Configures webhook in TTN (<code>ttn-bootstrap</code>)
   - Stores encrypted credentials</p><p><li><strong>Verify webhook</strong>:</li>
   - TTN Application â†’ Webhooks â†’ Should show <code>freshtrack-webhook</code></p><p><h3>Webhook Configuration</h3></p><p><strong>Endpoint</strong>: <code>https://<project>.supabase.co/functions/v1/ttn-webhook</code></p><p><strong>Headers</strong>:
| Header | Value |
|--------|-------|
| <code>X-Webhook-Secret</code> | Per-org secret from <code>ttn_connections.webhook_secret</code> |
| <code>Content-Type</code> | <code>application/json</code> |</p><p><strong>Enabled Messages</strong>:
<li>Uplink message</li>
<li>Join accept (optional)</li></p><p><h3>Device Provisioning</h3></p><p>#### Add Sensor Flow</p><p><li>User enters DevEUI, JoinEUI, AppKey</li>
<li>System queues job in <code>ttn_provisioning_queue</code></li>
<li><code>ttn-provision-device</code> registers in TTN</li>
<li>Sensor status changes: <code>pending</code> â†’ <code>joining</code> â†’ <code>active</code></li></p><p>#### DevEUI Formats Supported</p><p>The system normalizes DevEUI to lowercase hex without separators:</p><p>| Input Format | Normalized |
|--------------|------------|
| <code>0004A30B001C1234</code> | <code>0004a30b001c1234</code> |
| <code>00:04:A3:0B:00:1C:12:34</code> | <code>0004a30b001c1234</code> |
| <code>00-04-A3-0B-00-1C-12-34</code> | <code>0004a30b001c1234</code> |
| <code>00 04 A3 0B 00 1C 12 34</code> | <code>0004a30b001c1234</code> |</p><p><h3>TTN Cluster</h3></p><p>Default cluster: <code>eu1</code> (Europe)</p><p>Configure via <code>ttn_connections.cluster</code>:
<li><code>eu1</code> - Europe (default)</li>
<li><code>nam1</code> - North America</li>
<li><code>au1</code> - Australia</li></p><p><h3>Troubleshooting</h3></p><p>| Issue | Cause | Solution |
|-------|-------|----------|
| Webhook not receiving data | Secret mismatch | Regenerate secret, update TTN |
| Device stuck in "joining" | Wrong AppKey | Verify AppKey matches TTN |
| 401 from TTN API | Invalid API key | Generate new key with correct permissions |
| Sensor not in dashboard | DevEUI mismatch | Check DevEUI format/normalization |</p><p><h3>Related Files</h3></p><p><li><code>supabase/functions/ttn-webhook/index.ts</code></li>
<li><code>supabase/functions/ttn-bootstrap/index.ts</code></li>
<li><code>supabase/functions/ttn-provision-device/index.ts</code></li>
<li><code>supabase/functions/_shared/ttnConfig.ts</code></li>
<li><code>supabase/functions/_shared/ttnPermissions.ts</code></li>
<li><code>src/components/settings/TTNConnectionSettings.tsx</code></li>
<li><code>src/types/ttn.ts</code></li></p><p>---</p><p><h2>Stripe</h2></p><p><h3>Overview</h3></p><p>Stripe handles subscription billing with:
<li>Checkout sessions for new subscriptions</li>
<li>Customer portal for management</li>
<li>Webhook for event processing</li></p><p><h3>Subscription Plans</h3></p><p>| Plan | Price ID | Monthly | Sensors | Features |
|------|----------|---------|---------|----------|
| Starter | <code>price_starter</code> | $29 | 5 | Basic monitoring |
| Pro | <code>price_pro</code> | $79 | 25 | + SMS alerts |
| HACCP | <code>price_haccp</code> | $199 | 100 | + Compliance reports |
| Enterprise | Custom | Custom | Unlimited | Custom features |</p><p><h3>Integration Flow</h3></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant F as Frontend
    participant S as stripe-checkout
    participant ST as Stripe
    participant W as stripe-webhook
    participant D as Database</p><p>    U->>F: Click "Upgrade"
    F->>S: Create checkout session
    S->>ST: Create session
    ST-->>S: Session URL
    S-->>F: Redirect URL
    F->>ST: Redirect to Stripe
    U->>ST: Complete payment
    ST->>W: Webhook: checkout.session.completed
    W->>D: Create subscription record
    ST-->>U: Redirect to success URL
</code></pre></p><p><h3>Webhook Events</h3></p><p>| Event | Handler Action |
|-------|----------------|
| <code>checkout.session.completed</code> | Create subscription, update org |
| <code>customer.subscription.created</code> | Log subscription start |
| <code>customer.subscription.updated</code> | Update plan, sensor limit |
| <code>customer.subscription.deleted</code> | Downgrade to free tier |
| <code>invoice.paid</code> | Record invoice |
| <code>invoice.payment_failed</code> | Send payment failure notification |</p><p><h3>Setup</h3></p><p>#### 1. Stripe Dashboard</p><p><li>Create product and prices for each plan</li>
<li>Configure webhook endpoint</li>
<li>Set up customer portal</li></p><p>#### 2. Environment Variables</p><p><pre><code class="env">STRIPE_SECRET_KEY=sk_live_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
STRIPE_PUBLISHABLE_KEY=pk_live_xxx (frontend)
</code></pre></p><p>#### 3. Webhook URL</p><p><code>https://<project>.supabase.co/functions/v1/stripe-webhook</code></p><p><h3>Related Files</h3></p><p><li><code>supabase/functions/stripe-checkout/index.ts</code></li>
<li><code>supabase/functions/stripe-portal/index.ts</code></li>
<li><code>supabase/functions/stripe-webhook/index.ts</code></li>
<li><code>src/components/billing/BillingTab.tsx</code></li>
<li><code>src/lib/stripe.ts</code></li></p><p>---</p><p><h2>Twilio</h2></p><p><h3>Overview</h3></p><p>Twilio provides SMS delivery for critical alerts.</p><p><h3>Integration</h3></p><p>SMS sent via <code>process-escalations</code> â†’ <code>send-sms-alert</code></p><p><h3>Phone Number Format</h3></p><p>All phone numbers must be in E.164 format:
<li><code>+15551234567</code> (US)</li>
<li><code>+447911123456</code> (UK)</li></p><p>Validation in <code>src/lib/validation.ts</code>:
<pre><code class="typescript">const phoneSchema = z.string().regex(/^\+[1-9]\d{1,14}$/);
</code></pre></p><p><h3>Message Format</h3></p><p><pre><code class="">FreshTrack Alert: [Unit Name]
Temperature at [XX]Â°F - exceeds [High/Low] limit of [XX]Â°F
Acknowledge: [Link]
</code></pre></p><p><h3>Rate Limiting</h3></p><p><li>Max 1 SMS per alert per contact per hour</li>
<li>Escalation respects quiet hours</li></p><p><h3>Setup</h3></p><p>#### Environment Variables</p><p><pre><code class="env">TWILIO_ACCOUNT_SID=ACxxx
TWILIO_AUTH_TOKEN=xxx
TWILIO_PHONE_NUMBER=+15551234567
</code></pre></p><p><h3>Troubleshooting</h3></p><p>| Issue | Cause | Solution |
|-------|-------|----------|
| SMS not delivered | Invalid phone format | Ensure E.164 format |
| Delivery failed | Twilio account issue | Check Twilio console |
| Rate limited | Too many SMS | Check escalation policy |</p><p><h3>Related Files</h3></p><p><li><code>supabase/functions/send-sms-alert/index.ts</code></li>
<li><code>supabase/functions/process-escalations/index.ts</code></li>
<li><code>src/components/settings/SmsAlertHistory.tsx</code></li></p><p>---</p><p><h2>Supabase Auth</h2></p><p><h3>Overview</h3></p><p>Supabase Auth provides:
<li>Email/password authentication</li>
<li>Session management with JWT</li>
<li>Password reset flow</li>
<li>OAuth providers (if configured)</li></p><p><h3>Authentication Flow</h3></p><p><li>User submits credentials</li>
<li>Supabase validates and returns JWT</li>
<li>JWT stored in localStorage</li>
<li>JWT included in all API requests</li>
<li>Auto-refresh before expiration</li></p><p><h3>Password Requirements</h3></p><p>| Requirement | Validation |
|-------------|------------|
| Minimum length | 8 characters |
| Uppercase | At least 1 |
| Lowercase | At least 1 |
| Number | At least 1 |
| Special character | At least 1 |
| Breach check | <code>check-password-breach</code> function |</p><p><h3>Session Configuration</h3></p><p><li>Access token expiry: 1 hour</li>
<li>Refresh token expiry: 7 days</li>
<li>Auto-refresh: Enabled</li></p><p><h3>Profile Creation</h3></p><p>Database trigger creates <code>profiles</code> record on user signup:</p><p><pre><code class="sql">CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email)
  VALUES (NEW.id, NEW.email);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;</p><p>CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
</code></pre></p><p><h3>Related Files</h3></p><p><li><code>src/pages/Auth.tsx</code></li>
<li><code>src/pages/AuthCallback.tsx</code></li>
<li><code>src/hooks/useAuthAndOnboarding.ts</code></li>
<li><code>src/integrations/supabase/client.ts</code></li></p><p>---</p><p><h2>Environment Variables</h2></p><p><h3>Required for Production</h3></p><p>| Variable | Service | Location |
|----------|---------|----------|
| <code>VITE_SUPABASE_URL</code> | Supabase | Frontend |
| <code>VITE_SUPABASE_PUBLISHABLE_KEY</code> | Supabase | Frontend |
| <code>SUPABASE_SERVICE_ROLE_KEY</code> | Supabase | Edge Functions (auto) |
| <code>INTERNAL_API_KEY</code> | Internal | Edge Functions |
| <code>STRIPE_SECRET_KEY</code> | Stripe | Edge Functions |
| <code>STRIPE_WEBHOOK_SECRET</code> | Stripe | Edge Functions |
| <code>TWILIO_ACCOUNT_SID</code> | Twilio | Edge Functions |
| <code>TWILIO_AUTH_TOKEN</code> | Twilio | Edge Functions |
| <code>TWILIO_PHONE_NUMBER</code> | Twilio | Edge Functions |</p><p><h3>Per-Organization (Database)</h3></p><p>| Variable | Table | Column |
|----------|-------|--------|
| TTN API Key | <code>ttn_connections</code> | <code>api_key</code> (encrypted) |
| TTN Webhook Secret | <code>ttn_connections</code> | <code>webhook_secret</code> (hashed) |
| TTN Application ID | <code>ttn_connections</code> | <code>application_id</code> |</p><p><h3>Setting Supabase Secrets</h3></p><p><pre><code class="bash"><h1>Via Supabase CLI</h1>
supabase secrets set INTERNAL_API_KEY=xxx
supabase secrets set STRIPE_SECRET_KEY=sk_live_xxx
supabase secrets set TWILIO_ACCOUNT_SID=ACxxx
supabase secrets set TWILIO_AUTH_TOKEN=xxx</p><p><h1>List secrets</h1>
supabase secrets list
</code></pre></p><p><h3>Verification Steps</h3></p><p><li><strong>TTN</strong>: Check Settings â†’ TTN tab for "Connected" status</li>
<li><strong>Stripe</strong>: Check Settings â†’ Billing tab loads plans</li>
<li><strong>Twilio</strong>: Check SMS delivery in Settings â†’ Notification History</li>
<li><strong>Auth</strong>: Verify login/logout works</li></p><p>---</p><p><h2>TBD Items</h2></p><p>| Integration | TBD | File to Verify |
|-------------|-----|----------------|
| TTN | Cluster configuration options | <code>supabase/functions/_shared/ttnConfig.ts</code> |
| Stripe | Enterprise plan setup | <code>src/lib/stripe.ts</code> |
| Twilio | Rate limit configuration | <code>supabase/functions/process-escalations/index.ts</code> |</p><p>
---</p><p><div class="page-break"></div></p><p><a id="engineering-observability"></a></p><p><h1>FreshTrack Pro Observability</h1></p><p><blockquote>Logging, monitoring, debugging, and incident response documentation</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#logging-strategy">Logging Strategy</a></li>
<li><a href="#error-handling">Error Handling</a></li>
<li><a href="#debugging-workflows">Debugging Workflows</a></li>
<li><a href="#health-monitoring">Health Monitoring</a></li>
<li><a href="#known-failure-scenarios">Known Failure Scenarios</a></li>
<li><a href="#incident-playbooks">Incident Playbooks</a></li>
<li><a href="#audit-trail">Audit Trail</a></li></p><p>---</p><p><h2>Logging Strategy</h2></p><p><h3>Frontend Logging</h3></p><p>#### Debug Logger</p><p><strong>File</strong>: <code>src/lib/debugLogger.ts</code></p><p><pre><code class="typescript">// Enable debug mode
localStorage.setItem('debug', 'true');</p><p>// Usage
debugLog('Component', 'Action description', { data });
</code></pre></p><p>#### Console Patterns</p><p>| Level | Usage |
|-------|-------|
| <code>console.log</code> | General information |
| <code>console.warn</code> | Non-critical issues |
| <code>console.error</code> | Errors requiring attention |</p><p>#### Route Logging</p><p><strong>File</strong>: <code>src/components/debug/RouteLogger.tsx</code></p><p>Logs route changes when debug mode is enabled.</p><p><h3>Backend Logging</h3></p><p>#### Edge Function Patterns</p><p><pre><code class="typescript">// Request tracing
const requestId = crypto.randomUUID().slice(0, 8);
console.log(<code>[FUNCTION-NAME] ${requestId} | Starting...</code>);</p><p>// Structured logging
console.log(<code>[TTN-WEBHOOK] ${requestId} | Uplink: device=${deviceId}, temp=${temp}</code>);</p><p>// Error logging
console.error(<code>[FUNCTION-NAME] ${requestId} | Error:</code>, error);
</code></pre></p><p>#### Log Format</p><p><pre><code class="">[FUNCTION-NAME] REQUEST_ID | message: details
</code></pre></p><p>Example:
<pre><code class="">[TTN-WEBHOOK] a1b2c3d4 | Uplink: device=sensor-001, dev_eui=0004a30b001c1234, app=freshtrack-org
[TTN-WEBHOOK] a1b2c3d4 | Found sensor by ttn_device_id: Walk-in Cooler
[TTN-WEBHOOK] a1b2c3d4 | Processing sensor: Walk-in Cooler, temp: 38.5
</code></pre></p><p><h3>Sensitive Data Handling</h3></p><p><strong>Never log</strong>:
<li>Full phone numbers (mask: <code>+1555</em><strong>4567</code>)</li>
<li>API keys</li>
<li>Passwords</li>
<li>Full webhook secrets</li></p><p></strong>Masking pattern<strong>:
<pre><code class="typescript">const maskPhone = (phone: string) =>
  phone.slice(0, 5) + '</strong><em>' + phone.slice(-4);
</code></pre></p><p>---</p><p><h2>Error Handling</h2></p><p><h3>Frontend Error Handling</h3></p><p>#### Toast Notifications</p><p><strong>File</strong>: <code>src/hooks/use-toast.ts</code>, Sonner (<code>sonner</code>)</p><p><pre><code class="typescript">import { toast } from 'sonner';</p><p>// Success
toast.success('Temperature logged successfully');</p><p>// Error
toast.error('Failed to save. Please try again.');</p><p>// Warning
toast.warning('Offline - will sync when connected');
</code></pre></p><p>#### Error Boundaries</p><p>React error boundaries catch component errors. Implement at page level.</p><p>#### API Error Handling</p><p><pre><code class="typescript">try {
  const { data, error } = await supabase.from('units').select();
  if (error) throw error;
  return data;
} catch (error) {
  console.error('[ComponentName] Failed to load:', error);
  toast.error('Failed to load data');
}
</code></pre></p><p><h3>Backend Error Handling</h3></p><p>#### Standard Response Pattern</p><p><pre><code class="typescript">// Success
return new Response(
  JSON.stringify({ success: true, data }),
  { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
);</p><p>// Error
return new Response(
  JSON.stringify({ error: errorMessage, code: 'ERROR_CODE' }),
  { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
);
</code></pre></p><p>#### Webhook Error Handling</p><p>For TTN webhooks, always return 2xx to prevent retries:</p><p><pre><code class="typescript">// Unknown device - accept but don't process
return new Response(
  JSON.stringify({ accepted: true, processed: false, reason: 'Unknown device' }),
  { status: 202, headers: corsHeaders }
);
</code></pre></p><p>---</p><p><h2>Debugging Workflows</h2></p><p><h3>Debug Mode</h3></p><p><strong>Enable</strong>: Settings â†’ Debug toggle (or <code>localStorage.setItem('debug', 'true')</code>)</p><p><strong>Features</strong>:
<li>Route logging</li>
<li>API call logging</li>
<li>Component state display</li>
<li>Debug terminal</li></p><p><h3>Debug Terminal</h3></p><p><strong>File</strong>: <code>src/components/debug/DebugTerminal.tsx</code></p><p>Access via debug mode. Shows:
<li>Recent API calls</li>
<li>Route changes</li>
<li>Error logs</li>
<li>State snapshots</li></p><p><h3>Inspector Tool</h3></p><p><strong>Route</strong>: <code>/inspector</code></p><p>Features:
<li>View raw database records</li>
<li>Examine sensor states</li>
<li>Check TTN configuration</li>
<li>Debug alerts</li></p><p><h3>Edge Function Diagnostics</h3></p><p><strong>File</strong>: <code>src/components/debug/EdgeFunctionDiagnostics.tsx</code></p><p>Shows:
<li>Function health status</li>
<li>Recent invocation logs</li>
<li>Error counts</li></p><p><h3>TTN Diagnostics</h3></p><p><strong>File</strong>: <code>src/components/ttn/TTNDiagnosticsDownload.tsx</code></p><p>Downloads diagnostic bundle containing:
<li>TTN connection status</li>
<li>Sensor inventory</li>
<li>Recent webhook logs</li>
<li>Provisioning history</li></p><p><h3>Common Debugging Steps</h3></p><p>#### 1. Sensor Not Receiving Data</p><p><li>Check sensor status in Settings â†’ Sensors</li>
<li>Verify DevEUI matches TTN console</li>
<li>Check TTN Application â†’ Live Data</li>
<li>Verify webhook in TTN â†’ Webhooks</li>
<li>Check <code>ttn-webhook</code> logs in Supabase</li></p><p>#### 2. Alerts Not Triggering</p><p><li>Check unit temperature thresholds</li>
<li>Verify <code>process-unit-states</code> is running</li>
<li>Check <code>alert_rules</code> for the unit</li>
<li>Review <code>event_logs</code> for state changes</li></p><p>#### 3. Notifications Not Sending</p><p><li>Check escalation contacts exist</li>
<li>Verify notification policy enabled</li>
<li>Check <code>notification_events</code> for delivery status</li>
<li>Review <code>process-escalations</code> logs</li></p><p>---</p><p><h2>Health Monitoring</h2></p><p><h3>Health Check Endpoint</h3></p><p><strong>Function</strong>: <code>health-check</code>
<strong>Route</strong>: <code>/admin/health</code></p><p>Checks:
<li>Database connectivity</li>
<li>Edge function availability</li>
<li>TTN webhook status</li>
<li>Stripe connectivity</li></p><p><h3>Health Check Components</h3></p><p><strong>Files</strong>: <code>src/components/health/</em>.tsx</code></p><p><li><code>HealthCheckList.tsx</code> - List of all checks</li>
<li><code>HealthStatusBadge.tsx</code> - Status indicator</li>
<li><code>HealthStatusCard.tsx</code> - Individual check card</li>
<li><code>OverallHealthSummary.tsx</code> - Aggregate status</li></p><p><h3>Monitoring Dashboard</h3></p><p><strong>Route</strong>: <code>/admin/health</code></p><p>Displays:
| Check | Description |
|-------|-------------|
| Database | PostgreSQL connection |
| Auth | Supabase Auth service |
| Edge Functions | Function availability |
| TTN Webhook | Recent webhook activity |
| Stripe | Payment service status |</p><p><h3>Automated Checks</h3></p><p><strong>TBD</strong>: Configure Supabase cron jobs for:
<li>Periodic health checks</li>
<li>Alert on failures</li>
<li>Metrics collection</li></p><p>---</p><p><h2>Known Failure Scenarios</h2></p><p><h3>TTN Webhook Failures</h3></p><p>| Scenario | Symptoms | Resolution |
|----------|----------|------------|
| Invalid secret | 401 responses | Regenerate secret, update TTN |
| Function timeout | Incomplete processing | Check function logs, optimize |
| Database error | 202 responses | Check Supabase status |</p><p><h3>Alert Processing Failures</h3></p><p>| Scenario | Symptoms | Resolution |
|----------|----------|------------|
| Function not triggered | No state changes | Check cron/trigger setup |
| RPC error | Cascade not working | Check <code>get_effective_alert_rules</code> |
| Missing org_id | Alert creation fails | Verify unit hierarchy |</p><p><h3>Notification Failures</h3></p><p>| Scenario | Symptoms | Resolution |
|----------|----------|------------|
| SMS delivery failed | <code>notification_events.status = 'failed'</code> | Check Twilio console |
| Email bounced | Delivery log shows bounce | Verify email address |
| Rate limited | Notifications delayed | Check escalation timing |</p><p><h3>Sensor Offline</h3></p><p>| Scenario | Symptoms | Resolution |
|----------|----------|------------|
| Gateway offline | All sensors show offline | Check gateway power/network |
| Sensor battery | Single sensor offline | Replace battery |
| TTN issue | Multiple sensors affected | Check TTN status page |</p><p>---</p><p><h2>Incident Playbooks</h2></p><p><h3>Playbook 1: All Sensors Offline</h3></p><p><strong>Symptoms</strong>: All sensors in an organization show offline status</p><p><strong>Steps</strong>:
<li>Check <code>/admin/health</code> for system status</li>
<li>Verify TTN webhook status</li>
<li>Check TTN console for gateway status</li>
<li>Review <code>ttn-webhook</code> logs for recent activity</li>
<li>Verify <code>ttn_connections.webhook_secret</code> is correct</li></p><p><strong>Resolution</strong>:
<li>If webhook issue: Regenerate secret, update TTN</li>
<li>If gateway issue: Power cycle gateway</li>
<li>If TTN outage: Wait for TTN recovery</li></p><p><h3>Playbook 2: Alerts Not Triggering</h3></p><p><strong>Symptoms</strong>: Temperature excursions not creating alerts</p><p><strong>Steps</strong>:
<li>Check unit has sensor assigned</li>
<li>Verify sensor is receiving data (check <code>sensor_readings</code>)</li>
<li>Check <code>process-unit-states</code> function logs</li>
<li>Verify <code>alert_rules</code> exist for org/site/unit</li>
<li>Check unit <code>temp_limit_high</code> and <code>temp_limit_low</code></li></p><p><strong>Resolution</strong>:
<li>If no readings: Debug sensor connection</li>
<li>If function error: Check function deployment</li>
<li>If rules missing: Create default rules</li></p><p><h3>Playbook 3: Notifications Not Sending</h3></p><p><strong>Symptoms</strong>: Alerts created but no notifications received</p><p><strong>Steps</strong>:
<li>Check <code>notification_policies</code> for alert type</li>
<li>Verify <code>escalation_contacts</code> exist</li>
<li>Check <code>notification_events</code> for delivery status</li>
<li>Review <code>process-escalations</code> logs</li>
<li>Verify Twilio/email credentials</li></p><p><strong>Resolution</strong>:
<li>If policy disabled: Enable notification policy</li>
<li>If no contacts: Add escalation contacts</li>
<li>If delivery failed: Check credential configuration</li></p><p><h3>Playbook 4: High Database Load</h3></p><p><strong>Symptoms</strong>: Slow queries, timeouts</p><p><strong>Steps</strong>:
<li>Check Supabase dashboard for metrics</li>
<li>Review recent migrations</li>
<li>Check for missing indexes</li>
<li>Review <code>sensor_readings</code> table size</li>
<li>Check for runaway queries</li></p><p><strong>Resolution</strong>:
<li>Add missing indexes</li>
<li>Implement data archival</li>
<li>Optimize slow queries</li></p><p><h3>Playbook 5: Payment Processing Failed</h3></p><p><strong>Symptoms</strong>: Subscriptions not updating after payment</p><p><strong>Steps</strong>:
<li>Check Stripe dashboard for webhook deliveries</li>
<li>Verify <code>stripe-webhook</code> function logs</li>
<li>Check <code>subscriptions</code> table for updates</li>
<li>Verify webhook secret is correct</li></p><p><strong>Resolution</strong>:
<li>Resend failed webhooks from Stripe</li>
<li>Update webhook secret if needed</li>
<li>Manually sync subscription status</li></p><p>---</p><p><h2>Audit Trail</h2></p><p><h3>Event Logging</h3></p><p><strong>Table</strong>: <code>event_logs</code></p><p>All significant events are logged:</p><p>| Event Type | Category | Description |
|------------|----------|-------------|
| <code>unit_state_change</code> | unit | Status transitions |
| <code>alert_created</code> | alert | New alert |
| <code>alert_acknowledged</code> | alert | Alert acknowledged |
| <code>alert_resolved</code> | alert | Alert resolved |
| <code>temperature_logged</code> | temperature | Manual log |
| <code>sensor_reading</code> | temperature | Auto reading |
| <code>setting_changed</code> | configuration | Config update |
| <code>user_login</code> | user | Auth event |</p><p><h3>Event Structure</h3></p><p><pre><code class="json">{
  "id": "uuid",
  "organization_id": "uuid",
  "site_id": "uuid (optional)",
  "unit_id": "uuid (optional)",
  "event_type": "unit_state_change",
  "category": "unit",
  "severity": "warning",
  "title": "Walk-in Cooler: ok â†’ excursion",
  "event_data": {
    "from_status": "ok",
    "to_status": "excursion",
    "reason": "Temperature 45Â°F above limit",
    "temp_reading": 45.0
  },
  "actor_id": "uuid or null",
  "actor_type": "user or system",
  "created_at": "2026-01-12T10:30:00Z"
}
</code></pre></p><p><h3>Viewing Audit Logs</h3></p><p><strong>Route</strong>: <code>/events</code></p><p>Features:
<li>Filterable by event type, category, severity</li>
<li>Date range selection</li>
<li>Export functionality</li></p><p><h3>Log Retention</h3></p><p><strong>TBD</strong>: Configure retention policy:
<li>Temperature readings: [configurable]</li>
<li>Event logs: 2 years (compliance)</li>
<li>Alert history: Indefinite</li></p><p><h3>Compliance Requirements</h3></p><p>For HACCP compliance:
<li>All temperature logs retained</li>
<li>Alert history with acknowledgment</li>
<li>Corrective action documentation</li>
<li>User action audit trail</li></p><p>---</p><p><h2>Metrics to Track</h2></p><p><h3>Key Metrics</h3></p><p>| Metric | Source | Alert Threshold |
|--------|--------|-----------------|
| Sensor uptime | <code>lora_sensors.last_seen_at</code> | < 95% |
| Alert response time | <code>alerts.acknowledged_at - triggered_at</code> | > 30 min |
| Webhook latency | Edge function logs | > 5 sec |
| Failed notifications | <code>notification_events</code> | > 10% |
| Database response time | Supabase metrics | > 1 sec |</p><p><h3>Dashboard Recommendations</h3></p><p><strong>TBD</strong>: Implement metrics dashboard showing:
<li>Active alerts by severity</li>
<li>Sensor health overview</li>
<li>Response time trends</li>
<li>Notification delivery rates</li></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#api">API.md</a> - Edge function details</li>
<li><a href="#data_model">DATA_MODEL.md</a> - Event log schema</li>
<li><a href="#integrations">INTEGRATIONS.md</a> - Third-party service status</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="onboarding-getting_started"></a></p><p><h1>Getting Started with FreshTrack Pro</h1></p><p><blockquote>Your mental model for understanding this codebase</blockquote></p><p>---</p><p><h2>What This System Does</h2></p><p>FreshTrack Pro is a <strong>refrigeration monitoring platform</strong> that:</p><p><li><strong>Collects temperature data</strong> from wireless sensors in commercial refrigerators</li>
<li><strong>Detects problems</strong> when temperatures go out of safe ranges</li>
<li><strong>Alerts the right people</strong> via email, SMS, and push notifications</li>
<li><strong>Maintains compliance records</strong> for health inspections (HACCP/FDA)</li></p><p>Think of it as a <strong>24/7 automated food safety system</strong> that replaces manual temperature checks with continuous monitoring.</p><p>---</p><p><h2>The Mental Model</h2></p><p><h3>The Data Flow</h3></p><p><pre><code class="">Sensors â†’ TTN (IoT Network) â†’ Our Webhooks â†’ Database â†’ Alerts â†’ Notifications
</code></pre></p><p><strong>Step by step:</strong></p><p><li><strong>Sensors</strong> in refrigerators transmit temperature readings via LoRa radio</li>
<li><strong>Gateways</strong> receive the radio signals and forward to The Things Network (TTN)</li>
<li><strong>TTN</strong> sends the data to our <code>ttn-webhook</code> edge function</li>
<li><strong>Database</strong> stores the reading and updates unit state</li>
<li><strong>process-unit-states</strong> evaluates if temperature is out of range</li>
<li><strong>process-escalations</strong> sends notifications if needed</li></p><p><h3>The Hierarchy</h3></p><p>Everything is organized hierarchically:</p><p><pre><code class="">Organization (tenant/customer)
    â””â”€â”€ Sites (physical locations)
        â””â”€â”€ Areas (zones within a site)
            â””â”€â”€ Units (refrigerators/freezers)
                â””â”€â”€ Sensors (monitoring devices)
</code></pre></p><p><strong>Why this matters:</strong>
<li>Settings cascade down (org defaults â†’ site overrides â†’ unit overrides)</li>
<li>Users see only their organization's data (multi-tenancy via RLS)</li>
<li>Reports can roll up at any level</li></p><p><h3>The Three Pillars</h3></p><p>| Pillar | What It Does | Key Files |
|--------|--------------|-----------|
| <strong>Frontend</strong> | React SPA for user interaction | <code>src/</code> |
| <strong>Edge Functions</strong> | Deno serverless backend logic | <code>supabase/functions/</code> |
| <strong>Database</strong> | PostgreSQL with RLS | <code>supabase/migrations/</code> |</p><p>---</p><p><h2>How to Think About This App</h2></p><p><h3>Think: Safety-Critical</h3></p><p>This is <strong>not</strong> a typical CRUD app. Temperature monitoring is safety-critical:</p><p><li>A missed alert can mean $10,000+ in spoiled inventory</li>
<li>A false negative is worse than a false positive</li>
<li>All changes must be logged for compliance audits</li></p><p><strong>Implication</strong>: Always consider failure modes. What happens if this breaks?</p><p><h3>Think: Event-Driven</h3></p><p>The system reacts to events, not user clicks:</p><p><li>Sensor reading arrives â†’ Process state â†’ Maybe create alert</li>
<li>Alert created â†’ Escalation timer starts</li>
<li>Escalation timeout â†’ Notify next level</li></p><p><strong>Implication</strong>: Follow the data flow. Changes ripple through the system.</p><p><h3>Think: Single Source of Truth</h3></p><p>Critical operations have ONE place that does them:</p><p>| Operation | SSOT |
|-----------|------|
| Creating/resolving alerts | <code>process-unit-states</code> edge function |
| Sending notifications | <code>process-escalations</code> edge function |
| Alert rule resolution | <code>get_effective_alert_rules</code> RPC |</p><p><strong>Implication</strong>: Never duplicate this logic. Always call the SSOT.</p><p><h3>Think: Hierarchical Cascade</h3></p><p>Settings flow down the hierarchy:</p><p><pre><code class="">Org sets: "Alert if temp > 40Â°F"
    â””â”€â”€ Site A inherits: "Alert if temp > 40Â°F"
        â””â”€â”€ Unit 1 overrides: "Alert if temp > 45Â°F"  â† This applies
        â””â”€â”€ Unit 2 inherits: "Alert if temp > 40Â°F"   â† Org default applies
</code></pre></p><p><strong>Implication</strong>: When reading settings, use <code>get_effective_<em></code> RPCs.</p><p>---</p><p><h2>Key Concepts You'll Encounter</h2></p><p><h3>Unit Status</h3></p><p>Units have a status that reflects their current state:</p><p>| Status | Meaning | Priority |
|--------|---------|----------|
| <code>ok</code> | Normal operation | 5 |
| <code>excursion</code> | Temp out of range (unconfirmed) | 2 |
| <code>alarm_active</code> | Confirmed temp alarm | 1 (highest) |
| <code>restoring</code> | Recovering from issue | 4 |
| <code>offline</code> | Warning-level offline | 6 |
| <code>monitoring_interrupted</code> | Critical offline | 3 |
| <code>manual_required</code> | Manual logging needed | 4 |</p><p>Status is computed by <code>process-unit-states</code> (backend) and mirrored in <code>useUnitStatus</code> (frontend).</p><p><h3>Alerts</h3></p><p>Alerts represent conditions that need attention:</p><p><li><strong>Types</strong>: <code>temp_excursion</code>, <code>monitoring_interrupted</code>, <code>door_open</code>, <code>low_battery</code>, etc.</li>
<li><strong>Severity</strong>: <code>warning</code> or <code>critical</code></li>
<li><strong>Status</strong>: <code>triggered</code> â†’ <code>acknowledged</code> â†’ <code>resolved</code></li></p><p>Alerts escalate to higher-level contacts if not acknowledged.</p><p><h3>LoRa Sensors</h3></p><p>Wireless sensors using LoRa radio technology via The Things Network:</p><p><li><strong>DevEUI</strong>: Unique device identifier (16 hex chars)</li>
<li><strong>Status</strong>: <code>pending</code> â†’ <code>joining</code> â†’ <code>active</code> â†’ <code>offline</code> â†’ <code>fault</code></li>
<li><strong>Provisioning</strong>: Registered in both our DB and TTN</li></p><p>---</p><p><h2>What You'll Be Working On</h2></p><p><h3>Most Common Tasks</h3></p><p><li><strong>UI changes</strong> â€” Components in <code>src/components/</code></li>
<li><strong>New pages</strong> â€” Add route in <code>src/App.tsx</code>, create page in <code>src/pages/</code></li>
<li><strong>Data fetching</strong> â€” Custom hooks in <code>src/hooks/</code></li>
<li><strong>Backend logic</strong> â€” Edge functions in <code>supabase/functions/</code></li>
<li><strong>Bug fixes</strong> â€” Usually in state computation or data flow</li></p><p><h3>Where Bugs Hide</h3></p><p><li><strong>State sync</strong> â€” Frontend status doesn't match backend reality</li>
<li><strong>Cascade logic</strong> â€” Wrong effective rules being applied</li>
<li><strong>TTN integration</strong> â€” DevEUI normalization, webhook secrets</li>
<li><strong>Timing issues</strong> â€” Confirm times, escalation delays</li></p><p>---</p><p><h2>Your First Day Checklist</h2></p><p><li>[ ] Read this document completely</li>
<li>[ ] Set up your local environment (<a href="#local_dev">LOCAL_DEV.md</a>)</li>
<li>[ ] Take the repository tour (<a href="#repo_tour">REPO_TOUR.md</a>)</li>
<li>[ ] Review common tasks (<a href="#common_tasks">COMMON_TASKS.md</a>)</li>
<li>[ ] Bookmark the debugging guide (<a href="#debugging_guide">DEBUGGING_GUIDE.md</a>)</li>
<li>[ ] Read <code>KNOWLEDGE.md</code> in the repo root (coding conventions)</li>
<li>[ ] Log into the app and explore the UI</li>
<li>[ ] Find a "good first issue" and fix it</li></p><p>---</p><p><h2>Key Files to Bookmark</h2></p><p>| Purpose | File |
|---------|------|
| Coding conventions | <code>/KNOWLEDGE.md</code> |
| All routes | <code>/src/App.tsx</code> |
| Supabase client | <code>/src/integrations/supabase/client.ts</code> |
| Database types | <code>/src/integrations/supabase/types.ts</code> |
| Alert configuration | <code>/src/lib/alertConfig.ts</code> |
| Status configuration | <code>/src/lib/statusConfig.ts</code> |
| Unit status computation | <code>/src/hooks/useUnitStatus.ts</code> |
| Alert processing (backend) | <code>/supabase/functions/process-unit-states/index.ts</code> |
| TTN webhook | <code>/supabase/functions/ttn-webhook/index.ts</code> |</p><p>---</p><p><h2>Terminology Quick Reference</h2></p><p>| Term | Meaning |
|------|---------|
| <strong>Unit</strong> | A refrigerator/freezer being monitored |
| <strong>Excursion</strong> | Temperature outside safe limits |
| <strong>Alarm</strong> | Confirmed excursion (beyond confirm time) |
| <strong>Escalation</strong> | Notifying higher-level contacts |
| <strong>TTN</strong> | The Things Network (LoRa infrastructure) |
| <strong>DevEUI</strong> | Device Extended Unique Identifier |
| <strong>RLS</strong> | Row-Level Security (Postgres access control) |
| <strong>SSOT</strong> | Single Source of Truth |
| <strong>HACCP</strong> | Hazard Analysis Critical Control Point (food safety) |</p><p>See the full glossary: <code>/docs/GLOSSARY.md</code></p><p>---</p><p><h2>Next Steps</h2></p><p><li><a href="#repo_tour">REPO_TOUR.md</a> â€” Walk through the codebase</li>
<li><a href="#local_dev">LOCAL_DEV.md</a> â€” Set up your environment</li>
<li><a href="#common_tasks">COMMON_TASKS.md</a> â€” Learn common development patterns</li>
<li><a href="#debugging_guide">DEBUGGING_GUIDE.md</a> â€” Troubleshooting tips</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="onboarding-repo_tour"></a></p><p><h1>Repository Tour</h1></p><p><blockquote>Folder-by-folder walkthrough of the FreshTrack Pro codebase</blockquote></p><p>---</p><p><h2>Top-Level Structure</h2></p><p><pre><code class="">freshtrack-pro/
â”œâ”€â”€ src/                    # Frontend React application
â”œâ”€â”€ supabase/               # Backend (edge functions, migrations)
â”œâ”€â”€ docs/                   # Documentation
â”œâ”€â”€ public/                 # Static assets (favicon, icons)
â”œâ”€â”€ scripts/                # Build utilities
â”œâ”€â”€ .env                    # Environment variables (not committed)
â”œâ”€â”€ package.json            # NPM dependencies
â”œâ”€â”€ vite.config.ts          # Vite build configuration
â”œâ”€â”€ tailwind.config.ts      # Tailwind CSS configuration
â”œâ”€â”€ tsconfig.json           # TypeScript configuration
â””â”€â”€ KNOWLEDGE.md            # Coding conventions (READ THIS)
</code></pre></p><p>---</p><p><h2><code>/src</code> â€” Frontend Application</h2></p><p>The React single-page application.</p><p><h3><code>/src/App.tsx</code></h3></p><p><strong>The entry point.</strong> This file defines:
<li>All routes (23 pages)</li>
<li>Provider hierarchy (QueryClient, Tooltip, Debug, TTN contexts)</li>
<li>Global components (Toasters, Debug terminal)</li></p><p><strong>When to edit:</strong> Adding a new route or changing provider order.</p><p><pre><code class="typescript">// Route pattern
<Route path="/units/:unitId" element={<UnitDetail />} />
</code></pre></p><p>---</p><p><h3><code>/src/pages/</code></h3></p><p><strong>Route-level components.</strong> One file per page:</p><p>| File | Route | Purpose |
|------|-------|---------|
| <code>Index.tsx</code> | <code>/</code> | Landing page |
| <code>Auth.tsx</code> | <code>/auth</code> | Sign in/sign up |
| <code>Dashboard.tsx</code> | <code>/dashboard</code> | Main monitoring view |
| <code>Settings.tsx</code> | <code>/settings</code> | Multi-tab settings |
| <code>UnitDetail.tsx</code> | <code>/units/:unitId</code> | Unit monitoring detail |
| <code>Alerts.tsx</code> | <code>/alerts</code> | Alert management |
| <code>Reports.tsx</code> | <code>/reports</code> | Compliance reporting |
| <code>ManualLog.tsx</code> | <code>/manual-log</code> | Manual temp logging |
| <code>SiteDetail.tsx</code> | <code>/sites/:siteId</code> | Site view |
| <code>AreaDetail.tsx</code> | <code>/sites/:siteId/areas/:areaId</code> | Area view |
| <code>HealthDashboard.tsx</code> | <code>/admin/health</code> | System health |</p><p><strong>Pattern:</strong> Pages compose components from <code>/src/components/</code>.</p><p>---</p><p><h3><code>/src/components/</code></h3></p><p><strong>Reusable React components</strong> organized by feature:</p><p><pre><code class="">components/
â”œâ”€â”€ ui/                    # shadcn/ui base components (43 files)
â”œâ”€â”€ alerts/                # Alert display (AlertRow.tsx)
â”œâ”€â”€ dashboard/             # Dashboard widgets (LowBatteryWidget.tsx)
â”œâ”€â”€ settings/              # Settings panels (20+ files)
â”œâ”€â”€ unit/                  # Unit monitoring (8 files)
â”œâ”€â”€ site/                  # Site components
â”œâ”€â”€ ttn/                   # TTN-specific components
â”œâ”€â”€ health/                # Health check components
â”œâ”€â”€ admin/                 # Admin tools
â”œâ”€â”€ billing/               # Stripe integration
â”œâ”€â”€ reports/               # Report components
â”œâ”€â”€ debug/                 # Debug utilities
â””â”€â”€ actions/               # Action button components
</code></pre></p><p>#### Key Component Directories</p><p><strong><code>/src/components/ui/</code></strong> â€” shadcn/ui base components. <strong>Do not modify these directly.</strong> They're generated from the shadcn CLI.</p><p><strong><code>/src/components/settings/</code></strong> â€” Most of the application complexity:
<li><code>SensorManager.tsx</code> â€” LoRa sensor CRUD</li>
<li><code>GatewayManager.tsx</code> â€” Gateway CRUD</li>
<li><code>TTNConnectionSettings.tsx</code> â€” TTN configuration</li>
<li><code>AlertRulesEditor.tsx</code> â€” Alert threshold configuration</li>
<li><code>NotificationPolicyEditor.tsx</code> â€” Notification settings</li></p><p><strong><code>/src/components/unit/</code></strong> â€” Unit detail page components:
<li><code>UnitAlertsBanner.tsx</code> â€” Active alerts display</li>
<li><code>UnitSensorsCard.tsx</code> â€” Assigned sensors</li>
<li><code>BatteryHealthCard.tsx</code> â€” Battery status</li>
<li><code>UnitSettingsSection.tsx</code> â€” Unit configuration</li></p><p>---</p><p><h3><code>/src/hooks/</code></h3></p><p><strong>Custom React hooks</strong> (25 files). These encapsulate data fetching and business logic:</p><p>| Hook | Purpose |
|------|---------|
| <code>useUnitStatus.ts</code> | Compute unit status (mirrors backend logic) |
| <code>useAlertRules.ts</code> | Fetch/update alert rules |
| <code>useNotificationPolicies.ts</code> | Notification policy CRUD |
| <code>useLoraSensors.ts</code> | LoRa sensor data |
| <code>useGateways.ts</code> | Gateway data |
| <code>useAuthAndOnboarding.ts</code> | Auth state + onboarding flow |
| <code>useUserRole.ts</code> | Role-based access checking |
| <code>useTTNSetupWizard.ts</code> | TTN onboarding flow |
| <code>useOfflineSync.ts</code> | Offline data sync |
| <code>useHealthCheck.ts</code> | System health monitoring |</p><p><strong>Pattern:</strong> Hooks use TanStack Query for caching. Query keys follow pattern:
<pre><code class="typescript">['units', unitId]
['alerts', { organizationId, status: 'active' }]
</code></pre></p><p>---</p><p><h3><code>/src/lib/</code></h3></p><p><strong>Utilities and configuration:</strong></p><p>| File | Purpose |
|------|---------|
| <code>alertConfig.ts</code> | Alert type definitions, icons, colors |
| <code>statusConfig.ts</code> | Unit status definitions, priorities |
| <code>entityStatusConfig.ts</code> | Entity-level status config |
| <code>validation.ts</code> | Zod validation schemas |
| <code>eventLogger.ts</code> | Event logging utility |
| <code>offlineStorage.ts</code> | IndexedDB for offline sync |
| <code>utils.ts</code> | General utilities (cn, etc.) |
| <code>stripe.ts</code> | Stripe plan configuration |</p><p><strong>Key file: <code>alertConfig.ts</code></strong> â€” Defines all alert types, their icons, colors, and clear conditions. Reference this when working with alerts.</p><p><strong>Key file: <code>statusConfig.ts</code></strong> â€” Defines unit status values, priorities, and display properties.</p><p>---</p><p><h3><code>/src/types/</code></h3></p><p><strong>TypeScript type definitions:</strong></p><p>| File | Purpose |
|------|---------|
| <code>ttn.ts</code> | TTN/LoRa types (Gateway, LoraSensor, permissions) |
| <code>ttnState.ts</code> | TTN config state machine types |</p><p>Most types are auto-generated in <code>/src/integrations/supabase/types.ts</code>.</p><p>---</p><p><h3><code>/src/contexts/</code></h3></p><p><strong>React context providers:</strong></p><p>| Context | Purpose |
|---------|---------|
| <code>DebugContext.tsx</code> | Debug mode global state |
| <code>TTNConfigContext.tsx</code> | TTN configuration state |</p><p>---</p><p><h3><code>/src/integrations/</code></h3></p><p><strong>External service clients:</strong></p><p><pre><code class="">integrations/
â””â”€â”€ supabase/
    â”œâ”€â”€ client.ts         # Supabase client instance
    â””â”€â”€ types.ts          # Auto-generated database types (DO NOT EDIT)
</code></pre></p><p><strong><code>types.ts</code></strong> is auto-generated from the database schema. Never edit manually.</p><p>---</p><p><h2><code>/supabase</code> â€” Backend</h2></p><p><h3><code>/supabase/functions/</code></h3></p><p><strong>Deno edge functions</strong> (33 functions). Each function is a folder:</p><p><pre><code class="">functions/
â”œâ”€â”€ _shared/               # Shared utilities
â”œâ”€â”€ process-unit-states/   # Alert engine (SSOT for alerts)
â”œâ”€â”€ process-escalations/   # Notification dispatch
â”œâ”€â”€ ttn-webhook/           # TTN data ingestion
â”œâ”€â”€ ttn-provision-device/  # Device provisioning
â”œâ”€â”€ stripe-checkout/       # Stripe checkout
â””â”€â”€ ... (28 more)
</code></pre></p><p>#### Function Categories</p><p><strong>Data Ingestion:</strong>
| Function | Purpose |
|----------|---------|
| <code>ttn-webhook</code> | Receive TTN uplink messages |
| <code>ingest-readings</code> | Generic data ingestion |
| <code>sensor-simulator</code> | Generate test data |</p><p><strong>Alert Processing (SSOT):</strong>
| Function | Purpose |
|----------|---------|
| <code>process-unit-states</code> | <strong>THE</strong> alert creation/resolution service |
| <code>process-escalations</code> | <strong>THE</strong> notification dispatch service |</p><p><strong>TTN Management:</strong>
| Function | Purpose |
|----------|---------|
| <code>ttn-bootstrap</code> | Auto-configure webhooks |
| <code>ttn-provision-device</code> | Register devices in TTN |
| <code>ttn-provision-gateway</code> | Register gateways in TTN |
| <code>ttn-gateway-preflight</code> | Validate TTN credentials |
| <code>ttn-list-devices</code> | List devices from TTN |</p><p><strong>Billing:</strong>
| Function | Purpose |
|----------|---------|
| <code>stripe-checkout</code> | Create checkout sessions |
| <code>stripe-portal</code> | Customer portal |
| <code>stripe-webhook</code> | Handle Stripe events |</p><p>#### <code>/supabase/functions/_shared/</code></p><p>Shared utilities used across functions:</p><p>| File | Purpose |
|------|---------|
| <code>ttnConfig.ts</code> | DevEUI normalization, TTN helpers |
| <code>ttnPermissions.ts</code> | API key permission validation |
| <code>validation.ts</code> | Request validation, auth helpers |
| <code>response.ts</code> | Standardized response helpers |
| <code>cors.ts</code> | CORS headers |</p><p>---</p><p><h3><code>/supabase/migrations/</code></h3></p><p><strong>Database migrations.</strong> 100+ SQL files defining the schema.</p><p>Files are named with timestamps: <code>20260112001512_name.sql</code></p><p><strong>Do not edit existing migrations.</strong> Create new ones to make changes.</p><p>---</p><p><h3><code>/supabase/config.toml</code></h3></p><p><strong>Supabase configuration.</strong> Defines:
<li>Edge function settings</li>
<li>JWT verification requirements</li>
<li>CORS configuration</li></p><p>---</p><p><h2><code>/docs</code> â€” Documentation</h2></p><p><pre><code class="">docs/
â”œâ”€â”€ README.md              # Technical overview
â”œâ”€â”€ INDEX.md               # Navigation guide
â”œâ”€â”€ GLOSSARY.md            # Terminology
â”œâ”€â”€ architecture/          # System architecture
â”œâ”€â”€ engineering/           # API, data model, integrations
â”œâ”€â”€ product/               # Pages, user flows
â”œâ”€â”€ diagrams/              # Mermaid diagrams
â”œâ”€â”€ charts/                # ER diagrams, flowcharts
â”œâ”€â”€ executive/             # Non-technical docs
â””â”€â”€ onboarding/            # This folder
</code></pre></p><p>---</p><p><h2><code>/public</code> â€” Static Assets</h2></p><p><pre><code class="">public/
â”œâ”€â”€ favicon.ico            # Browser favicon
â”œâ”€â”€ icon.svg               # PWA icon
â”œâ”€â”€ placeholder.svg        # Placeholder image
â””â”€â”€ robots.txt             # SEO robots file
</code></pre></p><p>---</p><p><h2>Key Files to Know</h2></p><p><h3>Configuration Files</h3></p><p>| File | Purpose |
|------|---------|
| <code>package.json</code> | NPM dependencies and scripts |
| <code>vite.config.ts</code> | Vite build config, PWA plugin, test setup |
| <code>tailwind.config.ts</code> | Tailwind CSS customization |
| <code>tsconfig.json</code> | TypeScript compiler options |
| <code>components.json</code> | shadcn/ui configuration |
| <code>.env</code> | Environment variables (not in git) |</p><p><h3>Critical Logic Files</h3></p><p>| File | What It Does |
|------|--------------|
| <code>supabase/functions/process-unit-states/index.ts</code> | THE alert engine. Creates/resolves all alerts. |
| <code>supabase/functions/ttn-webhook/index.ts</code> | Receives all sensor data from TTN. |
| <code>src/hooks/useUnitStatus.ts</code> | Frontend status computation (mirrors backend). |
| <code>src/lib/alertConfig.ts</code> | Alert type definitions and display config. |</p><p>---</p><p><h2>Where to Find Things</h2></p><p>| I need to... | Look in... |
|--------------|------------|
| Add a new page | <code>src/pages/</code> + <code>src/App.tsx</code> |
| Add a component | <code>src/components/{feature}/</code> |
| Add a data hook | <code>src/hooks/</code> |
| Change alert logic | <code>supabase/functions/process-unit-states/</code> |
| Change TTN handling | <code>supabase/functions/ttn-webhook/</code> |
| Add a database table | <code>supabase/migrations/</code> |
| Change validation | <code>src/lib/validation.ts</code> |
| Add an edge function | <code>supabase/functions/{new-function}/</code> |</p><p>---</p><p><h2>Next Steps</h2></p><p><li><a href="#local_dev">LOCAL_DEV.md</a> â€” Set up your development environment</li>
<li><a href="#common_tasks">COMMON_TASKS.md</a> â€” How to do common development tasks</li>
<li><a href="#debugging_guide">DEBUGGING_GUIDE.md</a> â€” Troubleshooting and debugging</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="onboarding-local_dev"></a></p><p><h1>Local Development Setup</h1></p><p><blockquote>Get FreshTrack Pro running on your machine</blockquote></p><p>---</p><p><h2>Prerequisites</h2></p><p>Before you begin, install these tools:</p><p>| Tool | Version | Purpose | Install |
|------|---------|---------|---------|
| <strong>Node.js</strong> | 18+ | JavaScript runtime | <a href="https://nodejs.org">nodejs.org</a> |
| <strong>npm</strong> | 9+ | Package manager | Included with Node |
| <strong>Git</strong> | 2.30+ | Version control | <a href="https://git-scm.com">git-scm.com</a> |
| <strong>Supabase CLI</strong> | Latest | Local backend | <code>npm install -g supabase</code> |
| <strong>Deno</strong> | 1.40+ | Edge function runtime | <a href="https://deno.land">deno.land</a> |</p><p><strong>Optional but recommended:</strong>
<li>VS Code with extensions: ESLint, Prettier, Tailwind CSS IntelliSense</li>
<li>Docker (for running Supabase locally)</li></p><p>---</p><p><h2>Quick Start</h2></p><p><pre><code class="bash"><h1>1. Clone the repository</h1>
git clone <repo-url>
cd freshtrack-pro</p><p><h1>2. Install dependencies</h1>
npm install</p><p><h1>3. Set up environment variables (see below)</h1>
cp .env.example .env</p><p><h1>4. Start the development server</h1>
npm run dev
</code></pre></p><p>The app will be available at <code>http://localhost:8080</code>.</p><p>---</p><p><h2>Environment Variables</h2></p><p>Create a <code>.env</code> file in the project root. Here are the required variables:</p><p><h3>Required Variables</h3></p><p><pre><code class="env"><h1>Supabase Connection (required)</h1>
VITE_SUPABASE_PROJECT_ID="your-project-id"
VITE_SUPABASE_URL="https://your-project-id.supabase.co"
VITE_SUPABASE_ANON_KEY="your-anon-key"
</code></pre></p><p><h3>Where to Find These Values</h3></p><p><li><strong>Supabase Dashboard</strong>: Go to Project Settings â†’ API</li>
   - <code>VITE_SUPABASE_PROJECT_ID</code>: The project reference ID
   - <code>VITE_SUPABASE_URL</code>: The project URL
   - <code>VITE_SUPABASE_ANON_KEY</code>: The <code>anon</code> public key</p><p><h3>Optional Variables (for local development)</h3></p><p><pre><code class="env"><h1>Feature flags</h1>
VITE_ENABLE_DEBUG_MODE="true"    # Shows debug terminal</p><p><h1>Stripe (for payment testing)</h1>
VITE_STRIPE_PUBLISHABLE_KEY="pk_test_..."
</code></pre></p><p><h3>Environment Variable Naming</h3></p><p>All frontend variables <strong>must</strong> start with <code>VITE_</code> to be exposed to the browser.</p><p><pre><code class="typescript">// Access in code
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
</code></pre></p><p>---</p><p><h2>NPM Scripts</h2></p><p><pre><code class="bash"><h1>Development</h1>
npm run dev           # Start dev server (port 8080)
npm run build         # Build for production
npm run preview       # Preview production build locally</p><p><h1>Code Quality</h1>
npm run lint          # Run ESLint
npm run typecheck     # TypeScript type checking (if configured)</p><p><h1>Testing</h1>
npm run test          # Run tests (Vitest)
</code></pre></p><p>---</p><p><h2>Running Supabase Locally</h2></p><p>For full backend development, run Supabase locally:</p><p><h3>Start Local Supabase</h3></p><p><pre><code class="bash"><h1>Start all Supabase services</h1>
supabase start</p><p><h1>This will output local URLs:</h1>
<h1>- API URL: http://localhost:54321</h1>
<h1>- Studio URL: http://localhost:54323</h1>
<h1>- Anon Key: eyJhb...</h1>
</code></pre></p><p><h3>Update <code>.env</code> for Local Development</h3></p><p><pre><code class="env">VITE_SUPABASE_URL="http://localhost:54321"
VITE_SUPABASE_ANON_KEY="<local-anon-key>"
</code></pre></p><p><h3>Apply Migrations</h3></p><p><pre><code class="bash"><h1>Apply all migrations to local database</h1>
supabase db reset</p><p><h1>This runs all migrations in /supabase/migrations/</h1>
</code></pre></p><p><h3>View Local Database</h3></p><p><pre><code class="bash"><h1>Open Supabase Studio in browser</h1>
supabase studio</p><p><h1>Or connect directly with psql</h1>
psql "postgresql://postgres:postgres@localhost:54322/postgres"
</code></pre></p><p>---</p><p><h2>Running Edge Functions Locally</h2></p><p>Edge functions are in <code>/supabase/functions/</code>. To run them locally:</p><p><h3>Serve All Functions</h3></p><p><pre><code class="bash">supabase functions serve
</code></pre></p><p>This runs all functions on <code>http://localhost:54321/functions/v1/<function-name></code>.</p><p><h3>Serve a Specific Function</h3></p><p><pre><code class="bash">supabase functions serve process-unit-states
</code></pre></p><p><h3>Test a Function</h3></p><p><pre><code class="bash"><h1>Example: Call the health check function</h1>
curl http://localhost:54321/functions/v1/health-check \
  -H "Authorization: Bearer <anon-key>"
</code></pre></p><p><h3>Environment Variables for Functions</h3></p><p>Edge functions need their own environment variables:</p><p><pre><code class="bash"><h1>Create a .env file for functions</h1>
touch supabase/.env.local</p><p><h1>Add function-specific secrets</h1>
TTN_API_KEY="your-ttn-key"
STRIPE_SECRET_KEY="sk_test_..."
TWILIO_ACCOUNT_SID="..."
</code></pre></p><p>---</p><p><h2>Project Structure for Development</h2></p><p><pre><code class="">freshtrack-pro/
â”œâ”€â”€ src/                    # Frontend (what you'll edit most)
â”‚   â”œâ”€â”€ pages/              # Route components
â”‚   â”œâ”€â”€ components/         # React components
â”‚   â”œâ”€â”€ hooks/              # Custom React hooks
â”‚   â””â”€â”€ lib/                # Utilities
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ functions/          # Edge functions (backend logic)
â”‚   â””â”€â”€ migrations/         # Database schema
â”œâ”€â”€ public/                 # Static assets
â”œâ”€â”€ .env                    # Environment variables (DON'T COMMIT)
â”œâ”€â”€ package.json            # Dependencies and scripts
â”œâ”€â”€ vite.config.ts          # Vite build configuration
â””â”€â”€ tailwind.config.ts      # Tailwind CSS configuration
</code></pre></p><p>---</p><p><h2>IDE Setup</h2></p><p><h3>VS Code (Recommended)</h3></p><p>Install these extensions:
<li><strong>ESLint</strong> â€” Linting</li>
<li><strong>Prettier</strong> â€” Code formatting</li>
<li><strong>Tailwind CSS IntelliSense</strong> â€” Autocomplete for Tailwind classes</li>
<li><strong>TypeScript Vue Plugin (Volar)</strong> â€” Better TypeScript support</li>
<li><strong>Deno</strong> â€” For edge function development</li></p><p><h3>Recommended Settings</h3></p><p>Add to <code>.vscode/settings.json</code>:</p><p><pre><code class="json">{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.tsdk": "node_modules/typescript/lib"
}
</code></pre></p><p>---</p><p><h2>Common Setup Problems</h2></p><p><h3>Problem: "Module not found" errors</h3></p><p><strong>Cause</strong>: Dependencies not installed or outdated.</p><p><strong>Solution</strong>:
<pre><code class="bash">rm -rf node_modules package-lock.json
npm install
</code></pre></p><p><h3>Problem: Supabase connection errors</h3></p><p><strong>Cause</strong>: Wrong environment variables or Supabase not running.</p><p><strong>Solutions</strong>:
<li>Check <code>.env</code> file has correct values</li>
<li>Ensure no quotes around values in some shells</li>
<li>Restart the dev server after changing <code>.env</code></li></p><p><pre><code class="bash"><h1>Verify your env vars are loaded</h1>
npm run dev
<h1>Check browser console for connection errors</h1>
</code></pre></p><p><h3>Problem: "Port 8080 already in use"</h3></p><p><strong>Cause</strong>: Another process using the port.</p><p><strong>Solution</strong>:
<pre><code class="bash"><h1>Find and kill the process</h1>
lsof -i :8080
kill -9 <PID></p><p><h1>Or use a different port</h1>
npm run dev -- --port 3000
</code></pre></p><p><h3>Problem: Edge functions not working locally</h3></p><p><strong>Cause</strong>: Deno not installed or functions not served.</p><p><strong>Solutions</strong>:
<li>Install Deno: <code>curl -fsSL https://deno.land/install.sh | sh</code></li>
<li>Start function server: <code>supabase functions serve</code></li>
<li>Check function logs in terminal</li></p><p><h3>Problem: TypeScript errors on first run</h3></p><p><strong>Cause</strong>: Generated types may be stale.</p><p><strong>Solution</strong>:
<pre><code class="bash"><h1>Regenerate Supabase types</h1>
supabase gen types typescript --local > src/integrations/supabase/types.ts
</code></pre></p><p><h3>Problem: Hot reload not working</h3></p><p><strong>Cause</strong>: File watcher limits or Vite cache issues.</p><p><strong>Solutions</strong>:
<pre><code class="bash"><h1>Increase file watcher limit (Linux)</h1>
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p</p><p><h1>Clear Vite cache</h1>
rm -rf node_modules/.vite
npm run dev
</code></pre></p><p><h3>Problem: CORS errors in browser</h3></p><p><strong>Cause</strong>: Frontend calling wrong backend URL.</p><p><strong>Solution</strong>: Check <code>VITE_SUPABASE_URL</code> matches your running backend:
<li>Local: <code>http://localhost:54321</code></li>
<li>Remote: <code>https://your-project.supabase.co</code></li></p><p>---</p><p><h2>Development Workflow</h2></p><p><h3>Typical Day</h3></p><p><li><strong>Pull latest changes</strong></li>
   <pre><code class="bash">   git pull origin main
   npm install  # If package.json changed
   </code></pre></p><p><li><strong>Start the dev server</strong></li>
   <pre><code class="bash">   npm run dev
   </code></pre></p><p><li><strong>Make changes</strong> â€” Hot reload will update the browser</li></p><p><li><strong>Check for errors</strong></li>
   <pre><code class="bash">   npm run lint
   </code></pre></p><p><li><strong>Commit your changes</strong></li>
   <pre><code class="bash">   git add .
   git commit -m "feat: add new feature"
   </code></pre></p><p><h3>Working on Backend</h3></p><p><li><strong>Start Supabase locally</strong></li>
   <pre><code class="bash">   supabase start
   </code></pre></p><p><li><strong>Make database changes</strong> via migration:</li>
   <pre><code class="bash">   supabase migration new my_change_name
   # Edit the generated SQL file
   supabase db reset  # Apply changes
   </code></pre></p><p><li><strong>Test edge functions</strong></li>
   <pre><code class="bash">   supabase functions serve
   # Call from frontend or curl
   </code></pre></p><p>---</p><p><h2>Connecting to Remote Environments</h2></p><p><h3>Development Environment</h3></p><p>Use the development Supabase project for shared testing:</p><p><pre><code class="env">VITE_SUPABASE_URL="https://dev-project.supabase.co"
VITE_SUPABASE_ANON_KEY="dev-anon-key"
</code></pre></p><p><h3>Production Environment</h3></p><p><strong>Never develop against production.</strong> But for debugging:</p><p><pre><code class="env"><h1>Use read-only access only</h1>
VITE_SUPABASE_URL="https://prod-project.supabase.co"
VITE_SUPABASE_ANON_KEY="prod-anon-key"
</code></pre></p><p>---</p><p><h2>Troubleshooting Checklist</h2></p><p>If something isn't working, check these in order:</p><p><li>[ ] Is Node.js 18+ installed? <code>node --version</code></li>
<li>[ ] Are dependencies installed? <code>npm install</code></li>
<li>[ ] Does <code>.env</code> file exist with correct values?</li>
<li>[ ] Is the dev server running? <code>npm run dev</code></li>
<li>[ ] Is Supabase running (if using local)? <code>supabase status</code></li>
<li>[ ] Are there console errors in the browser?</li>
<li>[ ] Are there terminal errors in the dev server?</li>
<li>[ ] Did you try clearing caches? <code>rm -rf node_modules/.vite</code></li></p><p>---</p><p><h2>Getting Help</h2></p><p><li>Check this guide and <a href="#debugging_guide">DEBUGGING_GUIDE.md</a></li>
<li>Search existing issues in the repository</li>
<li>Ask in the team chat</li>
<li>File an issue with:</li>
   - What you're trying to do
   - What you expected to happen
   - What actually happened
   - Error messages and logs</p><p>---</p><p><h2>Next Steps</h2></p><p><li><a href="#common_tasks">COMMON_TASKS.md</a> â€” How to do common development tasks</li>
<li><a href="#debugging_guide">DEBUGGING_GUIDE.md</a> â€” Troubleshooting and debugging</li>
<li><a href="#repo_tour">REPO_TOUR.md</a> â€” Understand the codebase structure</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="onboarding-common_tasks"></a></p><p><h1>Common Development Tasks</h1></p><p><blockquote>Step-by-step guides for everyday development work</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#adding-a-new-page">Adding a New Page</a></li>
<li><a href="#adding-a-new-component">Adding a New Component</a></li>
<li><a href="#fetching-data-from-supabase">Fetching Data from Supabase</a></li>
<li><a href="#adding-a-new-edge-function">Adding a New Edge Function</a></li>
<li><a href="#creating-a-database-migration">Creating a Database Migration</a></li>
<li><a href="#adding-a-new-alert-type">Adding a New Alert Type</a></li>
<li><a href="#modifying-the-ttn-integration">Modifying the TTN Integration</a></li>
<li><a href="#working-with-the-settings-wizard">Working with the Settings Wizard</a></li>
<li><a href="#adding-role-based-access">Adding Role-Based Access</a></li>
<li><a href="#testing-your-changes">Testing Your Changes</a></li></p><p>---</p><p><h2>Adding a New Page</h2></p><p><h3>Step 1: Create the Page Component</h3></p><p>Create a new file in <code>/src/pages/</code>:</p><p><pre><code class="typescript">// src/pages/MyNewPage.tsx
import { useNavigate } from "react-router-dom";</p><p>const MyNewPage = () => {
  const navigate = useNavigate();</p><p>  return (
    <div className="container mx-auto py-8">
      <h1 className="text-2xl font-bold mb-4">My New Page</h1>
      <p>Page content goes here.</p>
    </div>
  );
};</p><p>export default MyNewPage;
</code></pre></p><p><h3>Step 2: Add the Route</h3></p><p>Edit <code>/src/App.tsx</code> to add the route:</p><p><pre><code class="typescript">// Import your page
import MyNewPage from "@/pages/MyNewPage";</p><p>// Add to the Routes (inside the <Routes> component)
<Route path="/my-new-page" element={<MyNewPage />} />
</code></pre></p><p><h3>Step 3: Add Navigation (Optional)</h3></p><p>If the page should appear in navigation, update the appropriate navigation component:</p><p><pre><code class="typescript">// In the navigation component
<Link to="/my-new-page">My New Page</Link>
</code></pre></p><p><h3>Protected Routes</h3></p><p>To require authentication, wrap the page in a protected route check:</p><p><pre><code class="typescript">// In App.tsx, use the auth check pattern
<Route
  path="/my-new-page"
  element={
    <ProtectedRoute>
      <MyNewPage />
    </ProtectedRoute>
  }
/>
</code></pre></p><p>---</p><p><h2>Adding a New Component</h2></p><p><h3>Step 1: Choose the Right Location</h3></p><p><pre><code class="">src/components/
â”œâ”€â”€ ui/              # Base UI components (shadcn) - DON'T ADD HERE
â”œâ”€â”€ dashboard/       # Dashboard-related components
â”œâ”€â”€ settings/        # Settings page components
â”œâ”€â”€ unit/            # Unit detail components
â”œâ”€â”€ alerts/          # Alert-related components
â””â”€â”€ [feature]/       # Create a new folder for new features
</code></pre></p><p><h3>Step 2: Create the Component</h3></p><p><pre><code class="typescript">// src/components/dashboard/MyWidget.tsx
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";</p><p>interface MyWidgetProps {
  title: string;
  data: SomeDataType;
}</p><p>export function MyWidget({ title, data }: MyWidgetProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
      </CardHeader>
      <CardContent>
        {/</em> Widget content <em>/}
      </CardContent>
    </Card>
  );
}
</code></pre></p><p><h3>Step 3: Use shadcn/ui Components</h3></p><p>Always use existing shadcn/ui components from <code>/src/components/ui/</code>:</p><p><pre><code class="typescript">import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { toast } from "@/hooks/use-toast";
</code></pre></p><p><strong>Adding a new shadcn component:</strong></p><p><pre><code class="bash">npx shadcn-ui@latest add [component-name]
</code></pre></p><p>---</p><p><h2>Fetching Data from Supabase</h2></p><p><h3>Pattern 1: Using TanStack Query (Recommended)</h3></p><p>Create a custom hook in <code>/src/hooks/</code>:</p><p><pre><code class="typescript">// src/hooks/useMyData.ts
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { supabase } from "@/integrations/supabase/client";</p><p>export function useMyData(organizationId: string) {
  return useQuery({
    queryKey: ["my-data", organizationId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from("my_table")
        .select("</em>")
        .eq("organization_id", organizationId);</p><p>      if (error) throw error;
      return data;
    },
    enabled: !!organizationId,
  });
}</p><p>export function useCreateMyData() {
  const queryClient = useQueryClient();</p><p>  return useMutation({
    mutationFn: async (newData: MyDataInsert) => {
      const { data, error } = await supabase
        .from("my_table")
        .insert(newData)
        .select()
        .single();</p><p>      if (error) throw error;
      return data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["my-data"] });
    },
  });
}
</code></pre></p><p><h3>Pattern 2: Using in Components</h3></p><p><pre><code class="typescript">// In your component
import { useMyData, useCreateMyData } from "@/hooks/useMyData";</p><p>function MyComponent() {
  const { data, isLoading, error } = useMyData(organizationId);
  const createMutation = useCreateMyData();</p><p>  if (isLoading) return <Spinner />;
  if (error) return <ErrorDisplay error={error} />;</p><p>  const handleCreate = async () => {
    await createMutation.mutateAsync({ name: "New Item" });
  };</p><p>  return (
    <div>
      {data.map(item => <ItemRow key={item.id} item={item} />)}
      <Button onClick={handleCreate}>Add New</Button>
    </div>
  );
}
</code></pre></p><p><h3>Query Key Conventions</h3></p><p>Follow these patterns for consistent cache invalidation:</p><p><pre><code class="typescript">// Entity lists
["units", organizationId]
["alerts", { organizationId, status: "active" }]
["sensors", { unitId }]</p><p>// Single entities
["unit", unitId]
["alert", alertId]</p><p>// Related data
["unit-sensors", unitId]
["unit-readings", unitId, { period: "24h" }]
</code></pre></p><p>---</p><p><h2>Adding a New Edge Function</h2></p><p><h3>Step 1: Create the Function Directory</h3></p><p><pre><code class="bash">mkdir supabase/functions/my-new-function
touch supabase/functions/my-new-function/index.ts
</code></pre></p><p><h3>Step 2: Write the Function</h3></p><p><pre><code class="typescript">// supabase/functions/my-new-function/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import { corsHeaders } from "../_shared/cors.ts";</p><p>serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }</p><p>  try {
    // Create Supabase client with auth context
    const supabaseClient = createClient(
      Deno.env.get("SUPABASE_URL") ?? "",
      Deno.env.get("SUPABASE_ANON_KEY") ?? "",
      {
        global: {
          headers: { Authorization: req.headers.get("Authorization")! },
        },
      }
    );</p><p>    // Get the authenticated user
    const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: "Unauthorized" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }</p><p>    // Parse request body
    const body = await req.json();</p><p>    // Your business logic here
    const result = await processData(body, supabaseClient);</p><p>    return new Response(
      JSON.stringify(result),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
</code></pre></p><p><h3>Step 3: Call from Frontend</h3></p><p><pre><code class="typescript">// In a hook or component
const { data, error } = await supabase.functions.invoke("my-new-function", {
  body: { key: "value" },
});
</code></pre></p><p><h3>Step 4: Deploy</h3></p><p><pre><code class="bash"><h1>Deploy to Supabase</h1>
supabase functions deploy my-new-function
</code></pre></p><p>---</p><p><h2>Creating a Database Migration</h2></p><p><h3>Step 1: Create Migration File</h3></p><p><pre><code class="bash">supabase migration new add_my_table
<h1>Creates: supabase/migrations/YYYYMMDDHHMMSS_add_my_table.sql</h1>
</code></pre></p><p><h3>Step 2: Write the SQL</h3></p><p><pre><code class="sql">-- supabase/migrations/YYYYMMDDHHMMSS_add_my_table.sql</p><p>-- Create the table
CREATE TABLE public.my_table (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);</p><p>-- Enable RLS
ALTER TABLE public.my_table ENABLE ROW LEVEL SECURITY;</p><p>-- Create RLS policies
CREATE POLICY "Users can view their org's data"
    ON public.my_table
    FOR SELECT
    USING (organization_id IN (
        SELECT organization_id FROM profiles WHERE id = auth.uid()
    ));</p><p>CREATE POLICY "Users can insert their org's data"
    ON public.my_table
    FOR INSERT
    WITH CHECK (organization_id IN (
        SELECT organization_id FROM profiles WHERE id = auth.uid()
    ));</p><p>-- Create updated_at trigger
CREATE TRIGGER update_my_table_updated_at
    BEFORE UPDATE ON public.my_table
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
</code></pre></p><p><h3>Step 3: Apply Migration</h3></p><p><pre><code class="bash"><h1>Locally</h1>
supabase db reset</p><p><h1>Remote (careful!)</h1>
supabase db push
</code></pre></p><p><h3>Step 4: Regenerate Types</h3></p><p><pre><code class="bash">supabase gen types typescript --local > src/integrations/supabase/types.ts
</code></pre></p><p>---</p><p><h2>Adding a New Alert Type</h2></p><p>Alerts are managed by the <code>process-unit-states</code> edge function. Here's how to add a new alert type:</p><p><h3>Step 1: Add to Alert Config (Frontend)</h3></p><p>Edit <code>/src/lib/alertConfig.ts</code>:</p><p><pre><code class="typescript">export const ALERT_TYPES = {
  // ... existing types
  my_new_alert: {
    label: "My New Alert",
    icon: AlertCircle,
    color: "warning", // or "critical"
    description: "Description of when this triggers",
    clearCondition: "When the condition is resolved",
  },
} as const;
</code></pre></p><p><h3>Step 2: Add Detection Logic (Backend)</h3></p><p>Edit <code>/supabase/functions/process-unit-states/index.ts</code>:</p><p><pre><code class="typescript">// In the alert evaluation section
function evaluateAlerts(unit: Unit, reading: Reading, rules: AlertRules) {
  const alerts: Alert[] = [];</p><p>  // ... existing alert checks</p><p>  // Add your new alert check
  if (shouldTriggerMyNewAlert(unit, reading, rules)) {
    alerts.push({
      type: "my_new_alert",
      severity: "warning",
      unit_id: unit.id,
      message: <code>My new alert triggered for ${unit.name}</code>,
    });
  }</p><p>  return alerts;
}
</code></pre></p><p><h3>Step 3: Add Database Support</h3></p><p>Create a migration if needed to support new alert metadata.</p><p>---</p><p><h2>Modifying the TTN Integration</h2></p><p>TTN (The Things Network) integration has several components:</p><p><h3>Webhook Handler</h3></p><p><code>/supabase/functions/ttn-webhook/index.ts</code> â€” Receives uplink messages from TTN.</p><p>To modify how sensor data is processed:</p><p><pre><code class="typescript">// In ttn-webhook/index.ts
async function processUplink(payload: TTNUplink) {
  // Normalize the DevEUI
  const devEUI = normalizeDevEUI(payload.end_device_ids.dev_eui);</p><p>  // Find the sensor
  const sensor = await findSensorByDevEUI(devEUI);</p><p>  // Extract and transform readings
  const reading = extractReading(payload);</p><p>  // Save to database
  await saveReading(sensor.id, reading);
}
</code></pre></p><p><h3>Device Provisioning</h3></p><p><code>/supabase/functions/ttn-provision-device/index.ts</code> â€” Registers devices with TTN.</p><p><h3>TTN Configuration</h3></p><p><code>/src/components/settings/TTNConnectionSettings.tsx</code> â€” UI for configuring TTN credentials.</p><p><h3>Key Files for TTN Work</h3></p><p>| File | Purpose |
|------|---------|
| <code>/supabase/functions/_shared/ttnConfig.ts</code> | DevEUI normalization, TTN helpers |
| <code>/supabase/functions/_shared/ttnPermissions.ts</code> | API key permission validation |
| <code>/src/types/ttn.ts</code> | TypeScript types for TTN entities |
| <code>/src/hooks/useTTNSetupWizard.ts</code> | TTN onboarding flow logic |</p><p>---</p><p><h2>Working with the Settings Wizard</h2></p><p>The settings wizard is in <code>/src/components/settings/</code>. The main orchestration happens in:</p><p><h3>Wizard Structure</h3></p><p><pre><code class="">settings/
â”œâ”€â”€ SettingsTabs.tsx           # Main tab container
â”œâ”€â”€ TTNConnectionSettings.tsx   # TTN configuration
â”œâ”€â”€ SensorManager.tsx           # Sensor CRUD
â”œâ”€â”€ GatewayManager.tsx          # Gateway CRUD
â”œâ”€â”€ AlertRulesEditor.tsx        # Alert thresholds
â””â”€â”€ NotificationPolicyEditor.tsx # Notification settings
</code></pre></p><p><h3>Adding a New Settings Section</h3></p><p><li>Create your component:</li></p><p><pre><code class="typescript">// src/components/settings/MyNewSettings.tsx
export function MyNewSettings({ organizationId }: Props) {
  // Your settings UI
}
</code></pre></p><p><li>Add to the tabs:</li></p><p><pre><code class="typescript">// In SettingsTabs.tsx
<TabsContent value="my-new">
  <MyNewSettings organizationId={organizationId} />
</TabsContent>
</code></pre></p><p><h3>Cascading Settings Pattern</h3></p><p>Settings cascade: Organization â†’ Site â†’ Unit. Use the <code>get_effective_<em></code> RPCs:</p><p><pre><code class="typescript">// Get effective settings for a unit (includes org/site defaults)
const { data } = await supabase.rpc("get_effective_alert_rules", {
  p_unit_id: unitId,
});
</code></pre></p><p>---</p><p><h2>Adding Role-Based Access</h2></p><p><h3>Check User Role</h3></p><p>Use the <code>useUserRole</code> hook:</p><p><pre><code class="typescript">import { useUserRole } from "@/hooks/useUserRole";</p><p>function MyComponent() {
  const { role, isAdmin, isOwner, isLoading } = useUserRole();</p><p>  if (isLoading) return <Spinner />;</p><p>  return (
    <div>
      {isAdmin && <AdminOnlyFeature />}
      {role === "staff" && <StaffView />}
    </div>
  );
}
</code></pre></p><p><h3>Role Hierarchy</h3></p><p>| Role | Can Do |
|------|--------|
| <code>owner</code> | Everything, including billing and user management |
| <code>admin</code> | All operations except billing |
| <code>manager</code> | View and manage assigned locations |
| <code>staff</code> | Log temperatures, acknowledge alerts |</p><p><h3>Backend Role Checks</h3></p><p>In edge functions, check roles via the profiles table:</p><p><pre><code class="typescript">const { data: profile } = await supabase
  .from("profiles")
  .select("role")
  .eq("id", user.id)
  .single();</p><p>if (!["owner", "admin"].includes(profile.role)) {
  return new Response(JSON.stringify({ error: "Forbidden" }), { status: 403 });
}
</code></pre></p><p>---</p><p><h2>Testing Your Changes</h2></p><p><h3>Frontend Testing</h3></p><p><pre><code class="bash"><h1>Run Vitest</h1>
npm run test</p><p><h1>Watch mode</h1>
npm run test -- --watch
</code></pre></p><p><h3>Manual Testing Checklist</h3></p><p>Before pushing, verify:</p><p><li>[ ] No console errors in browser</li>
<li>[ ] No TypeScript errors (<code>npm run lint</code>)</li>
<li>[ ] Feature works as expected</li>
<li>[ ] Mobile responsive (check at 375px width)</li>
<li>[ ] Loading states handled</li>
<li>[ ] Error states handled</li>
<li>[ ] Works with empty data</li></p><p><h3>Testing Edge Functions</h3></p><p><pre><code class="bash"><h1>Start function server</h1>
supabase functions serve</p><p><h1>Test with curl</h1>
curl -X POST http://localhost:54321/functions/v1/my-function \
  -H "Authorization: Bearer <anon-key>" \
  -H "Content-Type: application/json" \
  -d '{"key": "value"}'
</code></pre></p><p><h3>Testing Database Changes</h3></p><p><pre><code class="bash"><h1>Reset local database (applies all migrations)</h1>
supabase db reset</p><p><h1>Check RLS policies work</h1>
<h1>1. Sign in as a user</h1>
<h1>2. Try to access data from another org</h1>
<h1>3. Should get no results (not an error)</h1>
</code></pre></p><p>---</p><p><h2>Quick Reference</h2></p><p><h3>Import Aliases</h3></p><p><pre><code class="typescript">import { something } from "@/components/...";  // src/components
import { something } from "@/hooks/...";       // src/hooks
import { something } from "@/lib/...";         // src/lib
import { something } from "@/pages/...";       // src/pages
</code></pre></p><p><h3>Supabase Client</h3></p><p><pre><code class="typescript">import { supabase } from "@/integrations/supabase/client";
</code></pre></p><p><h3>Toast Notifications</h3></p><p><pre><code class="typescript">import { toast } from "@/hooks/use-toast";</p><p>toast({
  title: "Success",
  description: "Your changes have been saved.",
});</p><p>toast({
  title: "Error",
  description: "Something went wrong.",
  variant: "destructive",
});
</code></pre></p><p><h3>Common Hooks</h3></p><p><pre><code class="typescript">import { useNavigate, useParams } from "react-router-dom";
import { useQuery, useMutation } from "@tanstack/react-query";
import { useUserRole } from "@/hooks/useUserRole";
import { useUnitStatus } from "@/hooks/useUnitStatus";
</code></pre></p><p>---</p><p><h2>Next Steps</h2></p><p><li><a href="#debugging_guide">DEBUGGING_GUIDE.md</a> â€” Troubleshooting common issues</li>
<li><a href="#repo_tour">REPO_TOUR.md</a> â€” Understand the codebase structure</li>
<li><a href="#getting_started">GETTING_STARTED.md</a> â€” Mental model for the system</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="onboarding-debugging_guide"></a></p><p><h1>Debugging Guide</h1></p><p><blockquote>Troubleshooting common issues and debugging strategies</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#debugging-philosophy">Debugging Philosophy</a></li>
<li><a href="#quick-diagnosis-checklist">Quick Diagnosis Checklist</a></li>
<li><a href="#frontend-debugging">Frontend Debugging</a></li>
<li><a href="#backend-debugging">Backend Debugging</a></li>
<li><a href="#database-debugging">Database Debugging</a></li>
<li><a href="#ttn-integration-issues">TTN Integration Issues</a></li>
<li><a href="#alert-system-issues">Alert System Issues</a></li>
<li><a href="#common-error-patterns">Common Error Patterns</a></li>
<li><a href="#performance-issues">Performance Issues</a></li>
<li><a href="#known-sharp-edges">Known Sharp Edges</a></li></p><p>---</p><p><h2>Debugging Philosophy</h2></p><p><h3>Follow the Data Flow</h3></p><p>Most bugs occur at boundaries. Trace data through the system:</p><p><pre><code class="">User Action â†’ React State â†’ Supabase Query â†’ Database â†’ Response â†’ React Query Cache â†’ UI
</code></pre></p><p><strong>Ask yourself:</strong>
<li>Where does the data enter the system?</li>
<li>Where does it transform?</li>
<li>Where does it render?</li></p><p><h3>Check These First (90% of issues)</h3></p><p><li><strong>Console errors</strong> â€” Browser DevTools console</li>
<li><strong>Network failures</strong> â€” Browser DevTools Network tab</li>
<li><strong>Wrong environment</strong> â€” Check <code>.env</code> values</li>
<li><strong>Stale cache</strong> â€” Hard refresh or clear query cache</li>
<li><strong>RLS blocking</strong> â€” User doesn't have access</li></p><p>---</p><p><h2>Quick Diagnosis Checklist</h2></p><p>When something isn't working, check in this order:</p><p><pre><code class="">â–¡ Browser console (F12 â†’ Console)
â–¡ Network tab (F12 â†’ Network)
â–¡ Terminal running dev server
â–¡ Supabase function logs
â–¡ Database query directly in Supabase Studio
</code></pre></p><p><h3>One-Liner Diagnostics</h3></p><p><pre><code class="bash"><h1>Check if frontend is running</h1>
curl http://localhost:8080</p><p><h1>Check if Supabase is running</h1>
supabase status</p><p><h1>Check function logs</h1>
supabase functions logs <function-name></p><p><h1>Check database connection</h1>
psql "postgresql://postgres:postgres@localhost:54322/postgres" -c "SELECT 1"
</code></pre></p><p>---</p><p><h2>Frontend Debugging</h2></p><p><h3>React DevTools</h3></p><p>Install the React DevTools browser extension. It lets you:
<li>Inspect component hierarchy</li>
<li>View props and state</li>
<li>See what triggered re-renders</li></p><p><h3>TanStack Query DevTools</h3></p><p>The app includes TanStack Query DevTools (in development mode):
<li>See all cached queries</li>
<li>Inspect query states (loading, error, success)</li>
<li>Manually invalidate queries</li>
<li>Trigger refetches</li></p><p><strong>Location:</strong> Bottom-right corner of the screen (flower icon).</p><p><h3>Debug Mode</h3></p><p>FreshTrack Pro has a built-in debug mode:</p><p><li>Enable in <code>.env</code>: <code>VITE_ENABLE_DEBUG_MODE="true"</code></li>
<li>Opens a debug terminal with system information</li>
<li>Shows real-time events and state changes</li></p><p><h3>Common Frontend Issues</h3></p><p>#### Issue: Data not updating after mutation</p><p><strong>Symptom:</strong> You save something, but the UI doesn't update.</p><p><strong>Cause:</strong> Query cache not invalidated.</p><p><strong>Solution:</strong>
<pre><code class="typescript">// In your mutation
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ["your-query-key"] });
},
</code></pre></p><p>#### Issue: Component re-renders infinitely</p><p><strong>Symptom:</strong> Browser freezes, "Maximum update depth" error.</p><p><strong>Cause:</strong> Dependency array issue in useEffect or useMemo.</p><p><strong>Debug:</strong>
<pre><code class="typescript">// Add logging to see what's changing
useEffect(() => {
  console.log("Effect ran", { dep1, dep2 });
}, [dep1, dep2]);
</code></pre></p><p><strong>Solution:</strong> Ensure dependencies are stable (use useMemo/useCallback).</p><p>#### Issue: "Cannot read property of undefined"</p><p><strong>Symptom:</strong> White screen, error in console.</p><p><strong>Cause:</strong> Data not loaded yet, or null check missing.</p><p><strong>Solution:</strong>
<pre><code class="typescript">// Add loading state check
if (isLoading) return <Spinner />;
if (!data) return <EmptyState />;</p><p>// Use optional chaining
const value = data?.nested?.property;
</code></pre></p><p>#### Issue: Toast not showing</p><p><strong>Symptom:</strong> Action completes but no feedback.</p><p><strong>Solution:</strong>
<pre><code class="typescript">import { toast } from "@/hooks/use-toast";</p><p>toast({
  title: "Success",
  description: "Your action completed.",
});
</code></pre></p><p>---</p><p><h2>Backend Debugging</h2></p><p><h3>Viewing Edge Function Logs</h3></p><p><pre><code class="bash"><h1>Stream logs in real-time (local)</h1>
supabase functions serve</p><p><h1>View logs in Supabase Dashboard (remote)</h1>
<h1>Go to: Project â†’ Edge Functions â†’ Logs</h1>
</code></pre></p><p><h3>Adding Debug Logging</h3></p><p><pre><code class="typescript">// In edge functions
console.log("Debug:", JSON.stringify({ variable, anotherVariable }));</p><p>// These appear in:
// - Terminal (local development)
// - Supabase Dashboard logs (production)
</code></pre></p><p><h3>Testing Functions Locally</h3></p><p><pre><code class="bash"><h1>Serve all functions</h1>
supabase functions serve</p><p><h1>Test with curl</h1>
curl -X POST http://localhost:54321/functions/v1/my-function \
  -H "Authorization: Bearer $(supabase status | grep anon | awk '{print $3}')" \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
</code></pre></p><p><h3>Common Backend Issues</h3></p><p>#### Issue: Function returns 401 Unauthorized</p><p><strong>Cause:</strong> Missing or invalid auth token.</p><p><strong>Debug:</strong>
<pre><code class="typescript">// Log the auth state
const { data: { user }, error } = await supabase.auth.getUser();
console.log("Auth:", { user: user?.id, error });
</code></pre></p><p><strong>Solutions:</strong>
<li>Ensure frontend passes auth header</li>
<li>Check if user is logged in</li>
<li>Verify JWT hasn't expired</li></p><p>#### Issue: Function returns 500 Internal Server Error</p><p><strong>Debug:</strong>
<pre><code class="typescript">try {
  // Your code
} catch (error) {
  console.error("Function error:", error);
  return new Response(
    JSON.stringify({ error: error.message, stack: error.stack }),
    { status: 500 }
  );
}
</code></pre></p><p>#### Issue: CORS errors</p><p><strong>Symptom:</strong> "Access-Control-Allow-Origin" error in console.</p><p><strong>Solution:</strong> Ensure you return CORS headers:
<pre><code class="typescript">import { corsHeaders } from "../_shared/cors.ts";</p><p>// For preflight
if (req.method === "OPTIONS") {
  return new Response("ok", { headers: corsHeaders });
}</p><p>// For all responses
return new Response(JSON.stringify(data), {
  headers: { ...corsHeaders, "Content-Type": "application/json" }
});
</code></pre></p><p>---</p><p><h2>Database Debugging</h2></p><p><h3>Direct Database Access</h3></p><p><pre><code class="bash"><h1>Connect to local database</h1>
psql "postgresql://postgres:postgres@localhost:54322/postgres"</p><p><h1>Or use Supabase Studio</h1>
supabase studio  # Opens at http://localhost:54323
</code></pre></p><p><h3>Debugging RLS Policies</h3></p><p>RLS issues are silent â€” you get empty results, not errors.</p><p><strong>Debug approach:</strong></p><p><li><strong>Test as service role (bypasses RLS):</strong></li>
<pre><code class="sql">-- In Supabase Studio SQL editor
SELECT </em> FROM units;  -- Service role bypasses RLS
</code></pre></p><p><li><strong>Test as user:</strong></li>
<pre><code class="sql">-- Simulate RLS as a specific user
SET request.jwt.claim.sub = 'user-uuid-here';
SELECT <em> FROM units;
</code></pre></p><p><li><strong>Check the policy:</strong></li>
<pre><code class="sql">-- View policies on a table
SELECT </em> FROM pg_policies WHERE tablename = 'units';
</code></pre></p><p><h3>Common Database Issues</h3></p><p>#### Issue: Insert/Update silently fails</p><p><strong>Cause:</strong> RLS policy blocks the operation.</p><p><strong>Debug:</strong>
<pre><code class="sql">-- Check if user has organization access
SELECT organization_id FROM profiles WHERE id = 'user-uuid';</p><p>-- Check policy conditions
SELECT organization_id FROM units WHERE id = 'unit-uuid';
</code></pre></p><p>#### Issue: Cascading settings not working</p><p><strong>Cause:</strong> <code>get_effective_<em></code> RPC not being used.</p><p><strong>Solution:</strong> Always use the RPC for settings that cascade:
<pre><code class="typescript">const { data } = await supabase.rpc("get_effective_alert_rules", {
  p_unit_id: unitId,
});
</code></pre></p><p>#### Issue: Migration fails</p><p><strong>Debug:</strong>
<pre><code class="bash"><h1>See migration status</h1>
supabase migration list</p><p><h1>Reset and reapply all migrations</h1>
supabase db reset</p><p><h1>Check for SQL errors</h1>
supabase db push --dry-run
</code></pre></p><p>---</p><p><h2>TTN Integration Issues</h2></p><p><h3>DevEUI Normalization</h3></p><p>DevEUIs must be normalized (uppercase, no separators):</p><p><pre><code class="typescript">// Correct
const devEUI = "70B3D57ED005A123";</p><p>// Incorrect (will fail to match)
const devEUI = "70:B3:D5:7E:D0:05:A1:23";  // Has colons
const devEUI = "70b3d57ed005a123";          // Lowercase
</code></pre></p><p><strong>Debug:</strong>
<pre><code class="typescript">// In ttn-webhook
console.log("Raw DevEUI:", payload.end_device_ids.dev_eui);
console.log("Normalized:", normalizeDevEUI(payload.end_device_ids.dev_eui));
</code></pre></p><p><h3>Webhook Not Receiving Data</h3></p><p><li><strong>Check TTN Console:</strong></li>
   - Go to Applications â†’ Your App â†’ Webhooks
   - Verify webhook URL is correct
   - Check "Last sent" timestamp</p><p><li><strong>Check webhook secret:</strong></li>
   - TTN sends an <code>X-Downlink-Apikey</code> header
   - Must match what's configured in our database</p><p><li><strong>Check function logs:</strong></li>
<pre><code class="bash">supabase functions logs ttn-webhook --follow
</code></pre></p><p><h3>Device Not Joining</h3></p><p><li><strong>Check device registration:</strong></li>
   - Device registered in TTN Console?
   - AppKey correct?
   - DevEUI matches physical device?</p><p><li><strong>Check gateway:</strong></li>
   - Gateway online in TTN Console?
   - Device in range of gateway?</p><p><h3>Sensor Shows "Offline"</h3></p><p><strong>Possible causes:</strong>
<li>Device battery dead</li>
<li>Device out of range</li>
<li>Gateway offline</li>
<li>Webhook not processing</li></p><p><strong>Debug path:</strong>
<li>Check TTN Console for recent uplinks</li>
<li>Check <code>sensor_readings</code> table for recent data</li>
<li>Check <code>lora_sensors</code> table for <code>last_seen_at</code></li>
<li>Check function logs for errors</li></p><p>---</p><p><h2>Alert System Issues</h2></p><p><h3>Alerts Not Triggering</h3></p><p>The SSOT for alerts is <code>process-unit-states</code>. Debug there:</p><p><pre><code class="bash"><h1>Check function logs</h1>
supabase functions logs process-unit-states --follow</p><p><h1>Manually trigger for a unit</h1>
curl -X POST http://localhost:54321/functions/v1/process-unit-states \
  -H "Authorization: Bearer <service-role-key>" \
  -H "Content-Type: application/json" \
  -d '{"unit_id": "your-unit-uuid"}'
</code></pre></p><p><strong>Common causes:</strong>
<li>Confirm time not elapsed (needs X minutes of excursion)</li>
<li>Alert rule not applied (check <code>get_effective_alert_rules</code>)</li>
<li>Unit status already in alarm state</li></p><p><h3>Alerts Not Resolving</h3></p><p><strong>Check:</strong>
<li>Temperature returned to safe range?</li>
<li>Clear condition met (in <code>alertConfig.ts</code>)?</li>
<li><code>process-unit-states</code> running on schedule?</li></p><p><h3>Escalations Not Sending</h3></p><p>The SSOT for notifications is <code>process-escalations</code>.</p><p><strong>Check:</strong>
<li>Notification policy configured?</li>
<li>User has valid contact (email/phone)?</li>
<li>Escalation delay elapsed?</li></p><p><pre><code class="bash">supabase functions logs process-escalations --follow
</code></pre></p><p>---</p><p><h2>Common Error Patterns</h2></p><p><h3>"TypeError: Cannot read properties of null"</h3></p><p><strong>Pattern:</strong>
<pre><code class="">TypeError: Cannot read properties of null (reading 'map')
</code></pre></p><p><strong>Cause:</strong> Trying to iterate over null/undefined data.</p><p><strong>Fix:</strong>
<pre><code class="typescript">// Before
{data.map(item => ...)}</p><p>// After
{data?.map(item => ...) ?? <EmptyState />}
</code></pre></p><p><h3>"Uncaught (in promise) Error"</h3></p><p><strong>Pattern:</strong> Async operation fails without being caught.</p><p><strong>Fix:</strong>
<pre><code class="typescript">// Add error handling
try {
  await someAsyncOperation();
} catch (error) {
  console.error("Operation failed:", error);
  toast({ title: "Error", description: error.message, variant: "destructive" });
}
</code></pre></p><p><h3>"PostgrestError: permission denied for table"</h3></p><p><strong>Cause:</strong> RLS policy blocking access.</p><p><strong>Fix:</strong> Check user's organization membership and policy conditions.</p><p><h3>"FunctionsFetchError: Failed to fetch"</h3></p><p><strong>Cause:</strong> Edge function not running or network issue.</p><p><strong>Check:</strong>
<li>Function is deployed/serving</li>
<li>URL is correct</li>
<li>No CORS issues</li></p><p>---</p><p><h2>Performance Issues</h2></p><p><h3>Slow Initial Load</h3></p><p><strong>Diagnose:</strong>
<li>Check Network tab for slow requests</li>
<li>Look for large bundle sizes</li>
<li>Check for unnecessary data fetching</li></p><p><strong>Solutions:</strong>
<li>Use React.lazy for code splitting</li>
<li>Limit initial data fetch (pagination)</li>
<li>Check for N+1 query patterns</li></p><p><h3>Slow Database Queries</h3></p><p><strong>Diagnose:</strong>
<pre><code class="sql">-- Find slow queries
SELECT </em> FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;
</code></pre></p><p><strong>Solutions:</strong>
<li>Add indexes for frequently filtered columns</li>
<li>Use <code>.select()</code> to limit returned columns</li>
<li>Add pagination</li></p><p><h3>Memory Leaks</h3></p><p><strong>Symptoms:</strong> App slows down over time.</p><p><strong>Common causes:</strong>
<li>Subscriptions not cleaned up</li>
<li>Timers not cleared</li>
<li>Event listeners not removed</li></p><p><strong>Fix:</strong>
<pre><code class="typescript">useEffect(() => {
  const subscription = supabase.channel('...').subscribe();</p><p>  return () => {
    subscription.unsubscribe();  // Cleanup!
  };
}, []);
</code></pre></p><p>---</p><p><h2>Known Sharp Edges</h2></p><p><h3>1. DevEUI Case Sensitivity</h3></p><p>DevEUIs from different sources may have different cases. Always normalize:</p><p><pre><code class="typescript">import { normalizeDevEUI } from "@/lib/ttnConfig";
const normalized = normalizeDevEUI(rawDevEUI);
</code></pre></p><p><h3>2. Timezone Handling</h3></p><p>All timestamps are stored in UTC. Display conversion happens on frontend:</p><p><pre><code class="typescript">// Database stores UTC
created_at: "2026-01-12T10:00:00Z"</p><p>// Display in user's timezone
new Date(created_at).toLocaleString()
</code></pre></p><p><h3>3. RLS Doesn't Error, It Filters</h3></p><p>If a user can't access data, they get empty results â€” not an error. This is intentional for security but can confuse debugging.</p><p><h3>4. Cascading Settings Evaluation</h3></p><p>Settings cascade: Org â†’ Site â†’ Unit. The most specific setting wins. Use <code>get_effective_<em></code> RPCs.</p><p><h3>5. Alert Confirm Time</h3></p><p>Alerts don't trigger immediately. They wait for <code>confirm_time_minutes</code> to avoid false alarms from brief fluctuations.</p><p><h3>6. Supabase Types Regeneration</h3></p><p>After database changes, regenerate types:</p><p><pre><code class="bash">supabase gen types typescript --local > src/integrations/supabase/types.ts
</code></pre></p><p>Forgetting this causes TypeScript errors about missing columns.</p><p><h3>7. Edge Function Cold Starts</h3></p><p>First request after deployment may be slow (cold start). This is normal.</p><p><h3>8. Query Key Inconsistency</h3></p><p>If query keys don't match between fetch and invalidation, cache updates won't work:</p><p><pre><code class="typescript">// These must match!
useQuery({ queryKey: ["units", orgId] })  // Fetch
queryClient.invalidateQueries({ queryKey: ["units", orgId] })  // Invalidate
</code></pre></p><p>---</p><p><h2>Debugging Toolkit</h2></p><p><h3>Browser DevTools</h3></p><p><li><strong>Console (F12):</strong> JavaScript errors and logs</li>
<li><strong>Network:</strong> API requests and responses</li>
<li><strong>Application â†’ Storage:</strong> Local storage, cookies</li>
<li><strong>React DevTools:</strong> Component inspection</li>
<li><strong>TanStack Query DevTools:</strong> Query cache state</li></p><p><h3>Terminal Commands</h3></p><p><pre><code class="bash"><h1>Frontend</h1>
npm run dev             # Start with hot reload
npm run lint            # Check for errors
npm run build           # Build (catches type errors)</p><p><h1>Backend</h1>
supabase start          # Start local Supabase
supabase functions serve # Run functions locally
supabase functions logs <name> # View function logs
supabase db reset       # Reset database</p><p><h1>Database</h1>
psql <connection-string> # Direct database access
supabase studio         # Visual database browser
</code></pre></p><p><h3>Useful Queries</h3></p><p><pre><code class="sql">-- Recent sensor readings
SELECT </em> FROM sensor_readings ORDER BY created_at DESC LIMIT 10;</p><p>-- Active alerts
SELECT <em> FROM alerts WHERE status = 'triggered';</p><p>-- User's organization
SELECT p.</em>, o.name as org_name
FROM profiles p
JOIN organizations o ON p.organization_id = o.id
WHERE p.id = 'user-uuid';</p><p>-- Check RLS policies
SELECT <em> FROM pg_policies WHERE tablename = 'your_table';
</code></pre></p><p>---</p><p><h2>Getting Help</h2></p><p><li><strong>Check this guide</strong> for common issues</li>
<li><strong>Search the codebase</strong> for similar patterns</li>
<li><strong>Check Supabase docs</strong> for database/auth issues</li>
<li><strong>Check React Query docs</strong> for caching issues</li>
<li><strong>Ask the team</strong> with context:</li>
   - What you're trying to do
   - What you expected
   - What actually happened
   - Error messages
   - Steps to reproduce</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#local_dev">LOCAL_DEV.md</a> â€” Development environment setup</li>
<li><a href="#common_tasks">COMMON_TASKS.md</a> â€” How to do common tasks</li>
<li><a href="#repo_tour">REPO_TOUR.md</a> â€” Codebase structure</li>
<li><a href="#getting_started">GETTING_STARTED.md</a> â€” System mental model</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="qa-test_strategy"></a></p><p><h1>Test Strategy</h1></p><p><blockquote>FreshTrack Pro Quality Assurance Philosophy and Approach</blockquote></p><p>---</p><p><h2>Executive Summary</h2></p><p>FreshTrack Pro is a <strong>safety-critical refrigeration monitoring platform</strong>. A missed alert can result in $10,000+ of spoiled inventory and potential health code violations. This test strategy prioritizes <strong>reliability over speed</strong> and <strong>coverage of critical paths over cosmetic features</strong>.</p><p>---</p><p><h2>Testing Philosophy</h2></p><p><h3>Core Principles</h3></p><p>| Principle | Description |
|-----------|-------------|
| <strong>Safety First</strong> | Test alert paths, escalations, and data integrity above all else |
| <strong>Follow the Data</strong> | Trace data from sensor â†’ webhook â†’ database â†’ UI â†’ notification |
| <strong>SSOT Validation</strong> | Verify single-source-of-truth components (process-unit-states, process-escalations) |
| <strong>Regression Prevention</strong> | Every bug fix should include a test that would have caught it |
| <strong>Test at Boundaries</strong> | Most bugs occur at integration pointsâ€”focus testing there |</p><p><h3>Risk-Based Prioritization</h3></p><p>| Risk Level | Feature Category | Testing Approach |
|------------|------------------|------------------|
| <strong>Critical</strong> | Alerts, notifications, data ingestion | Automated + Manual + E2E |
| <strong>High</strong> | Device provisioning, TTN integration, auth | Automated + Manual |
| <strong>Medium</strong> | Dashboard, reports, settings | Automated unit + Manual |
| <strong>Low</strong> | UI polish, branding, theming | Manual only |</p><p>---</p><p><h2>Testing Layers</h2></p><p><h3>The Testing Pyramid</h3></p><p><pre><code class="">                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   E2E Tests     â”‚  â† Few, slow, high confidence
                    â”‚   (Manual/Auto) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Integration Tests â”‚  â† Medium coverage
                   â”‚  (API, Database)   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚        Unit Tests           â”‚  â† Many, fast, focused
              â”‚  (Functions, Components)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p><h3>Layer Definitions</h3></p><p>#### 1. Unit Tests (Automated)</p><p><strong>Scope:</strong> Individual functions, hooks, and components in isolation.</p><p><strong>Current Framework:</strong>
<li>Frontend: Vitest + React Testing Library</li>
<li>Edge Functions: Deno standard library testing</li></p><p><strong>What to Test:</strong>
<li>Pure functions (eligibility checks, data transformations)</li>
<li>Validation logic</li>
<li>State computations (e.g., unit status)</li>
<li>Utility functions</li></p><p><strong>What NOT to Test:</strong>
<li>UI styling</li>
<li>Third-party library internals</li>
<li>Generated types</li></p><p><strong>Example:</strong>
<pre><code class="typescript">describe("canProvisionGateway", () => {
  it("returns ALLOWED when all conditions are met", () => {
    const result = canProvisionGateway(validGateway, validTtnConfig);
    expect(result.allowed).toBe(true);
  });
});
</code></pre></p><p>#### 2. Integration Tests (Automated + Manual)</p><p><strong>Scope:</strong> Multiple components/services working together.</p><p><strong>What to Test:</strong>
<li>API calls â†’ Database â†’ Response chain</li>
<li>Hook + Supabase client interactions</li>
<li>Edge function + Database operations</li>
<li>RLS policy enforcement</li></p><p><strong>Approaches:</strong>
<li>Mock Supabase client for deterministic testing</li>
<li>Use local Supabase for realistic integration tests</li>
<li>Test RLS policies with different user roles</li></p><p>#### 3. End-to-End Tests (Primarily Manual)</p><p><strong>Scope:</strong> Complete user journeys through the application.</p><p><strong>What to Test:</strong>
<li>Onboarding flow (signup â†’ org setup â†’ device provisioning)</li>
<li>Alert lifecycle (trigger â†’ acknowledge â†’ resolve)</li>
<li>Escalation chain (primary â†’ secondary â†’ manager notification)</li>
<li>Report generation</li></p><p><strong>Execution:</strong>
<li>Manual testing with documented checklists</li>
<li>Consider Playwright for critical paths in future</li></p><p>---</p><p><h2>Testing Responsibilities</h2></p><p><h3>What is Automated</h3></p><p>| Category | What's Tested | Framework |
|----------|--------------|-----------|
| <strong>Eligibility Logic</strong> | Gateway/sensor provisioning rules | Vitest |
| <strong>TTN Permissions</strong> | API key permission validation | Deno |
| <strong>Data Transformations</strong> | DevEUI normalization, temperature conversion | Vitest |
| <strong>Validation Schemas</strong> | Input validation (Zod schemas) | Vitest |</p><p><h3>What is Manual</h3></p><p>| Category | Why Manual | Documentation |
|----------|-----------|---------------|
| <strong>Device Provisioning</strong> | Requires TTN account, real hardware | <a href="#manual_testing">MANUAL_TESTING.md</a> |
| <strong>Alert Flow</strong> | Complex timing, escalation chains | <a href="#e2e_scenarios">E2E_SCENARIOS.md</a> |
| <strong>Onboarding Wizard</strong> | Multi-step UI with external dependencies | <a href="#manual_testing">MANUAL_TESTING.md</a> |
| <strong>Mobile Responsiveness</strong> | Visual verification required | <a href="#manual_testing">MANUAL_TESTING.md</a> |
| <strong>Stripe Integration</strong> | Payment flows, webhooks | <a href="#manual_testing">MANUAL_TESTING.md</a> |</p><p>---</p><p><h2>Test Environments</h2></p><p><h3>Local Development</h3></p><p><pre><code class="bash"><h1>Start local Supabase</h1>
supabase start</p><p><h1>Run frontend tests</h1>
npm run test</p><p><h1>Run edge function tests</h1>
cd supabase/functions/_shared
deno test
</code></pre></p><p><h3>Staging Environment</h3></p><p><li>Shared Supabase project for integration testing</li>
<li>Test TTN application (separate from production)</li>
<li>Stripe test mode</li></p><p><h3>Production</h3></p><p><li>No testing in production</li>
<li>Canary deployments for new features</li>
<li>Feature flags for gradual rollout</li></p><p>---</p><p><h2>Test Data Management</h2></p><p><h3>Principles</h3></p><p><li><strong>Isolation:</strong> Each test creates its own data</li>
<li><strong>Cleanup:</strong> Tests clean up after themselves</li>
<li><strong>Determinism:</strong> Same test, same result (no random data in assertions)</li>
<li><strong>Factories:</strong> Use factory functions for test data</li></p><p><h3>Test Data Factories (Recommended Pattern)</h3></p><p><pre><code class="typescript">// src/test/factories.ts
export function createTestTTNConfig(overrides = {}): TTNConfigState {
  return {
    isEnabled: true,
    hasApiKey: true,
    applicationId: "test-app-id",
    ...overrides,
  };
}</p><p>export function createTestGateway(overrides = {}): GatewayForEligibility {
  return {
    gateway_eui: "AABBCCDDEEFF0011",
    ttn_gateway_id: null,
    status: "pending",
    ...overrides,
  };
}
</code></pre></p><p>---</p><p><h2>Critical Path Coverage</h2></p><p>These paths MUST have both automated and manual testing:</p><p><h3>1. Data Ingestion Pipeline</h3></p><p><pre><code class="">Sensor â†’ TTN â†’ ttn-webhook â†’ sensor_readings table â†’ process-unit-states
</code></pre></p><p>| Step | Test Type | Coverage |
|------|-----------|----------|
| TTN webhook receives data | Integration | Manual |
| DevEUI normalization | Unit | Automated |
| Reading stored in database | Integration | Manual |
| Unit status computed | Unit | Automated (planned) |</p><p><h3>2. Alert Lifecycle</h3></p><p><pre><code class="">Excursion detected â†’ Alert created â†’ Notification sent â†’ Acknowledged â†’ Resolved
</code></pre></p><p>| Step | Test Type | Coverage |
|------|-----------|----------|
| Temperature threshold breach | Unit | Automated (planned) |
| Confirm time elapsed | Integration | Manual |
| Alert record created | Integration | Manual |
| Escalation triggered | E2E | Manual |</p><p><h3>3. Device Provisioning</h3></p><p><pre><code class="">User enters DevEUI â†’ Validate â†’ Register with TTN â†’ Save to database â†’ Status: Active
</code></pre></p><p>| Step | Test Type | Coverage |
|------|-----------|----------|
| DevEUI validation | Unit | Automated |
| Permission check | Unit | Automated |
| TTN API call | Integration | Manual |
| Database update | Integration | Manual |</p><p>---</p><p><h2>Quality Gates</h2></p><p><h3>Before Merging (PR Checklist)</h3></p><p><li>[ ] All existing tests pass</li>
<li>[ ] New tests added for new functionality</li>
<li>[ ] Manual testing completed for UI changes</li>
<li>[ ] No TypeScript errors (<code>npm run lint</code>)</li>
<li>[ ] No console errors in browser</li></p><p><h3>Before Release</h3></p><p><li>[ ] All automated tests pass</li>
<li>[ ] Manual E2E scenarios completed</li>
<li>[ ] Staging environment tested</li>
<li>[ ] Performance acceptable (page load < 3s)</li>
<li>[ ] Critical path manual testing signed off</li></p><p>---</p><p><h2>Metrics and Goals</h2></p><p><h3>Current State (Baseline)</h3></p><p>| Metric | Value |
|--------|-------|
| Test files | 3 |
| Lines of test code | 476 |
| Components with tests | 0/112 (0%) |
| Hooks with tests | 0/26 (0%) |
| Edge functions with tests | 1/32 (3%) |
| Pages with tests | 0/23 (0%) |</p><p><h3>Target State (6-Month Goal)</h3></p><p>| Metric | Target |
|--------|--------|
| Test files | 50+ |
| Lines of test code | 5,000+ |
| Critical path unit coverage | 80% |
| Edge function coverage | 50% |
| Manual test documentation | Complete |</p><p>---</p><p><h2>Running Tests</h2></p><p><h3>Frontend Tests (Vitest)</h3></p><p><pre><code class="bash"><h1>Run all tests</h1>
npm run test</p><p><h1>Run in watch mode</h1>
npm run test -- --watch</p><p><h1>Run with UI</h1>
npm run test -- --ui</p><p><h1>Run specific file</h1>
npm run test -- gatewayEligibility</p><p><h1>Run with coverage (when configured)</h1>
npm run test -- --coverage
</code></pre></p><p><h3>Edge Function Tests (Deno)</h3></p><p><pre><code class="bash"><h1>Navigate to function</h1>
cd supabase/functions/_shared</p><p><h1>Run tests</h1>
deno test</p><p><h1>Run specific test file</h1>
deno test ttnPermissions.test.ts</p><p><h1>Run with permissions</h1>
deno test --allow-net --allow-env
</code></pre></p><p>---</p><p><h2>Adding Tests (For Developers)</h2></p><p><h3>New Feature Checklist</h3></p><p><li><strong>Identify the critical logic</strong> â€” What could break?</li>
<li><strong>Write unit tests first</strong> â€” Test edge cases</li>
<li><strong>Add integration test if external service involved</strong></li>
<li><strong>Update manual test documentation</strong> if UI-heavy</li>
<li><strong>Update COVERAGE_MAP.md</strong> with new coverage</li></p><p><h3>Test File Naming</h3></p><p><pre><code class=""><h1>Unit tests - co-located with source</h1>
src/lib/actions/gatewayEligibility.ts
src/lib/actions/gatewayEligibility.test.ts</p><p><h1>Edge function tests</h1>
supabase/functions/_shared/ttnPermissions.ts
supabase/functions/_shared/ttnPermissions.test.ts
</code></pre></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#coverage_map">COVERAGE_MAP.md</a> â€” Feature-to-test mapping</li>
<li><a href="#manual_testing">MANUAL_TESTING.md</a> â€” Step-by-step manual QA checklists</li>
<li><a href="#e2e_scenarios">E2E_SCENARIOS.md</a> â€” Critical user flow testing</li>
<li><a href="#known_gaps">KNOWN_GAPS.md</a> â€” Missing coverage and risks</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="qa-coverage_map"></a></p><p><h1>Coverage Map</h1></p><p><blockquote>Feature-to-test mapping for FreshTrack Pro</blockquote></p><p>---</p><p><h2>Overview</h2></p><p>This document maps every major feature and component to its test coverage status. Use this to quickly identify what's tested and what requires manual verification.</p><p><h3>Legend</h3></p><p>| Symbol | Meaning |
|--------|---------|
| :white_check_mark: | Automated tests exist |
| :large_orange_diamond: | Partial coverage |
| :red_circle: | No automated tests |
| <strong>M</strong> | Manual testing required |
| <strong>U</strong> | Unit test |
| <strong>I</strong> | Integration test |
| <strong>E</strong> | E2E test |</p><p>---</p><p><h2>Pages</h2></p><p>| Page | Route | Test Status | Test Type | Notes |
|------|-------|-------------|-----------|-------|
| Landing | <code>/</code> | :red_circle: | M | Visual verification only |
| Auth | <code>/auth</code> | :red_circle: | M | Supabase Auth dependency |
| Onboarding | <code>/onboarding</code> | :red_circle: | M | Multi-step wizard |
| Dashboard | <code>/dashboard</code> | :red_circle: | M | Complex state management |
| Settings | <code>/settings</code> | :red_circle: | M | Tabs, forms, permissions |
| Unit Detail | <code>/units/:unitId</code> | :red_circle: | M | Real-time data, sensors |
| Site Detail | <code>/sites/:siteId</code> | :red_circle: | M | Hierarchy display |
| Area Detail | <code>/sites/:siteId/areas/:areaId</code> | :red_circle: | M | Unit listing |
| Alerts | <code>/alerts</code> | :red_circle: | M | Alert CRUD, acknowledgment |
| Reports | <code>/reports</code> | :red_circle: | M | Report generation |
| Manual Log | <code>/manual-log</code> | :red_circle: | M | Offline capability |
| Admin Health | <code>/admin/health</code> | :red_circle: | M | System diagnostics |
| Inspector | <code>/inspector</code> | :red_circle: | M | Debug tools |</p><p><strong>Coverage: 0/23 pages have automated tests</strong></p><p>---</p><p><h2>Components by Feature Area</h2></p><p><h3>Settings Components</h3></p><p>| Component | File | Test Status | Priority |
|-----------|------|-------------|----------|
| TTN Connection Settings | <code>TTNConnectionSettings.tsx</code> | :red_circle: | Critical |
| Sensor Manager | <code>SensorManager.tsx</code> | :red_circle: | Critical |
| Gateway Manager | <code>GatewayManager.tsx</code> | :red_circle: | Critical |
| Alert Rules Editor | <code>AlertRulesEditor.tsx</code> | :red_circle: | High |
| Notification Policy Editor | <code>NotificationPolicyEditor.tsx</code> | :red_circle: | High |
| Organization Settings | <code>OrganizationSettings.tsx</code> | :red_circle: | Medium |
| Escalation Contacts | <code>EscalationContactsManager.tsx</code> | :red_circle: | High |
| Branding Settings | <code>BrandingSettings.tsx</code> | :red_circle: | Low |</p><p><h3>Dashboard Components</h3></p><p>| Component | File | Test Status | Priority |
|-----------|------|-------------|----------|
| Low Battery Widget | <code>LowBatteryWidget.tsx</code> | :red_circle: | Medium |
| Dashboard Layout | <code>DashboardLayout.tsx</code> | :red_circle: | Medium |
| Site Overview | <code>SiteOverview.tsx</code> | :red_circle: | Medium |
| Unit Status Card | <code>UnitStatusCard.tsx</code> | :red_circle: | High |</p><p><h3>Unit Components</h3></p><p>| Component | File | Test Status | Priority |
|-----------|------|-------------|----------|
| Unit Alerts Banner | <code>UnitAlertsBanner.tsx</code> | :red_circle: | High |
| Unit Sensors Card | <code>UnitSensorsCard.tsx</code> | :red_circle: | High |
| Battery Health Card | <code>BatteryHealthCard.tsx</code> | :red_circle: | Medium |
| Temperature Graph | <code>TemperatureGraph.tsx</code> | :red_circle: | Medium |
| Unit Settings Section | <code>UnitSettingsSection.tsx</code> | :red_circle: | Medium |</p><p><h3>Alert Components</h3></p><p>| Component | File | Test Status | Priority |
|-----------|------|-------------|----------|
| Alert Row | <code>AlertRow.tsx</code> | :red_circle: | High |
| Alert Detail Modal | <code>AlertDetailModal.tsx</code> | :red_circle: | High |
| Notification Dropdown | <code>NotificationDropdown.tsx</code> | :red_circle: | Medium |</p><p><h3>UI Components (shadcn/ui)</h3></p><p>| Component | Test Status | Notes |
|-----------|-------------|-------|
| All 43 shadcn components | :large_orange_diamond: | Third-party, tested upstream |</p><p>---</p><p><h2>Hooks</h2></p><p>| Hook | File | Test Status | Priority | Notes |
|------|------|-------------|----------|-------|
| useUnitStatus | <code>useUnitStatus.ts</code> | :red_circle: | Critical | Mirrors backend logic |
| useAlertRules | <code>useAlertRules.ts</code> | :red_circle: | Critical | CRUD operations |
| useLoraSensors | <code>useLoraSensors.ts</code> | :red_circle: | Critical | Sensor management |
| useGateways | <code>useGateways.ts</code> | :red_circle: | Critical | Gateway management |
| useNotificationPolicies | <code>useNotificationPolicies.ts</code> | :red_circle: | High | Notification config |
| useAuthAndOnboarding | <code>useAuthAndOnboarding.ts</code> | :red_circle: | High | Auth state |
| useUserRole | <code>useUserRole.ts</code> | :red_circle: | High | RBAC |
| useTTNSetupWizard | <code>useTTNSetupWizard.ts</code> | :red_circle: | High | Multi-step flow |
| useGatewayProvisioningPreflight | <code>useGatewayProvisioningPreflight.ts</code> | :red_circle: | High | TTN validation |
| useHealthCheck | <code>useHealthCheck.ts</code> | :red_circle: | Medium | System health |
| useOfflineSync | <code>useOfflineSync.ts</code> | :red_circle: | High | Offline capability |
| useBatteryForecast | <code>useBatteryForecast.ts</code> | :red_circle: | Medium | Predictions |
| useSoftDelete | <code>useSoftDelete.ts</code> | :red_circle: | Medium | Soft delete logic |
| useTTNDeprovision | <code>useTTNDeprovision.ts</code> | :red_circle: | Medium | Cleanup operations |</p><p><strong>Coverage: 0/26 hooks have automated tests</strong></p><p>---</p><p><h2>Library Functions (src/lib/)</h2></p><p><h3>Eligibility Logic (TESTED)</h3></p><p>| Function | File | Test Status | Tests |
|----------|------|-------------|-------|
| canProvisionGateway | <code>gatewayEligibility.ts</code> | :white_check_mark: | 9 cases |
| canEditGateway | <code>gatewayEligibility.ts</code> | :white_check_mark: | 3 cases |
| canDeleteGateway | <code>gatewayEligibility.ts</code> | :white_check_mark: | 3 cases |
| canProvisionSensor | <code>sensorEligibility.ts</code> | :white_check_mark: | 9 cases |
| canEditSensor | <code>sensorEligibility.ts</code> | :white_check_mark: | 3 cases |
| canDeleteSensor | <code>sensorEligibility.ts</code> | :white_check_mark: | 3 cases |</p><p><h3>Configuration (NOT TESTED)</h3></p><p>| File | Test Status | Priority |
|------|-------------|----------|
| alertConfig.ts | :red_circle: | Medium |
| statusConfig.ts | :red_circle: | Medium |
| entityStatusConfig.ts | :red_circle: | Medium |
| validation.ts | :red_circle: | High |
| utils.ts | :red_circle: | Low |
| stripe.ts | :red_circle: | Medium |</p><p>---</p><p><h2>Edge Functions (supabase/functions/)</h2></p><p><h3>Critical Functions</h3></p><p>| Function | Test Status | Priority | Risk |
|----------|-------------|----------|------|
| <code>process-unit-states</code> | :red_circle: | <strong>Critical</strong> | Alert SSOT - untested |
| <code>process-escalations</code> | :red_circle: | <strong>Critical</strong> | Notification SSOT - untested |
| <code>ttn-webhook</code> | :red_circle: | <strong>Critical</strong> | Data ingestion - untested |
| <code>ingest-readings</code> | :red_circle: | <strong>Critical</strong> | Data pipeline - untested |</p><p><h3>TTN Management</h3></p><p>| Function | Test Status | Priority |
|----------|-------------|----------|
| <code>ttn-bootstrap</code> | :red_circle: | High |
| <code>ttn-provision-device</code> | :red_circle: | High |
| <code>ttn-provision-gateway</code> | :red_circle: | High |
| <code>ttn-gateway-preflight</code> | :red_circle: | High |
| <code>ttn-list-devices</code> | :red_circle: | Medium |
| <code>ttn-deprovision-worker</code> | :red_circle: | Medium |</p><p><h3>Shared Utilities</h3></p><p>| File | Test Status | Tests |
|------|-------------|-------|
| <code>ttnPermissions.ts</code> | :white_check_mark: | 5 cases |
| <code>ttnConfig.ts</code> | :red_circle: | - |
| <code>validation.ts</code> | :red_circle: | - |
| <code>response.ts</code> | :red_circle: | - |
| <code>cors.ts</code> | :red_circle: | - |</p><p><h3>Billing Functions</h3></p><p>| Function | Test Status | Priority |
|----------|-------------|----------|
| <code>stripe-checkout</code> | :red_circle: | High |
| <code>stripe-portal</code> | :red_circle: | High |
| <code>stripe-webhook</code> | :red_circle: | High |</p><p><h3>Other Functions</h3></p><p>| Function | Test Status | Priority |
|----------|-------------|----------|
| <code>health-check</code> | :red_circle: | Medium |
| <code>sensor-simulator</code> | :red_circle: | Low |
| <code>create-organization</code> | :red_circle: | Medium |
| <code>soft-delete-cleanup</code> | :red_circle: | Low |</p><p><strong>Coverage: 1/32 edge functions have tests (3%)</strong></p><p>---</p><p><h2>Database (Migrations & RLS)</h2></p><p><h3>Tables with RLS Policies</h3></p><p>| Table | RLS Tested | Notes |
|-------|------------|-------|
| organizations | :red_circle: | Multi-tenant isolation |
| profiles | :red_circle: | User access |
| units | :red_circle: | Org-scoped access |
| alerts | :red_circle: | Status filtering |
| sensor_readings | :red_circle: | Time-series data |
| lora_sensors | :red_circle: | Device management |
| gateways | :red_circle: | Gateway management |
| alert_rules | :red_circle: | Cascading settings |
| notification_policies | :red_circle: | Notification config |
| escalation_contacts | :red_circle: | Contact management |</p><p><strong>No automated RLS policy tests exist</strong></p><p>---</p><p><h2>External Integrations</h2></p><p>| Integration | Test Status | Testing Approach |
|-------------|-------------|------------------|
| Supabase Auth | :red_circle: | Manual testing |
| Supabase Database | :red_circle: | Local instance for integration |
| The Things Network (TTN) | :red_circle: | Test TTN application |
| Stripe | :red_circle: | Test mode + webhooks |
| Twilio (SMS) | :red_circle: | Manual testing |
| Resend (Email) | :red_circle: | Manual testing |</p><p>---</p><p><h2>Feature Coverage Summary</h2></p><p>| Feature Area | Files | Tested | Coverage |
|--------------|-------|--------|----------|
| <strong>Pages</strong> | 23 | 0 | 0% |
| <strong>Components</strong> | 112 | 0 | 0% |
| <strong>Hooks</strong> | 26 | 0 | 0% |
| <strong>Edge Functions</strong> | 32 | 1 | 3% |
| <strong>Lib/Actions</strong> | 6 functions | 6 | 100% |
| <strong>Lib/Config</strong> | 6 files | 0 | 0% |</p><p><h3>Overall Automated Test Coverage</h3></p><p>| Metric | Count |
|--------|-------|
| Total test files | 3 |
| Total test cases | ~35 |
| Lines of test code | 476 |
| <strong>Estimated code coverage</strong> | <strong>< 5%</strong> |</p><p>---</p><p><h2>Test File Inventory</h2></p><p><h3>Existing Test Files</h3></p><p><pre><code class="">src/lib/actions/gatewayEligibility.test.ts   (178 lines, 15 tests)
src/lib/actions/sensorEligibility.test.ts    (193 lines, 15 tests)
supabase/functions/_shared/ttnPermissions.test.ts (105 lines, 5 tests)
</code></pre></p><p><h3>Testing Infrastructure</h3></p><p><pre><code class="">src/test/setup.ts                 # Jest-DOM matchers
vite.config.ts                    # Vitest configuration
package.json                      # Dependencies (vitest, testing-library)
</code></pre></p><p>---</p><p><h2>Priority Matrix</h2></p><p><h3>Immediate Priority (Week 1-2)</h3></p><p>| What | Why | Type |
|------|-----|------|
| <code>process-unit-states</code> | Alert SSOT, safety-critical | Unit + Integration |
| <code>ttn-webhook</code> | Data ingestion entry point | Integration |
| <code>useUnitStatus</code> | Frontend status computation | Unit |</p><p><h3>High Priority (Week 3-4)</h3></p><p>| What | Why | Type |
|------|-----|------|
| <code>process-escalations</code> | Notification SSOT | Unit + Integration |
| <code>useAlertRules</code> | Alert configuration | Unit |
| <code>useLoraSensors</code> | Device management | Unit |
| Onboarding flow | Critical user journey | E2E Manual |</p><p><h3>Medium Priority (Month 2)</h3></p><p>| What | Why | Type |
|------|-----|------|
| RLS policy tests | Security validation | Integration |
| Dashboard components | User-facing | Component |
| Settings components | Configuration | Component |</p><p>---</p><p><h2>How to Read This Map</h2></p><p><li><strong>Identify the feature</strong> you're working on</li>
<li><strong>Check the test status</strong> in this document</li>
<li><strong>If :red_circle:</strong>, either:</li>
   - Write automated tests before making changes
   - Follow manual testing procedures in <a href="#manual_testing">MANUAL_TESTING.md</a>
<li><strong>If :white_check_mark:</strong>, ensure existing tests still pass</li>
<li><strong>Update this document</strong> when adding new tests</li></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#test_strategy">TEST_STRATEGY.md</a> â€” Overall testing philosophy</li>
<li><a href="#manual_testing">MANUAL_TESTING.md</a> â€” Step-by-step manual QA checklists</li>
<li><a href="#e2e_scenarios">E2E_SCENARIOS.md</a> â€” Critical user flow testing</li>
<li><a href="#known_gaps">KNOWN_GAPS.md</a> â€” Missing coverage and risks</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="qa-manual_testing"></a></p><p><h1>Manual Testing Guide</h1></p><p><blockquote>Step-by-step QA checklists for FreshTrack Pro</blockquote></p><p>---</p><p><h2>How to Use This Guide</h2></p><p><li><strong>Before testing:</strong> Ensure you have access to a test environment</li>
<li><strong>During testing:</strong> Follow each step exactly, check the boxes</li>
<li><strong>After testing:</strong> Document any failures with screenshots</li>
<li><strong>Report issues:</strong> Create tickets with reproduction steps</li></p><p><h3>Test Environment Requirements</h3></p><p>| Requirement | Details |
|-------------|---------|
| Browser | Chrome (latest), Firefox, Safari, Edge |
| Mobile | iOS Safari, Android Chrome |
| Test account | QA account with admin permissions |
| TTN access | Test TTN application (not production) |
| Stripe | Test mode API keys |</p><p>---</p><p><h2>Section 1: Authentication & Onboarding</h2></p><p><h3>1.1 New User Registration</h3></p><p><strong>Preconditions:</strong> Logged out, fresh browser session</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to <code>/auth</code> | Sign in form displays | [ ] |
| 2 | Click "Sign Up" tab | Sign up form displays | [ ] |
| 3 | Enter valid email | Email field accepts input | [ ] |
| 4 | Enter password (< 6 chars) | Error: "Password must be at least 6 characters" | [ ] |
| 5 | Enter valid password (6+ chars) | Password field accepts input | [ ] |
| 6 | Click "Sign Up" | Loading indicator appears | [ ] |
| 7 | Wait for completion | Redirects to onboarding page | [ ] |
| 8 | Check email | Confirmation email received | [ ] |</p><p><h3>1.2 User Login</h3></p><p><strong>Preconditions:</strong> Registered account exists</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to <code>/auth</code> | Sign in form displays | [ ] |
| 2 | Enter registered email | Email field accepts input | [ ] |
| 3 | Enter wrong password | Error: "Invalid login credentials" | [ ] |
| 4 | Enter correct password | Password field accepts input | [ ] |
| 5 | Click "Sign In" | Loading indicator appears | [ ] |
| 6 | Wait for completion | Redirects to dashboard | [ ] |</p><p><h3>1.3 Onboarding Wizard</h3></p><p><strong>Preconditions:</strong> New user, first login</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | After first login | Onboarding wizard appears | [ ] |
| 2 | Enter organization name | Field accepts input | [ ] |
| 3 | Click "Next" | Moves to site creation step | [ ] |
| 4 | Enter site name | Field accepts input | [ ] |
| 5 | Enter site address (optional) | Address field works | [ ] |
| 6 | Click "Next" | Moves to area creation step | [ ] |
| 7 | Enter area name | Field accepts input | [ ] |
| 8 | Click "Next" | Moves to unit creation step | [ ] |
| 9 | Enter unit name | Field accepts input | [ ] |
| 10 | Select unit type | Dropdown works | [ ] |
| 11 | Set temperature range | Min/Max sliders work | [ ] |
| 12 | Click "Complete Setup" | Wizard completes | [ ] |
| 13 | Verify redirect | Dashboard displays with new unit | [ ] |</p><p><h3>1.4 Password Reset</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to <code>/auth</code> | Sign in form displays | [ ] |
| 2 | Click "Forgot Password" | Reset form appears | [ ] |
| 3 | Enter registered email | Email field accepts input | [ ] |
| 4 | Click "Send Reset Link" | Success message appears | [ ] |
| 5 | Check email | Reset link received | [ ] |
| 6 | Click reset link | Password reset form appears | [ ] |
| 7 | Enter new password | Password accepted | [ ] |
| 8 | Submit | Success message, redirect to login | [ ] |
| 9 | Login with new password | Login successful | [ ] |</p><p>---</p><p><h2>Section 2: TTN Configuration</h2></p><p><h3>2.1 TTN Setup Wizard</h3></p><p><strong>Preconditions:</strong> Logged in as admin, TTN not configured</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to Settings â†’ TTN | TTN settings page displays | [ ] |
| 2 | Click "Connect to TTN" | Setup wizard opens | [ ] |
| 3 | Enter TTN Application ID | Field accepts input | [ ] |
| 4 | Enter TTN API Key | Field accepts input (masked) | [ ] |
| 5 | Click "Validate" | Validation starts | [ ] |
| 6 | Wait for validation | Permission report displays | [ ] |
| 7 | If permissions valid | "Configuration Valid" message | [ ] |
| 8 | If permissions invalid | Missing permissions listed | [ ] |
| 9 | Click "Save Configuration" | Configuration saved | [ ] |
| 10 | Verify webhook created | TTN console shows webhook | [ ] |</p><p><h3>2.2 TTN Permission Validation</h3></p><p><strong>Preconditions:</strong> Have TTN API key with known permissions</p><p>| Permission | Required | Test Action | Pass/Fail |
|------------|----------|-------------|-----------|
| <code>RIGHT_APPLICATION_INFO</code> | Yes | Validate basic info read | [ ] |
| <code>RIGHT_APPLICATION_TRAFFIC_READ</code> | Yes | Required for webhook data | [ ] |
| <code>RIGHT_APPLICATION_SETTINGS_BASIC</code> | Yes | Webhook configuration | [ ] |
| <code>RIGHT_APPLICATION_DEVICES_READ</code> | Yes | Device listing | [ ] |
| <code>RIGHT_APPLICATION_DEVICES_WRITE</code> | Yes | Device provisioning | [ ] |
| <code>RIGHT_APPLICATION_TRAFFIC_DOWN_WRITE</code> | No | Downlink (optional) | [ ] |</p><p>---</p><p><h2>Section 3: Device Management</h2></p><p><h3>3.1 Gateway Registration</h3></p><p><strong>Preconditions:</strong> TTN configured, admin access</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to Settings â†’ Gateways | Gateway list displays | [ ] |
| 2 | Click "Add Gateway" | Add gateway form opens | [ ] |
| 3 | Enter Gateway EUI (invalid format) | Error: "Invalid EUI format" | [ ] |
| 4 | Enter Gateway EUI (16 hex chars) | Field accepts input | [ ] |
| 5 | Enter Gateway name | Field accepts input | [ ] |
| 6 | Select location | Location selector works | [ ] |
| 7 | Click "Save" | Gateway saved (pending status) | [ ] |
| 8 | Click "Provision" on gateway | Provisioning starts | [ ] |
| 9 | Wait for completion | Status changes to "active" | [ ] |
| 10 | Verify in TTN Console | Gateway appears in TTN | [ ] |</p><p><h3>3.2 Sensor Registration</h3></p><p><strong>Preconditions:</strong> TTN configured, admin access, unit exists</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to Settings â†’ Sensors | Sensor list displays | [ ] |
| 2 | Click "Add Sensor" | Add sensor form opens | [ ] |
| 3 | Enter DevEUI (invalid format) | Error: "Invalid DevEUI format" | [ ] |
| 4 | Enter DevEUI (16 hex chars) | Field accepts input | [ ] |
| 5 | Enter AppKey (32 hex chars) | Field accepts input | [ ] |
| 6 | Select unit to assign | Unit dropdown works | [ ] |
| 7 | Click "Save" | Sensor saved (pending status) | [ ] |
| 8 | Click "Provision" on sensor | Provisioning starts | [ ] |
| 9 | Wait for completion | Status changes to "joining" | [ ] |
| 10 | Verify in TTN Console | Device appears in TTN | [ ] |
| 11 | Power on physical sensor | Wait for join | [ ] |
| 12 | Verify sensor joins | Status changes to "active" | [ ] |</p><p><h3>3.3 Sensor Assignment to Unit</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to unit detail page | Unit page displays | [ ] |
| 2 | Click "Assign Sensor" | Sensor selector opens | [ ] |
| 3 | Select available sensor | Sensor selected | [ ] |
| 4 | Click "Assign" | Sensor assigned to unit | [ ] |
| 5 | Verify sensor shows on unit | Sensor card displays | [ ] |
| 6 | Verify readings flow | Temperature data appears | [ ] |</p><p><h3>3.4 Device Deprovisioning</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Select provisioned device | Device selected | [ ] |
| 2 | Click "Deprovision" | Confirmation dialog appears | [ ] |
| 3 | Confirm deprovisioning | Deprovisioning starts | [ ] |
| 4 | Wait for completion | Status changes to "pending" | [ ] |
| 5 | Verify removed from TTN | Device gone from TTN console | [ ] |</p><p>---</p><p><h2>Section 4: Alert Configuration</h2></p><p><h3>4.1 Alert Rules Setup</h3></p><p><strong>Preconditions:</strong> Unit exists, admin access</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to Settings â†’ Alert Rules | Alert rules list displays | [ ] |
| 2 | Select a unit | Unit-specific rules show | [ ] |
| 3 | Click "Add Rule" | Rule form opens | [ ] |
| 4 | Set high temperature threshold | Slider/input works | [ ] |
| 5 | Set low temperature threshold | Slider/input works | [ ] |
| 6 | Set confirm time (minutes) | Input accepts number | [ ] |
| 7 | Click "Save" | Rule saved | [ ] |
| 8 | Verify rule appears in list | Rule displays correctly | [ ] |</p><p><h3>4.2 Notification Policy Setup</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to Settings â†’ Notifications | Notification settings display | [ ] |
| 2 | Click "Add Policy" | Policy form opens | [ ] |
| 3 | Enter policy name | Field accepts input | [ ] |
| 4 | Select alert types | Multi-select works | [ ] |
| 5 | Select notification channels | Email/SMS/Push checkboxes | [ ] |
| 6 | Set escalation delay | Time input works | [ ] |
| 7 | Add escalation contacts | Contact selector works | [ ] |
| 8 | Click "Save" | Policy saved | [ ] |</p><p><h3>4.3 Escalation Contact Management</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to Settings â†’ Contacts | Contact list displays | [ ] |
| 2 | Click "Add Contact" | Contact form opens | [ ] |
| 3 | Enter contact name | Field accepts input | [ ] |
| 4 | Enter email address | Email validation works | [ ] |
| 5 | Enter phone number | Phone validation works | [ ] |
| 6 | Set escalation level | Level selector works | [ ] |
| 7 | Click "Save" | Contact saved | [ ] |
| 8 | Verify in contact list | Contact appears | [ ] |</p><p>---</p><p><h2>Section 5: Dashboard & Monitoring</h2></p><p><h3>5.1 Dashboard Overview</h3></p><p><strong>Preconditions:</strong> Logged in, units configured</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to <code>/dashboard</code> | Dashboard loads | [ ] |
| 2 | Verify unit cards display | All units show status | [ ] |
| 3 | Verify color coding | Green/Yellow/Red correct | [ ] |
| 4 | Click on a unit card | Navigates to unit detail | [ ] |
| 5 | Verify battery indicators | Battery levels show | [ ] |
| 6 | Verify last reading time | Timestamps accurate | [ ] |</p><p><h3>5.2 Unit Detail Page</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to unit detail | Unit page loads | [ ] |
| 2 | Verify temperature graph | Graph displays readings | [ ] |
| 3 | Change time range | Graph updates | [ ] |
| 4 | Verify current temperature | Current reading displays | [ ] |
| 5 | Verify status badge | Status correct | [ ] |
| 6 | Verify sensor list | Assigned sensors show | [ ] |
| 7 | Verify alert banner | Active alerts show (if any) | [ ] |</p><p><h3>5.3 Real-Time Updates</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Open unit detail page | Page displays | [ ] |
| 2 | Wait for new sensor reading | (5-minute interval) | [ ] |
| 3 | Verify auto-update | New reading appears | [ ] |
| 4 | Verify no page refresh needed | Data updates in place | [ ] |</p><p>---</p><p><h2>Section 6: Alert Handling</h2></p><p><h3>6.1 Alert Acknowledgment</h3></p><p><strong>Preconditions:</strong> Active alert exists</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to <code>/alerts</code> | Alert list displays | [ ] |
| 2 | Find active alert | Alert row visible | [ ] |
| 3 | Click "Acknowledge" | Confirmation dialog appears | [ ] |
| 4 | Enter acknowledgment note | Text field accepts input | [ ] |
| 5 | Click "Confirm" | Alert status changes | [ ] |
| 6 | Verify status update | Shows "acknowledged" | [ ] |
| 7 | Verify timestamp | Acknowledgment time recorded | [ ] |</p><p><h3>6.2 Alert Resolution</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Temperature returns to normal | Condition resolves | [ ] |
| 2 | Wait for processing | System processes state | [ ] |
| 3 | Verify alert auto-resolves | Status changes to "resolved" | [ ] |
| 4 | Check resolution time | Timestamp recorded | [ ] |
| 5 | Alert moves to history | Not in active list | [ ] |</p><p><h3>6.3 Alert Notification Delivery</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Trigger temperature excursion | (Simulator or real) | [ ] |
| 2 | Wait for confirm time | Alert triggers | [ ] |
| 3 | Check email | Email notification received | [ ] |
| 4 | Check SMS (if configured) | SMS received | [ ] |
| 5 | Check push notification | Push received | [ ] |
| 6 | Verify notification content | Contains unit, temp, time | [ ] |</p><p>---</p><p><h2>Section 7: Manual Temperature Logging</h2></p><p><h3>7.1 Online Manual Log</h3></p><p><strong>Preconditions:</strong> Logged in, unit exists</p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to <code>/manual-log</code> | Manual log page displays | [ ] |
| 2 | Select unit | Unit dropdown works | [ ] |
| 3 | Enter temperature value | Number input works | [ ] |
| 4 | Add optional note | Text field works | [ ] |
| 5 | Click "Log Temperature" | Submission starts | [ ] |
| 6 | Verify success message | "Temperature logged" shows | [ ] |
| 7 | Check unit detail | Manual log appears in history | [ ] |</p><p><h3>7.2 Offline Manual Log</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Enable airplane mode | Device offline | [ ] |
| 2 | Navigate to <code>/manual-log</code> | Page loads from cache | [ ] |
| 3 | Enter temperature | Input works offline | [ ] |
| 4 | Click "Log Temperature" | Stored locally | [ ] |
| 5 | Verify pending indicator | Shows "pending sync" | [ ] |
| 6 | Disable airplane mode | Device online | [ ] |
| 7 | Wait for sync | Data syncs to server | [ ] |
| 8 | Verify synced | Pending indicator clears | [ ] |
| 9 | Check unit detail | Entry appears in history | [ ] |</p><p>---</p><p><h2>Section 8: Reports</h2></p><p><h3>8.1 Temperature Log Report</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Navigate to <code>/reports</code> | Reports page displays | [ ] |
| 2 | Select "Temperature Log" | Report type selected | [ ] |
| 3 | Select date range | Date picker works | [ ] |
| 4 | Select units/sites | Multi-select works | [ ] |
| 5 | Click "Generate" | Report generates | [ ] |
| 6 | Verify data content | Readings display correctly | [ ] |
| 7 | Click "Export PDF" | PDF downloads | [ ] |
| 8 | Open PDF | Content matches on-screen | [ ] |</p><p><h3>8.2 Compliance Report</h3></p><p>| Step | Action | Expected Result | Pass/Fail |
|------|--------|-----------------|-----------|
| 1 | Select "Compliance Report" | Report type selected | [ ] |
| 2 | Select time period | 30/60/90 days options | [ ] |
| 3 | Click "Generate" | Report generates | [ ] |
| 4 | Verify summary stats | Counts accurate | [ ] |
| 5 | Verify alert history | Alerts listed | [ ] |
| 6 | Verify corrective actions | Actions documented | [ ] |</p><p>---</p><p><h2>Section 9: Mobile Responsiveness</h2></p><p><h3>9.1 Mobile Layout Check</h3></p><p><strong>Test on:</strong> iPhone SE (375px), iPhone 14 (390px), Android (360px)</p><p>| Page | Test | Pass/Fail |
|------|------|-----------|
| Dashboard | Units readable, cards stack vertically | [ ] |
| Unit Detail | Graph scrollable, data visible | [ ] |
| Settings | Navigation accessible, forms usable | [ ] |
| Manual Log | Form fields full width, easy to tap | [ ] |
| Alerts | Alert rows readable, actions accessible | [ ] |</p><p><h3>9.2 Touch Interactions</h3></p><p>| Interaction | Test | Pass/Fail |
|-------------|------|-----------|
| Buttons | Minimum 44px tap target | [ ] |
| Dropdowns | Easy to select on mobile | [ ] |
| Modals | Close button accessible | [ ] |
| Scroll | Smooth, no jank | [ ] |
| Pull to refresh | Works where expected | [ ] |</p><p>---</p><p><h2>Section 10: Role-Based Access</h2></p><p><h3>10.1 Staff Role Permissions</h3></p><p><strong>Preconditions:</strong> Logged in as staff user</p><p>| Action | Expected Result | Pass/Fail |
|--------|-----------------|-----------|
| View dashboard | Allowed | [ ] |
| View unit details | Allowed | [ ] |
| Log temperature manually | Allowed | [ ] |
| Acknowledge alerts | Allowed | [ ] |
| Add new sensor | <strong>Denied</strong> | [ ] |
| Delete unit | <strong>Denied</strong> | [ ] |
| Access billing | <strong>Denied</strong> | [ ] |</p><p><h3>10.2 Manager Role Permissions</h3></p><p><strong>Preconditions:</strong> Logged in as manager</p><p>| Action | Expected Result | Pass/Fail |
|--------|-----------------|-----------|
| All staff permissions | Allowed | [ ] |
| Create units | Allowed | [ ] |
| Edit alert rules | Allowed | [ ] |
| View reports | Allowed | [ ] |
| Manage users | <strong>Denied</strong> | [ ] |
| Access billing | <strong>Denied</strong> | [ ] |</p><p><h3>10.3 Admin/Owner Permissions</h3></p><p>| Action | Expected Result | Pass/Fail |
|--------|-----------------|-----------|
| All manager permissions | Allowed | [ ] |
| Manage users | Allowed | [ ] |
| Configure TTN | Allowed | [ ] |
| Access billing | Allowed | [ ] |
| Delete organization | Allowed (owner only) | [ ] |</p><p>---</p><p><h2>Section 11: Browser Compatibility</h2></p><p>Test all major pages on:</p><p>| Browser | Version | Dashboard | Settings | Alerts | Manual Log |
|---------|---------|-----------|----------|--------|------------|
| Chrome | Latest | [ ] | [ ] | [ ] | [ ] |
| Firefox | Latest | [ ] | [ ] | [ ] | [ ] |
| Safari | Latest | [ ] | [ ] | [ ] | [ ] |
| Edge | Latest | [ ] | [ ] | [ ] | [ ] |
| Safari iOS | Latest | [ ] | [ ] | [ ] | [ ] |
| Chrome Android | Latest | [ ] | [ ] | [ ] | [ ] |</p><p>---</p><p><h2>Section 12: Performance Checks</h2></p><p><h3>12.1 Page Load Times</h3></p><p>| Page | Target | Actual | Pass/Fail |
|------|--------|--------|-----------|
| Dashboard | < 3s | ___s | [ ] |
| Unit Detail | < 2s | ___s | [ ] |
| Settings | < 2s | ___s | [ ] |
| Reports | < 3s | ___s | [ ] |</p><p><h3>12.2 Data Operations</h3></p><p>| Operation | Target | Actual | Pass/Fail |
|-----------|--------|--------|-----------|
| Save alert rule | < 1s | ___s | [ ] |
| Acknowledge alert | < 1s | ___s | [ ] |
| Log temperature | < 1s | ___s | [ ] |
| Generate report | < 5s | ___s | [ ] |</p><p>---</p><p><h2>Test Session Template</h2></p><p><pre><code class="markdown"><h2>Test Session Report</h2></p><p><strong>Date:</strong> YYYY-MM-DD
<strong>Tester:</strong> [Name]
<strong>Environment:</strong> [Staging/Local/Production]
<strong>Browser:</strong> [Browser/Version]
<strong>Device:</strong> [Desktop/Mobile/Tablet]</p><p><h3>Sections Tested</h3>
<li>[ ] Section 1: Authentication</li>
<li>[ ] Section 2: TTN Configuration</li>
<li>[ ] Section 3: Device Management</li>
<li>[ ] Section 4: Alert Configuration</li>
<li>[ ] Section 5: Dashboard</li>
<li>[ ] Section 6: Alert Handling</li>
<li>[ ] Section 7: Manual Logging</li>
<li>[ ] Section 8: Reports</li>
<li>[ ] Section 9: Mobile</li>
<li>[ ] Section 10: Permissions</li>
<li>[ ] Section 11: Browser Compatibility</li>
<li>[ ] Section 12: Performance</li></p><p><h3>Issues Found</h3>
| ID | Section | Description | Severity | Screenshot |
|----|---------|-------------|----------|------------|
| 1  |         |             |          |            |</p><p><h3>Notes</h3>
[Additional observations]
</code></pre></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#test_strategy">TEST_STRATEGY.md</a> â€” Overall testing philosophy</li>
<li><a href="#coverage_map">COVERAGE_MAP.md</a> â€” Feature-to-test mapping</li>
<li><a href="#e2e_scenarios">E2E_SCENARIOS.md</a> â€” Critical user flow testing</li>
<li><a href="#known_gaps">KNOWN_GAPS.md</a> â€” Missing coverage and risks</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="qa-e2e_scenarios"></a></p><p><h1>End-to-End Test Scenarios</h1></p><p><blockquote>Critical user flows with full preconditions, steps, and expected results</blockquote></p><p>---</p><p><h2>Overview</h2></p><p>These scenarios represent the most critical user journeys through FreshTrack Pro. Each scenario should be executed completely to validate system behavior under real-world conditions.</p><p><h3>Scenario Priority Levels</h3></p><p>| Level | Description | Testing Frequency |
|-------|-------------|-------------------|
| <strong>P0</strong> | Business-critical, safety-impacting | Every release |
| <strong>P1</strong> | Core functionality | Every release |
| <strong>P2</strong> | Important features | Major releases |
| <strong>P3</strong> | Nice-to-have | Quarterly |</p><p>---</p><p><h2>Scenario 1: New Customer Onboarding (P0)</h2></p><p><h3>Description</h3>
A new customer signs up, configures their organization, connects TTN, provisions their first device, and receives their first temperature reading.</p><p><h3>Preconditions</h3>
<li>Fresh test account (not previously registered)</li>
<li>Valid TTN application with API key</li>
<li>Physical gateway and sensor (or simulator)</li>
<li>Email access for verification</li></p><p><h3>Test Data Required</h3>
<pre><code class="">Email: test-{timestamp}@example.com
TTN Application ID: test-freshtrack-app
TTN API Key: NNSXS.xxx... (with full permissions)
Gateway EUI: AABBCCDDEEFF0011
Sensor DevEUI: 0011223344556677
Sensor AppKey: 00112233445566778899AABBCCDDEEFF
</code></pre></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Navigate to <code>/auth</code> | Sign-up form displays | |
| 2 | Create account with test email | Account created, redirect to onboarding | |
| 3 | Complete onboarding wizard (org, site, area, unit) | Organization structure created | |
| 4 | Navigate to Settings â†’ TTN | TTN settings page shows "Not Connected" | |
| 5 | Enter TTN Application ID | Field accepts input | |
| 6 | Enter TTN API Key | Field accepts input (masked) | |
| 7 | Click "Validate Connection" | Permission validation runs | |
| 8 | Verify all permissions valid | Green checkmarks for all permissions | |
| 9 | Click "Save Configuration" | Configuration saved, webhook created | |
| 10 | Navigate to Settings â†’ Gateways | Gateway list shows (empty) | |
| 11 | Add gateway with test EUI | Gateway created in "pending" status | |
| 12 | Click "Provision to TTN" | Provisioning starts | |
| 13 | Wait for provisioning | Status changes to "active" | |
| 14 | Navigate to Settings â†’ Sensors | Sensor list shows (empty) | |
| 15 | Add sensor with test DevEUI/AppKey | Sensor created in "pending" status | |
| 16 | Assign sensor to unit | Sensor assigned | |
| 17 | Click "Provision to TTN" | Provisioning starts | |
| 18 | Wait for device to join | Status changes to "joining" then "active" | |
| 19 | Navigate to Dashboard | Dashboard shows unit | |
| 20 | Wait for first reading (~5 min) | Temperature value appears on unit card | |
| 21 | Click on unit card | Unit detail page shows temperature graph | |</p><p><h3>Success Criteria</h3>
<li>[ ] Account created successfully</li>
<li>[ ] Organization structure visible</li>
<li>[ ] TTN webhook verified in TTN Console</li>
<li>[ ] Gateway visible in TTN Console</li>
<li>[ ] Sensor visible in TTN Console</li>
<li>[ ] First temperature reading received within 10 minutes</li>
<li>[ ] Temperature displays correctly on dashboard</li></p><p><h3>Failure Handling</h3></p><p>| Failure Point | Recovery Action |
|---------------|-----------------|
| TTN validation fails | Verify API key permissions in TTN Console |
| Gateway provisioning fails | Check Gateway EUI format, verify not already registered |
| Sensor won't join | Verify AppKey matches, check gateway is online |
| No readings received | Check TTN Live Data tab, verify webhook URL |</p><p>---</p><p><h2>Scenario 2: Temperature Excursion Alert Lifecycle (P0)</h2></p><p><h3>Description</h3>
A refrigerator temperature rises above threshold, triggering an alert that is acknowledged and then resolves when temperature returns to normal.</p><p><h3>Preconditions</h3>
<li>Unit with active sensor</li>
<li>Alert rule configured (e.g., max 40Â°F)</li>
<li>Notification policy with email enabled</li>
<li>Escalation contacts configured</li></p><p><h3>Test Data Required</h3>
<pre><code class="">Unit: Test Cooler
Max Temperature Threshold: 40Â°F (4.4Â°C)
Confirm Time: 5 minutes
Escalation Delay: 15 minutes
Primary Contact: primary@test.com
Secondary Contact: secondary@test.com
</code></pre></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Verify unit shows "OK" status | Dashboard shows green status | |
| 2 | Cause temperature to rise above 40Â°F | (Use simulator or physical test) | |
| 3 | Wait 1 minute | Unit status may show "excursion" | |
| 4 | Wait for confirm time (5 min) | Alert status changes to "triggered" | |
| 5 | Check primary contact email | Alert notification received | |
| 6 | Verify notification content | Contains unit name, temperature, timestamp | |
| 7 | Navigate to <code>/alerts</code> | Alert appears in active list | |
| 8 | Click on alert row | Alert detail displays | |
| 9 | Verify alert details | Type, severity, timestamps correct | |
| 10 | Click "Acknowledge" | Acknowledgment dialog appears | |
| 11 | Enter note: "Investigating issue" | Note field accepts input | |
| 12 | Confirm acknowledgment | Alert status changes to "acknowledged" | |
| 13 | Verify escalation stopped | Secondary contact NOT notified yet | |
| 14 | Return temperature to normal | (Use simulator or physical test) | |
| 15 | Wait for next processing cycle | Alert auto-resolves | |
| 16 | Verify alert resolved | Status shows "resolved" in history | |
| 17 | Verify unit status | Dashboard shows "OK" again | |</p><p><h3>Success Criteria</h3>
<li>[ ] Alert triggered after confirm time</li>
<li>[ ] Email notification delivered within 2 minutes of trigger</li>
<li>[ ] Notification contains accurate information</li>
<li>[ ] Acknowledgment stops escalation</li>
<li>[ ] Alert resolves when condition clears</li>
<li>[ ] Full audit trail preserved</li></p><p><h3>Failure Handling</h3></p><p>| Failure Point | Recovery Action |
|---------------|-----------------|
| Alert not triggered | Check <code>process-unit-states</code> logs, verify alert rules |
| Email not received | Check spam, verify notification policy, check Resend logs |
| Alert won't resolve | Verify temperature actually below threshold, check processing |</p><p>---</p><p><h2>Scenario 3: Alert Escalation Chain (P0)</h2></p><p><h3>Description</h3>
An alert is triggered but not acknowledged, causing automatic escalation through the contact chain.</p><p><h3>Preconditions</h3>
<li>Alert rule configured</li>
<li>Notification policy with escalation enabled</li>
<li>Multiple escalation levels configured:</li>
  - Level 1: primary@test.com (0 min delay)
  - Level 2: manager@test.com (15 min delay)
  - Level 3: director@test.com (30 min delay)</p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Trigger temperature excursion | Alert created | |
| 2 | Wait for confirm time | Alert status: "triggered" | |
| 3 | Check Level 1 email | Notification received | |
| 4 | <strong>Do NOT acknowledge</strong> | Alert remains triggered | |
| 5 | Wait 15 minutes | Escalation timer runs | |
| 6 | Check Level 2 email | Escalation notification received | |
| 7 | Verify escalation flag | Alert shows "escalated" | |
| 8 | <strong>Do NOT acknowledge</strong> | Alert remains triggered | |
| 9 | Wait 15 more minutes (30 total) | Second escalation | |
| 10 | Check Level 3 email | Second escalation notification received | |
| 11 | Acknowledge as Level 3 | Alert acknowledged | |
| 12 | Verify acknowledgment record | Shows who acknowledged, timestamp | |</p><p><h3>Success Criteria</h3>
<li>[ ] Each escalation level notified at correct time</li>
<li>[ ] Escalation notifications include escalation context</li>
<li>[ ] Acknowledgment at any level stops further escalation</li>
<li>[ ] Full escalation history preserved</li></p><p><h3>Timing Diagram</h3></p><p><pre><code class="">0 min     5 min     15 min    30 min
  |         |         |         |
  |--Confirm--|--Wait---|--Wait---|
  |           |         |         |
              |         |         |
            Alert     Level 2   Level 3
           Triggers   Notified  Notified
           Level 1
           Notified
</code></pre></p><p>---</p><p><h2>Scenario 4: Offline Manual Logging with Sync (P1)</h2></p><p><h3>Description</h3>
Staff logs temperature manually while offline, data syncs when connectivity returns.</p><p><h3>Preconditions</h3>
<li>Unit exists with manual logging enabled</li>
<li>Staff user account</li>
<li>Mobile device with app access</li></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Log in on mobile device | Dashboard loads | |
| 2 | Navigate to Manual Log | Manual log page displays | |
| 3 | Enable airplane mode | Device offline | |
| 4 | Verify offline indicator | "Offline" badge appears | |
| 5 | Select unit from dropdown | Unit selected (cached) | |
| 6 | Enter temperature: 38Â°F | Input accepted | |
| 7 | Add note: "Visual check" | Note accepted | |
| 8 | Tap "Log Temperature" | Success with "pending sync" | |
| 9 | Repeat for 2 more entries | All stored locally | |
| 10 | Disable airplane mode | Device online | |
| 11 | Wait for sync | Sync indicator appears | |
| 12 | Verify sync complete | "Pending" badges clear | |
| 13 | Check unit detail page | All 3 entries appear in history | |
| 14 | Verify timestamps | Original entry times preserved | |</p><p><h3>Success Criteria</h3>
<li>[ ] Offline logging works without errors</li>
<li>[ ] All entries synced without data loss</li>
<li>[ ] Original timestamps preserved</li>
<li>[ ] Entries appear in correct chronological order</li></p><p><h3>Failure Handling</h3></p><p>| Failure Point | Recovery Action |
|---------------|-----------------|
| Offline mode not working | Check service worker registration, clear cache |
| Sync fails | Check network, retry sync, examine IndexedDB |
| Entries missing | Check local storage, check for sync conflicts |</p><p>---</p><p><h2>Scenario 5: Multi-Location Monitoring (P1)</h2></p><p><h3>Description</h3>
Regional manager monitors multiple locations, receives alerts from different sites, and generates consolidated reports.</p><p><h3>Preconditions</h3>
<li>Organization with 3+ sites configured</li>
<li>Units at each site with sensors</li>
<li>Regional manager account with access to all sites</li>
<li>Alert rules configured for each site</li></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Log in as regional manager | Dashboard loads | |
| 2 | Verify all sites visible | 3+ sites displayed | |
| 3 | Verify aggregate status | Overall org status shows | |
| 4 | Click on Site A | Site detail page shows | |
| 5 | Verify Site A units | Units list displays | |
| 6 | Navigate back to dashboard | Dashboard displays | |
| 7 | Click on Site B | Site B detail page shows | |
| 8 | Trigger alert at Site A | (Background action) | |
| 9 | Refresh dashboard | Alert indicator appears for Site A | |
| 10 | Click alert notification | Navigate to alert | |
| 11 | Acknowledge alert | Alert acknowledged | |
| 12 | Navigate to Reports | Reports page displays | |
| 13 | Select "All Sites" | Multi-site scope selected | |
| 14 | Select last 7 days | Date range set | |
| 15 | Generate compliance report | Report generates | |
| 16 | Verify all sites in report | Data from all 3 sites included | |
| 17 | Export PDF | PDF downloads | |
| 18 | Verify PDF content | All site data in document | |</p><p><h3>Success Criteria</h3>
<li>[ ] All sites accessible from single dashboard</li>
<li>[ ] Aggregate status accurate</li>
<li>[ ] Alerts visible regardless of source site</li>
<li>[ ] Cross-site reports generate correctly</li></p><p>---</p><p><h2>Scenario 6: Device Failure and Recovery (P1)</h2></p><p><h3>Description</h3>
A sensor goes offline, triggers monitoring interrupt alert, and then recovers when replaced.</p><p><h3>Preconditions</h3>
<li>Unit with active sensor</li>
<li>Monitoring interrupt rule enabled (e.g., offline > 30 min)</li>
<li>Replacement sensor available</li></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Verify sensor is "active" | Dashboard shows normal status | |
| 2 | Simulate sensor failure | (Power off or remove battery) | |
| 3 | Wait 30 minutes | Sensor goes offline | |
| 4 | Verify sensor status | Status changes to "offline" | |
| 5 | Verify unit status | Shows "monitoring_interrupted" | |
| 6 | Check for alert | "Monitoring Interrupted" alert created | |
| 7 | Check notification | Alert notification received | |
| 8 | Navigate to Settings â†’ Sensors | Sensor shows offline | |
| 9 | Deprovision failed sensor | Sensor removed from TTN | |
| 10 | Add replacement sensor | New sensor added | |
| 11 | Provision replacement | Sensor provisioned to TTN | |
| 12 | Assign to unit | Sensor assigned | |
| 13 | Power on replacement sensor | Device joins network | |
| 14 | Wait for first reading | Reading received | |
| 15 | Verify unit status | Returns to "OK" | |
| 16 | Verify original alert | Should auto-resolve | |</p><p><h3>Success Criteria</h3>
<li>[ ] Offline detection works within expected timeframe</li>
<li>[ ] Monitoring interrupt alert triggers</li>
<li>[ ] Sensor replacement process works</li>
<li>[ ] Unit status recovers automatically</li></p><p>---</p><p><h2>Scenario 7: Health Inspection Report (P1)</h2></p><p><h3>Description</h3>
Generate compliance documentation for a health inspector requesting 90 days of temperature records.</p><p><h3>Preconditions</h3>
<li>90+ days of temperature data</li>
<li>Some alerts during period (for realistic testing)</li>
<li>Admin or manager account</li></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Navigate to Reports | Reports page displays | |
| 2 | Select "Compliance Report" | Report type selected | |
| 3 | Set date range: last 90 days | Date range set | |
| 4 | Select specific site | Site scope set | |
| 5 | Click "Generate Report" | Report loading starts | |
| 6 | Wait for completion | Report displays | |
| 7 | Verify summary section | Total readings, alert count | |
| 8 | Verify reading counts | Expected number present | |
| 9 | Verify alert history | Alerts listed with resolution | |
| 10 | Verify corrective actions | Actions documented | |
| 11 | Click "Export PDF" | PDF generates | |
| 12 | Download PDF | File downloads | |
| 13 | Open PDF | Content renders correctly | |
| 14 | Verify all sections present | Summary, data, alerts, actions | |
| 15 | Verify timestamps | All in correct timezone | |</p><p><h3>Success Criteria</h3>
<li>[ ] Report generates within 30 seconds</li>
<li>[ ] All 90 days of data included</li>
<li>[ ] Alert history complete</li>
<li>[ ] PDF professional and print-ready</li>
<li>[ ] Data matches on-screen display</li></p><p>---</p><p><h2>Scenario 8: Billing and Plan Upgrade (P2)</h2></p><p><h3>Description</h3>
Customer upgrades from Starter to Pro plan to add more sensors.</p><p><h3>Preconditions</h3>
<li>Account on Starter plan</li>
<li>Stripe test mode enabled</li>
<li>Test card numbers available</li></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Navigate to Settings â†’ Billing | Billing page displays | |
| 2 | Verify current plan | Shows "Starter" | |
| 3 | Click "Upgrade Plan" | Plan selection appears | |
| 4 | Select "Pro" plan | Pro features highlighted | |
| 5 | Click "Continue" | Stripe checkout opens | |
| 6 | Enter test card: 4242... | Card accepted | |
| 7 | Complete checkout | Payment processes | |
| 8 | Return to app | Success message | |
| 9 | Verify plan updated | Shows "Pro" | |
| 10 | Verify sensor limit increased | Limit shows 25 | |
| 11 | Add sensor beyond old limit | Sensor added successfully | |
| 12 | Check Stripe dashboard | Subscription active | |</p><p><h3>Success Criteria</h3>
<li>[ ] Checkout flow completes</li>
<li>[ ] Plan updates immediately</li>
<li>[ ] New limits take effect</li>
<li>[ ] Stripe webhook processed correctly</li></p><p>---</p><p><h2>Scenario 9: User Role and Permission Changes (P2)</h2></p><p><h3>Description</h3>
Admin invites new user, assigns role, and verifies permission enforcement.</p><p><h3>Preconditions</h3>
<li>Admin account</li>
<li>New user email for invitation</li></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Log in as admin | Dashboard displays | |
| 2 | Navigate to Settings â†’ Users | User list displays | |
| 3 | Click "Invite User" | Invitation form opens | |
| 4 | Enter new user email | Email accepted | |
| 5 | Select role: "Staff" | Role selected | |
| 6 | Send invitation | Invitation sent | |
| 7 | Check new user email | Invitation received | |
| 8 | Accept invitation (new session) | Account created | |
| 9 | Log in as new staff user | Dashboard displays | |
| 10 | Verify dashboard access | Units visible | |
| 11 | Try to access Settings â†’ TTN | Access denied | |
| 12 | Try to delete a unit | Action blocked | |
| 13 | Log temperature manually | Action succeeds | |
| 14 | Acknowledge an alert | Action succeeds | |
| 15 | Log back in as admin | Admin dashboard | |
| 16 | Change user role to Manager | Role updated | |
| 17 | Log back in as user | Role change reflected | |
| 18 | Verify expanded permissions | Settings access granted | |</p><p><h3>Success Criteria</h3>
<li>[ ] Invitation flow works</li>
<li>[ ] Role restrictions enforced immediately</li>
<li>[ ] Role changes take effect without re-login</li>
<li>[ ] No permission leakage</li></p><p>---</p><p><h2>Scenario 10: Data Integrity Under Load (P2)</h2></p><p><h3>Description</h3>
Verify system handles high-frequency sensor readings without data loss.</p><p><h3>Preconditions</h3>
<li>Sensor simulator available</li>
<li>Ability to send rapid readings</li></p><p><h3>Steps</h3></p><p>| # | Action | Expected Result | Actual Result |
|---|--------|-----------------|---------------|
| 1 | Configure simulator for 10 sensors | Simulator ready | |
| 2 | Set reading frequency: 1 per minute | Fast mode enabled | |
| 3 | Start simulator | Readings begin flowing | |
| 4 | Run for 30 minutes | 300+ readings generated | |
| 5 | Stop simulator | Readings stop | |
| 6 | Query database: count readings | Should match sent count | |
| 7 | Verify no duplicates | No duplicate timestamps | |
| 8 | Verify no gaps | Sequential readings present | |
| 9 | Check dashboard performance | Still responsive | |
| 10 | Generate report for period | Report includes all data | |</p><p><h3>Success Criteria</h3>
<li>[ ] 100% of sent readings stored</li>
<li>[ ] No duplicate entries</li>
<li>[ ] Dashboard remains responsive</li>
<li>[ ] No webhook failures (check TTN logs)</li></p><p>---</p><p><h2>Test Session Log Template</h2></p><p><pre><code class="markdown"><h2>E2E Test Session</h2></p><p><strong>Date:</strong> YYYY-MM-DD HH:MM
<strong>Tester:</strong> [Name]
<strong>Environment:</strong> [Staging/Local]
<strong>Scenario:</strong> [Scenario Name]</p><p><h3>Execution Log</h3></p><p>| Step | Start Time | Status | Notes |
|------|------------|--------|-------|
| 1    | HH:MM      | Pass   |       |
| 2    | HH:MM      | Pass   |       |
| 3    | HH:MM      | FAIL   | [Details] |</p><p><h3>Failure Details</h3>
[Detailed description of any failures]</p><p><h3>Screenshots</h3>
[Attach relevant screenshots]</p><p><h3>Environment Notes</h3>
<li>Browser:</li>
<li>Device:</li>
<li>Network conditions:</li></p><p><h3>Sign-off</h3>
<li>[ ] All steps completed</li>
<li>[ ] All success criteria verified</li>
<li>[ ] Issues documented and reported</li>
</code></pre></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#test_strategy">TEST_STRATEGY.md</a> â€” Overall testing philosophy</li>
<li><a href="#coverage_map">COVERAGE_MAP.md</a> â€” Feature-to-test mapping</li>
<li><a href="#manual_testing">MANUAL_TESTING.md</a> â€” Step-by-step manual QA checklists</li>
<li><a href="#known_gaps">KNOWN_GAPS.md</a> â€” Missing coverage and risks</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="qa-known_gaps"></a></p><p><h1>Known Test Coverage Gaps</h1></p><p><blockquote>Risk assessment and recommended future tests</blockquote></p><p>---</p><p><h2>Executive Summary</h2></p><p>FreshTrack Pro has <strong>minimal automated test coverage</strong> (~5% estimated). The existing tests cover only eligibility logic and TTN permission validation. Critical paths including alert processing, data ingestion, and the entire frontend remain untested.</p><p><h3>Current Coverage Statistics</h3></p><p>| Area | Files | Tested | Coverage |
|------|-------|--------|----------|
| Pages | 23 | 0 | 0% |
| Components | 112 | 0 | 0% |
| Hooks | 26 | 0 | 0% |
| Edge Functions | 32 | 1 | 3% |
| Lib/Actions | 6 | 6 | 100% |
| <strong>Total</strong> | <strong>199+</strong> | <strong>7</strong> | <strong>~3%</strong> |</p><p>---</p><p><h2>Critical Gaps (P0 - Immediate Risk)</h2></p><p><h3>Gap 1: Alert Processing Engine</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>File</strong> | <code>supabase/functions/process-unit-states/index.ts</code> |
| <strong>Risk Level</strong> | <strong>CRITICAL</strong> |
| <strong>Business Impact</strong> | Missed alerts â†’ spoiled inventory ($10K+), health violations |
| <strong>Current Testing</strong> | None |</p><p><strong>What Could Go Wrong:</strong>
<li>Temperature threshold comparisons fail</li>
<li>Confirm time logic broken</li>
<li>Alert state transitions incorrect</li>
<li>Database writes silently fail</li></p><p><strong>Recommended Tests:</strong>
<pre><code class="typescript">// Unit tests for alert logic
describe("process-unit-states", () => {
  it("creates alert when temp exceeds threshold for confirm_time");
  it("does not create alert for brief excursions");
  it("resolves alert when temp returns to normal");
  it("handles multiple simultaneous excursions");
  it("respects unit-specific override rules");
});
</code></pre></p><p><strong>Priority:</strong> Implement within 1 week</p><p>---</p><p><h3>Gap 2: Notification Dispatch</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>File</strong> | <code>supabase/functions/process-escalations/index.ts</code> |
| <strong>Risk Level</strong> | <strong>CRITICAL</strong> |
| <strong>Business Impact</strong> | Alerts triggered but no one notified |
| <strong>Current Testing</strong> | None |</p><p><strong>What Could Go Wrong:</strong>
<li>Escalation timing incorrect</li>
<li>Wrong contacts notified</li>
<li>Email/SMS delivery fails silently</li>
<li>Duplicate notifications sent</li></p><p><strong>Recommended Tests:</strong>
<pre><code class="typescript">describe("process-escalations", () => {
  it("sends notification to level 1 contacts immediately");
  it("escalates to level 2 after delay if unacknowledged");
  it("stops escalation when alert acknowledged");
  it("handles contact with no email gracefully");
  it("respects notification policy channel settings");
});
</code></pre></p><p><strong>Priority:</strong> Implement within 1 week</p><p>---</p><p><h3>Gap 3: TTN Webhook Data Ingestion</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>File</strong> | <code>supabase/functions/ttn-webhook/index.ts</code> |
| <strong>Risk Level</strong> | <strong>CRITICAL</strong> |
| <strong>Business Impact</strong> | Temperature data not recorded â†’ compliance gaps |
| <strong>Current Testing</strong> | None |</p><p><strong>What Could Go Wrong:</strong>
<li>DevEUI normalization fails</li>
<li>Webhook secret validation bypassed</li>
<li>Payload parsing errors</li>
<li>Database insert fails</li>
<li>Duplicate readings accepted</li></p><p><strong>Recommended Tests:</strong>
<pre><code class="typescript">describe("ttn-webhook", () => {
  it("accepts valid uplink with correct webhook secret");
  it("rejects requests with invalid webhook secret");
  it("normalizes DevEUI to uppercase no-separator format");
  it("parses temperature from various payload formats");
  it("stores reading with correct sensor association");
  it("handles unknown DevEUI gracefully");
});
</code></pre></p><p><strong>Priority:</strong> Implement within 1 week</p><p>---</p><p><h3>Gap 4: Frontend Unit Status Computation</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>File</strong> | <code>src/hooks/useUnitStatus.ts</code> |
| <strong>Risk Level</strong> | <strong>HIGH</strong> |
| <strong>Business Impact</strong> | Dashboard shows wrong status â†’ delayed response |
| <strong>Current Testing</strong> | None |</p><p><strong>What Could Go Wrong:</strong>
<li>Status priority ordering wrong</li>
<li>Excursion vs alarm distinction broken</li>
<li>Offline detection timing wrong</li>
<li>Status doesn't update when data changes</li></p><p><strong>Recommended Tests:</strong>
<pre><code class="typescript">describe("useUnitStatus", () => {
  it("returns 'ok' when temperature in range");
  it("returns 'excursion' during unconfirmed excursion");
  it("returns 'alarm_active' after confirm time");
  it("returns 'offline' when sensor stops reporting");
  it("priority: alarm_active > excursion > offline > ok");
});
</code></pre></p><p><strong>Priority:</strong> Implement within 2 weeks</p><p>---</p><p><h2>High-Priority Gaps (P1 - Significant Risk)</h2></p><p><h3>Gap 5: Row-Level Security Policies</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>Files</strong> | All migrations with RLS policies |
| <strong>Risk Level</strong> | <strong>HIGH</strong> |
| <strong>Business Impact</strong> | Data leakage between organizations |
| <strong>Current Testing</strong> | None |</p><p><strong>Risk Scenarios:</strong>
<li>User A can see User B's organization data</li>
<li>Deleted user retains access</li>
<li>Role changes not enforced</li>
<li>Cross-tenant data in reports</li></p><p><strong>Recommended Tests:</strong>
<pre><code class="sql">-- Test RLS for units table
SET request.jwt.claim.sub = 'user-org-a';
SELECT </em> FROM units WHERE organization_id = 'org-b'; -- Should return 0
</code></pre></p><p><strong>Priority:</strong> Implement within 2 weeks</p><p>---</p><p><h3>Gap 6: Device Provisioning Flow</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>Files</strong> | <code>ttn-provision-device</code>, <code>ttn-provision-gateway</code> |
| <strong>Risk Level</strong> | <strong>HIGH</strong> |
| <strong>Business Impact</strong> | Devices not registered â†’ no data collection |
| <strong>Current Testing</strong> | Eligibility only (logic before API call) |</p><p><strong>What Could Go Wrong:</strong>
<li>TTN API call format wrong</li>
<li>Error handling insufficient</li>
<li>Rollback on partial failure missing</li>
<li>Status not updated after provisioning</li></p><p><strong>Priority:</strong> Implement within 3 weeks</p><p>---</p><p><h3>Gap 7: Offline Sync Mechanism</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>File</strong> | <code>src/hooks/useOfflineSync.ts</code> |
| <strong>Risk Level</strong> | <strong>HIGH</strong> |
| <strong>Business Impact</strong> | Manual logs lost during field work |
| <strong>Current Testing</strong> | None |</p><p><strong>What Could Go Wrong:</strong>
<li>IndexedDB writes fail</li>
<li>Sync conflicts not resolved</li>
<li>Data loss during sync</li>
<li>Timestamps corrupted</li></p><p><strong>Priority:</strong> Implement within 3 weeks</p><p>---</p><p><h3>Gap 8: Alert Rules Cascading</h3></p><p>| Attribute | Value |
|-----------|-------|
| <strong>Files</strong> | <code>get_effective_alert_rules</code> RPC, <code>useAlertRules.ts</code> |
| <strong>Risk Level</strong> | <strong>MEDIUM-HIGH</strong> |
| <strong>Business Impact</strong> | Wrong thresholds applied â†’ false positives/negatives |
| <strong>Current Testing</strong> | None |</p><p><strong>What Could Go Wrong:</strong>
<li>Unit override not applied</li>
<li>Site settings ignored</li>
<li>Inheritance chain broken</li>
<li>Default rules missing</li></p><p><strong>Priority:</strong> Implement within 4 weeks</p><p>---</p><p><h2>Medium-Priority Gaps (P2)</h2></p><p><h3>Gap 9: Component Testing</h3></p><p>| Files | Count | Risk |
|-------|-------|------|
| Settings components | 20+ | Forms may break silently |
| Dashboard widgets | 10+ | Data display errors |
| Alert components | 5+ | Status not reflected |</p><p><strong>Recommended Approach:</strong>
<li>Use React Testing Library</li>
<li>Start with forms that save data</li>
<li>Test error states</li></p><p><strong>Priority:</strong> Implement over 2 months</p><p>---</p><p><h3>Gap 10: Page-Level Integration</h3></p><p>| Pages | Risk |
|-------|------|
| Dashboard | Data loading, filtering, refresh |
| Settings | Form submission, validation |
| Unit Detail | Real-time updates, graph rendering |
| Reports | Report generation, export |</p><p><strong>Recommended Approach:</strong>
<li>Mock Supabase client</li>
<li>Test component composition</li>
<li>Verify data flow</li></p><p><strong>Priority:</strong> Implement over 2 months</p><p>---</p><p><h3>Gap 11: Stripe Integration</h3></p><p>| Functions | Risk |
|-----------|------|
| <code>stripe-checkout</code> | Payment failures |
| <code>stripe-portal</code> | Customer access issues |
| <code>stripe-webhook</code> | Subscription state sync |</p><p><strong>Recommended Approach:</strong>
<li>Use Stripe test mode</li>
<li>Mock webhook events</li>
<li>Test state transitions</li></p><p><strong>Priority:</strong> Implement over 2 months</p><p>---</p><p><h2>Low-Priority Gaps (P3)</h2></p><p><h3>Gap 12: UI/Visual Testing</h3></p><p>| Area | Current State |
|------|---------------|
| Responsive design | Manual only |
| Browser compatibility | Manual only |
| Theme/branding | Manual only |
| Accessibility | Not tested |</p><p><strong>Recommended Approach:</strong>
<li>Consider Playwright for visual regression</li>
<li>Use axe-core for accessibility</li></p><p><strong>Priority:</strong> Quarterly review</p><p>---</p><p><h3>Gap 13: Performance Testing</h3></p><p>| Metric | Current State |
|--------|---------------|
| Page load times | Not measured |
| API response times | Not measured |
| Database query performance | Not measured |
| Concurrent user load | Not tested |</p><p><strong>Recommended Approach:</strong>
<li>Lighthouse CI for page performance</li>
<li>k6 for API load testing</li>
<li>pg_stat_statements for query analysis</li></p><p><strong>Priority:</strong> Before scaling</p><p>---</p><p><h2>Risk Matrix</h2></p><p>| Gap | Likelihood | Impact | Risk Score | Priority |
|-----|------------|--------|------------|----------|
| Alert Processing | Medium | Critical | <strong>P0</strong> | Week 1 |
| Notification Dispatch | Medium | Critical | <strong>P0</strong> | Week 1 |
| TTN Webhook | Low | Critical | <strong>P0</strong> | Week 1 |
| Unit Status | Medium | High | <strong>P1</strong> | Week 2 |
| RLS Policies | Low | Critical | <strong>P1</strong> | Week 2 |
| Device Provisioning | Medium | High | <strong>P1</strong> | Week 3 |
| Offline Sync | Medium | High | <strong>P1</strong> | Week 3 |
| Alert Cascading | Low | High | <strong>P1</strong> | Week 4 |
| Components | High | Medium | <strong>P2</strong> | Month 2 |
| Page Integration | High | Medium | <strong>P2</strong> | Month 2 |
| Stripe | Low | Medium | <strong>P2</strong> | Month 2 |
| UI/Visual | High | Low | <strong>P3</strong> | Quarterly |
| Performance | Low | Medium | <strong>P3</strong> | Pre-scale |</p><p>---</p><p><h2>Immediate Action Items</h2></p><p><h3>Week 1</h3></p><p><li><strong>Add npm test script to package.json</strong></li>
   <pre><code class="json">   "test": "vitest",
   "test:watch": "vitest --watch",
   "test:coverage": "vitest --coverage"
   </code></pre></p><p><li><strong>Create test utilities file</strong></li>
   <pre><code class="typescript">   // src/test/utils.ts
   export function createMockSupabaseClient() { ... }
   export function createTestAlertRule() { ... }
   export function createTestUnit() { ... }
   </code></pre></p><p><li><strong>Write first critical path tests</strong></li>
   - <code>process-unit-states</code> alert logic
   - <code>ttn-webhook</code> payload parsing
   - <code>useUnitStatus</code> status computation</p><p><h3>Week 2-4</h3></p><p><li>Add integration tests for database operations</li>
<li>Create RLS policy test suite</li>
<li>Document manual test procedures for gaps</li></p><p>---</p><p><h2>Testing Debt Tracking</h2></p><p><h3>Definition of Done for Test Debt</h3></p><p>A gap is "closed" when:
<li>[ ] Automated tests exist for happy path</li>
<li>[ ] Automated tests exist for error cases</li>
<li>[ ] Tests run in CI</li>
<li>[ ] Coverage documented in COVERAGE_MAP.md</li></p><p><h3>Quarterly Review Checklist</h3></p><p><li>[ ] Review this document</li>
<li>[ ] Update gap priorities based on incidents</li>
<li>[ ] Track coverage metrics</li>
<li>[ ] Plan next quarter's test debt reduction</li></p><p>---</p><p><h2>Appendix: Test Infrastructure Improvements</h2></p><p><h3>Immediate Needs</h3></p><p><li><strong>npm test script</strong> â€” Currently missing from package.json</li>
<li><strong>CI integration</strong> â€” Tests should run on every PR</li>
<li><strong>Coverage reporting</strong> â€” Track progress over time</li></p><p><h3>Future Considerations</h3></p><p><li><strong>Playwright for E2E</strong> â€” Automate critical user journeys</li>
<li><strong>Visual regression</strong> â€” Catch UI breakage</li>
<li><strong>Load testing</strong> â€” Validate scaling before growth</li></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#test_strategy">TEST_STRATEGY.md</a> â€” Overall testing philosophy</li>
<li><a href="#coverage_map">COVERAGE_MAP.md</a> â€” Feature-to-test mapping</li>
<li><a href="#manual_testing">MANUAL_TESTING.md</a> â€” Step-by-step manual QA checklists</li>
<li><a href="#e2e_scenarios">E2E_SCENARIOS.md</a> â€” Critical user flow testing</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="security-security_overview"></a></p><p><h1>Security Overview</h1></p><p><blockquote>FreshTrack Pro Security Architecture and Principles</blockquote></p><p>---</p><p><h2>Executive Summary</h2></p><p>FreshTrack Pro is a multi-tenant SaaS platform for refrigeration monitoring. Security is architected around <strong>tenant isolation</strong>, <strong>defense in depth</strong>, and <strong>least privilege access</strong>. The platform handles sensitive operational data and integrates with external IoT infrastructure (The Things Network) and payment processing (Stripe).</p><p><h3>Security Classification</h3></p><p>| Data Type | Classification | Handling |
|-----------|----------------|----------|
| Temperature readings | Business Sensitive | Encrypted in transit, RLS protected |
| TTN API keys | Secret | Encrypted at rest, never logged |
| User credentials | Secret | Managed by Supabase Auth |
| Organization data | Business Sensitive | Tenant-isolated via RLS |
| Payment information | PCI Sensitive | Handled by Stripe (not stored) |</p><p>---</p><p><h2>Security Principles</h2></p><p><h3>1. Defense in Depth</h3></p><p>Multiple security layers protect each transaction:</p><p><pre><code class="">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PERIMETER LAYER                          â”‚
â”‚  TLS 1.3 â€¢ CDN WAF â€¢ Rate Limiting                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   APPLICATION LAYER                          â”‚
â”‚  JWT Validation â€¢ CORS â€¢ Input Validation â€¢ CSRF Protection â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   AUTHORIZATION LAYER                        â”‚
â”‚  RBAC â€¢ RLS Policies â€¢ Org Scope Verification               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      DATA LAYER                              â”‚
â”‚  Encryption at Rest â€¢ Column Encryption â€¢ Audit Logging     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p><h3>2. Tenant Isolation (Zero Trust Between Tenants)</h3></p><p>Every database query is scoped to the authenticated user's organization:</p><p><li><strong>Row Level Security (RLS)</strong>: PostgreSQL policies enforce org boundaries</li>
<li><strong>Foreign Key Constraints</strong>: Data relationships maintain org scope</li>
<li><strong>Unique Constraints</strong>: Scoped to organization (e.g., DevEUI per org)</li>
<li><strong>Function-Level Checks</strong>: Edge functions verify org membership</li></p><p><h3>3. Least Privilege Access</h3></p><p>| Principal | Access Level | Justification |
|-----------|-------------|---------------|
| Anonymous users | Public pages only | No data access |
| Authenticated users | Own organization only | RLS enforced |
| Staff role | Read + limited write | Operational needs |
| Admin role | Full org access | Management needs |
| Service role | Cross-org (internal only) | Scheduled jobs |</p><p><h3>4. Secure by Default</h3></p><p><li>All database tables have RLS <strong>enabled by default</strong></li>
<li>All edge functions require JWT verification unless explicitly disabled</li>
<li>All external webhooks require signature/secret verification</li>
<li>Sensitive fields are encrypted before storage</li></p><p>---</p><p><h2>Trust Boundaries</h2></p><p><pre><code class="mermaid">graph TB
    subgraph "UNTRUSTED ZONE"
        U[Users/Browsers]
        TTN[TTN Network]
        STRIPE[Stripe]
    end</p><p>    subgraph "DMZ"
        CDN[Supabase CDN/Edge]
    end</p><p>    subgraph "TRUSTED ZONE"
        subgraph "Application Layer"
            FUNC[Edge Functions]
            AUTH[Supabase Auth]
        end
        subgraph "Data Layer"
            DB[(PostgreSQL)]
            SECRETS[Vault/Secrets]
        end
    end</p><p>    U -->|TLS| CDN
    TTN -->|Webhook Secret| CDN
    STRIPE -->|Signature| CDN
    CDN -->|JWT| FUNC
    CDN -->|JWT| AUTH
    FUNC -->|Service Role| DB
    AUTH -->|Internal| DB
    FUNC -->|Read| SECRETS
</code></pre></p><p><h3>Boundary Definitions</h3></p><p>| Boundary | From | To | Validation |
|----------|------|-----|------------|
| <strong>B1</strong> | Browser | CDN | TLS, CORS |
| <strong>B2</strong> | CDN | Edge Functions | JWT signature |
| <strong>B3</strong> | TTN | Webhook | Per-org secret (constant-time compare) |
| <strong>B4</strong> | Stripe | Webhook | HMAC signature |
| <strong>B5</strong> | Edge Functions | Database | RLS policies + service role |
| <strong>B6</strong> | Edge Functions | Secrets | Environment variables |</p><p>---</p><p><h2>High-Level Security Controls</h2></p><p><h3>Authentication Controls</h3></p><p>| Control | Implementation | Status |
|---------|----------------|--------|
| Password authentication | Supabase Auth | Active |
| Session management | JWT with refresh tokens | Active |
| Password strength | 8+ chars, complexity rules | Active |
| Account lockout | Supabase rate limiting | Active |
| Email verification | Supabase email confirmation | Active |
| MFA/2FA | <strong>TBD</strong> - Not currently implemented | Planned |</p><p><h3>Authorization Controls</h3></p><p>| Control | Implementation | Status |
|---------|----------------|--------|
| Role-Based Access Control | 6 roles (owner â†’ inspector) | Active |
| Row-Level Security | PostgreSQL RLS policies | Active |
| Organization isolation | <code>organization_id</code> on all tables | Active |
| Permission functions | <code>has_role()</code>, <code>user_belongs_to_org()</code> | Active |
| API endpoint protection | JWT verification per function | Active |</p><p><h3>Data Protection Controls</h3></p><p>| Control | Implementation | Status |
|---------|----------------|--------|
| Transport encryption | TLS 1.3 (Supabase managed) | Active |
| Database encryption | Supabase managed encryption at rest | Active |
| Sensitive field encryption | XOR-based obfuscation (v2 format) | Active |
| Secret storage | Environment variables / Vault | Active |
| Audit logging | <code>event_logs</code> table with hash chain | Active |</p><p><h3>Network Controls</h3></p><p>| Control | Implementation | Status |
|---------|----------------|--------|
| CORS | Configured per function | Active |
| Rate limiting | Supabase platform level | Active |
| DDoS protection | Supabase/Cloudflare | Active |
| Webhook validation | Per-integration verification | Active |</p><p>---</p><p><h2>Security Architecture by Layer</h2></p><p><h3>Frontend (Browser)</h3></p><p><li>Single-page React application</li>
<li>JWT stored in localStorage (with refresh mechanism)</li>
<li>No sensitive data stored client-side (except session token)</li>
<li>CSP headers managed by hosting platform</li>
<li>Input validation with Zod schemas</li></p><p><h3>API Layer (Edge Functions)</h3></p><p><li>Deno runtime with V8 isolates</li>
<li>Per-request JWT verification</li>
<li>Service role for internal operations</li>
<li>Constant-time secret comparison for webhooks</li>
<li>Request validation before processing</li></p><p><h3>Database Layer (PostgreSQL)</h3></p><p><li>Row Level Security on all tables</li>
<li><code>SECURITY DEFINER</code> functions for privileged operations</li>
<li>Encrypted columns for API keys</li>
<li>Audit tables for compliance</li>
<li>Cascading deletes preserve referential integrity</li></p><p><h3>External Integrations</h3></p><p>| Integration | Auth Method | Data Flow |
|-------------|-------------|-----------|
| The Things Network | Per-org webhook secret | Inbound only |
| Stripe | HMAC signature | Bidirectional |
| Resend (Email) | API key | Outbound only |
| Twilio (SMS) | API key | Outbound only |</p><p>---</p><p><h2>Compliance Considerations</h2></p><p><h3>Data Residency</h3></p><p><li>Primary database: Supabase cloud (region configurable)</li>
<li>CDN: Global edge locations</li>
<li>TTN data: EU1 cluster enforced for European deployments</li></p><p><h3>Regulatory Alignment</h3></p><p>| Requirement | Status | Notes |
|-------------|--------|-------|
| GDPR | Partial | Data deletion, audit logs implemented |
| HACCP | Active | Temperature logging, tamper-evident records |
| FDA 21 CFR Part 11 | Partial | Audit trail, electronic signatures TBD |
| SOC 2 | TBD | Supabase platform certified |
| PCI DSS | N/A | No card data stored (Stripe handles) |</p><p><h3>Audit Capabilities</h3></p><p><li><strong>Event logs</strong>: All significant actions logged with actor, timestamp, IP</li>
<li><strong>Hash chaining</strong>: Events include <code>previous_hash</code> for tamper detection</li>
<li><strong>Immutable design</strong>: Append-only logging tables</li>
<li><strong>Retention</strong>: Configurable per compliance requirements</li></p><p>---</p><p><h2>Security Responsibilities</h2></p><p><h3>Platform (Supabase)</h3></p><p><li>Infrastructure security</li>
<li>Database encryption at rest</li>
<li>Network security and DDoS protection</li>
<li>Auth service security</li>
<li>Patching and updates</li></p><p><h3>Application (FreshTrack Pro)</h3></p><p><li>RLS policy correctness</li>
<li>Input validation</li>
<li>Secret management</li>
<li>Secure coding practices</li>
<li>Vulnerability remediation</li></p><p><h3>Customer</h3></p><p><li>Strong passwords</li>
<li>User access management</li>
<li>Device physical security</li>
<li>Timely security updates</li>
<li>Incident reporting</li></p><p>---</p><p><h2>Known Security Considerations</h2></p><p><h3>Acknowledged Risks</h3></p><p>| Risk | Mitigation | Status |
|------|------------|--------|
| CORS wildcard (<em>) | Protected by JWT/API key auth | Documented |
| localStorage JWT | Refresh token rotation | Active |
| API key in logs (last4) | Log access controls required | TBD |
| Debug encryption mode | Temporary, requires reversion | In Progress |</p><p><h3>Security Debt</h3></p><p><li><strong>MFA not implemented</strong> - Planned for future release</li>
<li><strong>API key rotation UI</strong> - Manual process currently</li>
<li><strong>Rate limiting visibility</strong> - Platform-level, not application-configurable</li>
<li><strong>Webhook secret rotation</strong> - No automated rotation</li></p><p>---</p><p><h2>Security Contacts</h2></p><p>| Role | Responsibility |
|------|----------------|
| Security Lead | Architecture, policy, incident response |
| Platform Team | Infrastructure, Supabase configuration |
| Development Team | Secure coding, vulnerability fixes |
| Operations | Monitoring, log analysis |</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#auth_model">AUTH_MODEL.md</a> â€” Authentication and authorization details</li>
<li><a href="#data_protection">DATA_PROTECTION.md</a> â€” Encryption and secrets management</li>
<li><a href="#threat_model">THREAT_MODEL.md</a> â€” Threats, attack surfaces, mitigations</li>
<li><a href="#incident_response">INCIDENT_RESPONSE.md</a> â€” Security incident procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="security-auth_model"></a></p><p><h1>Authentication & Authorization Model</h1></p><p><blockquote>How users authenticate and what they can access</blockquote></p><p>---</p><p><h2>Authentication Architecture</h2></p><p><h3>Authentication Provider</h3></p><p>FreshTrack Pro uses <strong>Supabase Auth</strong> for all user authentication:</p><p>| Component | Technology |
|-----------|------------|
| Identity Provider | Supabase Auth (GoTrue) |
| Token Format | JWT (RS256 signed) |
| Session Storage | Browser localStorage |
| Token Refresh | Automatic refresh before expiry |
| Password Hashing | bcrypt (Supabase managed) |</p><p><h3>Authentication Flow</h3></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User Browser
    participant A as Auth Page
    participant SA as Supabase Auth
    participant DB as Database
    participant D as Dashboard</p><p>    U->>A: Navigate to /auth
    A->>U: Display login form
    U->>A: Submit email/password
    A->>SA: signInWithPassword()
    SA->>SA: Validate credentials
    SA->>DB: Create session record
    SA->>A: Return JWT + refresh token
    A->>U: Store tokens in localStorage
    A->>D: Redirect to /dashboard
    D->>SA: Verify JWT on each request
    SA->>D: Return user context
</code></pre></p><p><h3>Token Structure</h3></p><p><pre><code class="typescript">// JWT Payload (decoded)
{
  "aud": "authenticated",
  "exp": 1704931200,           // Expiration timestamp
  "sub": "user-uuid-here",     // User ID
  "email": "user@example.com",
  "role": "authenticated",     // Supabase role (not app role)
  "session_id": "session-uuid"
}
</code></pre></p><p><h3>Session Management</h3></p><p>| Aspect | Configuration |
|--------|---------------|
| Access token lifetime | 1 hour (Supabase default) |
| Refresh token lifetime | 7 days |
| Concurrent sessions | Unlimited |
| Session invalidation | On password change, manual logout |</p><p><h3>Authentication Endpoints</h3></p><p>| Endpoint | Purpose | Rate Limited |
|----------|---------|--------------|
| <code>/auth/v1/signup</code> | User registration | Yes |
| <code>/auth/v1/token</code> | Login, refresh | Yes |
| <code>/auth/v1/logout</code> | Session termination | No |
| <code>/auth/v1/recover</code> | Password reset | Yes |</p><p>---</p><p><h2>Password Security</h2></p><p><h3>Password Requirements</h3></p><p>Enforced in <code>/src/pages/Auth.tsx</code>:</p><p><pre><code class="typescript">// Password validation
password.length >= 8           // Minimum length
/[A-Z]/.test(password)        // Uppercase required
/[a-z]/.test(password)        // Lowercase required
/[0-9]/.test(password)        // Number required
/[^A-Za-z0-9]/.test(password) // Special character required
</code></pre></p><p><h3>Password Storage</h3></p><p><li><strong>Hashing</strong>: bcrypt with cost factor (Supabase managed)</li>
<li><strong>Salt</strong>: Unique per password (bcrypt built-in)</li>
<li><strong>Storage</strong>: <code>auth.users</code> table (never in application tables)</li></p><p><h3>Password Reset Flow</h3></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant A as Auth Page
    participant SA as Supabase Auth
    participant E as Email Service</p><p>    U->>A: Click "Forgot Password"
    A->>SA: resetPasswordForEmail()
    SA->>E: Send reset link email
    E->>U: Email with magic link
    U->>A: Click reset link
    A->>SA: Verify token from URL
    SA->>A: Token valid
    A->>U: Show new password form
    U->>A: Submit new password
    A->>SA: updateUser({ password })
    SA->>SA: Invalidate other sessions
    SA->>A: Success
</code></pre></p><p>---</p><p><h2>Authorization Model</h2></p><p><h3>Role Hierarchy</h3></p><p>FreshTrack Pro implements a <strong>role-based access control (RBAC)</strong> model:</p><p><pre><code class="">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OWNER                         â”‚
â”‚  Full control, billing, user management          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ADMIN                         â”‚
â”‚  All operations except billing                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   MANAGER                        â”‚
â”‚  Operational control, settings, reports          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    STAFF                         â”‚
â”‚  Daily operations, temperature logging           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   VIEWER                         â”‚
â”‚  Read-only access to alerts                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  INSPECTOR                       â”‚
â”‚  Alerts + export reports for audits              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p><h3>Role Permissions Matrix</h3></p><p>| Permission | Owner | Admin | Manager | Staff | Viewer | Inspector |
|------------|:-----:|:-----:|:-------:|:-----:|:------:|:---------:|
| View dashboard | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ |
| View alerts | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ |
| Acknowledge alerts | âœ“ | âœ“ | âœ“ | - | - | - |
| Log temperatures | âœ“ | âœ“ | âœ“ | âœ“ | - | - |
| Edit temperature limits | âœ“ | âœ“ | âœ“ | - | - | - |
| Manage sites/areas/units | âœ“ | âœ“ | âœ“ | - | - | - |
| Configure TTN | âœ“ | âœ“ | - | - | - | - |
| Manage sensors/gateways | âœ“ | âœ“ | - | - | - | - |
| Manage users | âœ“ | âœ“ | - | - | - | - |
| Export reports | âœ“ | âœ“ | âœ“ | - | - | âœ“ |
| Access billing | âœ“ | - | - | - | - | - |
| Delete organization | âœ“ | - | - | - | - | - |</p><p><h3>Role Assignment</h3></p><p>Roles are stored in the <code>user_roles</code> table:</p><p><pre><code class="sql">CREATE TABLE user_roles (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    organization_id UUID REFERENCES organizations(id),
    role TEXT NOT NULL CHECK (role IN (
        'owner', 'admin', 'manager', 'staff', 'viewer', 'inspector'
    )),
    created_at TIMESTAMPTZ,
    UNIQUE (user_id, organization_id)  -- One role per user per org
);
</code></pre></p><p><h3>Permission Checking (Frontend)</h3></p><p><pre><code class="typescript">// src/hooks/useUserRole.ts
const { role, permissions } = useUserRole();</p><p>// Check specific permission
if (permissions.canManageSites) {
    // Show site management UI
}</p><p>// Check role directly
if (role === 'owner' || role === 'admin') {
    // Show admin features
}
</code></pre></p><p><h3>Permission Checking (Backend)</h3></p><p><pre><code class="typescript">// Edge function pattern
const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();</p><p>if (!['owner', 'admin'].includes(profile.role)) {
    return new Response(JSON.stringify({ error: 'Forbidden' }), {
        status: 403
    });
}
</code></pre></p><p>---</p><p><h2>Organization/User Separation</h2></p><p><h3>Multi-Tenancy Model</h3></p><p><pre><code class="mermaid">graph TD
    subgraph "Organization A"
        UA1[User A1 - Owner]
        UA2[User A2 - Staff]
        SA[Site A]
        DA[(Data A)]
    end</p><p>    subgraph "Organization B"
        UB1[User B1 - Owner]
        SB[Site B]
        DB[(Data B)]
    end</p><p>    UA1 --> SA
    UA2 --> SA
    SA --> DA</p><p>    UB1 --> SB
    SB --> DB</p><p>    DA -.-x|RLS Blocks| UB1
    DB -.-x|RLS Blocks| UA1
</code></pre></p><p><h3>Organization Isolation Enforcement</h3></p><p>#### Database Level (RLS)</p><p><pre><code class="sql">-- Example RLS policy on units table
CREATE POLICY "Users can view their org's units"
    ON units
    FOR SELECT
    USING (
        organization_id IN (
            SELECT organization_id
            FROM profiles
            WHERE id = auth.uid()
        )
    );
</code></pre></p><p>#### Helper Functions</p><p><pre><code class="sql">-- Check if user belongs to organization
CREATE FUNCTION user_belongs_to_org(_user_id UUID, _org_id UUID)
RETURNS BOOLEAN AS $$
    SELECT EXISTS (
        SELECT 1 FROM profiles
        WHERE id = _user_id AND organization_id = _org_id
    );
$$ LANGUAGE sql SECURITY DEFINER;</p><p>-- Check if user has specific role
CREATE FUNCTION has_role(_user_id UUID, _org_id UUID, _role TEXT)
RETURNS BOOLEAN AS $$
    SELECT EXISTS (
        SELECT 1 FROM user_roles
        WHERE user_id = _user_id
        AND organization_id = _org_id
        AND role = _role
    );
$$ LANGUAGE sql SECURITY DEFINER;
</code></pre></p><p>#### Application Level</p><p><pre><code class="typescript">// Every data query includes organization scope
const { data } = await supabase
    .from('units')
    .select('</em>')
    .eq('organization_id', organizationId);  // Explicit scope
</code></pre></p><p><h3>Cross-Organization Protection</h3></p><p>| Scenario | Protection Mechanism |
|----------|---------------------|
| User A queries Org B data | RLS returns empty result |
| User A's token used with Org B ID | RLS blocks + function validation |
| DevEUI registered in both orgs | <code>UNIQUE (organization_id, dev_eui)</code> constraint |
| Webhook for wrong org | Webhook secret lookup isolates |</p><p>---</p><p><h2>Session and Token Security</h2></p><p><h3>Token Storage</h3></p><p>| Token Type | Storage Location | Security Consideration |
|------------|-----------------|----------------------|
| Access token | localStorage | XSS vulnerable, short-lived |
| Refresh token | localStorage | Longer-lived, rotated on use |</p><p><h3>Token Refresh Flow</h3></p><p><pre><code class="typescript">// Automatic refresh (Supabase client)
const { data, error } = await supabase.auth.refreshSession();</p><p>// Triggered when:
// - Access token expires
// - Manual refresh called
// - Page load with valid refresh token
</code></pre></p><p><h3>Session Invalidation</h3></p><p>| Event | Action |
|-------|--------|
| User logout | Clear localStorage, server-side session invalidation |
| Password change | All sessions invalidated |
| Account deletion | All sessions and data deleted |
| Admin revocation | Session invalidated on next request |</p><p>---</p><p><h2>JWT Verification in Edge Functions</h2></p><p><h3>Automatic Verification (config.toml)</h3></p><p><pre><code class="toml">[functions.stripe-checkout]
verify_jwt = true  # Supabase verifies before function executes
</code></pre></p><p><h3>Manual Verification</h3></p><p><pre><code class="typescript">// For functions with verify_jwt = false
const authHeader = req.headers.get('Authorization');
const token = authHeader?.replace('Bearer ', '');</p><p>const { data: { user }, error } = await supabase.auth.getUser(token);</p><p>if (error || !user) {
    return new Response('Unauthorized', { status: 401 });
}
</code></pre></p><p><h3>Verification Matrix</h3></p><p>| Function | JWT Verification | Auth Method |
|----------|-----------------|-------------|
| <code>stripe-checkout</code> | Automatic | Supabase JWT |
| <code>stripe-portal</code> | Automatic | Supabase JWT |
| <code>sensor-simulator</code> | Automatic | Supabase JWT |
| <code>ttn-webhook</code> | None | Webhook secret |
| <code>stripe-webhook</code> | None | HMAC signature |
| <code>manage-ttn-settings</code> | Manual | Bearer token |
| <code>process-unit-states</code> | None | Internal API key |
| <code>export-temperature-logs</code> | Manual | JWT or API key |</p><p>---</p><p><h2>API Authentication Methods</h2></p><p><h3>Method 1: JWT Bearer Token</h3></p><p><pre><code class="http">Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
</code></pre></p><p>Used by: Browser clients, authenticated API calls</p><p><h3>Method 2: API Key Header</h3></p><p><pre><code class="http">X-Internal-Key: sk_internal_xxxxx
</code></pre></p><p>Used by: Scheduled jobs, service-to-service</p><p><h3>Method 3: Webhook Secret</h3></p><p><pre><code class="http">X-Webhook-Secret: whsec_xxxxxxx
</code></pre></p><p>Used by: TTN webhooks (per-organization)</p><p><h3>Method 4: Signature Verification</h3></p><p><pre><code class="http">stripe-signature: t=xxx,v1=xxx
</code></pre></p><p>Used by: Stripe webhooks</p><p>---</p><p><h2>Security Events Logged</h2></p><p>| Event | Logged Data | Table |
|-------|-------------|-------|
| Login success | user_id, IP, user_agent, timestamp | Supabase audit |
| Login failure | email, IP, timestamp | Supabase audit |
| Password change | user_id, timestamp | Supabase audit |
| Role change | actor, target_user, old_role, new_role | event_logs |
| Permission denied | user_id, resource, action, timestamp | Function logs |</p><p>---</p><p><h2>Security Recommendations</h2></p><p><h3>Current Implementation</h3></p><p><li>[x] Password complexity requirements</li>
<li>[x] JWT-based session management</li>
<li>[x] Role-based access control</li>
<li>[x] Row-level security policies</li>
<li>[x] Webhook signature verification</li>
<li>[x] Service role isolation</li></p><p><h3>Recommended Enhancements</h3></p><p>| Enhancement | Priority | Status |
|-------------|----------|--------|
| Multi-factor authentication (MFA) | High | TBD |
| Session timeout configuration | Medium | TBD |
| Login anomaly detection | Medium | TBD |
| API key rotation workflow | Medium | TBD |
| OAuth/SSO integration | Low | TBD |</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#security_overview">SECURITY_OVERVIEW.md</a> â€” High-level security architecture</li>
<li><a href="#data_protection">DATA_PROTECTION.md</a> â€” Encryption and secrets management</li>
<li><a href="#threat_model">THREAT_MODEL.md</a> â€” Threats and mitigations</li>
<li><a href="#incident_response">INCIDENT_RESPONSE.md</a> â€” Security incident procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="security-data_protection"></a></p><p><h1>Data Protection</h1></p><p><blockquote>Encryption, secrets management, and data handling practices</blockquote></p><p>---</p><p><h2>Data Classification</h2></p><p><h3>Classification Scheme</h3></p><p>| Level | Description | Examples | Controls |
|-------|-------------|----------|----------|
| <strong>Secret</strong> | Credentials, keys | API keys, passwords | Encrypted, never logged |
| <strong>Confidential</strong> | Sensitive business data | Customer data, configs | Encrypted, access controlled |
| <strong>Internal</strong> | Operational data | Temperature readings | RLS protected |
| <strong>Public</strong> | Non-sensitive | Marketing content | Standard controls |</p><p><h3>Data Inventory</h3></p><p>| Data Type | Classification | Storage | Encryption |
|-----------|---------------|---------|------------|
| User passwords | Secret | Supabase Auth | bcrypt hashed |
| TTN API keys | Secret | <code>ttn_connections</code> | Application-level |
| Webhook secrets | Secret | <code>ttn_connections</code> | Application-level |
| Stripe keys | Secret | Environment only | Not stored in DB |
| Temperature readings | Internal | <code>sensor_readings</code> | At rest (platform) |
| Organization info | Confidential | <code>organizations</code> | At rest (platform) |
| User profiles | Confidential | <code>profiles</code> | At rest (platform) |</p><p>---</p><p><h2>Encryption at Rest</h2></p><p><h3>Platform-Level Encryption</h3></p><p>Supabase provides transparent encryption for all database storage:</p><p>| Component | Encryption | Key Management |
|-----------|------------|----------------|
| PostgreSQL data files | AES-256 | Supabase managed |
| PostgreSQL WAL | AES-256 | Supabase managed |
| Backups | AES-256 | Supabase managed |
| Blob storage | AES-256 | Supabase managed |</p><p><h3>Application-Level Encryption</h3></p><p>Sensitive fields receive additional application-level encryption:</p><p>#### Encrypted Fields</p><p>| Table | Field | Encryption Method |
|-------|-------|-------------------|
| <code>ttn_connections</code> | <code>ttn_api_key_encrypted</code> | XOR v2 |
| <code>ttn_connections</code> | <code>ttn_webhook_secret_encrypted</code> | XOR v2 |
| <code>ttn_connections</code> | <code>ttn_gateway_api_key_encrypted</code> | XOR v2 |
| <code>ttn_connections</code> | <code>ttn_org_api_key_encrypted</code> | XOR v2 |</p><p>#### Encryption Algorithm (v2 Format)</p><p><pre><code class="typescript">// Location: supabase/functions/_shared/ttnConfig.ts</p><p>function obfuscateKey(key: string, salt: string): string {
    const encoder = new TextEncoder();
    const keyBytes = encoder.encode(key);
    const saltBytes = encoder.encode(salt);</p><p>    const obfuscated = new Uint8Array(keyBytes.length);
    for (let i = 0; i < keyBytes.length; i++) {
        obfuscated[i] = keyBytes[i] ^ saltBytes[i % saltBytes.length];
    }</p><p>    return "v2:" + btoa(String.fromCharCode(...obfuscated));
}
</code></pre></p><p><strong>Key Derivation:</strong>
<li>Salt source: <code>TTN_ENCRYPTION_SALT</code> environment variable</li>
<li>Fallback: First 32 characters of <code>SUPABASE_SERVICE_ROLE_KEY</code></li>
<li>Format prefix: <code>v2:</code> for version identification</li></p><p>#### Decryption</p><p><pre><code class="typescript">function deobfuscateKey(encoded: string, salt: string): string {
    // Handle v2 format
    if (encoded.startsWith("v2:")) {
        const decoded = atob(encoded.slice(3));
        // XOR with salt to recover original
        // ...
    }
    // Legacy format fallback
    // ...
}
</code></pre></p><p><h3>Display Safety</h3></p><p>For user interface display, only the last 4 characters are shown:</p><p>| Stored Field | Display Field | Example |
|--------------|--------------|---------|
| <code>ttn_api_key_encrypted</code> | <code>ttn_api_key_last4</code> | <code>â€¢â€¢â€¢â€¢â€¢A1B2</code> |
| <code>ttn_webhook_secret_encrypted</code> | (computed) | <code>â€¢â€¢â€¢â€¢â€¢X9Y8</code> |</p><p>---</p><p><h2>Encryption in Transit</h2></p><p><h3>TLS Configuration</h3></p><p>All communications use TLS 1.3:</p><p>| Connection | TLS Version | Certificate |
|------------|-------------|-------------|
| Browser â†’ CDN | TLS 1.3 | Supabase managed |
| CDN â†’ Edge Functions | TLS 1.3 | Internal |
| Edge Functions â†’ Database | TLS 1.3 | Internal |
| Application â†’ TTN | TLS 1.3 | TTN certificate |
| Application â†’ Stripe | TLS 1.3 | Stripe certificate |</p><p><h3>API Security Headers</h3></p><p><pre><code class="typescript">// Applied to all responses
{
    "Strict-Transport-Security": "max-age=31536000; includeSubDomains",
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY"
}
</code></pre></p><p>---</p><p><h2>Secrets Management</h2></p><p><h3>Secret Categories</h3></p><p>| Category | Examples | Storage Location |
|----------|----------|------------------|
| <strong>Platform secrets</strong> | Database password, JWT secret | Supabase Vault |
| <strong>Integration secrets</strong> | TTN admin key, Stripe secret | Environment variables |
| <strong>Per-org secrets</strong> | TTN app keys, webhook secrets | Database (encrypted) |
| <strong>User secrets</strong> | Passwords | Supabase Auth |</p><p><h3>Environment Variables</h3></p><p>#### Frontend (Exposed to Browser)</p><p><pre><code class="env"><h1>.env - VITE_ prefix exposes to browser</h1>
VITE_SUPABASE_PROJECT_ID=xxxxx
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJS...  # Public anon key (safe)
</code></pre></p><p><strong>Security Note:</strong> <code>VITE_</code> prefixed variables are bundled into client-side code. Never put secrets here.</p><p>#### Backend (Server-Side Only)</p><p><pre><code class="env"><h1>Edge function secrets (never exposed to browser)</h1>
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJS...  # Privileged access
TTN_ADMIN_API_KEY=NNSXS.xxxxx             # TTN admin operations
TTN_ENCRYPTION_SALT=xxxxxxxx              # Encryption salt
STRIPE_SECRET_KEY=sk_live_xxxxx           # Stripe API
STRIPE_WEBHOOK_SECRET=whsec_xxxxx         # Stripe webhook
INTERNAL_API_KEY=xxxxx                     # Internal service calls
DEVICE_INGEST_API_KEY=xxxxx               # Device data ingestion
</code></pre></p><p><h3>Secret Rotation</h3></p><p>| Secret Type | Rotation Method | Frequency |
|-------------|-----------------|-----------|
| Database password | Supabase dashboard | On compromise |
| JWT secret | Supabase dashboard | On compromise |
| TTN API keys | Manual re-provisioning | On compromise |
| Stripe keys | Stripe dashboard | On compromise |
| Webhook secrets | Regenerate + update DB | On compromise |</p><p><h3>Secret Access Patterns</h3></p><p><pre><code class="typescript">// Correct: Server-side secret access
const apiKey = Deno.env.get("TTN_ADMIN_API_KEY");</p><p>// Incorrect: Never log secrets
console.log("API Key:", apiKey);  // NEVER DO THIS</p><p>// Acceptable: Log last 4 for debugging
console.log("Using key ending in:", apiKey.slice(-4));
</code></pre></p><p>---</p><p><h2>CI/CD Security</h2></p><p><h3>Build-Time Security</h3></p><p>| Check | Tool | Stage |
|-------|------|-------|
| Secret scanning | <strong>TBD</strong> | Pre-commit |
| Dependency audit | <code>npm audit</code> | Build |
| Type checking | TypeScript | Build |
| Linting | ESLint | Build |</p><p><h3>Deployment Security</h3></p><p>| Environment | Secret Injection | Method |
|-------------|-----------------|--------|
| Development | <code>.env</code> file | Local only, gitignored |
| Staging | Supabase Secrets | Dashboard/CLI |
| Production | Supabase Secrets | Dashboard/CLI |</p><p><h3>Gitignore Rules</h3></p><p><pre><code class="gitignore"><h1>Secrets - NEVER commit</h1>
.env
.env.local
.env.<em>.local
</em>.pem
<em>.key
credentials.json</p><p><h1>Supabase local</h1>
supabase/.branches
supabase/.temp
</code></pre></p><p><h3>Secret Exposure Prevention</h3></p><p>| Control | Implementation |
|---------|----------------|
| Pre-commit hooks | <strong>TBD</strong> - Recommend git-secrets |
| Branch protection | <strong>TBD</strong> - Configure in repository |
| Secret scanning | <strong>TBD</strong> - GitHub secret scanning |
| Audit logging | Supabase audit logs |</p><p>---</p><p><h2>Sensitive Data Handling</h2></p><p><h3>PII (Personally Identifiable Information)</h3></p><p>| Data Type | Collected | Storage | Retention |
|-----------|-----------|---------|-----------|
| Email | Yes | <code>auth.users</code> | Account lifetime |
| Name | Optional | <code>profiles</code> | Account lifetime |
| Phone | Optional | <code>escalation_contacts</code> | Account lifetime |
| IP Address | Logged | <code>event_logs</code> | Configurable |</p><p><h3>Data Minimization</h3></p><p><li>Only collect data necessary for functionality</li>
<li>Phone numbers only for SMS alerts</li>
<li>IP addresses only for audit trails</li></p><p><h3>Data Retention</h3></p><p>| Data Type | Retention Period | Deletion Method |
|-----------|------------------|-----------------|
| Temperature readings | Permanent | N/A (compliance) |
| Alert history | Permanent | N/A (compliance) |
| Audit logs | Permanent | N/A (compliance) |
| Session data | 7 days | Automatic |
| Deleted user data | Immediate cascade | Referential delete |</p><p><h3>Right to Deletion</h3></p><p><pre><code class="sql">-- User deletion cascades through:
-- 1. profiles (FK to auth.users)
-- 2. user_roles (FK to profiles)
-- 3. Organization data remains (other users may exist)</p><p>-- Full org deletion required for complete data removal
DELETE FROM organizations WHERE id = ?;
-- Cascades to all related data
</code></pre></p><p>---</p><p><h2>Database Security</h2></p><p><h3>Connection Security</h3></p><p>| Aspect | Configuration |
|--------|---------------|
| Connection encryption | TLS required |
| Connection pooling | Supabase managed |
| Prepared statements | Yes (SQL injection prevention) |
| Query timeouts | Configured |</p><p><h3>RLS as Data Protection</h3></p><p>Row Level Security acts as a data protection mechanism:</p><p><pre><code class="sql">-- Users can only see their organization's data
CREATE POLICY "org_isolation" ON sensor_readings
    FOR SELECT
    USING (
        organization_id = (
            SELECT organization_id FROM profiles
            WHERE id = auth.uid()
        )
    );
</code></pre></p><p><h3>Privileged Access</h3></p><p>| Role | Access Level | Use Case |
|------|-------------|----------|
| <code>anon</code> | RLS enforced, limited | Public/unauthenticated |
| <code>authenticated</code> | RLS enforced, user context | Normal users |
| <code>service_role</code> | Bypasses RLS | Backend services |</p><p><strong>Service Role Protection:</strong>
<li>Never expose service role key to frontend</li>
<li>Use only in edge functions for internal operations</li>
<li>Audit all service role usage</li></p><p>---</p><p><h2>Backup and Recovery</h2></p><p><h3>Backup Configuration</h3></p><p>| Aspect | Configuration |
|--------|---------------|
| Frequency | Daily (Supabase managed) |
| Retention | 7 days (configurable) |
| Encryption | AES-256 |
| Location | Same region as database |</p><p><h3>Recovery Procedures</h3></p><p>| Scenario | Recovery Method | RTO |
|----------|-----------------|-----|
| Accidental deletion | Point-in-time recovery | Hours |
| Database corruption | Restore from backup | Hours |
| Region failure | Cross-region restore | Hours |</p><p>---</p><p><h2>Audit and Compliance</h2></p><p><h3>Audit Trail</h3></p><p><pre><code class="sql">-- Event logs table structure
CREATE TABLE event_logs (
    id UUID PRIMARY KEY,
    organization_id UUID,
    event_type TEXT NOT NULL,
    actor_id UUID,
    actor_type TEXT,  -- 'user' | 'system'
    resource_type TEXT,
    resource_id UUID,
    details JSONB,
    ip_address INET,
    user_agent TEXT,
    previous_hash TEXT,  -- Chain hash for tamper detection
    event_hash TEXT,
    created_at TIMESTAMPTZ
);
</code></pre></p><p><h3>Logged Events</h3></p><p>| Event Type | Logged Details |
|------------|----------------|
| <code>user.login</code> | IP, user agent, success/failure |
| <code>user.logout</code> | Session ID |
| <code>role.change</code> | Old role, new role, actor |
| <code>data.export</code> | Export type, date range |
| <code>settings.change</code> | Field changed, old/new values |
| <code>alert.acknowledge</code> | Alert ID, actor, note |</p><p><h3>Tamper Detection</h3></p><p>Events are hash-chained to detect tampering:</p><p><pre><code class="typescript">// Each event includes hash of previous event
const eventHash = hash(event.id + event.data + previousHash);
</code></pre></p><p>---</p><p><h2>Security Monitoring</h2></p><p><h3>Log Analysis</h3></p><p>| Log Source | Contains | Access |
|------------|----------|--------|
| Supabase logs | Database queries, auth events | Supabase dashboard |
| Edge function logs | Application events | Supabase dashboard |
| Event logs table | Business events | Application |</p><p><h3>Alerting (TBD)</h3></p><p>| Condition | Alert | Priority |
|-----------|-------|----------|
| Failed login spike | <strong>TBD</strong> | High |
| Service role access anomaly | <strong>TBD</strong> | High |
| RLS policy bypass attempt | <strong>TBD</strong> | Critical |
| Secret access from new IP | <strong>TBD</strong> | Medium |</p><p>---</p><p><h2>Security Hardening Checklist</h2></p><p><h3>Implemented</h3></p><p><li>[x] TLS for all connections</li>
<li>[x] Encrypted secrets storage</li>
<li>[x] RLS on all tables</li>
<li>[x] Input validation (Zod)</li>
<li>[x] Prepared statements</li>
<li>[x] Audit logging</li>
<li>[x] Service role isolation</li></p><p><h3>Recommended Enhancements</h3></p><p>| Enhancement | Priority | Status |
|-------------|----------|--------|
| Secret scanning in CI | High | TBD |
| Automated key rotation | Medium | TBD |
| Enhanced audit alerting | Medium | TBD |
| Field-level encryption expansion | Low | TBD |
| Hardware security module (HSM) | Low | TBD |</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#security_overview">SECURITY_OVERVIEW.md</a> â€” High-level security architecture</li>
<li><a href="#auth_model">AUTH_MODEL.md</a> â€” Authentication and authorization</li>
<li><a href="#threat_model">THREAT_MODEL.md</a> â€” Threats and mitigations</li>
<li><a href="#incident_response">INCIDENT_RESPONSE.md</a> â€” Security incident procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="security-threat_model"></a></p><p><h1>Threat Model</h1></p><p><blockquote>Assets, threat actors, attack surfaces, and mitigations</blockquote></p><p>---</p><p><h2>Document Information</h2></p><p>| Attribute | Value |
|-----------|-------|
| Last Updated | 2026-01-12 |
| Review Frequency | Quarterly |
| Methodology | STRIDE + DREAD |
| Scope | FreshTrack Pro application and infrastructure |</p><p>---</p><p><h2>Assets</h2></p><p><h3>Critical Assets</h3></p><p>| Asset | Description | Confidentiality | Integrity | Availability |
|-------|-------------|-----------------|-----------|--------------|
| <strong>Temperature Data</strong> | Historical sensor readings | Medium | Critical | High |
| <strong>Alert Records</strong> | Alert history, acknowledgments | Medium | Critical | High |
| <strong>TTN Credentials</strong> | API keys for IoT infrastructure | Critical | Critical | High |
| <strong>User Credentials</strong> | Passwords, sessions | Critical | Critical | High |
| <strong>Organization Data</strong> | Customer configurations | High | High | High |</p><p><h3>High-Value Assets</h3></p><p>| Asset | Description | CIA Rating |
|-------|-------------|------------|
| Stripe credentials | Payment processing | C: Critical, I: Critical, A: High |
| Webhook secrets | External integration auth | C: Critical, I: High, A: Medium |
| Service role key | Database bypass access | C: Critical, I: Critical, A: Critical |
| Audit logs | Compliance records | C: Medium, I: Critical, A: High |</p><p><h3>Supporting Assets</h3></p><p>| Asset | Description | CIA Rating |
|-------|-------------|------------|
| Source code | Application logic | C: Medium, I: High, A: Medium |
| Infrastructure config | Deployment settings | C: Medium, I: High, A: High |
| Documentation | Technical/business docs | C: Low, I: Medium, A: Low |</p><p>---</p><p><h2>Threat Actors</h2></p><p><h3>Actor Profiles</h3></p><p>| Actor | Motivation | Capability | Likelihood |
|-------|------------|------------|------------|
| <strong>Competitor</strong> | Data theft, sabotage | Medium | Low |
| <strong>Cybercriminal</strong> | Financial gain, ransomware | Medium-High | Medium |
| <strong>Disgruntled Employee</strong> | Revenge, data theft | High (insider) | Low |
| <strong>Script Kiddie</strong> | Curiosity, reputation | Low | Medium |
| <strong>Nation State</strong> | Espionage, disruption | Very High | Very Low |
| <strong>Malicious Customer</strong> | Cross-tenant access | Medium | Medium |</p><p><h3>Most Likely Threat Actors</h3></p><p><li><strong>Malicious Customer</strong> â€” Attempts to access other organizations' data</li>
<li><strong>Cybercriminal</strong> â€” Credential stuffing, API abuse</li>
<li><strong>Script Kiddie</strong> â€” Automated scanning, known vulnerabilities</li></p><p>---</p><p><h2>Attack Surfaces</h2></p><p><h3>Threat Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "External Actors"
        ATK[Attacker]
        MAL[Malicious Customer]
    end</p><p>    subgraph "Attack Surface"
        WEB[Web Application<br/>React SPA]
        API[API Endpoints<br/>Edge Functions]
        WH_TTN[TTN Webhook]
        WH_STRIPE[Stripe Webhook]
        AUTH[Auth Endpoints]
    end</p><p>    subgraph "Internal Systems"
        DB[(PostgreSQL<br/>+ RLS)]
        SECRETS[Secrets Store]
        FUNC[Edge Functions]
    end</p><p>    subgraph "External Services"
        TTN[The Things Network]
        STRIPE[Stripe]
    end</p><p>    ATK -->|XSS, CSRF| WEB
    ATK -->|Injection, Auth Bypass| API
    ATK -->|Forged Webhooks| WH_TTN
    ATK -->|Forged Webhooks| WH_STRIPE
    ATK -->|Credential Stuffing| AUTH
    MAL -->|Tenant Escape| API</p><p>    WEB --> API
    API --> DB
    API --> SECRETS
    WH_TTN --> FUNC
    WH_STRIPE --> FUNC
    FUNC --> DB</p><p>    TTN -.->|Legitimate| WH_TTN
    STRIPE -.->|Legitimate| WH_STRIPE</p><p>    style ATK fill:#ff6b6b
    style MAL fill:#ff9f43
    style DB fill:#2ed573
    style SECRETS fill:#2ed573
</code></pre></p><p><h3>Attack Surface Inventory</h3></p><p>| Surface | Entry Point | Authentication | Risk Level |
|---------|-------------|----------------|------------|
| Web Application | <code>/</em></code> routes | JWT session | Medium |
| REST API | <code>/functions/<em></code> | JWT/API key | High |
| TTN Webhook | <code>/functions/ttn-webhook</code> | Webhook secret | High |
| Stripe Webhook | <code>/functions/stripe-webhook</code> | HMAC signature | Medium |
| Auth Endpoints | <code>/auth/v1/</em></code> | None (public) | High |
| Database | PostgreSQL port | Service role | Critical |</p><p>---</p><p><h2>Threat Analysis (STRIDE)</h2></p><p><h3>Spoofing</h3></p><p>| Threat | Target | Mitigation | Status |
|--------|--------|------------|--------|
| <strong>S1</strong> Session hijacking | User sessions | JWT with expiry, HTTPS only | Active |
| <strong>S2</strong> Credential stuffing | Auth endpoint | Rate limiting, complexity rules | Active |
| <strong>S3</strong> Forged webhook calls | TTN/Stripe | Secret/signature verification | Active |
| <strong>S4</strong> API key theft | Service endpoints | Encrypted storage, rotation | Partial |</p><p><h3>Tampering</h3></p><p>| Threat | Target | Mitigation | Status |
|--------|--------|------------|--------|
| <strong>T1</strong> Temperature data modification | Sensor readings | RLS, audit logs, hash chain | Active |
| <strong>T2</strong> Alert state manipulation | Alert records | RLS, role checks | Active |
| <strong>T3</strong> Configuration tampering | Org settings | RLS, admin-only access | Active |
| <strong>T4</strong> Log tampering | Audit logs | Hash chain, append-only | Active |</p><p><h3>Repudiation</h3></p><p>| Threat | Target | Mitigation | Status |
|--------|--------|------------|--------|
| <strong>R1</strong> Deny alert acknowledgment | Alert actions | Actor ID, timestamp, IP logged | Active |
| <strong>R2</strong> Deny temperature logs | Manual entries | Actor ID, timestamp logged | Active |
| <strong>R3</strong> Deny configuration changes | Settings | Event log with actor | Active |</p><p><h3>Information Disclosure</h3></p><p>| Threat | Target | Mitigation | Status |
|--------|--------|------------|--------|
| <strong>I1</strong> Cross-tenant data access | All data | RLS policies, org scope | Active |
| <strong>I2</strong> API key exposure | TTN keys | Encryption, last4 display | Active |
| <strong>I3</strong> Log leakage | Audit data | Access control, RLS | Partial |
| <strong>I4</strong> Error message disclosure | Stack traces | Production error handling | Active |</p><p><h3>Denial of Service</h3></p><p>| Threat | Target | Mitigation | Status |
|--------|--------|------------|--------|
| <strong>D1</strong> API flooding | Edge functions | Rate limiting (platform) | Active |
| <strong>D2</strong> Auth endpoint abuse | Login | Rate limiting | Active |
| <strong>D3</strong> Webhook flooding | TTN webhook | Secret validation first | Active |
| <strong>D4</strong> Database exhaustion | PostgreSQL | Connection pooling | Active |</p><p><h3>Elevation of Privilege</h3></p><p>| Threat | Target | Mitigation | Status |
|--------|--------|------------|--------|
| <strong>E1</strong> Tenant escape | Cross-org access | RLS, org_id validation | Active |
| <strong>E2</strong> Role escalation | User roles | DB constraints, RLS | Active |
| <strong>E3</strong> Service role access | Privileged ops | Server-side only | Active |
| <strong>E4</strong> Webhook to admin | Internal systems | Scoped permissions | Active |</p><p>---</p><p><h2>Attack Scenarios</h2></p><p><h3>Scenario 1: Cross-Tenant Data Access</h3></p><p><strong>Actor:</strong> Malicious Customer
<strong>Goal:</strong> Access competitor's temperature data
<strong>Attack Path:</strong></p><p><pre><code class="">1. Attacker signs up for legitimate account
<li>Inspects API calls in browser DevTools</li>
<li>Modifies organization_id in request</li>
<li>Attempts to fetch data from victim org</li>
</code></pre></p><p><strong>Mitigations:</strong>
<li>RLS policy checks <code>auth.uid()</code> against <code>profiles.organization_id</code></li>
<li>Returns empty result, not error (prevents enumeration)</li>
<li>Function-level org validation as defense in depth</li></p><p><strong>Risk Rating:</strong> Medium (mitigated)</p><p>---</p><p><h3>Scenario 2: Webhook Forgery</h3></p><p><strong>Actor:</strong> External Attacker
<strong>Goal:</strong> Inject false sensor data
<strong>Attack Path:</strong></p><p><pre><code class="">1. Attacker discovers webhook URL
<li>Crafts fake TTN uplink payload</li>
<li>Sends to webhook endpoint</li>
<li>Attempts to inject readings for target org</li>
</code></pre></p><p><strong>Mitigations:</strong>
<li>Per-org webhook secret required in header</li>
<li>Constant-time secret comparison (timing attack prevention)</li>
<li>Org lookup via secret isolates scope</li>
<li>Unknown secrets rejected before processing</li></p><p><strong>Risk Rating:</strong> Low (well mitigated)</p><p>---</p><p><h3>Scenario 3: Credential Stuffing</h3></p><p><strong>Actor:</strong> Cybercriminal
<strong>Goal:</strong> Account takeover
<strong>Attack Path:</strong></p><p><pre><code class="">1. Attacker obtains leaked credential database
<li>Automates login attempts against /auth/v1/token</li>
<li>Successful logins captured</li>
<li>Access victim organizations</li>
</code></pre></p><p><strong>Mitigations:</strong>
<li>Supabase rate limiting on auth endpoints</li>
<li>Password complexity requirements</li>
<li><strong>TBD:</strong> Account lockout after failures</li>
<li><strong>TBD:</strong> Breach detection alerting</li>
<li><strong>TBD:</strong> MFA would prevent this attack</li></p><p><strong>Risk Rating:</strong> Medium (partially mitigated)</p><p>---</p><p><h3>Scenario 4: API Key Extraction</h3></p><p><strong>Actor:</strong> Disgruntled Employee
<strong>Goal:</strong> Exfiltrate TTN API keys for sabotage
<strong>Attack Path:</strong></p><p><pre><code class="">1. Employee with admin access views TTN settings
<li>Uses browser DevTools to intercept API response</li>
<li>Extracts encrypted key from response</li>
<li>Attempts offline decryption</li>
</code></pre></p><p><strong>Mitigations:</strong>
<li>Keys encrypted in database</li>
<li>Full key never returned to frontend (only last4)</li>
<li>Decryption requires server-side salt</li>
<li><strong>TBD:</strong> Key access logging and alerting</li></p><p><strong>Risk Rating:</strong> Medium (encryption helps, access control needed)</p><p>---</p><p><h3>Scenario 5: Privilege Escalation via Role Manipulation</h3></p><p><strong>Actor:</strong> Malicious Customer (staff role)
<strong>Goal:</strong> Gain admin access
<strong>Attack Path:</strong></p><p><pre><code class="">1. Staff user inspects API calls
<li>Discovers role update endpoint</li>
<li>Attempts to modify own role to admin</li>
<li>Crafts request with elevated role</li>
</code></pre></p><p><strong>Mitigations:</strong>
<li>Role table protected by RLS</li>
<li>Only owner/admin can modify roles</li>
<li><code>has_role()</code> function validates permissions</li>
<li>Database constraint on valid role values</li></p><p><strong>Risk Rating:</strong> Low (well mitigated)</p><p>---</p><p><h2>Risk Assessment (DREAD)</h2></p><p>| Threat | Damage | Reproducibility | Exploitability | Affected Users | Discoverability | Score |
|--------|--------|-----------------|----------------|----------------|-----------------|-------|
| S1 Session hijacking | 3 | 2 | 2 | 3 | 2 | <strong>2.4</strong> |
| S2 Credential stuffing | 4 | 4 | 3 | 3 | 4 | <strong>3.6</strong> |
| S3 Webhook forgery | 4 | 3 | 2 | 4 | 2 | <strong>3.0</strong> |
| I1 Cross-tenant access | 5 | 2 | 2 | 5 | 3 | <strong>3.4</strong> |
| I2 API key exposure | 4 | 2 | 2 | 4 | 2 | <strong>2.8</strong> |
| E1 Tenant escape | 5 | 2 | 2 | 5 | 3 | <strong>3.4</strong> |
| D1 API flooding | 2 | 4 | 4 | 4 | 4 | <strong>3.6</strong> |</p><p><strong>Score interpretation:</strong> 1-2 (Low), 2-3 (Medium), 3-4 (High), 4-5 (Critical)</p><p><h3>Priority Ranking</h3></p><p><li><strong>S2 Credential stuffing</strong> (3.6) â€” Implement MFA</li>
<li><strong>D1 API flooding</strong> (3.6) â€” Review rate limits</li>
<li><strong>I1/E1 Tenant escape</strong> (3.4) â€” Audit RLS policies</li>
<li><strong>S3 Webhook forgery</strong> (3.0) â€” Regular secret rotation</li>
<li><strong>I2 API key exposure</strong> (2.8) â€” Add access logging</li></p><p>---</p><p><h2>Mitigation Controls</h2></p><p><h3>Authentication Controls</h3></p><p>| Control | Threat Addressed | Implementation |
|---------|-----------------|----------------|
| JWT verification | S1 Spoofing | Supabase Auth |
| Password complexity | S2 Stuffing | Frontend validation |
| Rate limiting | S2, D1 | Platform level |
| Webhook secrets | S3 Forgery | Per-org secrets |
| <strong>MFA (TBD)</strong> | S2 Stuffing | Not implemented |</p><p><h3>Authorization Controls</h3></p><p>| Control | Threat Addressed | Implementation |
|---------|-----------------|----------------|
| RLS policies | E1, I1 | PostgreSQL |
| Role validation | E2 | <code>has_role()</code> function |
| Org scope checks | E1, I1 | Function-level |
| Service role isolation | E3 | Server-side only |</p><p><h3>Data Protection Controls</h3></p><p>| Control | Threat Addressed | Implementation |
|---------|-----------------|----------------|
| TLS | T1, I2 | Platform |
| Encryption at rest | I2, I4 | Platform + app |
| Audit logging | R1, R2, R3 | Event logs table |
| Hash chain | T4 | Append-only logs |</p><p><h3>Monitoring Controls</h3></p><p>| Control | Threat Addressed | Status |
|---------|-----------------|--------|
| Failed login monitoring | S2 | <strong>TBD</strong> |
| Unusual access patterns | E1, I1 | <strong>TBD</strong> |
| API abuse detection | D1 | <strong>TBD</strong> |
| Secret access logging | I2 | <strong>TBD</strong> |</p><p>---</p><p><h2>Security Testing Recommendations</h2></p><p><h3>Penetration Testing Scope</h3></p><p>| Area | Test Type | Frequency |
|------|-----------|-----------|
| Authentication | Credential attacks, session | Annual |
| Authorization | Tenant isolation, RBAC | Annual |
| API security | Injection, rate limiting | Annual |
| Webhook security | Forgery, replay | Annual |</p><p><h3>Automated Testing</h3></p><p>| Tool | Purpose | Integration |
|------|---------|-------------|
| Dependency scanner | Known vulnerabilities | CI/CD |
| SAST | Code vulnerabilities | CI/CD |
| DAST | Runtime vulnerabilities | Staging |
| Secret scanner | Credential leakage | Pre-commit |</p><p>---</p><p><h2>Residual Risks</h2></p><p><h3>Accepted Risks</h3></p><p>| Risk | Justification | Monitoring |
|------|---------------|------------|
| CORS wildcard | Multi-tenant SaaS, protected by auth | Auth logs |
| localStorage JWT | Browser standard, short-lived | Session audit |
| XOR encryption | Defense in depth, not sole protection | Key rotation |</p><p><h3>Risks Requiring Attention</h3></p><p>| Risk | Current State | Recommendation | Priority |
|------|---------------|----------------|----------|
| No MFA | Single factor | Implement TOTP | High |
| Limited rate visibility | Platform only | Add app-level | Medium |
| No breach detection | Manual review | Automated alerting | Medium |
| Key rotation manual | On-demand | Automated rotation | Low |</p><p>---</p><p><h2>Threat Model Maintenance</h2></p><p><h3>Review Triggers</h3></p><p><li>New feature deployment</li>
<li>Security incident</li>
<li>Quarterly review cycle</li>
<li>Dependency updates</li>
<li>Infrastructure changes</li></p><p><h3>Update Process</h3></p><p><li>Review current threats and mitigations</li>
<li>Assess new attack vectors</li>
<li>Update risk ratings</li>
<li>Document new controls</li>
<li>Communicate changes to team</li></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#security_overview">SECURITY_OVERVIEW.md</a> â€” High-level security architecture</li>
<li><a href="#auth_model">AUTH_MODEL.md</a> â€” Authentication and authorization</li>
<li><a href="#data_protection">DATA_PROTECTION.md</a> â€” Encryption and secrets</li>
<li><a href="#incident_response">INCIDENT_RESPONSE.md</a> â€” Security incident procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="security-incident_response"></a></p><p><h1>Incident Response</h1></p><p><blockquote>Detection, containment, recovery, and postmortem procedures</blockquote></p><p>---</p><p><h2>Document Information</h2></p><p>| Attribute | Value |
|-----------|-------|
| Document Owner | Security Lead |
| Last Updated | 2026-01-12 |
| Review Frequency | Semi-annual |
| Test Frequency | Annual tabletop exercise |</p><p>---</p><p><h2>Incident Classification</h2></p><p><h3>Severity Levels</h3></p><p>| Level | Description | Response Time | Examples |
|-------|-------------|---------------|----------|
| <strong>P1 - Critical</strong> | Active breach, data exfiltration | Immediate (< 15 min) | Credential theft, RLS bypass |
| <strong>P2 - High</strong> | Potential breach, service impact | < 1 hour | Suspicious access, DoS attack |
| <strong>P3 - Medium</strong> | Security weakness, limited impact | < 4 hours | Vulnerability discovered, failed attacks |
| <strong>P4 - Low</strong> | Minor issue, informational | < 24 hours | Policy violation, audit finding |</p><p><h3>Incident Categories</h3></p><p>| Category | Description | Examples |
|----------|-------------|----------|
| <strong>Unauthorized Access</strong> | Access beyond permissions | Tenant escape, privilege escalation |
| <strong>Data Breach</strong> | Data exposure or theft | Customer data leak, API key exposure |
| <strong>Service Disruption</strong> | Availability impact | DoS, infrastructure failure |
| <strong>Malware/Compromise</strong> | System infection | Compromised credentials, malicious code |
| <strong>Policy Violation</strong> | Non-compliance | Improper access, audit failure |</p><p>---</p><p><h2>Response Team</h2></p><p><h3>Roles and Responsibilities</h3></p><p>| Role | Primary Responsibility | Backup |
|------|----------------------|--------|
| <strong>Incident Commander</strong> | Overall coordination, decisions | Engineering Lead |
| <strong>Security Lead</strong> | Technical investigation, containment | Senior Developer |
| <strong>Communications Lead</strong> | Customer/stakeholder updates | Product Manager |
| <strong>Engineering Lead</strong> | Technical remediation | On-call Engineer |
| <strong>Legal Counsel</strong> | Regulatory compliance | External Counsel |</p><p><h3>Escalation Path</h3></p><p><pre><code class="">P4 â†’ On-call Engineer (monitor)
P3 â†’ Security Lead (investigate)
P2 â†’ Incident Commander + Security Lead (respond)
P1 â†’ Full Response Team (all hands)
</code></pre></p><p><h3>Contact Information</h3></p><p>| Role | Contact Method | Availability |
|------|---------------|--------------|
| Security Lead | <strong>[TBD - Add contact]</strong> | 24/7 for P1/P2 |
| On-call Engineer | <strong>[TBD - PagerDuty/Opsgenie]</strong> | 24/7 |
| Incident Commander | <strong>[TBD - Add contact]</strong> | Business hours + P1 |</p><p>---</p><p><h2>Phase 1: Detection</h2></p><p><h3>Detection Sources</h3></p><p>| Source | What It Detects | Alert Mechanism |
|--------|-----------------|-----------------|
| Supabase Logs | Auth failures, errors | Dashboard monitoring |
| Edge Function Logs | Application errors | Log aggregation |
| Event Logs Table | Business anomalies | Periodic review |
| Customer Reports | Visible issues | Support channel |
| External Scanners | Vulnerabilities | Scheduled scans |
| Platform Alerts | Infrastructure issues | Supabase status |</p><p><h3>Detection Indicators</h3></p><p>#### High Confidence Indicators</p><p>| Indicator | Likely Incident | Action |
|-----------|-----------------|--------|
| Multiple failed logins from one IP | Brute force attack | Block IP, investigate |
| Cross-org data in logs | RLS bypass | Escalate immediately |
| Unexpected service role usage | Credential theft | Rotate keys, investigate |
| Webhook failures spike | Attack or misconfiguration | Validate secrets |</p><p>#### Medium Confidence Indicators</p><p>| Indicator | Possible Incident | Action |
|-----------|-------------------|--------|
| Unusual login times/locations | Account compromise | Verify with user |
| High API request volume | DoS or scraping | Review rate limits |
| New admin user created | Privilege escalation | Audit user creation |
| Configuration changes | Unauthorized change | Verify with admins |</p><p><h3>Initial Triage Checklist</h3></p><p><pre><code class="markdown"><h2>Triage Checklist</h2></p><p><li>[ ] What was detected and when?</li>
<li>[ ] What systems are affected?</li>
<li>[ ] Is the attack ongoing?</li>
<li>[ ] What data may be exposed?</li>
<li>[ ] Are customers impacted?</li>
<li>[ ] What is the preliminary severity (P1-P4)?</li>
<li>[ ] Who needs to be notified?</li>
</code></pre></p><p>---</p><p><h2>Phase 2: Containment</h2></p><p><h3>Immediate Actions by Incident Type</h3></p><p>#### Credential Compromise</p><p><pre><code class="">1. Identify compromised credentials
<li>Revoke/rotate affected credentials:</li>
   - User password: Force password reset
   - API key: Regenerate in Supabase
   - Webhook secret: Regenerate + update integrations
   - Service role key: Contact Supabase support
<li>Invalidate active sessions</li>
<li>Block suspicious IPs (if identifiable)</li>
<li>Preserve logs for investigation</li>
</code></pre></p><p>#### Data Breach</p><p><pre><code class="">1. Identify scope of exposure
<li>If ongoing: Disable affected endpoints</li>
<li>Preserve evidence (logs, database state)</li>
<li>Document what data was accessed</li>
<li>Identify affected customers</li>
<li>Assess regulatory notification requirements</li>
</code></pre></p><p>#### DoS Attack</p><p><pre><code class="">1. Identify attack vector
<li>Enable enhanced rate limiting</li>
<li>Block attacking IPs/ranges</li>
<li>Scale infrastructure if possible</li>
<li>Monitor for attack pattern changes</li>
<li>Consider CDN-level mitigation</li>
</code></pre></p><p>#### RLS Bypass / Tenant Escape</p><p><pre><code class="">1. CRITICAL: Disable affected functionality immediately
<li>Identify all potentially affected queries</li>
<li>Audit logs for unauthorized access</li>
<li>Notify affected tenants</li>
<li>Preserve full database state for analysis</li>
<li>Review and fix RLS policies</li>
</code></pre></p><p><h3>Containment Commands</h3></p><p>#### Rotate Supabase Secrets</p><p><pre><code class="bash"><h1>API keys - via Supabase Dashboard</h1>
<h1>Settings â†’ API â†’ Regenerate Keys</h1></p><p><h1>JWT secret rotation - Contact Supabase Support</h1>
<h1>This invalidates ALL sessions</h1>
</code></pre></p><p>#### Block User Access</p><p><pre><code class="sql">-- Disable specific user (preserves data)
UPDATE auth.users
SET banned_until = 'infinity'
WHERE id = 'user-uuid-here';</p><p>-- Or delete session
DELETE FROM auth.sessions
WHERE user_id = 'user-uuid-here';
</code></pre></p><p>#### Emergency RLS Policy</p><p><pre><code class="sql">-- If RLS bypass suspected, add emergency deny-all
CREATE POLICY "emergency_lockdown"
ON affected_table
AS RESTRICTIVE
FOR ALL
USING (false);</p><p>-- Remember to drop after investigation
-- DROP POLICY "emergency_lockdown" ON affected_table;
</code></pre></p><p><h3>Evidence Preservation</h3></p><p>| Evidence | Collection Method | Retention |
|----------|------------------|-----------|
| Database logs | Supabase export | 90 days minimum |
| Edge function logs | Supabase export | 90 days minimum |
| Event logs table | Database backup | Permanent |
| Network logs | Supabase/CDN logs | As available |
| Timeline of actions | Incident document | Permanent |</p><p>---</p><p><h2>Phase 3: Eradication</h2></p><p><h3>Root Cause Analysis</h3></p><p><pre><code class="markdown"><h2>Root Cause Template</h2></p><p><li><strong>What happened?</strong></li>
   - Factual description of the incident</p><p><li><strong>How did it happen?</strong></li>
   - Attack vector or failure mode
   - Vulnerabilities exploited</p><p><li><strong>Why wasn't it prevented?</strong></li>
   - Control gaps
   - Detection failures</p><p><li><strong>What data/systems were affected?</strong></li>
   - Scope of impact
   - Customer impact</p><p><li><strong>Timeline of events</strong></li>
   - Detection time
   - Response time
   - Resolution time
</code></pre></p><p><h3>Remediation Checklist</h3></p><p><pre><code class="markdown"><h2>Remediation Checklist</h2></p><p><li>[ ] Vulnerability identified and understood</li>
<li>[ ] Fix developed and tested</li>
<li>[ ] Fix deployed to production</li>
<li>[ ] Verification that fix works</li>
<li>[ ] Similar vulnerabilities identified and fixed</li>
<li>[ ] Detection improved for future incidents</li>
<li>[ ] Credentials rotated (if applicable)</li>
<li>[ ] Affected users notified (if applicable)</li>
</code></pre></p><p><h3>Common Remediation Actions</h3></p><p>| Issue | Remediation |
|-------|-------------|
| Weak RLS policy | Rewrite policy, audit similar |
| Missing input validation | Add validation, review endpoints |
| Exposed credentials | Rotate all affected, add scanning |
| Missing rate limiting | Implement application-level limits |
| Insufficient logging | Add logging for blind spots |</p><p>---</p><p><h2>Phase 4: Recovery</h2></p><p><h3>Recovery Procedures</h3></p><p>#### Service Restoration</p><p><pre><code class="markdown">1. Verify eradication is complete
<li>Remove emergency controls (if applied)</li>
<li>Restore normal operations</li>
<li>Monitor for incident recurrence</li>
<li>Confirm functionality with smoke tests</li>
</code></pre></p><p>#### Customer Communication</p><p>| Scenario | Communication |
|----------|---------------|
| No customer impact | Internal documentation only |
| Service disruption | Status page update |
| Data exposure (specific users) | Direct notification to affected |
| Data breach (broad) | Public notification + regulatory |</p><p>#### Regulatory Notification</p><p>| Regulation | Notification Requirement | Timeline |
|------------|-------------------------|----------|
| GDPR | Data breach to supervisory authority | 72 hours |
| State laws (varies) | Consumer notification | Varies by state |
| Industry specific | Per contractual requirements | Per contract |</p><p><h3>Recovery Verification</h3></p><p><pre><code class="markdown"><h2>Recovery Checklist</h2></p><p><li>[ ] All affected systems restored</li>
<li>[ ] Monitoring confirms normal operation</li>
<li>[ ] No indicators of persistence</li>
<li>[ ] Customer impact resolved</li>
<li>[ ] Communications completed</li>
<li>[ ] Documentation updated</li>
</code></pre></p><p>---</p><p><h2>Phase 5: Postmortem</h2></p><p><h3>Postmortem Process</h3></p><p><pre><code class="">1. Schedule postmortem meeting (within 5 business days)
<li>Gather all timeline and evidence</li>
<li>Conduct blameless review</li>
<li>Document findings</li>
<li>Identify action items</li>
<li>Assign owners and deadlines</li>
<li>Share learnings (as appropriate)</li>
</code></pre></p><p><h3>Postmortem Template</h3></p><p><pre><code class="markdown"><h1>Security Incident Postmortem</h1></p><p><h2>Incident Summary</h2>
<li><strong>Date/Time:</strong></li>
<li><strong>Duration:</strong></li>
<li><strong>Severity:</strong></li>
<li><strong>Incident Commander:</strong></li></p><p><h2>What Happened</h2>
[Factual description]</p><p><h2>Timeline</h2>
| Time | Event |
|------|-------|
| | Detection |
| | Containment began |
| | Root cause identified |
| | Fix deployed |
| | Incident closed |</p><p><h2>Impact</h2>
<li><strong>Users Affected:</strong></li>
<li><strong>Data Exposed:</strong></li>
<li><strong>Service Downtime:</strong></li>
<li><strong>Financial Impact:</strong></li></p><p><h2>Root Cause</h2>
[Technical explanation]</p><p><h2>What Went Well</h2>
<li>[List positives]</li></p><p><h2>What Went Poorly</h2>
<li>[List improvements needed]</li></p><p><h2>Action Items</h2>
| Action | Owner | Due Date | Status |
|--------|-------|----------|--------|
| | | | |</p><p><h2>Lessons Learned</h2>
[Key takeaways]
</code></pre></p><p><h3>Action Item Tracking</h3></p><p>| Priority | Timeline | Example Actions |
|----------|----------|-----------------|
| Critical | 24 hours | Emergency patches, key rotation |
| High | 1 week | Security control additions |
| Medium | 1 month | Process improvements |
| Low | 1 quarter | Documentation updates |</p><p>---</p><p><h2>Communication Templates</h2></p><p><h3>Internal Escalation</h3></p><p><pre><code class="">SECURITY INCIDENT - [P1/P2/P3/P4]</p><p>What: [Brief description]
When: [Detection time]
Impact: [Current assessment]
Status: [Detection/Containment/Eradication/Recovery]</p><p>Next Steps:
<li>[Immediate actions]</li></p><p>Requested:
<li>[Any assistance needed]</li>
</code></pre></p><p><h3>Customer Notification (Data Breach)</h3></p><p><pre><code class="">Subject: Important Security Notice from FreshTrack Pro</p><p>Dear [Customer],</p><p>We are writing to inform you of a security incident that may
have affected your data.</p><p><strong>What Happened:</strong>
[Clear, factual description]</p><p><strong>What Information Was Involved:</strong>
[Specific data types]</p><p><strong>What We Are Doing:</strong>
[Remediation steps]</p><p><strong>What You Can Do:</strong>
[Recommended actions]</p><p><strong>For More Information:</strong>
[Contact details]</p><p>We apologize for this incident and are committed to protecting
your data. If you have questions, please contact [support].</p><p>Sincerely,
[Name]
FreshTrack Pro Security Team
</code></pre></p><p><h3>Status Page Update</h3></p><p><pre><code class="">[TIMESTAMP] - Investigating increased error rates
[TIMESTAMP] - Identified issue, implementing fix
[TIMESTAMP] - Fix deployed, monitoring
[TIMESTAMP] - Incident resolved, all systems normal
</code></pre></p><p>---</p><p><h2>Tabletop Exercises</h2></p><p><h3>Exercise Schedule</h3></p><p>| Exercise Type | Frequency | Participants |
|---------------|-----------|--------------|
| Tabletop scenario | Quarterly | Response team |
| Technical drill | Semi-annual | Engineering |
| Full simulation | Annual | All stakeholders |</p><p><h3>Sample Scenarios</h3></p><p><li><strong>Credential Stuffing Attack</strong></li>
   - Large volume of failed logins detected
   - Some accounts may be compromised
   - Practice: Detection, containment, communication</p><p><li><strong>RLS Policy Bypass</strong></li>
   - Customer reports seeing another org's data
   - Practice: Immediate containment, investigation</p><p><li><strong>Webhook Secret Exposure</strong></li>
   - TTN webhook secret found in public log
   - Practice: Rotation, impact assessment</p><p><li><strong>Ransomware Scenario</strong></li>
   - Supabase account access compromised
   - Practice: Escalation, recovery from backup</p><p>---</p><p><h2>Metrics and Improvement</h2></p><p><h3>Key Metrics</h3></p><p>| Metric | Target | Measurement |
|--------|--------|-------------|
| Mean Time to Detect (MTTD) | < 1 hour (P1) | Detection time - incident start |
| Mean Time to Contain (MTTC) | < 4 hours (P1) | Containment time - detection |
| Mean Time to Recover (MTTR) | < 24 hours (P1) | Recovery time - detection |
| Postmortem completion | 100% (P1-P2) | Days to complete |
| Action item closure | 90% on time | Per due date |</p><p><h3>Continuous Improvement</h3></p><p>After each incident:
<li>Update runbooks with lessons learned</li>
<li>Improve detection for similar incidents</li>
<li>Enhance automated response where possible</li>
<li>Train team on new procedures</li>
<li>Update this document as needed</li></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#security_overview">SECURITY_OVERVIEW.md</a> â€” High-level security architecture</li>
<li><a href="#auth_model">AUTH_MODEL.md</a> â€” Authentication and authorization</li>
<li><a href="#data_protection">DATA_PROTECTION.md</a> â€” Encryption and secrets</li>
<li><a href="#threat_model">THREAT_MODEL.md</a> â€” Threats and mitigations</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="operations-metrics_overview"></a></p><p><h1>Metrics Overview</h1></p><p><blockquote>Key system metrics and health indicators for FreshTrack Pro</blockquote></p><p>---</p><p><h2>Metric Categories</h2></p><p><h3>Overview</h3></p><p>| Category | What It Measures | Priority |
|----------|------------------|----------|
| <strong>System Health</strong> | Database, edge functions, infrastructure | Critical |
| <strong>Application Health</strong> | User operations, data processing | High |
| <strong>Integration Health</strong> | TTN, Stripe, notification delivery | High |
| <strong>Business Metrics</strong> | Sensors, alerts, readings | Medium |</p><p>---</p><p><h2>System Health Metrics</h2></p><p><h3>Database Metrics</h3></p><p>| Metric | Description | Healthy | Degraded | Unhealthy |
|--------|-------------|---------|----------|-----------|
| <strong>Query Latency</strong> | Time for standard queries | < 300ms | 300-500ms | > 500ms |
| <strong>RPC Latency</strong> | Time for function calls | < 500ms | 500-1000ms | > 1000ms |
| <strong>Connection Status</strong> | Database reachability | Connected | - | Unreachable |
| <strong>Table Availability</strong> | Critical tables accessible | All OK | Some degraded | Tables missing |</p><p>#### Critical Tables</p><p>These tables are checked during health checks:</p><p><pre><code class="">organizations    - Tenant configuration
sites            - Location data
units            - Refrigeration units
alerts           - Active alerts
lora_sensors     - IoT sensors
gateways         - LoRa gateways
sensor_readings  - Temperature data
ttn_connections  - TTN configuration
</code></pre></p><p>#### How to Check</p><p><pre><code class="bash"><h1>Via health check endpoint</h1>
curl https://your-project.supabase.co/functions/v1/health-check</p><p><h1>Response structure</h1>
{
  "status": "ok|degraded|error",
  "timestamp": "2026-01-12T12:00:00Z",
  "checks": {
    "database": { "status": "ok", "latency_ms": 45 },
    "tables": { "status": "ok", "checked": 8, "available": 8 }
  }
}
</code></pre></p><p>---</p><p><h3>Edge Function Metrics</h3></p><p>| Metric | Description | Source |
|--------|-------------|--------|
| <strong>Invocation Count</strong> | Number of function calls | Supabase Dashboard |
| <strong>Success Rate</strong> | Percentage of 2xx responses | Supabase Dashboard |
| <strong>Average Latency</strong> | Mean execution time | Supabase Dashboard |
| <strong>Error Rate</strong> | Percentage of 4xx/5xx | Supabase Dashboard |
| <strong>Cold Start Rate</strong> | First invocations after idle | Supabase Dashboard |</p><p>#### Critical Functions to Monitor</p><p>| Function | Criticality | Expected Latency | Notes |
|----------|-------------|------------------|-------|
| <code>ttn-webhook</code> | Critical | < 500ms | Data ingestion path |
| <code>process-unit-states</code> | Critical | < 2000ms | Alert processing |
| <code>process-escalations</code> | Critical | < 3000ms | Notification dispatch |
| <code>ingest-readings</code> | High | < 500ms | Sensor data processing |
| <code>health-check</code> | High | < 200ms | Monitoring endpoint |
| <code>stripe-webhook</code> | High | < 1000ms | Payment processing |</p><p>#### Function Health Check Status</p><p>The application checks 34 edge functions with these methods:</p><p>| Check Type | Description |
|------------|-------------|
| <code>GET</code> | Simple availability check |
| <code>POST</code> | Functions requiring request body |
| <code>skip</code> | Functions with side effects (webhooks, SMS) |</p><p>---</p><p><h3>Infrastructure Metrics</h3></p><p>| Metric | Description | Where to Find |
|--------|-------------|---------------|
| <strong>CDN Cache Hit Rate</strong> | Edge cache efficiency | Supabase/CDN dashboard |
| <strong>Bandwidth Usage</strong> | Data transfer volume | Supabase dashboard |
| <strong>Storage Usage</strong> | Database size | Supabase dashboard |
| <strong>Connection Pool</strong> | Active DB connections | Supabase dashboard |</p><p>---</p><p><h2>Application Health Indicators</h2></p><p><h3>Data Processing Metrics</h3></p><p>| Metric | Description | Healthy State |
|--------|-------------|---------------|
| <strong>Readings/Hour</strong> | Sensor data ingestion rate | Consistent with sensor count |
| <strong>Processing Lag</strong> | Time from reading to storage | < 30 seconds |
| <strong>Alert Creation Rate</strong> | New alerts per hour | Within normal variance |
| <strong>Alert Resolution Rate</strong> | Resolved alerts per hour | Matches creation rate |</p><p>#### Sensor Reading Flow</p><p><pre><code class="">Sensor â†’ TTN â†’ ttn-webhook â†’ sensor_readings table
                    â†“
              process-unit-states â†’ alerts table
                    â†“
              process-escalations â†’ notifications
</code></pre></p><p><h3>Unit Status Distribution</h3></p><p>Track the distribution of unit statuses:</p><p>| Status | Meaning | Normal Distribution |
|--------|---------|---------------------|
| <code>ok</code> | Normal operation | 85-95% |
| <code>excursion</code> | Unconfirmed temp issue | 0-5% |
| <code>alarm_active</code> | Confirmed alarm | 0-2% |
| <code>monitoring_interrupted</code> | No data received | 0-3% |
| <code>offline</code> | Extended no data | 0-5% |
| <code>manual_required</code> | Needs manual log | 0-10% |
| <code>restoring</code> | Recovering | 0-2% |</p><p><h3>Alert Metrics</h3></p><p>| Metric | Description | Target |
|--------|-------------|--------|
| <strong>Active Alerts</strong> | Currently unresolved | Minimize |
| <strong>MTTR</strong> | Mean time to resolution | < 30 min |
| <strong>Acknowledgment Rate</strong> | % acknowledged before escalation | > 80% |
| <strong>Escalation Rate</strong> | % requiring escalation | < 20% |</p><p>---</p><p><h2>Integration Health Metrics</h2></p><p><h3>TTN Integration</h3></p><p>| Metric | Description | Healthy State |
|--------|-------------|---------------|
| <strong>Webhook Success Rate</strong> | Valid payloads processed | > 99% |
| <strong>Device Match Rate</strong> | DevEUI matched to sensor | > 99% |
| <strong>Unknown Device Rate</strong> | Unmatched DevEUIs | < 1% |
| <strong>Provisioning Success</strong> | Devices registered to TTN | > 95% |</p><p>#### TTN Connection Status</p><p>Checked via <code>ttn_connections</code> table:</p><p><pre><code class="sql">SELECT
  organization_id,
  is_enabled,
  provisioning_status,
  ttn_region,
  ttn_application_id IS NOT NULL as has_app_id,
  updated_at
FROM ttn_connections
WHERE is_enabled = true;
</code></pre></p><p>| Status | Description |
|--------|-------------|
| <code>healthy</code> | Enabled + complete + has app ID |
| <code>degraded</code> | Enabled but incomplete config |
| <code>unhealthy</code> | Disabled or missing critical fields |</p><p><h3>Stripe Integration</h3></p><p>| Metric | Description | Healthy State |
|--------|-------------|---------------|
| <strong>Webhook Delivery</strong> | Stripe events received | 100% |
| <strong>Signature Validation</strong> | Valid signatures | 100% |
| <strong>Event Processing</strong> | Events handled successfully | > 99% |
| <strong>Subscription Sync</strong> | DB matches Stripe state | 100% |</p><p>#### Webhook Events Monitored</p><p><pre><code class="">checkout.session.completed     - New subscription
customer.subscription.updated  - Plan changes
invoice.payment_succeeded      - Successful payment
invoice.payment_failed         - Failed payment
</code></pre></p><p><h3>Notification Delivery</h3></p><p>| Metric | Description | Target |
|--------|-------------|--------|
| <strong>Email Delivery Rate</strong> | Emails successfully sent | > 99% |
| <strong>SMS Delivery Rate</strong> | SMS messages delivered | > 98% |
| <strong>Push Notification Rate</strong> | Push notifications sent | > 99% |
| <strong>Notification Latency</strong> | Time from trigger to delivery | < 60s |</p><p>---</p><p><h2>Sensor and Gateway Metrics</h2></p><p><h3>Sensor Health</h3></p><p>| Metric | Description | Warning Threshold |
|--------|-------------|-------------------|
| <strong>Active Sensors</strong> | Status = 'active' | Compare to expected |
| <strong>Offline Sensors</strong> | No reading > check-in interval | > 5% of total |
| <strong>Low Battery</strong> | Battery < 20% | Any sensors |
| <strong>Weak Signal</strong> | Signal < -100 dBm | > 10% of sensors |</p><p>#### Sensor Status Query</p><p><pre><code class="sql">SELECT
  status,
  COUNT(<em>) as count,
  ROUND(100.0 </em> COUNT(<em>) / SUM(COUNT(</em>)) OVER (), 2) as percentage
FROM lora_sensors
GROUP BY status;
</code></pre></p><p>| Status | Meaning |
|--------|---------|
| <code>pending</code> | Created, not provisioned |
| <code>joining</code> | Registered, awaiting join |
| <code>active</code> | Operating normally |
| <code>offline</code> | No recent data |
| <code>fault</code> | Hardware issue detected |</p><p><h3>Gateway Health</h3></p><p>| Metric | Description | Warning Threshold |
|--------|-------------|-------------------|
| <strong>Online Gateways</strong> | Status = 'online' | All expected online |
| <strong>Offline Gateways</strong> | No recent activity | Any offline |
| <strong>Coverage Gaps</strong> | Areas without gateway | Site-specific |</p><p>---</p><p><h2>Business Metrics</h2></p><p><h3>Operational KPIs</h3></p><p>| KPI | Description | How to Calculate |
|-----|-------------|------------------|
| <strong>Monitoring Uptime</strong> | % time sensors reporting | <code>(readings_received / expected_readings) <em> 100</code> |
| <strong>Alert Response Time</strong> | Time to acknowledge | <code>AVG(acknowledged_at - created_at)</code> |
| <strong>Compliance Rate</strong> | % readings in range | <code>(in_range_readings / total_readings) </em> 100</code> |
| <strong>Coverage</strong> | Units with active sensors | <code>(units_with_sensor / total_units) <em> 100</code> |</p><p><h3>Usage Metrics</h3></p><p>| Metric | Description |
|--------|-------------|
| <strong>Active Organizations</strong> | Orgs with recent activity |
| <strong>Active Users</strong> | Users logged in last 30 days |
| <strong>Total Sensors</strong> | Deployed sensor count |
| <strong>Daily Readings</strong> | Readings per day |
| <strong>Report Exports</strong> | Reports generated |</p><p>---</p><p><h2>Metric Collection Points</h2></p><p><h3>Current Implementation</h3></p><p>| Collection Point | Method | Data Captured |
|------------------|--------|---------------|
| Health Check Endpoint | <code>/functions/v1/health-check</code> | System status, latencies |
| Debug Logger | Client-side ring buffer | Operations, errors, timing |
| Event Logs Table | Database insert | Business events |
| Supabase Dashboard | Platform metrics | Function stats, errors |</p><p><h3>Recommended Additions</h3></p><p>| Metric | Recommended Tool | Purpose |
|--------|------------------|---------|
| APM traces | Sentry/DataDog | End-to-end timing |
| Custom metrics | Prometheus/Grafana | Business KPIs |
| Log aggregation | LogTail/Papertrail | Centralized logging |
| Uptime monitoring | BetterStack/Pingdom | External availability |</p><p>---</p><p><h2>Thresholds Summary</h2></p><p><h3>System Thresholds</h3></p><p>| Metric | Warning | Critical |
|--------|---------|----------|
| DB Query Latency | > 300ms | > 500ms |
| RPC Latency | > 500ms | > 1000ms |
| Edge Function Error Rate | > 1% | > 5% |
| Cold Start Rate | > 10% | > 25% |</p><p><h3>Integration Thresholds</h3></p><p>| Metric | Warning | Critical |
|--------|---------|----------|
| Webhook Success Rate | < 99% | < 95% |
| Device Match Rate | < 99% | < 95% |
| Notification Delivery | < 99% | < 95% |
| TTN Provisioning | < 95% | < 90% |</p><p><h3>Operational Thresholds</h3></p><p>| Metric | Warning | Critical |
|--------|---------|----------|
| Units in Alarm | > 5% | > 10% |
| Sensors Offline | > 5% | > 15% |
| Alert Acknowledgment | > 30 min | > 60 min |
| Processing Lag | > 30s | > 60s |</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#dashboards">DASHBOARDS.md</a> â€” Dashboard configuration and visualization</li>
<li><a href="#alerting">ALERTING.md</a> â€” Alert conditions and escalation</li>
<li><a href="#logging">LOGGING.md</a> â€” Log sources and debugging</li>
<li><a href="#runbooks">RUNBOOKS.md</a> â€” Operational procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="operations-dashboards"></a></p><p><h1>Dashboards</h1></p><p><blockquote>Monitoring dashboards and visualization for FreshTrack Pro</blockquote></p><p>---</p><p><h2>Dashboard Architecture</h2></p><p><h3>Metrics Flow Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Data Sources"
        S[Sensors/Gateways]
        TTN[TTN Network]
        STRIPE[Stripe]
        USERS[User Actions]
    end</p><p>    subgraph "Ingestion Layer"
        WH_TTN[ttn-webhook]
        WH_STRIPE[stripe-webhook]
        EF[Edge Functions]
    end</p><p>    subgraph "Storage Layer"
        DB[(PostgreSQL)]
        LOGS[Event Logs]
        METRICS[Debug Logs]
    end</p><p>    subgraph "Monitoring Layer"
        HC[Health Check]
        DT[Debug Terminal]
        SUPA[Supabase Dashboard]
    end</p><p>    subgraph "Dashboards"
        HD[Health Dashboard]
        INSP[Inspector]
        EVHIST[Event History]
        MAINT[Data Maintenance]
    end</p><p>    S --> TTN
    TTN --> WH_TTN
    STRIPE --> WH_STRIPE
    USERS --> EF</p><p>    WH_TTN --> DB
    WH_STRIPE --> DB
    EF --> DB
    EF --> LOGS
    EF --> METRICS</p><p>    DB --> HC
    DB --> HD
    LOGS --> EVHIST
    LOGS --> INSP
    METRICS --> DT</p><p>    HC --> HD
    HC --> SUPA
</code></pre></p><p>---</p><p><h2>Existing Dashboards</h2></p><p><h3>1. Health Dashboard</h3></p><p><strong>Location:</strong> <code>/admin/health</code>
<strong>Access:</strong> Admin users only
<strong>Component:</strong> <code>src/pages/HealthDashboard.tsx</code></p><p>#### What It Shows</p><p>| Section | Information | Update Frequency |
|---------|-------------|------------------|
| Overall Status | System health summary | 1 minute (auto-refresh) |
| Category Breakdown | Database, Edge Functions, TTN, Overall | 1 minute |
| Check List | Individual check results | 1 minute |
| Latency Display | Response times per check | Per check |</p><p>#### Visual Elements</p><p><li><strong>Status Badges:</strong> healthy (green), degraded (yellow), unhealthy (red), unknown (gray)</li>
<li><strong>Expandable Cards:</strong> Click to see check details</li>
<li><strong>Search/Filter:</strong> Find specific checks</li>
<li><strong>Sort Options:</strong> By status, name, or latency</li></p><p>#### Health Check Categories</p><p><pre><code class="">Database Checks
â”œâ”€â”€ Query Latency
â”œâ”€â”€ RPC Latency
â””â”€â”€ Table Availability</p><p>Edge Function Checks
â”œâ”€â”€ Critical Functions (flagged)
â””â”€â”€ Non-Critical Functions</p><p>TTN Integration
â”œâ”€â”€ Configuration Status
â”œâ”€â”€ Provisioning Status
â””â”€â”€ Application ID Check
</code></pre></p><p>#### Refresh Controls</p><p>| Control | Behavior |
|---------|----------|
| Auto-refresh | 1-minute interval (toggle) |
| Quick check | 5-minute interval for header badge |
| Manual refresh | Click to run all checks |</p><p>---</p><p><h3>2. Debug Terminal</h3></p><p><strong>Location:</strong> Bottom dock (when enabled)
<strong>Access:</strong> Users with debug mode enabled
<strong>Component:</strong> <code>src/components/debug/DebugTerminal.tsx</code></p><p>#### What It Shows</p><p>| Tab | Contents |
|-----|----------|
| <strong>Events</strong> | All logged events |
| <strong>CRUD</strong> | Database operations |
| <strong>Network</strong> | Edge function calls |
| <strong>Sync</strong> | Data synchronization |
| <strong>TTN</strong> | TTN-related operations |
| <strong>Errors</strong> | Error-level logs only |</p><p>#### Log Entry Details</p><p><pre><code class="">[timestamp] [level] [category] Message
â”œâ”€â”€ Duration: Xms (for operations)
â”œâ”€â”€ Entity: type/id
â”œâ”€â”€ Correlation ID: (for tracing)
â””â”€â”€ Payload: (expandable JSON)
</code></pre></p><p>#### Controls</p><p>| Control | Function |
|---------|----------|
| Pause/Resume | Stop/start log collection |
| Clear | Empty the log buffer |
| Auto-scroll | Follow new entries |
| Export JSON | Download full log |
| Support Snapshot | Redacted export for support |
| Filter | By level, category, search |</p><p>---</p><p><h3>3. Inspector (Audit Trail)</h3></p><p><strong>Location:</strong> <code>/inspector</code>
<strong>Access:</strong> Admin, Inspector roles
<strong>Component:</strong> <code>src/pages/Inspector.tsx</code></p><p>#### What It Shows</p><p>| Section | Information |
|---------|-------------|
| Temperature Logs | Manual and sensor readings |
| Exception Logs | Alerts, violations, issues |
| Corrective Actions | Responses to exceptions |
| Monitoring Gaps | Periods without data |</p><p>#### Filters Available</p><p><li>Date range</li>
<li>Site selection</li>
<li>Unit selection</li>
<li>Log type</li></p><p>#### Export Options</p><p><li>CSV export</li>
<li>PDF report generation</li></p><p>---</p><p><h3>4. Event History</h3></p><p><strong>Location:</strong> <code>/event-history</code> (or via admin menu)
<strong>Access:</strong> Admin users
<strong>Component:</strong> <code>src/pages/EventHistory.tsx</code></p><p>#### What It Shows</p><p>All business events from <code>event_logs</code> table:</p><p>| Event Category | Examples |
|----------------|----------|
| Device | sensor_paired, reading_received, device_offline |
| Alert | created, activated, acknowledged, resolved |
| Compliance | manual_temp_logged, excursion_started |
| Settings | unit_settings_updated, alert_rules_updated |
| Notification | sent, failed, delivered |
| TTN | settings.updated, .enabled, .tested |
| System | user_login, report_exported |</p><p>#### Display Features</p><p><li>Expandable event details</li>
<li>Actor identification (user/system)</li>
<li>Entity links (site, unit, sensor)</li>
<li>Severity badges</li>
<li>Pagination (50 per page)</li></p><p>---</p><p><h3>5. Data Maintenance</h3></p><p><strong>Location:</strong> <code>/admin/maintenance</code>
<strong>Access:</strong> Owner/Admin only
<strong>Component:</strong> <code>src/pages/DataMaintenance.tsx</code></p><p>#### What It Shows</p><p>| Section | Information |
|---------|-------------|
| Orphan Organizations | Orgs with no active users |
| Cleanup Jobs | Background job status |
| Data Integrity | Referential integrity checks |</p><p>#### Actions Available</p><p><li>Soft delete orphan orgs</li>
<li>View job history</li>
<li>Manual cleanup triggers</li></p><p>---</p><p><h2>Supabase Dashboard</h2></p><p><h3>Location</h3></p><p>Access via: https://supabase.com/dashboard/project/{project-id}</p><p><h3>Key Sections</h3></p><p>#### Database</p><p>| View | Information |
|------|-------------|
| Table Editor | Browse/edit data |
| SQL Editor | Run queries |
| Database Health | Connection stats |</p><p>#### Edge Functions</p><p>| View | Information |
|------|-------------|
| Function List | All deployed functions |
| Logs | Real-time function logs |
| Metrics | Invocations, latency, errors |</p><p>#### Authentication</p><p>| View | Information |
|------|-------------|
| Users | Registered users |
| Sessions | Active sessions |
| Logs | Auth events |</p><p>#### Storage</p><p>| View | Information |
|------|-------------|
| Buckets | File storage |
| Usage | Storage metrics |</p><p>---</p><p><h2>Recommended Dashboards</h2></p><p><h3>Operations Dashboard (To Build)</h3></p><p><strong>Purpose:</strong> Single pane for ops team</p><p><pre><code class="">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OPERATIONS DASHBOARD                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ System Health   â”‚ Alert Summary     â”‚ Integration Status    â”‚
â”‚ â— Database: OK  â”‚ Active: 5         â”‚ â— TTN: Healthy        â”‚
â”‚ â— Functions: OK â”‚ Unack: 2          â”‚ â— Stripe: Healthy     â”‚
â”‚ â— TTN: OK       â”‚ Critical: 1       â”‚ â— Email: Healthy      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Key Metrics (24h)                         â”‚
â”‚ Readings: 145,234 | Alerts: 23 | MTTR: 18min | Uptime: 99.9%â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Recent Events                             â”‚
â”‚ 12:34 - Alert resolved: Unit 42 temperature normal          â”‚
â”‚ 12:28 - Alert created: Unit 15 high temperature             â”‚
â”‚ 12:15 - Sensor offline: DEV-A1B2C3                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p>#### Recommended Implementation</p><p>| Component | Tool | Data Source |
|-----------|------|-------------|
| System Health | Health check API | <code>/functions/v1/health-check</code> |
| Alert Summary | Database query | <code>alerts</code> table |
| Integration Status | Health checks | TTN, Stripe checks |
| Key Metrics | Database queries | Aggregated data |
| Recent Events | Event logs | <code>event_logs</code> table |</p><p>---</p><p><h3>Customer Success Dashboard (To Build)</h3></p><p><strong>Purpose:</strong> Customer health and usage</p><p><pre><code class="">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CUSTOMER SUCCESS DASHBOARD                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Active Organizations: 127  â”‚  Active Users: 892             â”‚
â”‚ New This Month: 12         â”‚  Churn Risk: 3                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Engagement Metrics                                           â”‚
â”‚ Daily Active Users: 234                                      â”‚
â”‚ Reports Generated: 89 (last 7 days)                          â”‚
â”‚ Alerts Acknowledged: 95%                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Health Distribution                                          â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 89% Healthy                           â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 8% At Risk                            â”‚
â”‚ â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 3% Needs Attention                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p>---</p><p><h3>Integration Monitor (To Build)</h3></p><p><strong>Purpose:</strong> Track external service health</p><p><pre><code class="">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   INTEGRATION MONITOR                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TTN (The Things Network)                                     â”‚
â”‚ â”œâ”€â”€ Status: â— Online                                         â”‚
â”‚ â”œâ”€â”€ Webhooks/hour: 1,234                                     â”‚
â”‚ â”œâ”€â”€ Success rate: 99.8%                                      â”‚
â”‚ â””â”€â”€ Last received: 2 seconds ago                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stripe                                                       â”‚
â”‚ â”œâ”€â”€ Status: â— Online                                         â”‚
â”‚ â”œâ”€â”€ Events/day: 45                                           â”‚
â”‚ â”œâ”€â”€ Failed payments: 2                                       â”‚
â”‚ â””â”€â”€ Last webhook: 3 hours ago                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Notifications                                                â”‚
â”‚ â”œâ”€â”€ Email (Resend): â— Online | Sent today: 89                â”‚
â”‚ â”œâ”€â”€ SMS (Twilio): â— Online | Sent today: 12                  â”‚
â”‚ â””â”€â”€ Push: â— Online | Sent today: 234                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></p><p>---</p><p><h2>Dashboard Access Matrix</h2></p><p>| Dashboard | Owner | Admin | Manager | Staff | Viewer |
|-----------|:-----:|:-----:|:-------:|:-----:|:------:|
| Health Dashboard | âœ“ | âœ“ | - | - | - |
| Debug Terminal | âœ“ | âœ“ | âœ“ | - | - |
| Inspector | âœ“ | âœ“ | - | - | âœ“ |
| Event History | âœ“ | âœ“ | - | - | - |
| Data Maintenance | âœ“ | âœ“ | - | - | - |
| Supabase Dashboard | Infra team only | - | - | - | - |</p><p>---</p><p><h2>Dashboard URLs</h2></p><p><h3>Application Dashboards</h3></p><p>| Dashboard | URL Path |
|-----------|----------|
| Health Dashboard | <code>/admin/health</code> |
| Inspector | <code>/inspector</code> |
| Event History | <code>/event-history</code> |
| Data Maintenance | <code>/admin/maintenance</code> |</p><p><h3>External Dashboards</h3></p><p>| Dashboard | URL |
|-----------|-----|
| Supabase | <code>https://supabase.com/dashboard/project/{id}</code> |
| TTN Console | <code>https://eu1.cloud.thethings.network/console</code> |
| Stripe | <code>https://dashboard.stripe.com</code> |
| Resend | <code>https://resend.com/emails</code> |</p><p>---</p><p><h2>Monitoring Best Practices</h2></p><p><h3>Daily Checks</h3></p><p><li>Review Health Dashboard status</li>
<li>Check active alert count</li>
<li>Verify sensor online rate</li>
<li>Review any failed notifications</li></p><p><h3>Weekly Checks</h3></p><p><li>Review Event History for patterns</li>
<li>Check integration success rates</li>
<li>Review customer usage metrics</li>
<li>Check storage and database growth</li></p><p><h3>Monthly Checks</h3></p><p><li>Review overall system performance</li>
<li>Analyze alert trends</li>
<li>Review error rates and patterns</li>
<li>Capacity planning review</li></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#metrics_overview">METRICS_OVERVIEW.md</a> â€” Metric definitions and thresholds</li>
<li><a href="#alerting">ALERTING.md</a> â€” Alert conditions and escalation</li>
<li><a href="#logging">LOGGING.md</a> â€” Log sources and debugging</li>
<li><a href="#runbooks">RUNBOOKS.md</a> â€” Operational procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="operations-alerting"></a></p><p><h1>Alerting</h1></p><p><blockquote>Alert conditions, severity levels, and escalation paths</blockquote></p><p>---</p><p><h2>Alert Types Overview</h2></p><p><h3>Application Alerts (Customer-Facing)</h3></p><p>These are alerts visible to customers in the FreshTrack Pro application:</p><p>| Alert Type | Description | Severity |
|------------|-------------|----------|
| <code>temp_excursion</code> | Temperature outside safe range | Warning â†’ Critical |
| <code>temp_high</code> | Temperature above max threshold | Warning â†’ Critical |
| <code>temp_low</code> | Temperature below min threshold | Warning â†’ Critical |
| <code>monitoring_interrupted</code> | No readings received | Warning â†’ Critical |
| <code>door_open</code> | Door open too long | Warning |
| <code>low_battery</code> | Sensor battery low | Warning |
| <code>sensor_offline</code> | Sensor not reporting | Warning |
| <code>gateway_offline</code> | Gateway not reporting | Warning |</p><p><h3>System Alerts (Operations)</h3></p><p>These require operational attention:</p><p>| Alert Type | Description | Severity |
|------------|-------------|----------|
| Health check failure | System component unhealthy | Critical |
| High error rate | Edge function errors > threshold | High |
| Integration failure | TTN/Stripe/notification failure | High |
| Database latency | Query time > threshold | Medium |
| Capacity warning | Storage/connections nearing limit | Medium |</p><p>---</p><p><h2>Alert Lifecycle</h2></p><p><h3>State Diagram</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> Triggered: Condition detected
    Triggered --> Activated: Confirm time elapsed
    Activated --> Escalated: No acknowledgment
    Activated --> Acknowledged: User acknowledges
    Escalated --> Acknowledged: User acknowledges
    Acknowledged --> Resolved: Condition clears
    Activated --> Resolved: Condition clears (auto)
    Resolved --> [<em>]
</code></pre></p><p><h3>State Definitions</h3></p><p>| State | Description | Actions Available |
|-------|-------------|-------------------|
| <strong>Triggered</strong> | Condition detected, waiting confirm time | Auto-resolve if clears |
| <strong>Activated</strong> | Confirmed, notifications sent | Acknowledge, auto-resolve |
| <strong>Escalated</strong> | Escalation level increased | Acknowledge |
| <strong>Acknowledged</strong> | User has responded | Wait for resolution |
| <strong>Resolved</strong> | Condition cleared | View history |</p><p>---</p><p><h2>Severity Levels</h2></p><p><h3>Application Severity</h3></p><p>| Level | Color | Description | Example |
|-------|-------|-------------|---------|
| <strong>Critical</strong> | Red | Immediate action required | Temp > 45Â°F for >15min |
| <strong>Warning</strong> | Orange | Attention needed | Temp slightly out of range |
| <strong>Info</strong> | Blue | Informational | System status update |</p><p><h3>Operational Severity</h3></p><p>| Level | Response Time | Description |
|-------|---------------|-------------|
| <strong>P1 - Critical</strong> | < 15 minutes | Service down, data at risk |
| <strong>P2 - High</strong> | < 1 hour | Significant degradation |
| <strong>P3 - Medium</strong> | < 4 hours | Minor impact |
| <strong>P4 - Low</strong> | < 24 hours | Informational |</p><p>---</p><p><h2>Alert Conditions</h2></p><p><h3>Temperature Alerts</h3></p><p>#### High Temperature</p><p><pre><code class="">Condition:
  current_temp > max_threshold
  AND duration > confirm_time_minutes</p><p>Transitions:
  excursion â†’ alarm_active (after confirm time)
  alarm_active â†’ ok (when temp returns to range)
</code></pre></p><p>#### Low Temperature</p><p><pre><code class="">Condition:
  current_temp < min_threshold
  AND duration > confirm_time_minutes</p><p>Transitions:
  Same as high temperature
</code></pre></p><p>#### Confirm Time</p><p><li>Prevents false alarms from brief fluctuations</li>
<li>Default: 5 minutes (configurable per unit)</li>
<li>Range: 1-60 minutes</li></p><p><h3>Monitoring Alerts</h3></p><p>#### No Data Received</p><p><pre><code class="">Condition:
  last_reading_at < (now - check_in_interval - buffer)
  Buffer: 30 seconds</p><p>Unit Status:
  monitoring_interrupted (if critical)
  offline (if warning level)
</code></pre></p><p>#### Sensor Offline</p><p><pre><code class="">Condition:
  sensor.last_seen_at < (now - 2 </em> expected_interval)</p><p>Threshold:
  Expected interval: 5-15 minutes (sensor-dependent)
</code></pre></p><p><h3>Device Alerts</h3></p><p>#### Low Battery</p><p><pre><code class="">Condition:
  battery_level < 20%</p><p>Notification:
  Warning at 20%
  Critical at 10%
</code></pre></p><p>#### Door Open</p><p><pre><code class="">Condition:
  door_state = 'open'
  AND duration > door_grace_period</p><p>Grace Period:
  Default: 5 minutes (configurable)
</code></pre></p><p>---</p><p><h2>Escalation Paths</h2></p><p><h3>Customer Alert Escalation</h3></p><p><pre><code class="">Level 1 (Immediate)
â”œâ”€â”€ Primary notification contacts
â”œâ”€â”€ Channels: Email, SMS, Push
â””â”€â”€ Wait: escalation_delay minutes</p><p>Level 2 (After delay)
â”œâ”€â”€ Secondary/manager contacts
â”œâ”€â”€ Channels: Same as configured
â””â”€â”€ Wait: escalation_delay minutes</p><p>Level 3 (After 2x delay)
â”œâ”€â”€ Emergency/owner contacts
â”œâ”€â”€ Channels: All available
â””â”€â”€ Final level
</code></pre></p><p><h3>Escalation Configuration</h3></p><p>Stored in <code>notification_policies</code> table:</p><p>| Field | Description |
|-------|-------------|
| <code>escalation_delay_minutes</code> | Time before escalation |
| <code>escalation_contacts</code> | Contact IDs per level |
| <code>quiet_hours_start/end</code> | Suppress non-critical during hours |
| <code>channels</code> | email, sms, push |</p><p><h3>Operational Escalation</h3></p><p>| Level | Time | Contacts | Actions |
|-------|------|----------|---------|
| L1 | 0 min | On-call engineer | Investigate |
| L2 | 15 min | Engineering lead | Join investigation |
| L3 | 30 min | Engineering manager | Incident command |
| L4 | 60 min | CTO/Leadership | Executive awareness |</p><p>---</p><p><h2>Notification Channels</h2></p><p><h3>Email Notifications</h3></p><p><li><strong>Provider:</strong> Resend API</li>
<li><strong>Trigger:</strong> All alert levels</li>
<li><strong>Content:</strong> Alert details, unit info, action links</li>
<li><strong>Retry:</strong> 3 attempts with backoff</li></p><p><h3>SMS Notifications</h3></p><p><li><strong>Provider:</strong> Twilio</li>
<li><strong>Trigger:</strong> Critical alerts, escalations</li>
<li><strong>Content:</strong> Brief alert summary, call to action</li>
<li><strong>Retry:</strong> 3 attempts</li></p><p><h3>Push Notifications</h3></p><p><li><strong>Platform:</strong> Web push (PWA)</li>
<li><strong>Trigger:</strong> All alerts (if enabled)</li>
<li><strong>Content:</strong> Title and brief message</li>
<li><strong>Delivery:</strong> Best-effort</li></p><p><h3>Notification Status</h3></p><p>| Status | Description |
|--------|-------------|
| <code>queued</code> | Waiting to send |
| <code>sent</code> | Successfully dispatched |
| <code>delivered</code> | Confirmed delivery |
| <code>failed</code> | Delivery failed |
| <code>suppressed</code> | Quiet hours or disabled |</p><p>---</p><p><h2>Alert Processing</h2></p><p><h3>Process Flow</h3></p><p><pre><code class="mermaid">sequenceDiagram
    participant S as Sensor Reading
    participant P as process-unit-states
    participant DB as Database
    participant E as process-escalations
    participant N as Notification Service</p><p>    S->>P: New reading received
    P->>DB: Check alert rules
    P->>DB: Compare to thresholds</p><p>    alt Threshold exceeded
        P->>DB: Create/update alert
        P->>DB: Update unit status
        P->>E: Trigger escalation check
        E->>DB: Check notification policy
        E->>N: Send notifications
        N-->>E: Delivery status
        E->>DB: Log notification
    else Within range
        P->>DB: Resolve any active alert
        P->>DB: Update unit status to OK
    end
</code></pre></p><p><h3>Processing Functions</h3></p><p>| Function | Purpose | Trigger |
|----------|---------|---------|
| <code>process-unit-states</code> | Evaluate alerts, update status | After reading ingestion |
| <code>process-escalations</code> | Send notifications, escalate | Alert state changes |</p><p>---</p><p><h2>Operational Alerts (Recommended)</h2></p><p><h3>Current State</h3></p><p>FreshTrack Pro does not currently have automated operational alerting. Monitoring is through:
<li>Health Dashboard (manual check)</li>
<li>Supabase Dashboard (platform metrics)</li>
<li>Debug Terminal (application logs)</li></p><p><h3>Recommended Alerting Setup</h3></p><p>#### Integration with External Service</p><p>| Service | Use Case | Integration Method |
|---------|----------|-------------------|
| PagerDuty | On-call management | Webhook from health check |
| Opsgenie | Incident management | API integration |
| Slack | Team notifications | Webhook |
| Email | Backup notifications | SMTP |</p><p>#### Recommended Alert Rules</p><p>| Condition | Threshold | Severity |
|-----------|-----------|----------|
| Health check returns error | Any check failed | P2 |
| Health check returns degraded | >3 checks degraded | P3 |
| Edge function error rate | >5% in 5 minutes | P2 |
| Database latency | >500ms avg | P3 |
| TTN webhook failures | >10% in 1 hour | P2 |
| No readings received | 0 in 15 minutes | P1 |</p><p>#### Implementation Approach</p><p><pre><code class="javascript">// Recommended: Add to health-check function
if (overallStatus === 'error') {
  await fetch(process.env.PAGERDUTY_WEBHOOK, {
    method: 'POST',
    body: JSON.stringify({
      routing_key: process.env.PAGERDUTY_KEY,
      event_action: 'trigger',
      payload: {
        summary: 'FreshTrack Pro health check failed',
        severity: 'critical',
        source: 'health-check',
        custom_details: checkResults
      }
    })
  });
}
</code></pre></p><p>---</p><p><h2>Alert Configuration</h2></p><p><h3>Per-Organization Settings</h3></p><p>| Setting | Location | Description |
|---------|----------|-------------|
| Alert rules | <code>alert_rules</code> table | Thresholds per unit/site |
| Notification policy | <code>notification_policies</code> | Channels, contacts |
| Escalation contacts | <code>escalation_contacts</code> | Contact hierarchy |
| Quiet hours | <code>notification_policies</code> | Suppress timing |</p><p><h3>Default Thresholds</h3></p><p>| Unit Type | Min Temp | Max Temp | Confirm Time |
|-----------|----------|----------|--------------|
| Cooler | 33Â°F | 40Â°F | 5 min |
| Freezer | -10Â°F | 0Â°F | 5 min |
| Walk-in Cooler | 35Â°F | 41Â°F | 10 min |
| Prep Station | 35Â°F | 40Â°F | 5 min |</p><p><h3>Alert Rule Cascade</h3></p><p><pre><code class="">Organization Default
    â†“ (override)
Site Settings
    â†“ (override)
Unit Settings
</code></pre></p><p>Resolved via <code>get_effective_alert_rules</code> RPC.</p><p>---</p><p><h2>Silencing and Suppression</h2></p><p><h3>Quiet Hours</h3></p><p><li>Configurable per notification policy</li>
<li>Suppresses non-critical alerts</li>
<li>Critical alerts always sent</li>
<li>Logged as "suppressed" for audit</li></p><p><h3>Manual Suppression</h3></p><p>| Action | Effect | Duration |
|--------|--------|----------|
| Acknowledge alert | Stops escalation | Until resolved |
| Disable unit monitoring | No alerts | Until re-enabled |
| Contact opt-out | Skip contact | Permanent |</p><p><h3>Maintenance Windows</h3></p><p>Currently: Manual acknowledgment during maintenance
Recommended: Scheduled suppression windows (to implement)</p><p>---</p><p><h2>Alert Auditing</h2></p><p><h3>What's Logged</h3></p><p>| Event | Logged Data |
|-------|-------------|
| Alert created | Type, severity, unit, timestamp |
| Alert acknowledged | User, timestamp, note |
| Alert resolved | Timestamp, auto/manual |
| Notification sent | Channel, recipient, status |
| Escalation triggered | Level, contacts notified |</p><p><h3>Audit Queries</h3></p><p><pre><code class="sql">-- Recent alerts by organization
SELECT <em> FROM alerts
WHERE organization_id = ?
ORDER BY created_at DESC
LIMIT 50;</p><p>-- Alert response times
SELECT
  id,
  type,
  created_at,
  acknowledged_at,
  EXTRACT(EPOCH FROM (acknowledged_at - created_at))/60 as minutes_to_ack
FROM alerts
WHERE acknowledged_at IS NOT NULL
ORDER BY created_at DESC;</p><p>-- Escalated alerts
SELECT </em> FROM alerts
WHERE escalation_level > 0
ORDER BY created_at DESC;
</code></pre></p><p>---</p><p><h2>Troubleshooting Alerts</h2></p><p><h3>Alert Not Triggering</h3></p><p><li>Check alert rules exist for unit</li>
<li>Verify confirm time hasn't elapsed yet</li>
<li>Check <code>process-unit-states</code> function logs</li>
<li>Verify sensor is sending data</li></p><p><h3>Notification Not Received</h3></p><p><li>Check notification policy configuration</li>
<li>Verify contact has valid email/phone</li>
<li>Check <code>process-escalations</code> function logs</li>
<li>Check notification delivery status in DB</li>
<li>Verify not in quiet hours</li></p><p><h3>Alert Not Resolving</h3></p><p><li>Verify temperature returned to range</li>
<li>Check <code>process-unit-states</code> is running</li>
<li>Check for stale readings (sensor offline)</li>
<li>Manual resolution may be needed</li></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#metrics_overview">METRICS_OVERVIEW.md</a> â€” Metric definitions and thresholds</li>
<li><a href="#dashboards">DASHBOARDS.md</a> â€” Dashboard configuration</li>
<li><a href="#logging">LOGGING.md</a> â€” Log sources and debugging</li>
<li><a href="#runbooks">RUNBOOKS.md</a> â€” Operational procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="operations-logging"></a></p><p><h1>Logging</h1></p><p><blockquote>Log sources, formats, and debugging procedures</blockquote></p><p>---</p><p><h2>Log Sources Overview</h2></p><p><h3>Log Architecture</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Client Side"
        DL[Debug Logger<br/>Ring Buffer]
        EL[Event Logger<br/>UI Events]
    end</p><p>    subgraph "Server Side"
        EF[Edge Function Logs<br/>console.log]
        AU[Supabase Auth Logs]
    end</p><p>    subgraph "Database"
        EVT[(event_logs table)]
        SR[(sensor_readings)]
        AL[(alerts)]
    end</p><p>    subgraph "Viewing"
        DT[Debug Terminal]
        EH[Event History]
        INSP[Inspector]
        SUPA[Supabase Dashboard]
    end</p><p>    DL --> DT
    EL --> EVT
    EF --> SUPA
    AU --> SUPA
    EVT --> EH
    EVT --> INSP
    SR --> INSP
    AL --> INSP
</code></pre></p><p>---</p><p><h2>Client-Side Logging</h2></p><p><h3>Debug Logger</h3></p><p><strong>Location:</strong> <code>src/lib/debugLogger.ts</code>
<strong>Storage:</strong> In-memory ring buffer (5000 entries)</p><p>#### Log Levels</p><p>| Level | Color | Use Case |
|-------|-------|----------|
| <code>debug</code> | Gray | Verbose debugging |
| <code>info</code> | Blue | Normal operations |
| <code>warn</code> | Orange | Potential issues |
| <code>error</code> | Red | Errors and failures |</p><p>#### Log Categories</p><p>| Category | Description | Examples |
|----------|-------------|----------|
| <code>ui</code> | User interface events | Button clicks, navigation |
| <code>routing</code> | Route changes | Page transitions |
| <code>db</code> | Database operations | Queries, mutations |
| <code>sync</code> | Data synchronization | Offline sync, refresh |
| <code>ttn</code> | TTN operations | Provisioning, webhooks |
| <code>provisioning</code> | Device provisioning | Sensor/gateway setup |
| <code>edge</code> | Edge function calls | API requests |
| <code>network</code> | Network activity | Fetch, WebSocket |
| <code>auth</code> | Authentication | Login, logout, token |
| <code>crud</code> | CRUD operations | Create, update, delete |
| <code>realtime</code> | Real-time updates | Subscriptions |
| <code>mutation</code> | Data mutations | Form submissions |
| <code>query</code> | Data queries | Data fetching |</p><p>#### Using the Debug Logger</p><p><pre><code class="typescript">import { debugLog, startOperation, endOperation } from '@/lib/debugLogger';</p><p>// Simple log
debugLog.info('crud', 'Created new unit', { unitId, name });</p><p>// Operation tracking
const opId = startOperation('provisioning', 'Provisioning sensor');
try {
  await provisionSensor(sensor);
  endOperation(opId, 'success', { sensorId: sensor.id });
} catch (error) {
  endOperation(opId, 'error', { error: error.message });
}</p><p>// With correlation ID (for tracing related operations)
debugLog.info('ttn', 'Starting TTN sync', {
  correlationId: 'abc-123'
});
</code></pre></p><p>#### Automatic Redaction</p><p>The debug logger automatically redacts sensitive data:</p><p>| Field Pattern | Redaction |
|---------------|-----------|
| <code>api_key</code>, <code>apiKey</code> | <code>[REDACTED]</code> |
| <code>secret</code>, <code>password</code> | <code>[REDACTED]</code> |
| <code>token</code>, <code>authorization</code> | <code>[REDACTED]</code> |
| <code>private_key</code>, <code>credential</code> | <code>[REDACTED]</code> |
| <code>ttn_api_key_last4</code> | Shows last 4 only |
| <code>dev_eui</code>, <code>gateway_eui</code> | Shows last 4 only |</p><p>#### Exporting Logs</p><p><pre><code class="typescript">import { exportLogs, generateSnapshot } from '@/lib/debugLogger';</p><p>// Full JSON export
const jsonLogs = exportLogs();</p><p>// Support snapshot (safe for sharing)
const snapshot = generateSnapshot({
  focusTimestamp: errorTime,
  includeNetwork: true,
  maxLogs: 500
});
</code></pre></p><p>---</p><p><h3>Event Logger</h3></p><p><strong>Location:</strong> <code>src/lib/eventLogger.ts</code>
<strong>Storage:</strong> <code>event_logs</code> database table</p><p>#### Log Functions</p><p><pre><code class="typescript">// General event logging
logEvent({
  event_type: 'unit.settings_updated',
  category: 'settings',
  severity: 'info',
  title: 'Unit settings changed',
  site_id: unit.site_id,
  unit_id: unit.id,
  event_data: { changes: diff }
});</p><p>// Alert-specific logging
logAlertEvent(alert, 'acknowledged', userId, { note: 'Checking now' });</p><p>// Manual temperature logging
logManualTempEvent(unit, temperature, userId, { note: 'Visual check' });</p><p>// Settings change logging
logSettingsEvent('alert_rules', 'updated', userId, {
  before: oldRules,
  after: newRules
});
</code></pre></p><p>#### Event Types</p><p>| Type Pattern | Description |
|--------------|-------------|
| <code>sensor.<em></code> | Sensor events (paired, reading, offline) |
| <code>alert.</em></code> | Alert lifecycle (created, acknowledged, resolved) |
| <code>compliance.<em></code> | Compliance events (excursion, gap) |
| <code>settings.</em></code> | Configuration changes |
| <code>notification.<em></code> | Notification delivery |
| <code>ttn.</em></code> | TTN integration events |
| <code>system.<em></code> | System events (login, export) |</p><p>---</p><p><h2>Server-Side Logging</h2></p><p><h3>Edge Function Logging</h3></p><p>All edge functions use <code>console.log</code> with prefixes:</p><p><pre><code class="typescript">// Standard pattern
console.log('[ttn-webhook] Received uplink', {
  dev_eui: payload.end_device_ids.dev_eui
});</p><p>// Error logging
console.error('[ttn-webhook] Device not found', {
  dev_eui: normalizedEui
});</p><p>// Timing
const startTime = Date.now();
// ... operation ...
console.log('[process-unit-states] Completed', {
  duration_ms: Date.now() - startTime,
  units_processed: count
});
</code></pre></p><p><h3>Function Log Prefixes</h3></p><p>| Function | Prefix |
|----------|--------|
| <code>ttn-webhook</code> | <code>[ttn-webhook]</code> |
| <code>stripe-webhook</code> | <code>[stripe-webhook]</code> |
| <code>process-unit-states</code> | <code>[process-unit-states]</code> |
| <code>process-escalations</code> | <code>[process-escalations]</code> |
| <code>ingest-readings</code> | <code>[ingest-readings]</code> |
| <code>health-check</code> | <code>[health-check]</code> |</p><p><h3>Viewing Server Logs</h3></p><p>#### Supabase Dashboard</p><p><li>Navigate to Edge Functions</li>
<li>Select function</li>
<li>View "Logs" tab</li>
<li>Filter by time range</li></p><p>#### CLI Access</p><p><pre><code class="bash"><h1>Stream logs (requires Supabase CLI)</h1>
supabase functions logs ttn-webhook --follow</p><p><h1>View recent logs</h1>
supabase functions logs ttn-webhook --limit 100
</code></pre></p><p>---</p><p><h2>Database Logging</h2></p><p><h3>Event Logs Table</h3></p><p><strong>Table:</strong> <code>event_logs</code></p><p>| Column | Type | Description |
|--------|------|-------------|
| <code>id</code> | UUID | Primary key |
| <code>organization_id</code> | UUID | Tenant scope |
| <code>event_type</code> | TEXT | Event identifier |
| <code>category</code> | TEXT | Event category |
| <code>severity</code> | TEXT | info/warning/critical |
| <code>title</code> | TEXT | Human-readable title |
| <code>actor_id</code> | UUID | User who triggered |
| <code>actor_type</code> | TEXT | user/system |
| <code>site_id</code> | UUID | Related site |
| <code>area_id</code> | UUID | Related area |
| <code>unit_id</code> | UUID | Related unit |
| <code>event_data</code> | JSONB | Additional data |
| <code>ip_address</code> | INET | Client IP |
| <code>user_agent</code> | TEXT | Browser info |
| <code>previous_hash</code> | TEXT | Hash chain |
| <code>event_hash</code> | TEXT | Event hash |
| <code>created_at</code> | TIMESTAMPTZ | Timestamp |</p><p><h3>Query Examples</h3></p><p><pre><code class="sql">-- Recent events for an organization
SELECT </em> FROM event_logs
WHERE organization_id = 'org-uuid'
ORDER BY created_at DESC
LIMIT 50;</p><p>-- Events by type
SELECT <em> FROM event_logs
WHERE event_type LIKE 'alert.%'
ORDER BY created_at DESC;</p><p>-- Events by actor
SELECT </em> FROM event_logs
WHERE actor_id = 'user-uuid'
ORDER BY created_at DESC;</p><p>-- Events with search
SELECT <em> FROM event_logs
WHERE title ILIKE '%temperature%'
OR event_data::text ILIKE '%temperature%'
ORDER BY created_at DESC;
</code></pre></p><p>---</p><p><h2>Log Retention</h2></p><p><h3>Current Retention</h3></p><p>| Log Type | Retention | Location |
|----------|-----------|----------|
| Debug logs | Session only | Browser memory |
| Event logs | Permanent | Database |
| Edge function logs | 7 days | Supabase |
| Auth logs | 7 days | Supabase |</p><p><h3>Recommendations</h3></p><p>| Log Type | Recommended Retention | Reason |
|----------|----------------------|--------|
| Event logs | 2+ years | Compliance (HACCP) |
| Edge function logs | 30 days | Debugging |
| Auth logs | 90 days | Security |</p><p>---</p><p><h2>Debugging Procedures</h2></p><p><h3>Using the Debug Terminal</h3></p><p><li><strong>Enable Debug Mode</strong></li>
   - Press <code>Ctrl+Shift+D</code> or toggle in settings
   - Debug terminal appears at bottom</p><p><li><strong>Filter Logs</strong></li>
   - Use tabs: Events, CRUD, Network, Sync, TTN, Errors
   - Search by keyword
   - Filter by category or entity</p><p><li><strong>Trace Operations</strong></li>
   - Click correlation ID link to filter related
   - Expand entries to see full payload
   - Note duration for performance issues</p><p><li><strong>Export for Support</strong></li>
   - Click "Support Snapshot" button
   - Automatically redacts sensitive data
   - Share JSON with support team</p><p><h3>Debugging Common Issues</h3></p><p>#### No Sensor Readings</p><p><pre><code class="">1. Check TTN tab in Debug Terminal
<li>Look for webhook entries</li>
<li>If no entries:</li>
   - Check TTN Console for uplinks
   - Verify webhook URL in TTN
   - Check webhook secret matches
<li>If entries exist:</li>
   - Look for error messages
   - Check device matching logs
   - Verify DevEUI format
</code></pre></p><p>#### Alert Not Triggering</p><p><pre><code class="">1. Check DB tab for alert rule queries
<li>Verify rules returned for unit</li>
<li>Check Edge tab for process-unit-states calls</li>
<li>Look for evaluation logs</li>
<li>Check confirm time hasn't elapsed</li>
</code></pre></p><p>#### Notification Not Delivered</p><p><pre><code class="">1. Check event_logs for notification events
<li>Look for process-escalations logs</li>
<li>Verify contact configuration</li>
<li>Check for quiet hours suppression</li>
<li>Review notification delivery status</li>
</code></pre></p><p><h3>Edge Function Debugging</h3></p><p>#### View Logs in Supabase</p><p><li>Go to Supabase Dashboard</li>
<li>Navigate to Edge Functions</li>
<li>Select the function</li>
<li>Click "Logs" tab</li>
<li>Set time range</li>
<li>Search for relevant entries</li></p><p>#### Log Search Patterns</p><p><pre><code class=""><h1>Find webhook errors</h1>
[ttn-webhook] Error</p><p><h1>Find device matching</h1>
Device not found</p><p><h1>Find processing times</h1>
duration_ms</p><p><h1>Find specific device</h1>
DEV-EUI-HERE
</code></pre></p><p>---</p><p><h2>Support Snapshot</h2></p><p><h3>What's Included</h3></p><p><pre><code class="json">{
  "meta": {
    "version": "1.0.0",
    "environment": "production",
    "timestamp": "2026-01-12T12:00:00Z",
    "currentRoute": "/dashboard"
  },
  "user": {
    "emailDomain": "example.com",
    "organizationId": "org-uuid",
    "debugEnabled": true
  },
  "logs": {
    "entries": [...],  // Last 500 entries
    "totalCount": 1234
  },
  "network": {
    "recentCalls": [...]  // Last 50 edge calls
  },
  "domain": {
    "ttnConfig": {
      "cluster": "eu1",
      "hasAppId": true
    },
    "sensors": { "count": 25, "active": 23 },
    "gateways": { "count": 2, "online": 2 }
  }
}
</code></pre></p><p><h3>What's Redacted</h3></p><p><li>Full API keys (shows last4 only)</li>
<li>Full email addresses (shows domain only)</li>
<li>Password fields</li>
<li>Auth tokens</li>
<li>Session data</li></p><p><h3>Generating Snapshot</h3></p><p><pre><code class="typescript">// Via UI
// Click "Support Snapshot" in Debug Terminal</p><p>// Via code
import { generateSnapshot } from '@/lib/snapshotBuilder';</p><p>const snapshot = generateSnapshot({
  focusTimestamp: errorTimestamp,
  includeNetwork: true,
  maxLogs: 500,
  surroundingSeconds: 30
});
</code></pre></p><p>---</p><p><h2>Log Analysis</h2></p><p><h3>Performance Analysis</h3></p><p><pre><code class="typescript">// Find slow operations
const slowOps = logs.filter(log =>
  log.duration && log.duration > 1000
);</p><p>// Find error patterns
const errors = logs.filter(log =>
  log.level === 'error'
);</p><p>// Group by category
const byCategory = logs.reduce((acc, log) => {
  acc[log.category] = (acc[log.category] || 0) + 1;
  return acc;
}, {});
</code></pre></p><p><h3>Common Patterns to Watch</h3></p><p>| Pattern | Indicates |
|---------|-----------|
| Repeated <code>401</code> errors | Auth issues |
| High <code>duration_ms</code> values | Performance problems |
| <code>Device not found</code> | DevEUI mismatch |
| <code>RLS policy violation</code> | Permission issue |
| <code>Connection timeout</code> | Network problems |</p><p>---</p><p><h2>Best Practices</h2></p><p><h3>Logging Guidelines</h3></p><p><li><strong>Always use structured logging</strong></li>
   <pre><code class="typescript">   // Good
   console.log('[function] Event', { key: value });</p><p>   // Bad
   console.log('Something happened with ' + value);
   </code></pre></p><p><li><strong>Include context</strong></li>
   <pre><code class="typescript">   // Good
   console.log('[process] Completed', {
     duration_ms: Date.now() - start,
     items_processed: count,
     errors: errorCount
   });
   </code></pre></p><p><li><strong>Use appropriate levels</strong></li>
   - <code>debug</code>: Verbose, development only
   - <code>info</code>: Normal operations
   - <code>warn</code>: Potential issues
   - <code>error</code>: Failures</p><p><li><strong>Never log secrets</strong></li>
   <pre><code class="typescript">   // Good
   console.log('Using key ending in', key.slice(-4));</p><p>   // Bad
   console.log('API key:', apiKey);
   </code></pre></p><p><li><strong>Use correlation IDs for tracing</strong></li>
   <pre><code class="typescript">   const correlationId = crypto.randomUUID();
   debugLog.info('Starting operation', { correlationId });
   // ... pass correlationId through the operation
   </code></pre></p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#metrics_overview">METRICS_OVERVIEW.md</a> â€” Metric definitions and thresholds</li>
<li><a href="#dashboards">DASHBOARDS.md</a> â€” Dashboard configuration</li>
<li><a href="#alerting">ALERTING.md</a> â€” Alert conditions and escalation</li>
<li><a href="#runbooks">RUNBOOKS.md</a> â€” Operational procedures</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="operations-runbooks"></a></p><p><h1>Runbooks</h1></p><p><blockquote>Step-by-step operational procedures for common incidents</blockquote></p><p>---</p><p><h2>Runbook Index</h2></p><p>| ID | Runbook | Severity | Trigger |
|----|---------|----------|---------|
| RB-001 | <a href="#rb-001-health-check-failure">Health Check Failure</a> | P2 | Health dashboard red |
| RB-002 | <a href="#rb-002-ttn-webhook-not-receiving">TTN Webhook Not Receiving</a> | P1 | No sensor readings |
| RB-003 | <a href="#rb-003-sensor-offline">Sensor Offline</a> | P3 | Sensor status offline |
| RB-004 | <a href="#rb-004-gateway-offline">Gateway Offline</a> | P2 | Gateway not reporting |
| RB-005 | <a href="#rb-005-alert-processing-failure">Alert Processing Failure</a> | P1 | Alerts not triggering |
| RB-006 | <a href="#rb-006-notification-delivery-failure">Notification Delivery Failure</a> | P2 | Notifications not sent |
| RB-007 | <a href="#rb-007-database-latency-high">Database Latency High</a> | P3 | Slow queries |
| RB-008 | <a href="#rb-008-stripe-webhook-failure">Stripe Webhook Failure</a> | P2 | Payment issues |
| RB-009 | <a href="#rb-009-simulator-not-running">Simulator Not Running</a> | P4 | Test data not generating |
| RB-010 | <a href="#rb-010-user-cannot-login">User Cannot Login</a> | P3 | Auth failures |
| RB-011 | <a href="#rb-011-ttn-provisioning-failure">TTN Provisioning Failure</a> | P3 | Device registration fails |
| RB-012 | <a href="#rb-012-data-ingestion-backlog">Data Ingestion Backlog</a> | P2 | Processing delays |</p><p>---</p><p><h2>RB-001: Health Check Failure</h2></p><p><h3>Symptoms</h3>
<li>Health Dashboard shows red status</li>
<li><code>/functions/v1/health-check</code> returns error status</li>
<li>One or more checks failing</li></p><p><h3>Severity</h3>
P2 - High</p><p><h3>Initial Assessment</h3></p><p><pre><code class="bash"><h1>1. Check health endpoint directly</h1>
curl https://your-project.supabase.co/functions/v1/health-check</p><p><h1>2. Note which checks are failing</h1>
<h1>Response format:</h1>
{
  "status": "error",
  "checks": {
    "database": { "status": "error", "error": "..." },
    "tables": { "status": "ok" },
    ...
  }
}
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### If Database Check Failing</p><p><li>Check Supabase status page: https://status.supabase.com</li>
<li>Verify database is accessible via Supabase Dashboard</li>
<li>Check for connection pool exhaustion</li>
<li>If persistent, contact Supabase support</li></p><p>#### If Edge Function Check Failing</p><p><li>Check Supabase Edge Functions dashboard</li>
<li>Look for deployment errors</li>
<li>Check function logs for errors</li>
<li>Verify environment variables are set</li>
<li>Try redeploying the function:</li>
   <pre><code class="bash">   supabase functions deploy <function-name>
   </code></pre></p><p>#### If TTN Check Failing</p><p><li>Verify TTN connection is enabled</li>
<li>Check <code>ttn_connections</code> table for config</li>
<li>Validate TTN API key is still valid</li>
<li>See <a href="#rb-002-ttn-webhook-not-receiving">RB-002</a></li></p><p><h3>Escalation</h3>
<li>If unresolved after 15 minutes: Escalate to Engineering Lead</li>
<li>If affecting customer data: Escalate immediately</li></p><p>---</p><p><h2>RB-002: TTN Webhook Not Receiving</h2></p><p><h3>Symptoms</h3>
<li>No new sensor readings appearing</li>
<li><code>sensor_readings</code> table not updating</li>
<li>TTN Console shows uplinks but no delivery</li></p><p><h3>Severity</h3>
P1 - Critical (data not being collected)</p><p><h3>Diagnosis</h3></p><p><pre><code class="bash"><h1>1. Check TTN webhook logs</h1>
supabase functions logs ttn-webhook --limit 50</p><p><h1>2. Look for patterns:</h1>
<h1>- "Webhook received" = Reaching our endpoint</h1>
<h1>- "Unknown device" = DevEUI not matched</h1>
<h1>- "Invalid secret" = Auth failure</h1>
<h1>- No logs = Webhook not reaching us</h1>
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Verify TTN Configuration</p><p><li>Go to TTN Console â†’ Applications â†’ Integrations â†’ Webhooks</li>
<li>Verify webhook URL: <code>https://your-project.supabase.co/functions/v1/ttn-webhook</code></li>
<li>Check "Enabled" is true</li>
<li>Verify "Uplink message" is checked</li></p><p>#### Step 2: Verify Webhook Secret</p><p><pre><code class="sql">-- Get webhook secret (last 4 chars)
SELECT
  organization_id,
  ttn_application_id,
  ttn_webhook_secret_encrypted IS NOT NULL as has_secret,
  SUBSTRING(ttn_webhook_secret_encrypted FROM -4) as secret_last4
FROM ttn_connections
WHERE is_enabled = true;
</code></pre></p><p><li>Compare secret in TTN Console header configuration</li>
<li>Header name should be: <code>X-Webhook-Secret</code></li>
<li>If mismatch, update in TTN Console</li></p><p>#### Step 3: Test Webhook Manually</p><p><pre><code class="bash"><h1>Send test payload (replace values)</h1>
curl -X POST \
  https://your-project.supabase.co/functions/v1/ttn-webhook \
  -H "Content-Type: application/json" \
  -H "X-Webhook-Secret: your-secret-here" \
  -d '{
    "end_device_ids": {
      "device_id": "test-device",
      "dev_eui": "AABBCCDDEEFF0011"
    },
    "uplink_message": {
      "decoded_payload": {
        "temperature": 38.5
      }
    }
  }'
</code></pre></p><p>#### Step 4: Check Device Matching</p><p><pre><code class="sql">-- Find sensor by DevEUI
SELECT id, dev_eui, status, unit_id
FROM lora_sensors
WHERE UPPER(REPLACE(dev_eui, ':', '')) = 'AABBCCDDEEFF0011';
</code></pre></p><p>If not found:
<li>DevEUI may be formatted differently</li>
<li>Sensor may not be registered</li>
<li>Check both <code>lora_sensors</code> and legacy <code>devices</code> table</li></p><p><h3>Escalation</h3>
<li>Immediate if no data for >15 minutes across all orgs</li>
<li>Engineering Lead + on-call</li></p><p>---</p><p><h2>RB-003: Sensor Offline</h2></p><p><h3>Symptoms</h3>
<li>Sensor status shows "offline"</li>
<li>No recent readings from sensor</li>
<li>Customer reports unit not updating</li></p><p><h3>Severity</h3>
P3 - Medium</p><p><h3>Diagnosis</h3></p><p><pre><code class="sql">-- Check sensor status
SELECT
  id,
  dev_eui,
  status,
  last_seen_at,
  battery_level,
  signal_strength,
  NOW() - last_seen_at as time_since_seen
FROM lora_sensors
WHERE id = 'sensor-uuid';
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Verify Physical Device</p><p><li>Contact customer to verify:</li>
   - Sensor is powered on
   - Sensor LED indicates normal operation
   - Sensor is in range of gateway</p><p>#### Step 2: Check Gateway Status</p><p><pre><code class="sql">-- Find gateway for this org
SELECT id, name, status, last_seen_at
FROM gateways
WHERE organization_id = 'org-uuid';
</code></pre></p><p>If gateway offline, see <a href="#rb-004-gateway-offline">RB-004</a></p><p>#### Step 3: Check TTN Device Status</p><p><li>Go to TTN Console â†’ Applications â†’ Devices</li>
<li>Find device by DevEUI</li>
<li>Check "Last seen" timestamp</li>
<li>Check for join issues</li></p><p>#### Step 4: Force Rejoin (If Needed)</p><p><li>In TTN Console, delete device session keys</li>
<li>Power cycle physical sensor</li>
<li>Monitor for new join request</li></p><p><h3>Customer Communication</h3></p><p><pre><code class="">Subject: Sensor Status Update</p><p>We've identified that sensor [DEV_EUI_LAST4] appears to be
offline. This could be due to:</p><p><li>Low battery - Please check the sensor battery</li>
<li>Signal issues - Ensure the sensor is within range of the gateway</li>
<li>Physical issue - Try power cycling the sensor</li></p><p>If the issue persists after checking these items, please
contact support with the sensor location details.
</code></pre></p><p>---</p><p><h2>RB-004: Gateway Offline</h2></p><p><h3>Symptoms</h3>
<li>Gateway status shows "offline"</li>
<li>Multiple sensors behind gateway not reporting</li>
<li>TTN Console shows gateway disconnected</li></p><p><h3>Severity</h3>
P2 - High (affects multiple sensors)</p><p><h3>Diagnosis</h3></p><p><pre><code class="sql">-- Check gateway and related sensors
SELECT
  g.id,
  g.name,
  g.status,
  g.last_seen_at,
  COUNT(s.id) as sensor_count
FROM gateways g
LEFT JOIN lora_sensors s ON s.gateway_id = g.id
WHERE g.id = 'gateway-uuid'
GROUP BY g.id;
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Verify Physical Gateway</p><p>Contact customer to verify:
<li>Gateway is powered on</li>
<li>Network cable connected (if ethernet)</li>
<li>LED status indicates online</li></p><p>#### Step 2: Check TTN Console</p><p><li>Go to TTN Console â†’ Gateways</li>
<li>Find gateway by EUI</li>
<li>Check connection status</li>
<li>Review "Last seen" timestamp</li></p><p>#### Step 3: Network Troubleshooting</p><p><li>Verify internet connectivity at location</li>
<li>Check firewall rules (ports 1700 UDP, 8883 TCP)</li>
<li>Try power cycling gateway</li></p><p>#### Step 4: Re-register if Needed</p><p>If gateway won't reconnect:
<li>Delete from TTN Console</li>
<li>Re-provision via FreshTrack Pro</li>
<li>Factory reset physical gateway</li></p><p>---</p><p><h2>RB-005: Alert Processing Failure</h2></p><p><h3>Symptoms</h3>
<li>Temperature out of range but no alert</li>
<li><code>process-unit-states</code> not updating unit status</li>
<li>Alerts not being created</li></p><p><h3>Severity</h3>
P1 - Critical (safety-critical functionality)</p><p><h3>Diagnosis</h3></p><p><pre><code class="bash"><h1>Check function logs</h1>
supabase functions logs process-unit-states --limit 50</p><p><h1>Look for errors or processing messages</h1>
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Verify Function is Running</p><p><pre><code class="bash"><h1>Invoke manually (if scheduled via cron)</h1>
curl -X POST \
  https://your-project.supabase.co/functions/v1/process-unit-states \
  -H "Authorization: Bearer SERVICE_ROLE_KEY"
</code></pre></p><p>#### Step 2: Check Alert Rules</p><p><pre><code class="sql">-- Verify alert rules exist
SELECT </em>
FROM alert_rules
WHERE unit_id = 'unit-uuid'
OR site_id = (SELECT site_id FROM units WHERE id = 'unit-uuid')
OR organization_id = (SELECT organization_id FROM units WHERE id = 'unit-uuid');
</code></pre></p><p>#### Step 3: Check Unit Status</p><p><pre><code class="sql">-- Current unit state
SELECT
  id,
  name,
  status,
  last_temp_reading,
  last_reading_at,
  temp_min,
  temp_max
FROM units
WHERE id = 'unit-uuid';
</code></pre></p><p>#### Step 4: Force Processing</p><p><pre><code class="sql">-- Mark unit for reprocessing (triggers next cycle)
UPDATE units
SET status = 'pending_evaluation'
WHERE id = 'unit-uuid';
</code></pre></p><p><h3>Escalation</h3>
<li>Immediate to Engineering Lead</li>
<li>This is safety-critical functionality</li></p><p>---</p><p><h2>RB-006: Notification Delivery Failure</h2></p><p><h3>Symptoms</h3>
<li>Alerts triggered but no notifications sent</li>
<li>Customer reports not receiving emails/SMS</li>
<li>Notification status shows "failed"</li></p><p><h3>Severity</h3>
P2 - High</p><p><h3>Diagnosis</h3></p><p><pre><code class="bash"><h1>Check escalation function logs</h1>
supabase functions logs process-escalations --limit 50
</code></pre></p><p><pre><code class="sql">-- Check notification records
SELECT <em>
FROM notification_logs
WHERE alert_id = 'alert-uuid'
ORDER BY created_at DESC;
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Verify Notification Policy</p><p><pre><code class="sql">-- Check policy exists and is configured
SELECT </em>
FROM notification_policies
WHERE organization_id = 'org-uuid';
</code></pre></p><p>#### Step 2: Verify Contact Information</p><p><pre><code class="sql">-- Check escalation contacts
SELECT <em>
FROM escalation_contacts
WHERE organization_id = 'org-uuid'
AND escalation_level = 1;
</code></pre></p><p>#### Step 3: Check Email Service (Resend)</p><p><li>Login to Resend dashboard</li>
<li>Check for failed deliveries</li>
<li>Verify API key is valid</li>
<li>Check for sending limits</li></p><p>#### Step 4: Check SMS Service (Twilio)</p><p><li>Login to Twilio console</li>
<li>Check message logs</li>
<li>Verify account balance</li>
<li>Check for carrier blocks</li></p><p><h3>Manual Notification (If Urgent)</h3></p><p><pre><code class="bash"><h1>Send manual email via Resend API</h1>
curl -X POST https://api.resend.com/emails \
  -H "Authorization: Bearer RESEND_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "from": "alerts@freshtrackpro.com",
    "to": "customer@example.com",
    "subject": "Urgent: Temperature Alert",
    "text": "Unit X has exceeded temperature threshold..."
  }'
</code></pre></p><p>---</p><p><h2>RB-007: Database Latency High</h2></p><p><h3>Symptoms</h3>
<li>Health check shows degraded database</li>
<li>Slow page loads</li>
<li>Query timeouts</li></p><p><h3>Severity</h3>
P3 - Medium</p><p><h3>Diagnosis</h3></p><p><pre><code class="sql">-- Check active queries
SELECT
  pid,
  now() - pg_stat_activity.query_start AS duration,
  query,
  state
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) > interval '5 seconds';
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Identify Slow Queries</p><p><li>Go to Supabase Dashboard â†’ Database â†’ Query Performance</li>
<li>Sort by execution time</li>
<li>Identify patterns (missing indexes, full table scans)</li></p><p>#### Step 2: Check Connection Pool</p><p><li>Go to Database Settings â†’ Connection Pool</li>
<li>Check active connections vs limit</li>
<li>Consider increasing pool size temporarily</li></p><p>#### Step 3: Kill Long-Running Queries (If Needed)</p><p><pre><code class="sql">-- Kill specific query (use with caution)
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE pid = <pid-from-above>;
</code></pre></p><p>#### Step 4: Optimize</p><p><li>Add missing indexes</li>
<li>Optimize problematic queries</li>
<li>Consider query caching</li></p><p>---</p><p><h2>RB-008: Stripe Webhook Failure</h2></p><p><h3>Symptoms</h3>
<li>Payments not reflected in app</li>
<li>Subscription changes not syncing</li>
<li>Stripe Dashboard shows webhook failures</li></p><p><h3>Severity</h3>
P2 - High</p><p><h3>Diagnosis</h3></p><p><pre><code class="bash"><h1>Check webhook logs</h1>
supabase functions logs stripe-webhook --limit 50
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Check Webhook Configuration</p><p><li>Go to Stripe Dashboard â†’ Developers â†’ Webhooks</li>
<li>Verify endpoint URL</li>
<li>Check for failed events</li>
<li>Verify webhook signing secret</li></p><p>#### Step 2: Replay Failed Events</p><p><li>In Stripe Dashboard, find failed webhook</li>
<li>Click "Resend" to replay event</li>
<li>Monitor logs for processing</li></p><p>#### Step 3: Verify Webhook Secret</p><p><pre><code class="bash"><h1>Test with correct secret</h1>
curl -X POST \
  https://your-project.supabase.co/functions/v1/stripe-webhook \
  -H "stripe-signature: test" \
  -d '{...}'
</code></pre></p><p>#### Step 4: Manual Sync</p><p><pre><code class="sql">-- Update subscription manually if needed
UPDATE organizations
SET
  plan_tier = 'pro',
  sensor_limit = 25,
  subscription_status = 'active'
WHERE stripe_customer_id = 'cus_xxx';
</code></pre></p><p>---</p><p><h2>RB-009: Simulator Not Running</h2></p><p><h3>Symptoms</h3>
<li>Test sensors not generating data</li>
<li>Simulator status shows inactive</li>
<li>No synthetic readings</li></p><p><h3>Severity</h3>
P4 - Low (development/testing only)</p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Check Simulator Status</p><p><pre><code class="sql">-- Find active simulations
SELECT </em>
FROM sensor_simulations
WHERE status = 'streaming'
AND organization_id = 'org-uuid';
</code></pre></p><p>#### Step 2: Verify Scheduler</p><p>Check if <code>run-simulator-heartbeats</code> is scheduled:
<li>Check pg_cron configuration</li>
<li>Or verify external scheduler (if used)</li></p><p>#### Step 3: Manual Trigger</p><p><pre><code class="bash"><h1>Trigger heartbeat manually</h1>
curl -X POST \
  https://your-project.supabase.co/functions/v1/run-simulator-heartbeats \
  -H "Authorization: Bearer INTERNAL_API_KEY"
</code></pre></p><p>#### Step 4: Restart Simulation</p><p><pre><code class="sql">-- Reset and restart simulation
UPDATE sensor_simulations
SET
  status = 'streaming',
  next_reading_at = NOW()
WHERE id = 'simulation-uuid';
</code></pre></p><p>---</p><p><h2>RB-010: User Cannot Login</h2></p><p><h3>Symptoms</h3>
<li>User reports login failure</li>
<li>"Invalid credentials" error</li>
<li>Account locked</li></p><p><h3>Severity</h3>
P3 - Medium</p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Verify User Exists</p><p><pre><code class="sql">-- Check auth.users table
SELECT
  id,
  email,
  email_confirmed_at,
  banned_until,
  last_sign_in_at
FROM auth.users
WHERE email = 'user@example.com';
</code></pre></p><p>#### Step 2: Check for Ban</p><p>If <code>banned_until</code> is set:
<pre><code class="sql">-- Remove ban
UPDATE auth.users
SET banned_until = NULL
WHERE email = 'user@example.com';
</code></pre></p><p>#### Step 3: Reset Password</p><p><li>User should use "Forgot Password"</li>
<li>Or admin can trigger reset via Supabase Dashboard</li>
<li>Or via API:</li>
   <pre><code class="bash">   curl -X POST \
     https://your-project.supabase.co/auth/v1/recover \
     -H "apikey: ANON_KEY" \
     -H "Content-Type: application/json" \
     -d '{"email": "user@example.com"}'
   </code></pre></p><p>#### Step 4: Check Profile</p><p><pre><code class="sql">-- Verify profile exists
SELECT <em> FROM profiles
WHERE id = 'user-uuid';</p><p>-- Verify organization assignment
SELECT </em> FROM user_roles
WHERE user_id = 'user-uuid';
</code></pre></p><p>---</p><p><h2>RB-011: TTN Provisioning Failure</h2></p><p><h3>Symptoms</h3>
<li>Device/gateway provisioning fails</li>
<li>Error in provisioning UI</li>
<li>Device not appearing in TTN Console</li></p><p><h3>Severity</h3>
P3 - Medium</p><p><h3>Diagnosis</h3></p><p><pre><code class="bash"><h1>Check provisioning logs</h1>
supabase functions logs ttn-provision-device --limit 30
supabase functions logs ttn-provision-gateway --limit 30
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Verify TTN Configuration</p><p><pre><code class="sql">-- Check org TTN config
SELECT
  organization_id,
  is_enabled,
  ttn_region,
  ttn_application_id,
  provisioning_status
FROM ttn_connections
WHERE organization_id = 'org-uuid';
</code></pre></p><p>#### Step 2: Validate API Key</p><p>Run preflight check:
<pre><code class="bash">curl -X POST \
  https://your-project.supabase.co/functions/v1/ttn-gateway-preflight \
  -H "Authorization: Bearer USER_JWT" \
  -H "Content-Type: application/json" \
  -d '{"organization_id": "org-uuid"}'
</code></pre></p><p>#### Step 3: Check TTN Quotas</p><p><li>Go to TTN Console</li>
<li>Check application device limits</li>
<li>Check gateway limits</li></p><p>#### Step 4: Manual Registration</p><p>If automated fails:
<li>Register device manually in TTN Console</li>
<li>Update local database to match</li>
<li>Investigate automation failure</li></p><p>---</p><p><h2>RB-012: Data Ingestion Backlog</h2></p><p><h3>Symptoms</h3>
<li>Readings delayed</li>
<li>Processing queue growing</li>
<li>Dashboard showing stale data</li></p><p><h3>Severity</h3>
P2 - High</p><p><h3>Diagnosis</h3></p><p><pre><code class="sql">-- Check recent reading counts
SELECT
  DATE_TRUNC('minute', created_at) as minute,
  COUNT(<em>) as reading_count
FROM sensor_readings
WHERE created_at > NOW() - INTERVAL '1 hour'
GROUP BY 1
ORDER BY 1 DESC;
</code></pre></p><p><h3>Resolution Steps</h3></p><p>#### Step 1: Check Function Performance</p><p><pre><code class="bash"><h1>Look for slow processing</h1>
supabase functions logs ingest-readings --limit 50</p><p><h1>Check for timeouts</h1>
supabase functions logs process-unit-states --limit 50
</code></pre></p><p>#### Step 2: Scale if Possible</p><p>Contact Supabase support for:
<li>Increased function concurrency</li>
<li>Database performance tier</li></p><p>#### Step 3: Prioritize Critical Processing</p><p><pre><code class="sql">-- Focus on units with active alerts
UPDATE units
SET processing_priority = 'high'
WHERE status = 'alarm_active';
</code></pre></p><p>#### Step 4: Clear Backlog</p><p>May need to:
<li>Temporarily skip non-critical processing</li>
<li>Increase batch sizes</li>
<li>Add processing capacity</li></p><p>---</p><p><h2>Emergency Contacts</h2></p><p>| Role | Contact | When to Use |
|------|---------|-------------|
| On-Call Engineer | See PagerDuty/Opsgenie | P1-P2 incidents |
| Engineering Lead | See team directory | Escalation |
| Supabase Support | support@supabase.io | Platform issues |
| TTN Support | support@thethings.network | TTN issues |
| Stripe Support | Stripe Dashboard | Payment issues |</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#metrics_overview">METRICS_OVERVIEW.md</a> â€” Metric definitions and thresholds</li>
<li><a href="#dashboards">DASHBOARDS.md</a> â€” Dashboard configuration</li>
<li><a href="#alerting">ALERTING.md</a> â€” Alert conditions and escalation</li>
<li><a href="#logging">LOGGING.md</a> â€” Log sources and debugging</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="diagrams-system_context"></a></p><p><h1>System Context Diagram</h1></p><p><blockquote>High-level view of FreshTrack Pro and its external actors</blockquote></p><p>---</p><p><h2>C4 System Context</h2></p><p><pre><code class="mermaid">graph TB
    subgraph "External Users"
        FSM[Food Safety Manager]
        OM[Operations Manager]
        KS[Kitchen Staff]
        IT[IT Administrator]
    end</p><p>    subgraph "FreshTrack Pro System"
        FT[FreshTrack Pro<br/>Refrigeration Monitoring Platform]
    end</p><p>    subgraph "External Systems"
        TTN[The Things Network<br/>LoRaWAN Infrastructure]
        STRIPE[Stripe<br/>Payment Processing]
        TWILIO[Twilio<br/>SMS Delivery]
        EMAIL[Email Service<br/>Supabase SMTP]
    end</p><p>    subgraph "IoT Devices"
        SENSORS[LoRa Sensors<br/>Temperature/Humidity/Door]
        GATEWAYS[LoRa Gateways<br/>Network Access Points]
    end</p><p>    FSM -->|"Views dashboard,<br/>generates reports"| FT
    OM -->|"Configures policies,<br/>reviews trends"| FT
    KS -->|"Logs temperatures,<br/>acknowledges alerts"| FT
    IT -->|"Provisions sensors,<br/>configures TTN"| FT</p><p>    SENSORS -->|"LoRa radio"| GATEWAYS
    GATEWAYS -->|"HTTPS"| TTN
    TTN -->|"Webhook<br/>uplink data"| FT
    FT -->|"API calls<br/>device mgmt"| TTN</p><p>    FT -->|"Checkout,<br/>subscriptions"| STRIPE
    STRIPE -->|"Webhook<br/>events"| FT</p><p>    FT -->|"SMS alerts"| TWILIO
    FT -->|"Email alerts"| EMAIL
</code></pre></p><p>---</p><p><h2>Actor Descriptions</h2></p><p>| Actor | Description | Key Interactions |
|-------|-------------|------------------|
| Food Safety Manager | Strategic oversight of food safety | Dashboard, reports, policy configuration |
| Operations Manager | Facilities and equipment management | Trends, escalations, equipment health |
| Kitchen Staff | Day-to-day operations | Manual logging, alert acknowledgment |
| IT Administrator | Technical setup and maintenance | Sensor provisioning, TTN configuration |</p><p>---</p><p><h2>External System Descriptions</h2></p><p>| System | Purpose | Integration Type |
|--------|---------|------------------|
| The Things Network | LoRaWAN sensor network | Bidirectional API + Webhook |
| Stripe | Subscription billing | API + Webhook |
| Twilio | SMS alert delivery | Outbound API |
| Email (Supabase) | Email notifications | SMTP |</p><p>---</p><p><h2>Data Flow Summary</h2></p><p><h3>Inbound Data</h3></p><p><pre><code class="mermaid">flowchart LR
    S[Sensors] --> G[Gateways]
    G --> T[TTN]
    T -->|Webhook| F[FreshTrack Pro]
    U[Users] -->|Manual Logs| F
    ST[Stripe] -->|Payment Events| F
</code></pre></p><p><h3>Outbound Data</h3></p><p><pre><code class="mermaid">flowchart LR
    F[FreshTrack Pro] -->|Device Provisioning| T[TTN]
    F -->|SMS Alerts| TW[Twilio]
    F -->|Email Alerts| E[Email]
    F -->|Checkout| ST[Stripe]
</code></pre></p><p>---</p><p><h2>Security Boundaries</h2></p><p><pre><code class="mermaid">graph TB
    subgraph "Trust Boundary: Internet"
        U[Users]
        TTN[TTN]
        STRIPE[Stripe]
    end</p><p>    subgraph "Trust Boundary: Supabase"
        subgraph "Public Access"
            AUTH[Auth Service]
            ANON[Anon API]
        end</p><p>        subgraph "Protected Access"
            EDGE[Edge Functions]
            DB[(PostgreSQL)]
        end
    end</p><p>    U -->|"HTTPS + JWT"| AUTH
    U -->|"HTTPS + JWT"| ANON
    TTN -->|"Webhook + Secret"| EDGE
    STRIPE -->|"Webhook + Signature"| EDGE
    EDGE -->|"Service Role"| DB
    ANON -->|"RLS Policies"| DB
</code></pre></p><p>---</p><p><h2>Related Diagrams</h2></p><p><li><a href="#container_diagram">CONTAINER_DIAGRAM.md</a> - Internal container architecture</li>
<li><a href="#architecture-architecture">ARCHITECTURE.md</a> - Detailed architecture documentation</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="diagrams-container_diagram"></a></p><p><h1>Container Diagram</h1></p><p><blockquote>Internal container-level architecture of FreshTrack Pro</blockquote></p><p>---</p><p><h2>C4 Container Diagram</h2></p><p><pre><code class="mermaid">graph TB
    subgraph "Users"
        U[Users<br/>Web Browser/Mobile]
    end</p><p>    subgraph "Frontend Container"
        SPA[React SPA<br/>TypeScript, Vite<br/>Port 8080]
    end</p><p>    subgraph "Supabase Platform"
        subgraph "API Gateway"
            GW[Kong Gateway<br/>HTTPS, JWT Validation]
        end</p><p>        subgraph "Auth Container"
            AUTH[Supabase Auth<br/>GoTrue<br/>JWT, Sessions]
        end</p><p>        subgraph "Database Container"
            DB[(PostgreSQL 14.1<br/>60+ Tables<br/>RLS Policies)]
        end</p><p>        subgraph "Edge Functions Container"
            subgraph "Data Ingestion"
                TTN_WH[ttn-webhook]
                INGEST[ingest-readings]
                SIM[sensor-simulator]
            end</p><p>            subgraph "Alert Processing"
                PROC[process-unit-states<br/>SSOT: Alerts]
                ESC[process-escalations<br/>SSOT: Notifications]
            end</p><p>            subgraph "TTN Management"
                TTN_BOOT[ttn-bootstrap]
                TTN_PROV[ttn-provision-</em>]
            end</p><p>            subgraph "Billing"
                STR_CO[stripe-checkout]
                STR_WH[stripe-webhook]
            end</p><p>            subgraph "Utilities"
                SMS[send-sms-alert]
                HEALTH[health-check]
            end
        end</p><p>        subgraph "Storage"
            STOR[File Storage<br/>Photos, Exports]
        end
    end</p><p>    subgraph "External Services"
        TTN[The Things Network]
        STRIPE[Stripe]
        TWILIO[Twilio]
    end</p><p>    U -->|"HTTPS"| SPA
    SPA -->|"Supabase JS SDK"| GW
    SPA -->|"Auth"| AUTH
    GW --> DB
    GW --> AUTH</p><p>    TTN -->|"Webhook"| TTN_WH
    TTN_WH --> DB
    TTN_WH --> PROC
    PROC --> DB
    PROC --> ESC
    ESC --> SMS
    SMS --> TWILIO</p><p>    TTN_PROV --> TTN
    STR_CO --> STRIPE
    STRIPE --> STR_WH
    STR_WH --> DB
</code></pre></p><p>---</p><p><h2>Container Details</h2></p><p><h3>Frontend Container</h3></p><p>| Property | Value |
|----------|-------|
| Technology | React 18.3.1, TypeScript, Vite |
| Build | <code>npm run build</code> â†’ <code>dist/</code> |
| Hosting | Lovable platform (CDN) |
| Port | 8080 (development) |</p><p><strong>Responsibilities</strong>:
<li>User interface rendering</li>
<li>Client-side routing</li>
<li>Form handling and validation</li>
<li>Offline data caching (IndexedDB)</li>
<li>PWA functionality</li></p><p><h3>Auth Container</h3></p><p>| Property | Value |
|----------|-------|
| Technology | Supabase Auth (GoTrue) |
| Protocol | JWT (HS256) |
| Session | localStorage |</p><p><strong>Responsibilities</strong>:
<li>User authentication</li>
<li>Session management</li>
<li>Password reset</li>
<li>OAuth providers (if configured)</li></p><p><h3>Database Container</h3></p><p>| Property | Value |
|----------|-------|
| Technology | PostgreSQL 14.1 |
| Tables | 60+ |
| Access Control | Row-Level Security |</p><p><strong>Key Features</strong>:
<li>RLS policies for multi-tenancy</li>
<li>Database functions (RPC)</li>
<li>Triggers for event handling</li>
<li>Foreign key relationships</li></p><p><h3>Edge Functions Container</h3></p><p>| Property | Value |
|----------|-------|
| Runtime | Deno |
| Functions | 33 |
| Invocation | HTTP, Scheduled |</p><p><strong>Function Categories</strong>:</p><p><pre><code class="mermaid">pie title Edge Functions by Category
    "Data Ingestion" : 3
    "Alert Processing" : 2
    "TTN Management" : 12
    "User/Data Mgmt" : 6
    "Billing" : 3
    "Utilities" : 7
</code></pre></p><p>---</p><p><h2>Data Flow Patterns</h2></p><p><h3>Sensor Data Flow</h3></p><p><pre><code class="mermaid">sequenceDiagram
    participant S as Sensor
    participant G as Gateway
    participant T as TTN
    participant W as ttn-webhook
    participant D as Database
    participant P as process-unit-states
    participant E as process-escalations</p><p>    S->>G: LoRa transmission
    G->>T: Forward uplink
    T->>W: Webhook POST
    W->>D: Insert sensor_reading
    W->>D: Update unit state
    W->>P: Trigger processing
    P->>D: Evaluate thresholds
    P->>D: Create/resolve alerts
    P->>E: Trigger notifications
    E->>D: Record delivery
</code></pre></p><p><h3>User Request Flow</h3></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant S as SPA
    participant G as API Gateway
    participant A as Auth
    participant D as Database</p><p>    U->>S: Navigate to page
    S->>A: Get session
    A-->>S: JWT token
    S->>G: Query with JWT
    G->>A: Validate JWT
    A-->>G: User context
    G->>D: Query with RLS
    D-->>G: Filtered data
    G-->>S: Response
    S-->>U: Render page
</code></pre></p><p>---</p><p><h2>Container Communication</h2></p><p><h3>Protocols</h3></p><p>| From | To | Protocol | Auth |
|------|----|---------|----- |
| SPA | Gateway | HTTPS | JWT |
| SPA | Auth | HTTPS | API Key |
| TTN | ttn-webhook | HTTPS | Webhook Secret |
| Stripe | stripe-webhook | HTTPS | Signature |
| Edge â†’ Database | TCP | Service Role Key |
| Edge â†’ Twilio | HTTPS | API Credentials |
| Edge â†’ TTN | HTTPS | Org API Key |</p><p><h3>Internal Communication</h3></p><p><pre><code class="mermaid">flowchart LR
    subgraph "Edge Functions"
        A[ttn-webhook] -->|HTTP| B[process-unit-states]
        B -->|HTTP| C[process-escalations]
        C -->|HTTP| D[send-sms-alert]
    end
</code></pre></p><p>---</p><p><h2>Deployment Architecture</h2></p><p><pre><code class="mermaid">graph TB
    subgraph "CDN (Lovable)"
        SPA[React SPA<br/>Static Assets]
    end</p><p>    subgraph "Supabase Region"
        subgraph "Edge Network"
            EDGE[Edge Functions<br/>Deno Workers]
        end</p><p>        subgraph "Database Cluster"
            PRIMARY[(Primary<br/>PostgreSQL)]
            REPLICA[(Read Replica)]
        end</p><p>        AUTH[Auth Service]
        STOR[Storage]
    end</p><p>    SPA --> EDGE
    SPA --> AUTH
    EDGE --> PRIMARY
    SPA -.->|"Read queries"| REPLICA
</code></pre></p><p>---</p><p><h2>Scalability Considerations</h2></p><p>| Component | Scaling Method |
|-----------|----------------|
| SPA | CDN distribution |
| Edge Functions | Auto-scaling workers |
| Database | Vertical scaling, read replicas |
| Auth | Managed by Supabase |</p><p>---</p><p><h2>Related Diagrams</h2></p><p><li><a href="#system_context">SYSTEM_CONTEXT.md</a> - External context</li>
<li><a href="#charts-flowcharts">FLOWCHARTS.md</a> - Process flows</li>
<li><a href="#architecture-architecture">ARCHITECTURE.md</a> - Full documentation</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="diagrams-page_diagrams"></a></p><p><h1>Page Diagrams</h1></p><p><blockquote>Component and data flow diagrams for each application page</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#dashboard">Dashboard</a></li>
<li><a href="#unit-detail">Unit Detail</a></li>
<li><a href="#alerts">Alerts</a></li>
<li><a href="#settings">Settings</a></li>
<li><a href="#manual-log">Manual Log</a></li>
<li><a href="#reports">Reports</a></li>
<li><a href="#auth-page">Auth Page</a></li>
<li><a href="#site-detail">Site Detail</a></li>
<li><a href="#area-detail">Area Detail</a></li>
<li><a href="#health-dashboard">Health Dashboard</a></li>
<li><a href="#onboarding">Onboarding</a></li></p><p>---</p><p><h2>Dashboard</h2></p><p><strong>Route</strong>: <code>/dashboard</code>
<strong>File</strong>: <code>src/pages/Dashboard.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Dashboard Page"
        DL[DashboardLayout]</p><p>        subgraph "Header"
            NB[NavBar]
            ND[NotificationDropdown]
            TT[ThemeToggle]
        end</p><p>        subgraph "Sidebar"
            NL[NavLinks]
            BC[BrandedLogo]
        end</p><p>        subgraph "Main Content"
            BW[LowBatteryWidget]
            SL[Site List]</p><p>            subgraph "Site Section"
                SC[Site Card]
                AL[Area List]</p><p>                subgraph "Area Section"
                    AC[Area Card]
                    UG[Unit Grid]
                    UC[Unit Card]
                end
            end
        end
    end</p><p>    DL --> NB
    DL --> ND
    DL --> TT
    DL --> NL
    DL --> BC
    DL --> BW
    DL --> SL
    SL --> SC
    SC --> AL
    AL --> AC
    AC --> UG
    UG --> UC
</code></pre></p><p><h3>Data Flow</h3></p><p><pre><code class="mermaid">flowchart TB
    subgraph "Data Sources"
        ORG[organizations]
        SITES[sites]
        AREAS[areas]
        UNITS[units]
        ALERTS[alerts]
        SENSORS[lora_sensors]
    end</p><p>    subgraph "Hooks"
        UO[useOrganization]
        US[useSites]
        UA[useAreas]
        UU[useUnits]
        UAL[useAlerts]
        UUS[useUnitStatus]
    end</p><p>    subgraph "Components"
        DASH[Dashboard]
        UCARD[UnitCard]
    end</p><p>    ORG --> UO --> DASH
    SITES --> US --> DASH
    AREAS --> UA --> DASH
    UNITS --> UU --> DASH
    ALERTS --> UAL --> UCARD
    SENSORS --> UUS --> UCARD
</code></pre></p><p><h3>State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [<em>] --> Loading
    Loading --> Ready: Data loaded
    Loading --> NoOrg: No organization
    Loading --> Error: Load failed</p><p>    NoOrg --> [</em>]: Redirect to /onboarding</p><p>    Ready --> Ready: Poll refresh
    Ready --> Navigating: Click unit</p><p>    Navigating --> [<em>]: Go to unit detail</p><p>    Error --> Loading: Retry
</code></pre></p><p>---</p><p><h2>Unit Detail</h2></p><p><strong>Route</strong>: <code>/units/:unitId</code>
<strong>File</strong>: <code>src/pages/UnitDetail.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Unit Detail Page"
        UD[UnitDetail]</p><p>        subgraph "Header Section"
            HB[HierarchyBreadcrumb]
            SB[StatusBadge]
            LTB[LogTempButton]
        end</p><p>        subgraph "Alert Section"
            UAB[UnitAlertsBanner]
        end</p><p>        subgraph "Status Cards"
            LKG[LastKnownGoodCard]
            BH[BatteryHealthCard]
            DR[DeviceReadinessCard]
        end</p><p>        subgraph "Sensors Section"
            USC[UnitSensorsCard]
            SDP[SensorDetailsPopover]
            ASD[AssignSensorToUnitDialog]
        end</p><p>        subgraph "Settings Section"
            UATS[UnitAlertThresholdsSection]
            USS[UnitSettingsSection]
        end</p><p>        subgraph "Charts"
            TC[TemperatureChart]
        end
    end</p><p>    UD --> HB
    UD --> SB
    UD --> LTB
    UD --> UAB
    UD --> LKG
    UD --> BH
    UD --> DR
    UD --> USC
    USC --> SDP
    USC --> ASD
    UD --> UATS
    UD --> USS
    UD --> TC
</code></pre></p><p><h3>Data Flow</h3></p><p><pre><code class="mermaid">flowchart TB
    subgraph "API Calls"
        U[units/:id]
        S[lora_sensors]
        R[sensor_readings]
        A[alerts]
        AR[get_effective_alert_rules]
    end</p><p>    subgraph "State"
        UNIT[Unit Data]
        SENS[Sensors]
        READ[Readings]
        ALR[Alerts]
        RULES[Alert Rules]
    end</p><p>    subgraph "Computed"
        STATUS[Unit Status]
        CHART[Chart Data]
    end</p><p>    U --> UNIT
    S --> SENS
    R --> READ
    A --> ALR
    AR --> RULES</p><p>    UNIT --> STATUS
    READ --> STATUS
    ALR --> STATUS
    RULES --> STATUS</p><p>    READ --> CHART
</code></pre></p><p><h3>State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> Loading
    Loading --> Ready: Unit loaded
    Loading --> NotFound: 404</p><p>    Ready --> AlertVisible: Has active alerts
    AlertVisible --> Ready: All resolved</p><p>    Ready --> Editing: Open settings
    Editing --> Saving: Submit
    Saving --> Ready: Success
    Saving --> Editing: Error</p><p>    Ready --> LoggingTemp: Open modal
    LoggingTemp --> Ready: Submit/Cancel
</code></pre></p><p>---</p><p><h2>Alerts</h2></p><p><strong>Route</strong>: <code>/alerts</code>
<strong>File</strong>: <code>src/pages/Alerts.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Alerts Page"
        AP[Alerts]</p><p>        subgraph "Filters"
            SF[StatusFilter]
            SEV[SeverityFilter]
            TF[TypeFilter]
            DR[DateRange]
        end</p><p>        subgraph "Alert List"
            AT[AlertTable]
            AR[AlertRow]
        end</p><p>        subgraph "Actions"
            ACK[AcknowledgeButton]
            RES[ResolveButton]
            VU[ViewUnitLink]
        end
    end</p><p>    AP --> SF
    AP --> SEV
    AP --> TF
    AP --> DR
    AP --> AT
    AT --> AR
    AR --> ACK
    AR --> RES
    AR --> VU
</code></pre></p><p><h3>State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [<em>] --> Loading
    Loading --> Empty: No alerts
    Loading --> Ready: Alerts loaded</p><p>    Ready --> Filtering: Apply filter
    Filtering --> Ready: Results</p><p>    Ready --> Acknowledging: Click acknowledge
    Acknowledging --> Ready: Success</p><p>    Ready --> Resolving: Click resolve
    Resolving --> Ready: Success
</code></pre></p><p>---</p><p><h2>Settings</h2></p><p><strong>Route</strong>: <code>/settings</code>
<strong>File</strong>: <code>src/pages/Settings.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Settings Page"
        SP[Settings]</p><p>        subgraph "Tabs"
            GT[General Tab]
            ART[Alert Rules Tab]
            NPT[Notification Policies Tab]
            ST[Sensors Tab]
            GWT[Gateways Tab]
            TTNT[TTN Tab]
            BT[Billing Tab]
            AT[Account Tab]
        end</p><p>        subgraph "Alert Rules Components"
            ARE[AlertRulesEditor]
            ARSE[AlertRulesScopedEditor]
            ARH[AlertRulesHistoryModal]
        end</p><p>        subgraph "Sensor Components"
            SM[SensorManager]
            ASD[AddSensorDialog]
            ESD[EditSensorDialog]
        end</p><p>        subgraph "Gateway Components"
            GM[GatewayManager]
            AGD[AddGatewayDialog]
            EGD[EditGatewayDialog]
        end</p><p>        subgraph "TTN Components"
            TTNCS[TTNConnectionSettings]
            TTNCP[TTNCredentialsPanel]
            TTNPL[TTNProvisioningLogs]
        end</p><p>        subgraph "Billing Components"
            BTB[BillingTab]
            PC[PlanCard]
            IH[InvoiceHistory]
        end
    end</p><p>    SP --> GT
    SP --> ART --> ARE
    ART --> ARSE
    ART --> ARH
    SP --> NPT
    SP --> ST --> SM
    SM --> ASD
    SM --> ESD
    SP --> GWT --> GM
    GM --> AGD
    GM --> EGD
    SP --> TTNT --> TTNCS
    TTNCS --> TTNCP
    TTNCS --> TTNPL
    SP --> BT --> BTB
    BTB --> PC
    BTB --> IH
    SP --> AT
</code></pre></p><p><h3>State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> Loading
    Loading --> Ready: Settings loaded</p><p>    Ready --> Editing: Modify setting
    Editing --> Saving: Submit
    Saving --> Ready: Success
    Saving --> Editing: Error</p><p>    Ready --> TabSwitch: Change tab
    TabSwitch --> Ready: Tab loaded
</code></pre></p><p>---</p><p><h2>Manual Log</h2></p><p><strong>Route</strong>: <code>/manual-log</code>
<strong>File</strong>: <code>src/pages/ManualLog.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Manual Log Page"
        ML[ManualLog]</p><p>        subgraph "Unit Selector"
            SS[SiteSelect]
            AS[AreaSelect]
            US[UnitSelect]
        end</p><p>        subgraph "Log Form"
            TI[TemperatureInput]
            NI[NotesInput]
            SB[SubmitButton]
        end</p><p>        subgraph "Status"
            OI[OfflineIndicator]
            QC[QueueCount]
        end
    end</p><p>    ML --> SS
    SS --> AS
    AS --> US
    ML --> TI
    ML --> NI
    ML --> SB
    ML --> OI
    ML --> QC
</code></pre></p><p><h3>State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [<em>] --> SelectUnit
    SelectUnit --> EnterTemp: Unit selected</p><p>    EnterTemp --> Validating: Submit
    Validating --> Submitting: Valid
    Validating --> EnterTemp: Invalid</p><p>    Submitting --> Success: Online + Success
    Submitting --> Queued: Offline
    Submitting --> EnterTemp: Error</p><p>    Success --> SelectUnit: Clear form
    Queued --> SelectUnit: Clear form</p><p>    state Offline {
        Queued --> Syncing: Online
        Syncing --> Synced: Success
    }
</code></pre></p><p>---</p><p><h2>Reports</h2></p><p><strong>Route</strong>: <code>/reports</code>
<strong>File</strong>: <code>src/pages/Reports.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Reports Page"
        RP[Reports]</p><p>        subgraph "Report Selection"
            RT[ReportType]
            DR[DateRange]
            UF[UnitFilter]
        end</p><p>        subgraph "Report Display"
            CRC[ComplianceReportCard]
            RP2[ReportPreview]
        end</p><p>        subgraph "Export"
            EP[ExportPDF]
            EC[ExportCSV]
        end
    end</p><p>    RP --> RT
    RP --> DR
    RP --> UF
    RP --> CRC
    RP --> RP2
    RP --> EP
    RP --> EC
</code></pre></p><p>---</p><p><h2>Auth Page</h2></p><p><strong>Route</strong>: <code>/auth</code>
<strong>File</strong>: <code>src/pages/Auth.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Auth Page"
        AP[Auth]</p><p>        subgraph "Tabs"
            SI[SignIn Form]
            SU[SignUp Form]
        end</p><p>        subgraph "Form Fields"
            EI[EmailInput]
            PI[PasswordInput]
            PR[PasswordRequirements]
        end</p><p>        subgraph "Actions"
            SB[SubmitButton]
            FR[ForgotPassword]
        end
    end</p><p>    AP --> SI
    AP --> SU
    SI --> EI
    SI --> PI
    SU --> EI
    SU --> PI
    SU --> PR
    SI --> SB
    SU --> SB
    SI --> FR
</code></pre></p><p><h3>State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> Idle</p><p>    Idle --> Submitting: Submit
    Submitting --> Success: Valid credentials
    Submitting --> Error: Invalid</p><p>    Success --> [<em>]: Redirect
    Error --> Idle: Clear error
</code></pre></p><p>---</p><p><h2>Site Detail</h2></p><p><strong>Route</strong>: <code>/sites/:siteId</code>
<strong>File</strong>: <code>src/pages/SiteDetail.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Site Detail Page"
        SD[SiteDetail]</p><p>        subgraph "Header"
            HB[HierarchyBreadcrumb]
            SN[SiteName]
            SA[SiteAddress]
        end</p><p>        subgraph "Content"
            AL[AreaList]
            AC[AreaCard]
            UL[UnitList]
        end</p><p>        subgraph "Settings"
            SCS[SiteComplianceSettings]
            SGC[SiteGatewaysCard]
        end
    end</p><p>    SD --> HB
    SD --> SN
    SD --> SA
    SD --> AL
    AL --> AC
    AC --> UL
    SD --> SCS
    SD --> SGC
</code></pre></p><p>---</p><p><h2>Area Detail</h2></p><p><strong>Route</strong>: <code>/sites/:siteId/areas/:areaId</code>
<strong>File</strong>: <code>src/pages/AreaDetail.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Area Detail Page"
        AD[AreaDetail]</p><p>        subgraph "Header"
            HB[HierarchyBreadcrumb]
            AN[AreaName]
        end</p><p>        subgraph "Units"
            UG[UnitGrid]
            UC[UnitCard]
            AU[AddUnitButton]
        end
    end</p><p>    AD --> HB
    AD --> AN
    AD --> UG
    UG --> UC
    AD --> AU
</code></pre></p><p>---</p><p><h2>Health Dashboard</h2></p><p><strong>Route</strong>: <code>/admin/health</code>
<strong>File</strong>: <code>src/pages/HealthDashboard.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Health Dashboard"
        HD[HealthDashboard]</p><p>        subgraph "Summary"
            OHS[OverallHealthSummary]
        end</p><p>        subgraph "Checks"
            HCL[HealthCheckList]
            HSC[HealthStatusCard]
            HSB[HealthStatusBadge]
        end
    end</p><p>    HD --> OHS
    HD --> HCL
    HCL --> HSC
    HSC --> HSB
</code></pre></p><p>---</p><p><h2>Onboarding</h2></p><p><strong>Route</strong>: <code>/onboarding</code>
<strong>File</strong>: <code>src/pages/Onboarding.tsx</code></p><p><h3>Component Diagram</h3></p><p><pre><code class="mermaid">graph TB
    subgraph "Onboarding Page"
        OB[Onboarding]</p><p>        subgraph "Steps"
            S1[Step 1: Organization]
            S2[Step 2: Site]
            S3[Step 3: Area]
            S4[Step 4: Unit]
            S5[Step 5: Sensor]
        end</p><p>        subgraph "Progress"
            PI[ProgressIndicator]
        end
    end</p><p>    OB --> PI
    OB --> S1
    S1 --> S2
    S2 --> S3
    S3 --> S4
    S4 --> S5
</code></pre></p><p><h3>State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> Step1_Org
    Step1_Org --> Step2_Site: Submit
    Step2_Site --> Step3_Area: Submit
    Step3_Area --> Step4_Unit: Submit
    Step4_Unit --> Step5_Sensor: Submit
    Step5_Sensor --> Complete: Skip/Submit
    Complete --> [<em>]: Redirect to dashboard
</code></pre></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#product-pages">PAGES.md</a> - Full page documentation</li>
<li><a href="#product-user_flows">USER_FLOWS.md</a> - User flow documentation</li>
<li><a href="#state_machines">STATE_MACHINES.md</a> - State machine details</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="diagrams-sequences"></a></p><p><h1>Sequence Diagrams</h1></p><p><blockquote>Sequence diagrams for major user flows and system processes</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#user-registration">User Registration</a></li>
<li><a href="#user-sign-in">User Sign In</a></li>
<li><a href="#temperature-reading-flow">Temperature Reading Flow</a></li>
<li><a href="#manual-logging-flow">Manual Logging Flow</a></li>
<li><a href="#alert-acknowledgment">Alert Acknowledgment</a></li>
<li><a href="#excursion-detection">Excursion Detection</a></li>
<li><a href="#alert-escalation">Alert Escalation</a></li>
<li><a href="#ttn-setup-flow">TTN Setup Flow</a></li>
<li><a href="#sensor-provisioning">Sensor Provisioning</a></li>
<li><a href="#dashboard-monitoring">Dashboard Monitoring</a></li></p><p>---</p><p><h2>User Registration</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant A as Auth Page
    participant PB as check-password-breach
    participant SA as Supabase Auth
    participant DB as Database
    participant OB as Onboarding</p><p>    U->>A: Enter email, password
    A->>A: Validate format (Zod)
    A->>PB: Check password breach
    PB-->>A: Not breached</p><p>    A->>SA: signUp(email, password)
    SA->>SA: Create auth.users record
    SA->>DB: Trigger: create profile
    DB-->>SA: Profile created
    SA-->>A: User + session</p><p>    A->>OB: Redirect to /onboarding
    U->>OB: Enter org details
    OB->>DB: create_organization_with_owner()
    DB-->>OB: Org created</p><p>    U->>OB: Create site, area, unit
    OB->>DB: create_site_for_org()
    OB->>DB: create_area_for_site()
    OB->>DB: create_unit_for_area()</p><p>    OB-->>U: Redirect to /dashboard
</code></pre></p><p>---</p><p><h2>User Sign In</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant A as Auth Page
    participant SA as Supabase Auth
    participant DB as Database
    participant D as Dashboard</p><p>    U->>A: Enter email, password
    A->>A: Validate format</p><p>    A->>SA: signInWithPassword(email, password)
    SA->>SA: Validate credentials
    SA-->>A: JWT + refresh token</p><p>    A->>DB: Fetch user profile
    DB-->>A: Profile data</p><p>    A->>DB: Fetch user_roles
    DB-->>A: Organization membership</p><p>    A->>D: Redirect to /dashboard
    D->>DB: Load dashboard data
    DB-->>D: Units, alerts, etc.
    D-->>U: Display dashboard
</code></pre></p><p>---</p><p><h2>Temperature Reading Flow</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant S as Sensor
    participant G as Gateway
    participant T as TTN
    participant W as ttn-webhook
    participant DB as Database
    participant P as process-unit-states
    participant E as process-escalations</p><p>    S->>G: LoRa transmission (temp: 38.5Â°F)
    G->>T: Forward uplink
    T->>T: Decode payload</p><p>    T->>W: POST webhook (X-Webhook-Secret)
    W->>W: Validate secret
    W->>DB: Lookup org by secret
    DB-->>W: Organization ID</p><p>    W->>DB: Lookup sensor by DevEUI
    DB-->>W: Sensor record</p><p>    W->>DB: INSERT sensor_readings
    W->>DB: UPDATE units (last_temp_reading)
    W->>DB: UPDATE lora_sensors (last_seen_at)</p><p>    W->>P: POST /process-unit-states
    P->>DB: SELECT units with readings
    P->>DB: SELECT get_effective_alert_rules()</p><p>    P->>P: Evaluate thresholds</p><p>    alt Temperature in range
        P->>DB: UPDATE units.status = 'ok'
    else Temperature out of range
        P->>DB: UPDATE units.status = 'excursion'
        P->>DB: INSERT alerts
        P->>E: POST /process-escalations
        E->>DB: SELECT notification_policies
        E->>DB: INSERT notification_events
    end</p><p>    P-->>W: Processing complete
    W-->>T: 200 OK
</code></pre></p><p>---</p><p><h2>Manual Logging Flow</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant ML as ManualLog Page
    participant IDB as IndexedDB
    participant DB as Database</p><p>    U->>ML: Select unit
    U->>ML: Enter temperature
    U->>ML: Click "Log"</p><p>    ML->>ML: Validate temperature range</p><p>    alt Online
        ML->>DB: INSERT manual_temperature_logs
        DB-->>ML: Success
        ML->>DB: UPDATE units.last_manual_log_at
        ML-->>U: Success toast
    else Offline
        ML->>IDB: Store in offline queue
        IDB-->>ML: Queued
        ML-->>U: "Saved offline" toast
    end</p><p>    Note over ML,IDB: When connection restored</p><p>    ML->>IDB: Get queued logs
    IDB-->>ML: Pending logs</p><p>    loop For each queued log
        ML->>DB: INSERT manual_temperature_logs
        DB-->>ML: Success
        ML->>IDB: Remove from queue
    end</p><p>    ML-->>U: "Synced" toast
</code></pre></p><p>---</p><p><h2>Alert Acknowledgment</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant A as Alerts Page
    participant DB as Database
    participant EL as event_logs</p><p>    U->>A: View alert list
    A->>DB: SELECT alerts WHERE status = 'triggered'
    DB-->>A: Active alerts</p><p>    U->>A: Click "Acknowledge"
    A->>A: Open notes dialog
    U->>A: Enter notes
    U->>A: Confirm</p><p>    A->>DB: UPDATE alerts SET acknowledged_at, acknowledged_by
    DB-->>A: Updated</p><p>    A->>EL: INSERT event_log (alert_acknowledged)
    EL-->>A: Logged</p><p>    A-->>U: Success toast
    A->>A: Refresh alert list
</code></pre></p><p>---</p><p><h2>Excursion Detection</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant S as Sensor
    participant P as process-unit-states
    participant DB as Database
    participant E as process-escalations
    participant N as Notifications</p><p>    Note over S,P: Temperature exceeds threshold</p><p>    S->>P: Reading: 48Â°F (limit: 40Â°F)
    P->>DB: Get unit current status
    DB-->>P: status = 'ok'</p><p>    P->>P: Temp > high_limit?
    P->>P: Yes, check door state</p><p>    alt Door open within grace
        P->>P: Skip excursion (grace period)
    else Door closed or grace exceeded
        P->>DB: UPDATE units.status = 'excursion'
        P->>DB: UPDATE units.last_status_change = NOW()
        P->>DB: INSERT alerts (temp_excursion, severity: critical)
        P->>DB: INSERT event_logs</p><p>        P->>E: Trigger escalations
        E->>DB: Get notification policy
        E->>N: Send email/SMS/push
        N-->>E: Delivery status
        E->>DB: INSERT notification_events
    end</p><p>    Note over P,DB: Confirm time passes (10-20 min)</p><p>    P->>DB: Check excursion duration
    DB-->>P: 15 minutes in excursion</p><p>    P->>DB: UPDATE units.status = 'alarm_active'
    P->>DB: UPDATE alerts.severity = 'critical'
    P->>E: Trigger critical notifications
</code></pre></p><p>---</p><p><h2>Alert Escalation</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant T as Timer
    participant E as process-escalations
    participant DB as Database
    participant EC as escalation_contacts
    participant N as Notification Service</p><p>    Note over T,E: Alert created at T=0</p><p>    T->>E: Escalation check (T=15min)
    E->>DB: SELECT alerts WHERE not acknowledged
    DB-->>E: Alert still active</p><p>    E->>DB: Get notification_policy
    DB-->>E: Escalation intervals: [15, 30, 60]</p><p>    E->>DB: UPDATE alerts.escalation_level = 2
    E->>EC: SELECT contacts WHERE level = 2
    EC-->>E: Level 2 contacts</p><p>    loop For each contact
        E->>N: Send notification
        N-->>E: Delivery status
        E->>DB: INSERT notification_events
    end</p><p>    E->>DB: UPDATE alerts.next_escalation_at</p><p>    Note over T,E: Still not acknowledged at T=30min</p><p>    T->>E: Escalation check (T=30min)
    E->>DB: UPDATE alerts.escalation_level = 3
    E->>EC: SELECT contacts WHERE level = 3
    E->>N: Send to level 3 contacts
</code></pre></p><p>---</p><p><h2>TTN Setup Flow</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant S as Settings Page
    participant V as ttn-gateway-preflight
    participant B as ttn-bootstrap
    participant DB as Database
    participant TTN as The Things Network</p><p>    U->>S: Navigate to TTN tab
    U->>S: Enter Application ID
    U->>S: Enter API Key</p><p>    S->>V: Validate API key
    V->>TTN: GET /applications (test permissions)</p><p>    alt Valid permissions
        TTN-->>V: 200 OK
        V-->>S: Valid, show permissions
    else Invalid
        TTN-->>V: 401/403
        V-->>S: Invalid key
        S-->>U: Show error
    end</p><p>    U->>S: Click "Connect"</p><p>    S->>DB: INSERT ttn_connections
    Note over S,DB: API key encrypted, secret hashed</p><p>    S->>B: Configure webhook
    B->>TTN: POST /webhooks
    TTN-->>B: Webhook created
    B->>DB: UPDATE ttn_connections.is_configured = true</p><p>    S-->>U: "Connected" status
</code></pre></p><p>---</p><p><h2>Sensor Provisioning</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant S as SensorManager
    participant DB as Database
    participant Q as ttn_provisioning_queue
    participant W as ttn-provision-worker
    participant TTN as The Things Network</p><p>    U->>S: Click "Add Sensor"
    U->>S: Enter DevEUI, name, type
    S->>S: Normalize DevEUI</p><p>    S->>DB: INSERT lora_sensors (status: pending)
    DB-->>S: Sensor created</p><p>    S->>Q: INSERT provisioning job
    Q-->>S: Job queued</p><p>    Note over W,TTN: Background worker runs</p><p>    W->>Q: SELECT pending jobs
    Q-->>W: Sensor provisioning job</p><p>    W->>DB: Get ttn_connections for org
    DB-->>W: TTN credentials</p><p>    W->>TTN: POST /devices (register device)</p><p>    alt Success
        TTN-->>W: Device registered
        W->>DB: UPDATE lora_sensors.status = 'joining'
        W->>DB: UPDATE lora_sensors.ttn_device_id
        W->>Q: UPDATE job status = 'complete'
    else Failure
        TTN-->>W: Error
        W->>Q: UPDATE job (status: failed, error)
        W->>DB: INSERT ttn_provisioning_logs
    end</p><p>    Note over S,TTN: Sensor joins network</p><p>    TTN->>DB: First uplink via ttn-webhook
    DB->>DB: UPDATE lora_sensors.status = 'active'
</code></pre></p><p>---</p><p><h2>Dashboard Monitoring</h2></p><p><pre><code class="mermaid">sequenceDiagram
    participant U as User
    participant D as Dashboard
    participant Q as TanStack Query
    participant DB as Database</p><p>    U->>D: Navigate to /dashboard</p><p>    D->>Q: useOrganization()
    Q->>DB: SELECT organizations
    DB-->>Q: Org data
    Q-->>D: Cached org</p><p>    D->>Q: useSites(), useAreas(), useUnits()
    Q->>DB: SELECT sites, areas, units
    DB-->>Q: Hierarchy data
    Q-->>D: Cached data</p><p>    D->>D: Render unit cards
    D->>D: Apply status styling</p><p>    loop Every 30 seconds
        Q->>DB: Refetch stale queries
        DB-->>Q: Updated data
        Q-->>D: Re-render if changed
    end</p><p>    U->>D: Click unit card
    D->>D: Navigate to /units/:id
</code></pre></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#product-user_flows">USER_FLOWS.md</a> - Detailed flow descriptions</li>
<li><a href="#page_diagrams">PAGE_DIAGRAMS.md</a> - Page component diagrams</li>
<li><a href="#state_machines">STATE_MACHINES.md</a> - State machine diagrams</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="diagrams-state_machines"></a></p><p><h1>State Machines</h1></p><p><blockquote>State machine diagrams for units, alerts, sensors, and application states</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#unit-status">Unit Status</a></li>
<li><a href="#alert-status">Alert Status</a></li>
<li><a href="#sensor-status">Sensor Status</a></li>
<li><a href="#gateway-status">Gateway Status</a></li>
<li><a href="#provisioning-job-status">Provisioning Job Status</a></li>
<li><a href="#page-states">Page States</a></li></p><p>---</p><p><h2>Unit Status</h2></p><p><strong>Source</strong>: <code>src/lib/statusConfig.ts</code>, <code>supabase/functions/process-unit-states/index.ts</code></p><p><h3>State Diagram</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> ok: Initial state</p><p>    ok --> excursion: Temp out of range
    ok --> offline: Missed check-ins (1-4)
    ok --> monitoring_interrupted: Missed check-ins (5+)</p><p>    excursion --> alarm_active: Confirm time exceeded
    excursion --> restoring: Temp returns to range
    excursion --> ok: Temp in range + hysteresis</p><p>    alarm_active --> restoring: Temp returns to range</p><p>    restoring --> ok: 2 consecutive good readings
    restoring --> excursion: Temp out of range again</p><p>    offline --> ok: Data received
    offline --> monitoring_interrupted: Critical threshold</p><p>    monitoring_interrupted --> manual_required: Manual log overdue
    monitoring_interrupted --> restoring: Data received</p><p>    manual_required --> restoring: Manual log or sensor data
    manual_required --> monitoring_interrupted: Manual log received</p><p>    note right of excursion: Unconfirmed temp violation
    note right of alarm_active: Confirmed critical alert
    note right of restoring: Recovering from issue
</code></pre></p><p><h3>State Descriptions</h3></p><p>| Status | Description | Priority | Color |
|--------|-------------|----------|-------|
| <code>ok</code> | Normal operation | 5 | Green |
| <code>excursion</code> | Temp out of range (unconfirmed) | 2 | Orange-red |
| <code>alarm_active</code> | Confirmed temp alarm | 1 (highest) | Red |
| <code>restoring</code> | Recovering from issue | 4 | Blue |
| <code>offline</code> | Warning-level offline (1-4 missed) | 6 | Gray |
| <code>monitoring_interrupted</code> | Critical offline (5+ missed) | 3 | Gray |
| <code>manual_required</code> | Manual logging needed | 4 | Orange |</p><p><h3>Transitions</h3></p><p>| From | To | Trigger |
|------|----|---------|
| <code>ok</code> â†’ <code>excursion</code> | Temperature exceeds threshold |
| <code>excursion</code> â†’ <code>alarm_active</code> | Confirm time (10-20 min) passed |
| <code>alarm_active</code> â†’ <code>restoring</code> | Temperature returns to safe range |
| <code>restoring</code> â†’ <code>ok</code> | 2 consecutive in-range readings |
| <code>ok</code> â†’ <code>offline</code> | 1-4 missed check-ins |
| <code>offline</code> â†’ <code>monitoring_interrupted</code> | 5+ missed check-ins |
| <code>monitoring_interrupted</code> â†’ <code>manual_required</code> | 4+ hours since last reading |
| <code><em></code> â†’ <code>restoring</code> | Sensor data received |</p><p>---</p><p><h2>Alert Status</h2></p><p><strong>Source</strong>: <code>src/integrations/supabase/types.ts</code> (alert_status enum)</p><p><h3>State Diagram</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> triggered: Alert created</p><p>    triggered --> acknowledged: User acknowledges
    triggered --> resolved: Condition clears (auto)</p><p>    acknowledged --> resolved: Condition clears (auto)
    acknowledged --> resolved: User resolves</p><p>    resolved --> [<em>]</p><p>    note right of triggered: Active, needs attention
    note right of acknowledged: Seen, being handled
    note right of resolved: Closed
</code></pre></p><p><h3>State Descriptions</h3></p><p>| Status | Description | Actions Available |
|--------|-------------|-------------------|
| <code>triggered</code> | Active alert, not yet acknowledged | Acknowledge, Resolve |
| <code>acknowledged</code> | User has seen and is handling | Resolve |
| <code>resolved</code> | Alert closed (auto or manual) | None (archived) |</p><p><h3>Escalation Behavior</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    state triggered {
        [</em>] --> level1: Alert created
        level1 --> level2: Escalation timeout
        level2 --> level3: Escalation timeout
        level3 --> level3: Max level
    }</p><p>    triggered --> acknowledged: Any level</p><p>    note right of level1: Initial notification
    note right of level2: Second tier contacts
    note right of level3: Final escalation
</code></pre></p><p>---</p><p><h2>Sensor Status</h2></p><p><strong>Source</strong>: <code>src/integrations/supabase/types.ts</code> (lora_sensor_status enum)</p><p><h3>State Diagram</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [<em>] --> pending: Sensor registered</p><p>    pending --> joining: TTN provisioning started
    pending --> fault: Provisioning failed</p><p>    joining --> active: First uplink received
    joining --> fault: Join timeout
    joining --> pending: Retry provisioning</p><p>    active --> offline: No data for threshold
    active --> fault: Sensor error</p><p>    offline --> active: Data received
    offline --> fault: Extended offline</p><p>    fault --> pending: Reset/retry</p><p>    note right of pending: Registered, not provisioned
    note right of joining: Waiting for TTN join
    note right of active: Receiving data
    note right of offline: No recent data
    note right of fault: Error state
</code></pre></p><p><h3>State Descriptions</h3></p><p>| Status | Description | Next Actions |
|--------|-------------|--------------|
| <code>pending</code> | Registered in FreshTrack, not in TTN | Provision |
| <code>joining</code> | Provisioned in TTN, waiting for join | Wait for uplink |
| <code>active</code> | Receiving data normally | Monitor |
| <code>offline</code> | No recent data | Investigate |
| <code>fault</code> | Error condition | Troubleshoot |</p><p>---</p><p><h2>Gateway Status</h2></p><p><strong>Source</strong>: <code>src/integrations/supabase/types.ts</code> (gateway_status enum)</p><p><h3>State Diagram</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> pending: Gateway registered</p><p>    pending --> online: First connection
    pending --> offline: Connection failed</p><p>    online --> offline: Connection lost
    online --> maintenance: Maintenance mode</p><p>    offline --> online: Connection restored
    offline --> maintenance: Manual maintenance</p><p>    maintenance --> online: Maintenance complete
    maintenance --> offline: Maintenance failed</p><p>    note right of pending: Awaiting connection
    note right of online: Operational
    note right of offline: Not connected
    note right of maintenance: Intentionally offline
</code></pre></p><p>---</p><p><h2>Provisioning Job Status</h2></p><p><strong>Source</strong>: <code>ttn_provisioning_queue</code> table</p><p><h3>State Diagram</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [<em>] --> pending: Job created</p><p>    pending --> processing: Worker picks up</p><p>    processing --> complete: TTN API success
    processing --> failed: TTN API error
    processing --> pending: Retry (if attempts < max)</p><p>    failed --> pending: Manual retry</p><p>    complete --> [</em>]</p><p>    note right of pending: Queued for processing
    note right of processing: Worker handling
    note right of complete: Successfully provisioned
    note right of failed: Max retries exceeded
</code></pre></p><p>---</p><p><h2>Page States</h2></p><p><h3>Generic Page State Machine</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [<em>] --> loading: Navigate to page</p><p>    loading --> ready: Data loaded
    loading --> error: Load failed
    loading --> empty: No data</p><p>    ready --> refreshing: Stale data
    refreshing --> ready: Fresh data</p><p>    ready --> editing: User action
    editing --> saving: Submit
    saving --> ready: Success
    saving --> editing: Validation error</p><p>    error --> loading: Retry</p><p>    empty --> ready: Data added
</code></pre></p><p><h3>Dashboard Specific</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> loading</p><p>    loading --> ready: Units loaded
    loading --> noOrg: No organization
    loading --> error: Load failed</p><p>    noOrg --> [<em>]: Redirect to onboarding</p><p>    state ready {
        [</em>] --> monitoring
        monitoring --> alertVisible: Active alerts
        alertVisible --> monitoring: All resolved
    }</p><p>    ready --> unitDetail: Click unit
</code></pre></p><p><h3>Settings Specific</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [<em>] --> loading</p><p>    loading --> generalTab: Default tab</p><p>    state "Tab States" as tabs {
        generalTab --> alertRulesTab: Switch
        alertRulesTab --> notificationTab: Switch
        notificationTab --> sensorsTab: Switch
        sensorsTab --> gatewaysTab: Switch
        gatewaysTab --> ttnTab: Switch
        ttnTab --> billingTab: Switch
        billingTab --> accountTab: Switch
    }</p><p>    state "Edit Mode" as edit {
        viewing --> editing: Modify
        editing --> saving: Submit
        saving --> viewing: Success
        saving --> editing: Error
    }
</code></pre></p><p><h3>Manual Log Specific</h3></p><p><pre><code class="mermaid">stateDiagram-v2
    [</em>] --> selectUnit</p><p>    selectUnit --> enterTemp: Unit selected
    enterTemp --> selectUnit: Change unit</p><p>    enterTemp --> validating: Submit
    validating --> submitting: Valid
    validating --> enterTemp: Invalid</p><p>    state submitting {
        [<em>] --> checkConnection
        checkConnection --> online: Connected
        checkConnection --> offline: Disconnected</p><p>        online --> success: DB insert ok
        online --> error: DB error</p><p>        offline --> queued: IndexedDB save
    }</p><p>    success --> selectUnit: Clear form
    queued --> selectUnit: Clear form
    error --> enterTemp: Show error</p><p>    state "Background Sync" as sync {
        queued --> syncing: Connection restored
        syncing --> synced: All uploaded
    }
</code></pre></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#page_diagrams">PAGE_DIAGRAMS.md</a> - Page component diagrams</li>
<li><a href="#sequences">SEQUENCES.md</a> - Sequence diagrams</li>
<li><a href="#product-pages">PAGES.md</a> - Page documentation</li>
<li><a href="#engineering-api">API.md</a> - Alert processing details</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="charts-er_diagram"></a></p><p><h1>Entity-Relationship Diagram</h1></p><p><blockquote>Database entity-relationship diagrams for FreshTrack Pro</blockquote></p><p>---</p><p><h2>Core Entity Relationships</h2></p><p><pre><code class="mermaid">erDiagram
    organizations ||--o{ sites : "has many"
    organizations ||--o{ user_roles : "has many"
    organizations ||--o{ lora_sensors : "owns"
    organizations ||--o{ gateways : "owns"
    organizations ||--|| ttn_connections : "has one"
    organizations ||--o{ alert_rules : "configures"
    organizations ||--o{ notification_policies : "configures"
    organizations ||--o{ escalation_contacts : "has many"
    organizations ||--o{ subscriptions : "has one"</p><p>    sites ||--o{ areas : "has many"
    sites ||--o{ gateways : "located at"
    sites ||--o{ alert_rules : "configures"
    sites ||--o{ escalation_contacts : "has many"</p><p>    areas ||--o{ units : "has many"</p><p>    units ||--o{ sensor_readings : "has many"
    units ||--o{ manual_temperature_logs : "has many"
    units ||--o{ alerts : "has many"
    units ||--o{ door_events : "has many"
    units ||--o{ corrective_actions : "has many"
    units ||--o{ alert_rules : "configures"</p><p>    lora_sensors ||--o{ sensor_readings : "provides"
    lora_sensors }o--o| units : "assigned to"</p><p>    alerts ||--o{ notification_events : "triggers"
    alerts ||--o{ corrective_actions : "requires"</p><p>    profiles ||--o{ user_roles : "has many"
    profiles ||--o{ manual_temperature_logs : "logs"</p><p>    organizations {
        uuid id PK
        text name
        text slug UK
        enum compliance_mode
        text timezone
        timestamp created_at
        timestamp deleted_at
    }</p><p>    sites {
        uuid id PK
        uuid organization_id FK
        text name
        text address
        boolean is_active
        timestamp created_at
    }</p><p>    areas {
        uuid id PK
        uuid site_id FK
        text name
        text description
        int sort_order
        timestamp created_at
    }</p><p>    units {
        uuid id PK
        uuid area_id FK
        text name
        text status
        numeric temp_limit_high
        numeric temp_limit_low
        numeric last_temp_reading
        timestamp last_reading_at
        int checkin_interval_minutes
        text door_state
        timestamp created_at
    }</p><p>    lora_sensors {
        uuid id PK
        uuid organization_id FK
        uuid unit_id FK
        text name
        text dev_eui UK
        enum sensor_type
        enum status
        boolean is_primary
        numeric battery_level
        timestamp last_seen_at
    }</p><p>    sensor_readings {
        uuid id PK
        uuid unit_id FK
        uuid lora_sensor_id FK
        numeric temperature
        numeric humidity
        boolean door_open
        text source
        timestamp recorded_at
    }</p><p>    alerts {
        uuid id PK
        uuid organization_id FK
        uuid unit_id FK
        enum alert_type
        enum severity
        enum status
        text title
        numeric temp_reading
        timestamp triggered_at
        timestamp acknowledged_at
        uuid acknowledged_by FK
        timestamp resolved_at
        int escalation_level
    }</p><p>    profiles {
        uuid id PK
        text email
        text full_name
        text phone
        timestamp created_at
    }</p><p>    user_roles {
        uuid id PK
        uuid user_id FK
        uuid organization_id FK
        enum role
    }
</code></pre></p><p>---</p><p><h2>Sensor & Reading Relationships</h2></p><p><pre><code class="mermaid">erDiagram
    lora_sensors ||--o{ sensor_readings : "generates"
    lora_sensors }o--|| organizations : "owned by"
    lora_sensors }o--o| sites : "located at"
    lora_sensors }o--o| units : "assigned to"</p><p>    gateways }o--|| organizations : "owned by"
    gateways }o--o| sites : "located at"</p><p>    devices ||--o{ sensor_readings : "generates"
    devices ||--o{ calibration_records : "has"</p><p>    units ||--o{ sensor_readings : "receives"
    units ||--o{ manual_temperature_logs : "receives"
    units ||--o{ door_events : "has"</p><p>    lora_sensors {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        uuid unit_id FK
        text dev_eui
        text ttn_device_id
        text ttn_application_id
        enum sensor_type
        enum status
        boolean is_primary
        numeric battery_level
        int signal_strength
        timestamp last_seen_at
        timestamp last_join_at
    }</p><p>    gateways {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        text name
        text eui
        enum status
        text ttn_gateway_id
        text frequency_plan
        timestamp last_seen_at
    }</p><p>    sensor_readings {
        uuid id PK
        uuid unit_id FK
        uuid lora_sensor_id FK
        uuid device_id FK
        numeric temperature
        numeric humidity
        numeric battery_level
        int signal_strength
        boolean door_open
        text source
        timestamp recorded_at
        timestamp created_at
    }</p><p>    manual_temperature_logs {
        uuid id PK
        uuid unit_id FK
        numeric temperature
        text notes
        uuid logged_by FK
        timestamp logged_at
    }</p><p>    door_events {
        uuid id PK
        uuid unit_id FK
        text state
        timestamp occurred_at
        text source
        jsonb metadata
    }
</code></pre></p><p>---</p><p><h2>Alert & Notification Relationships</h2></p><p><pre><code class="mermaid">erDiagram
    alerts ||--o{ notification_events : "triggers"
    alerts }o--|| organizations : "belongs to"
    alerts }o--|| units : "for"
    alerts }o--o| corrective_actions : "has"</p><p>    alert_rules }o--o| organizations : "at org level"
    alert_rules }o--o| sites : "at site level"
    alert_rules }o--o| units : "at unit level"
    alert_rules ||--o{ alert_rules_history : "has history"</p><p>    notification_policies }o--o| organizations : "at org level"
    notification_policies }o--o| sites : "at site level"
    notification_policies }o--o| units : "at unit level"</p><p>    escalation_contacts }o--|| organizations : "belongs to"
    escalation_contacts }o--o| sites : "scoped to"</p><p>    alerts {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        uuid area_id FK
        uuid unit_id FK
        enum alert_type
        enum severity
        enum status
        text title
        text message
        numeric temp_reading
        numeric temp_limit
        text source
        timestamp triggered_at
        timestamp first_active_at
        timestamp acknowledged_at
        uuid acknowledged_by FK
        text acknowledgment_notes
        timestamp resolved_at
        uuid resolved_by FK
        int escalation_level
        timestamp last_notified_at
        timestamp next_escalation_at
        jsonb escalation_steps_sent
        jsonb metadata
    }</p><p>    alert_rules {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        uuid unit_id FK
        int offline_warning_missed_checkins
        int offline_critical_missed_checkins
        int manual_interval_minutes
        int manual_grace_minutes
        int door_open_warning_minutes
        int door_open_critical_minutes
        int excursion_confirm_minutes_door_closed
        int excursion_confirm_minutes_door_open
        timestamp created_at
        timestamp updated_at
    }</p><p>    notification_policies {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        uuid unit_id FK
        enum alert_type
        boolean enabled
        jsonb channels
        int[] escalation_minutes
        time quiet_start
        time quiet_end
    }</p><p>    notification_events {
        uuid id PK
        uuid alert_id FK
        text channel
        text recipient
        text status
        timestamp sent_at
        text error_message
        jsonb metadata
    }</p><p>    escalation_contacts {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        text name
        text email
        text phone
        int escalation_level
        boolean is_active
    }
</code></pre></p><p>---</p><p><h2>TTN Integration Relationships</h2></p><p><pre><code class="mermaid">erDiagram
    organizations ||--|| ttn_connections : "has config"
    organizations ||--o{ ttn_provisioning_queue : "has jobs"
    organizations ||--o{ ttn_provisioning_logs : "has logs"
    organizations ||--o{ ttn_deprovision_jobs : "has cleanup"</p><p>    lora_sensors ||--o{ ttn_provisioning_queue : "provisioned via"
    gateways ||--o{ ttn_provisioning_queue : "provisioned via"</p><p>    ttn_provisioning_queue ||--o{ ttn_provisioning_logs : "has logs"</p><p>    ttn_connections {
        uuid id PK
        uuid organization_id FK UK
        text application_id
        text api_key
        text webhook_secret
        text cluster
        text webhook_url
        boolean is_configured
        timestamp last_sync_at
        timestamp created_at
        timestamp updated_at
    }</p><p>    ttn_provisioning_queue {
        uuid id PK
        uuid organization_id FK
        uuid sensor_id FK
        uuid gateway_id FK
        text action
        text status
        int attempts
        text last_error
        timestamp processed_at
        timestamp created_at
    }</p><p>    ttn_provisioning_logs {
        uuid id PK
        uuid queue_id FK
        uuid organization_id FK
        text action
        boolean success
        jsonb response
        text error
        timestamp created_at
    }</p><p>    ttn_deprovision_jobs {
        uuid id PK
        uuid organization_id FK
        uuid sensor_id FK
        text dev_eui
        text status
        timestamp created_at
        timestamp processed_at
    }
</code></pre></p><p>---</p><p><h2>User & Billing Relationships</h2></p><p><pre><code class="mermaid">erDiagram
    profiles ||--o{ user_roles : "has roles"
    user_roles }o--|| organizations : "in organization"</p><p>    organizations ||--o| subscriptions : "has subscription"
    organizations ||--o{ invoices : "has invoices"</p><p>    profiles ||--o{ event_logs : "actor in"
    profiles ||--o{ manual_temperature_logs : "logs"
    profiles ||--o{ alerts : "acknowledges"</p><p>    profiles {
        uuid id PK
        text email
        text full_name
        text phone
        text avatar_url
        timestamp created_at
        timestamp updated_at
    }</p><p>    user_roles {
        uuid id PK
        uuid user_id FK
        uuid organization_id FK
        enum role
        timestamp created_at
        timestamp updated_at
    }</p><p>    subscriptions {
        uuid id PK
        uuid organization_id FK
        text stripe_subscription_id
        text stripe_customer_id
        text plan_id
        text status
        timestamp current_period_start
        timestamp current_period_end
        timestamp cancel_at
        timestamp created_at
        timestamp updated_at
    }</p><p>    invoices {
        uuid id PK
        uuid organization_id FK
        text stripe_invoice_id
        int amount
        text status
        timestamp paid_at
        timestamp created_at
    }</p><p>    event_logs {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        uuid unit_id FK
        text event_type
        text category
        text severity
        text title
        jsonb event_data
        uuid actor_id FK
        text actor_type
        timestamp created_at
    }
</code></pre></p><p>---</p><p><h2>Compliance Relationships</h2></p><p><pre><code class="mermaid">erDiagram
    units ||--o{ corrective_actions : "has"
    alerts }o--o| corrective_actions : "related to"</p><p>    devices ||--o{ calibration_records : "has"</p><p>    corrective_actions {
        uuid id PK
        uuid unit_id FK
        uuid alert_id FK
        text action_taken
        text root_cause
        text preventive_measures
        text[] photo_urls
        uuid created_by FK
        timestamp completed_at
        timestamp created_at
    }</p><p>    calibration_records {
        uuid id PK
        uuid device_id FK
        numeric reference_temp
        numeric measured_temp
        numeric offset_applied
        uuid performed_by FK
        timestamp calibrated_at
        timestamp next_calibration_due
        text notes
        timestamp created_at
    }</p><p>    event_logs {
        uuid id PK
        uuid organization_id FK
        uuid site_id FK
        uuid unit_id FK
        text event_type
        text category
        text severity
        text title
        jsonb event_data
        uuid actor_id FK
        text actor_type
        timestamp created_at
    }
</code></pre></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#engineering-data_model">DATA_MODEL.md</a> - Complete schema documentation</li>
<li><a href="#architecture-architecture">ARCHITECTURE.md</a> - Database architecture</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="charts-flowcharts"></a></p><p><h1>Flowcharts</h1></p><p><blockquote>Process flowcharts for data ingestion, alert processing, and system operations</blockquote></p><p>---</p><p><h2>Table of Contents</h2></p><p><li><a href="#data-ingestion-flow">Data Ingestion Flow</a></li>
<li><a href="#alert-processing-flow">Alert Processing Flow</a></li>
<li><a href="#notification-flow">Notification Flow</a></li>
<li><a href="#ttn-provisioning-flow">TTN Provisioning Flow</a></li>
<li><a href="#manual-logging-flow">Manual Logging Flow</a></li>
<li><a href="#authentication-flow">Authentication Flow</a></li>
<li><a href="#cascade-resolution-flow">Cascade Resolution Flow</a></li></p><p>---</p><p><h2>Data Ingestion Flow</h2></p><p><h3>TTN Webhook Processing</h3></p><p><pre><code class="mermaid">flowchart TD
    A[TTN Uplink] --> B{Has X-Webhook-Secret?}
    B -->|No| C[Return 401]
    B -->|Yes| D[Lookup org by secret]</p><p>    D --> E{Org found?}
    E -->|No| F[Return 401]
    E -->|Yes| G[Extract DevEUI]</p><p>    G --> H{Valid DevEUI?}
    H -->|No| I[Return 202 - Accepted]
    H -->|Yes| J[Normalize DevEUI]</p><p>    J --> K[Lookup sensor by DevEUI]
    K --> L{Sensor found?}</p><p>    L -->|No| M[Lookup legacy device]
    M --> N{Device found?}
    N -->|No| O[Return 202 - Unknown]
    N -->|Yes| P[Process legacy device]</p><p>    L -->|Yes| Q{Assigned to unit?}
    Q -->|No| R[Update sensor only]
    Q -->|Yes| S[Insert sensor_reading]</p><p>    S --> T[Update unit state]
    T --> U[Trigger process-unit-states]
    U --> V[Return 200 OK]</p><p>    R --> W[Return 200 OK]
    P --> V
</code></pre></p><p><h3>Sensor Reading Processing</h3></p><p><pre><code class="mermaid">flowchart TD
    A[New Reading] --> B[Extract temperature]
    B --> C{Temperature present?}</p><p>    C -->|No| D[Check door state]
    C -->|Yes| E[Apply scaling if needed]</p><p>    E --> F[Insert sensor_readings]
    F --> G[Update unit.last_temp_reading]
    G --> H[Update unit.last_reading_at]
    H --> I[Update unit.last_checkin_at]</p><p>    D --> J{Door state present?}
    J -->|No| K[Update sensor only]
    J -->|Yes| L[Update unit.door_state]
    L --> M{State changed?}
    M -->|Yes| N[Insert door_event]
    M -->|No| O[Continue]</p><p>    I --> P[Trigger state processing]
    N --> P
    O --> P
</code></pre></p><p>---</p><p><h2>Alert Processing Flow</h2></p><p><h3>Unit State Evaluation (process-unit-states)</h3></p><p><pre><code class="mermaid">flowchart TD
    A[Process Unit States] --> B[Fetch all active units]
    B --> C[For each unit]</p><p>    C --> D[Compute missed check-ins]
    D --> E{Missed >= critical?}</p><p>    E -->|Yes| F[Check manual log required]
    F --> G{Manual overdue?}
    G -->|Yes| H[Status: manual_required]
    G -->|No| I[Status: monitoring_interrupted]</p><p>    E -->|No| J{Missed >= warning?}
    J -->|Yes| K[Status: offline]
    J -->|No| L[Check temperature]</p><p>    L --> M{Temp out of range?}
    M -->|Yes| N{Door open grace?}
    N -->|Yes| O[Skip - grace period]
    N -->|No| P{Currently ok?}
    P -->|Yes| Q[Status: excursion]
    P -->|No| R{In excursion?}
    R -->|Yes| S{Confirm time passed?}
    S -->|Yes| T[Status: alarm_active]
    S -->|No| U[Stay in excursion]</p><p>    M -->|No| V{Was in excursion?}
    V -->|Yes| W[Status: restoring]
    V -->|No| X{Was restoring?}
    X -->|Yes| Y{2 good readings?}
    Y -->|Yes| Z[Status: ok]
    Y -->|No| AA[Stay restoring]</p><p>    Q --> AB[Create temp_excursion alert]
    T --> AC[Update alert to critical]
    H --> AD[Create monitoring_interrupted alert]
    I --> AD</p><p>    AB --> AE[Trigger process-escalations]
    AC --> AE
    AD --> AE
</code></pre></p><p><h3>Temperature Excursion Detection</h3></p><p><pre><code class="mermaid">flowchart TD
    A[Temperature Reading] --> B[Get unit thresholds]
    B --> C{Temp > high_limit?}
    C -->|Yes| D[Out of range - HIGH]
    C -->|No| E{low_limit set?}
    E -->|Yes| F{Temp < low_limit?}
    F -->|Yes| G[Out of range - LOW]
    F -->|No| H[In range]
    E -->|No| H</p><p>    D --> I{Door state?}
    G --> I</p><p>    I -->|Open| J{Within grace period?}
    J -->|Yes| K[Skip - door grace]
    J -->|No| L[Create excursion]</p><p>    I -->|Closed/Unknown| L</p><p>    L --> M[Start confirm timer]
    M --> N{Temp returns to range?}
    N -->|Yes| O[Resolve excursion]
    N -->|No| P{Confirm time passed?}
    P -->|Yes| Q[Escalate to alarm_active]
    P -->|No| R[Continue monitoring]
</code></pre></p><p>---</p><p><h2>Notification Flow</h2></p><p><h3>Escalation Processing (process-escalations)</h3></p><p><pre><code class="mermaid">flowchart TD
    A[New/Updated Alert] --> B[Get notification policy]
    B --> C{Policy enabled?}</p><p>    C -->|No| D[Skip notification]
    C -->|Yes| E{In quiet hours?}</p><p>    E -->|Yes| F[Delay until quiet end]
    E -->|No| G[Get escalation level]</p><p>    G --> H[Get contacts for level]
    H --> I[For each contact]</p><p>    I --> J{Channel: email?}
    J -->|Yes| K[Send email]</p><p>    I --> L{Channel: SMS?}
    L -->|Yes| M[Send SMS]</p><p>    I --> N{Channel: push?}
    N -->|Yes| O[Send push]</p><p>    K --> P[Record notification_event]
    M --> P
    O --> P</p><p>    P --> Q[Update alert.last_notified_at]
    Q --> R[Calculate next_escalation_at]
    R --> S[Update alert]</p><p>    subgraph "Escalation Timer"
        T[Wait escalation_minutes]
        T --> U{Alert acknowledged?}
        U -->|Yes| V[Stop escalation]
        U -->|No| W{Max level?}
        W -->|Yes| X[Repeat current level]
        W -->|No| Y[Increment level]
        Y --> H
    end
</code></pre></p><p><h3>SMS Delivery</h3></p><p><pre><code class="mermaid">flowchart TD
    A[Send SMS Request] --> B[Validate phone E.164]
    B --> C{Valid format?}</p><p>    C -->|No| D[Log error]
    C -->|Yes| E[Call Twilio API]</p><p>    E --> F{Delivery success?}
    F -->|Yes| G[Log success]
    F -->|No| H[Log failure]</p><p>    G --> I[Insert sms_alert_log]
    H --> I</p><p>    I --> J[Update notification_event]
</code></pre></p><p>---</p><p><h2>TTN Provisioning Flow</h2></p><p><h3>Device Provisioning</h3></p><p><pre><code class="mermaid">flowchart TD
    A[Add Sensor Request] --> B[Normalize DevEUI]
    B --> C[Insert lora_sensors]
    C --> D[Queue provisioning job]</p><p>    D --> E[Worker picks up job]
    E --> F[Get TTN credentials]
    F --> G{Credentials valid?}</p><p>    G -->|No| H[Mark job failed]
    G -->|Yes| I[Call TTN API]</p><p>    I --> J{Device exists?}
    J -->|Yes| K[Update device]
    J -->|No| L[Create device]</p><p>    K --> M{API success?}
    L --> M</p><p>    M -->|Yes| N[Update sensor status: joining]
    M -->|No| O{Retry count < max?}</p><p>    O -->|Yes| P[Increment retry, requeue]
    O -->|No| Q[Mark job failed]</p><p>    N --> R[Log provisioning success]
    Q --> S[Log provisioning failure]</p><p>    subgraph "Join Process"
        T[Wait for uplink]
        T --> U{First uplink received?}
        U -->|Yes| V[Update status: active]
        U -->|No| W{Timeout?}
        W -->|Yes| X[Update status: fault]
        W -->|No| T
    end
</code></pre></p><p><h3>Webhook Bootstrap</h3></p><p><pre><code class="mermaid">flowchart TD
    A[Bootstrap Request] --> B[Get TTN credentials]
    B --> C{Valid API key?}</p><p>    C -->|No| D[Return error]
    C -->|Yes| E[Check existing webhook]</p><p>    E --> F{Webhook exists?}
    F -->|Yes| G[Update webhook]
    F -->|No| H[Create webhook]</p><p>    G --> I[Set webhook URL]
    H --> I</p><p>    I --> J[Set webhook secret]
    J --> K[Enable uplink messages]
    K --> L[Save to TTN]</p><p>    L --> M{Success?}
    M -->|Yes| N[Update ttn_connections]
    M -->|No| O[Return error]</p><p>    N --> P[Return success]
</code></pre></p><p>---</p><p><h2>Manual Logging Flow</h2></p><p><pre><code class="mermaid">flowchart TD
    A[User submits log] --> B[Validate temperature]
    B --> C{Valid range?}</p><p>    C -->|No| D[Show validation error]
    C -->|Yes| E{Online?}</p><p>    E -->|Yes| F[Insert manual_temperature_logs]
    E -->|No| G[Store in IndexedDB]</p><p>    F --> H{Success?}
    H -->|Yes| I[Update unit.last_manual_log_at]
    H -->|No| J[Show error toast]</p><p>    G --> K[Show "saved offline" toast]
    I --> L[Show success toast]</p><p>    K --> M[Queue sync]</p><p>    subgraph "Background Sync"
        N[Connection restored]
        N --> O[Get queued logs]
        O --> P[For each log]
        P --> Q[Insert to database]
        Q --> R{Success?}
        R -->|Yes| S[Remove from queue]
        R -->|No| T[Retry later]
        S --> U{More logs?}
        U -->|Yes| P
        U -->|No| V[Show "synced" toast]
    end
</code></pre></p><p>---</p><p><h2>Authentication Flow</h2></p><p><pre><code class="mermaid">flowchart TD
    A[Auth Request] --> B{Sign In or Sign Up?}</p><p>    B -->|Sign In| C[Validate credentials]
    C --> D{Valid?}
    D -->|Yes| E[Create session]
    D -->|No| F[Show error]</p><p>    B -->|Sign Up| G[Validate email format]
    G --> H{Valid?}
    H -->|No| I[Show error]
    H -->|Yes| J[Check password breach]</p><p>    J --> K{Breached?}
    K -->|Yes| L[Show breach warning]
    K -->|No| M[Check password strength]</p><p>    M --> N{Strong enough?}
    N -->|No| O[Show requirements]
    N -->|Yes| P[Create auth user]</p><p>    P --> Q[Trigger: create profile]
    Q --> R[Create session]</p><p>    E --> S{Has organization?}
    R --> S</p><p>    S -->|Yes| T[Redirect to /dashboard]
    S -->|No| U[Redirect to /onboarding]
</code></pre></p><p>---</p><p><h2>Cascade Resolution Flow</h2></p><p><h3>Alert Rules Cascade</h3></p><p><pre><code class="mermaid">flowchart TD
    A[get_effective_alert_rules] --> B[Get unit_id]
    B --> C[Get unit's area_id]
    C --> D[Get area's site_id]
    D --> E[Get site's organization_id]</p><p>    E --> F[Query unit-level rules]
    F --> G{Found?}
    G -->|Yes| H[Use unit rules]</p><p>    G -->|No| I[Query site-level rules]
    I --> J{Found?}
    J -->|Yes| K[Merge with defaults]</p><p>    J -->|No| L[Query org-level rules]
    L --> M{Found?}
    M -->|Yes| N[Merge with defaults]
    M -->|No| O[Use system defaults]</p><p>    H --> P[Return merged rules]
    K --> P
    N --> P
    O --> P</p><p>    subgraph "Merge Logic"
        Q[Unit overrides Site]
        R[Site overrides Org]
        S[Org overrides System]
        S --> R --> Q
    end
</code></pre></p><p><h3>Notification Policy Cascade</h3></p><p><pre><code class="mermaid">flowchart TD
    A[get_effective_notification_policy] --> B[Input: unit_id, alert_type]</p><p>    B --> C[Query unit-level policy]
    C --> D{Found?}
    D -->|Yes| E[Return unit policy]</p><p>    D -->|No| F[Get site_id from unit]
    F --> G[Query site-level policy]
    G --> H{Found?}
    H -->|Yes| I[Return site policy]</p><p>    H -->|No| J[Get org_id from site]
    J --> K[Query org-level policy]
    K --> L{Found?}
    L -->|Yes| M[Return org policy]
    L -->|No| N[Return default policy]
</code></pre></p><p>---</p><p><h2>Related Documentation</h2></p><p><li><a href="#engineering-api">API.md</a> - Edge function details</li>
<li><a href="#diagrams-sequences">SEQUENCES.md</a> - Sequence diagrams</li>
<li><a href="#diagrams-state_machines">STATE_MACHINES.md</a> - State machines</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="glossary"></a></p><p><h1>FreshTrack Pro Glossary</h1></p><p><blockquote>Terminology and definitions used throughout the documentation</blockquote></p><p><strong>Last Updated:</strong> 2026-01-12 02:24:44 UTC
<strong>Total Terms:</strong> 198</p><p>---</p><p><h2>Quick Navigation</h2></p><p><li><a href="#architecture">Architecture</a></li>
<li><a href="#product">Product</a></li>
<li><a href="#iot-hardware">IoT/Hardware</a></li>
<li><a href="#alert-system">Alert System</a></li>
<li><a href="#monitoring">Monitoring</a></li>
<li><a href="#security">Security</a></li>
<li><a href="#data">Data</a></li>
<li><a href="#integration">Integration</a></li>
<li><a href="#development">Development</a></li>
<li><a href="#general">General</a></li></p><p>---</p><p><h2>Architecture</h2></p><p>| Term | Definition |
|------|------------|
| <strong>Anon Key</strong> | Public API key with restricted access, safe for client-side use |
| <strong>Edge Function</strong> | Serverless function deployed on Supabase's edge network for low-latency API endpoints |
| <strong>JWT</strong> | JSON Web Token - compact, URL-safe token format used for authentication and authorization |
| <strong>Multi-tenant</strong> | Architecture where a single application instance serves multiple isolated organizations |
| <strong>RLS</strong> | Row Level Security - PostgreSQL feature that restricts data access at the row level based on user context |
| <strong>Service Role Key</strong> | Privileged API key that bypasses RLS policies, used only in server-side contexts |</p><p><h2>Product</h2></p><p>| Term | Definition |
|------|------------|
| <strong>Alert Rule</strong> | Configuration defining temperature thresholds and timing for generating alerts |
| <strong>Check-in Interval</strong> | The configured frequency at which a sensor should report temperature readings |
| <strong>Confirm Time</strong> | Delay before a temperature excursion triggers an active alarm (prevents false positives) |
| <strong>Excursion</strong> | A temperature reading outside the configured safe range for a unit |
| <strong>Site</strong> | A physical location containing one or more units under an organization |
| <strong>Unit</strong> | A refrigeration unit (cooler, freezer, walk-in) being monitored for temperature compliance |</p><p><h2>IoT/Hardware</h2></p><p>| Term | Definition |
|------|------------|
| <strong>DevEUI</strong> | Device Extended Unique Identifier - globally unique 64-bit identifier for LoRa devices |
| <strong>Downlink</strong> | Data transmission from network to sensor (configuration, commands) |
| <strong>Gateway</strong> | LoRaWAN gateway that receives sensor transmissions and forwards to TTN |
| <strong>Join Request</strong> | LoRaWAN procedure where a device authenticates and joins the network |
| <strong>LoRa</strong> | Long Range - low-power wireless protocol for IoT sensor communication |
| <strong>TTN</strong> | The Things Network - community and enterprise LoRaWAN network infrastructure |
| <strong>Uplink</strong> | Data transmission from sensor to network (readings, status) |</p><p><h2>Alert System</h2></p><p>| Term | Definition |
|------|------------|
| <strong>Escalation</strong> | Process of notifying additional contacts when an alert is not acknowledged |
| <strong>MTTR</strong> | Mean Time To Resolution - average time from alert creation to resolution |
| <strong>Notification Policy</strong> | Configuration for how and when to send alert notifications |
| <strong>Quiet Hours</strong> | Time periods when non-critical notifications are suppressed |</p><p><h2>Monitoring</h2></p><p>| Term | Definition |
|------|------------|
| <strong>Debug Terminal</strong> | Developer tool displaying real-time application logs and events |
| <strong>Degraded</strong> | System state where functionality is impaired but not completely failed |
| <strong>Event Log</strong> | Timestamped record of system and business events for auditing |
| <strong>Health Check</strong> | Automated system status verification across all components |</p><p><h2>Security</h2></p><p>| Term | Definition |
|------|------------|
| <strong>MFA</strong> | Multi-Factor Authentication - requiring multiple verification methods for login |
| <strong>Organization Context</strong> | The tenant boundary that determines data access scope |
| <strong>RBAC</strong> | Role-Based Access Control - permission system based on user roles within organizations |
| <strong>Session Token</strong> | Time-limited authentication credential stored after user login |</p><p><h2>Data</h2></p><p>| Term | Definition |
|------|------------|
| <strong>Cascade</strong> | Automatic propagation of database operations to related records |
| <strong>Reading Buffer</strong> | Temporary storage for sensor readings before database persistence |
| <strong>Sensor Reading</strong> | Individual temperature measurement with timestamp and metadata |
| <strong>Soft Delete</strong> | Marking records as deleted without physical removal (preserves audit trail) |</p><p><h2>Integration</h2></p><p>| Term | Definition |
|------|------------|
| <strong>API Endpoint</strong> | URL path that accepts requests and returns responses |
| <strong>Idempotency</strong> | Property where repeated operations produce the same result |
| <strong>Rate Limiting</strong> | Restricting the number of requests within a time window |
| <strong>Webhook</strong> | HTTP callback triggered by external events (TTN data, Stripe payments) |</p><p><h2>Development</h2></p><p>| Term | Definition |
|------|------------|
| <strong>React Query</strong> | Data fetching and caching library for React applications |
| <strong>Supabase</strong> | Backend-as-a-service platform providing PostgreSQL, Auth, and Edge Functions |
| <strong>Vite</strong> | Modern frontend build tool for development and production bundling |
| <strong>Zustand</strong> | Lightweight state management library for React |</p><p><h2>General</h2></p><p>| Term | Definition |
|------|------------|
| <strong>Actions</strong> | \| Action \| Description \| Side Effects \| |
| <strong>Actors</strong> | - Primary: New User (Food Safety Manager) |
| <strong>Add Sensors</strong> | Register your LoRaWAN sensors in the TTN Console |
| <strong>Alert Creation</strong> | Only <code>process-unit-states</code> creates alerts in the database |
| <strong>Alert Resolution</strong> | Only <code>process-unit-states</code> resolves alerts automatically |
| <strong>Alert Types Created</strong> | - <code>temp_excursion</code> - Temperature out of range |
| <strong>API Calls</strong> | - <code>supabase |
| <strong>API key rotation UI</strong> | Manual process currently |
| <strong>APIs and Data Touched</strong> | - </code>supabase |
| <strong>Application ID</strong> | <code>freshtracker-{org-slug}</code> |
| <strong>Application Name</strong> | <code>FreshTracker - {Org Name}</code> |
| <strong>Architecture</strong> | - Per-organization TTN Application |
| <strong>Audit Trail</strong> | <code>event_logs</code> for significant changes |
| <strong>Auth</strong> | Verify login/logout works |
| <strong>Authentication</strong> | Unique webhook secret per organization |
| <strong>Backend</strong> | Zod validation in edge functions |
| <strong>Cause</strong> | API key is invalid or expired |
| <strong>Causes</strong> | - Secrets may take a few seconds to propagate |
| <strong>Check</strong> | API key is valid |
| <strong>Compliance Documentation</strong> | Immutable audit trails for health inspections |
| <strong>Component</strong> | <code>AlertRulesEditor |
| <strong>Component Composition</strong> | Use shadcn components as building blocks |
| <strong>Components</strong> | - </code>HealthCheckList |
| <strong>Config Objects</strong> | Centralized status/alert configuration in <code>lib/</code> |
| <strong>Configuration</strong> | Stored in <code>ttn_connections</code> table per organization |
| <strong>Configure Devices</strong> | Add device EUIs and keys |
| <strong>Continuous Monitoring</strong> | Automated temperature readings every 5 minutes (configurable) |
| <strong>Copy the generated API key</strong> | you won't be able to see it again! |
| <strong>Credential Stuffing Attack</strong> | Large volume of failed logins detected |
| <strong>Data Dependencies</strong> | - None (creates new session) |
| <strong>Database</strong> | Organization-specific settings (TTN credentials) |
| <strong>Dedicated API Key</strong> | Application-scoped with minimal required permissions |
| <strong>Dedicated Webhook</strong> | Points to FreshTrack with unique secret for authentication |
| <strong>Diagram Reference</strong> | <a href=" |
| <strong>Enable</strong> | Settings â†’ Debug toggle (or <code>localStorage |
| <strong>Enable Debug Mode</strong> | Press </code>Ctrl+Shift+D<code> or toggle in settings |
| <strong>Enabled Messages</strong> | - Uplink message |
| <strong>Encrypted Storage</strong> | All API keys and secrets are encrypted in the database |
| <strong>Endpoint</strong> | </code>https://<project> |
| <strong>Engine</strong> | PostgreSQL 14 |
| <strong>Equipment Health</strong> | Battery forecasting, calibration tracking, and connectivity monitoring |
| <strong>Error States</strong> | - Invalid credentials |
| <strong>Event Logging</strong> | All significant state changes logged via <code>logEvent(">Landing Page Diagram</a></code> or edge function logging |
| <strong>Event logs</strong> | All significant actions logged with actor, timestamp, IP |
| <strong>Events</strong> | Uplink messages, join accepts |
| <strong>Events Handled</strong> | - <code>checkout |
| <strong>Excursion Detection</strong> | Immediate alerts when temperatures exceed safe thresholds |
| <strong>Export for Support</strong> | Click "Support Snapshot" button |
| <strong>Failure Modes</strong> | \| Failure \| Cause \| Recovery \| |
| <strong>Features</strong> | - Route logging |
| <strong>File</strong> | </code>supabase/functions/user-sync/index |
| <strong>Files</strong> | <code>src/components/health/</em> |
| <strong>Files Involved</strong> | - </code>src/pages/Auth |
| <strong>Filter Logs</strong> | Use tabs: Events, CRUD, Network, Sync, TTN, Errors |
| <strong>Filters</strong> | - Event type (alert, temperature, configuration, user) |
| <strong>Fix</strong> | Ensure user is synced and <code>ttn |
| <strong>Foreign Key Constraints</strong> | Data relationships maintain org scope |
| <strong>FreshTrack Pro subscription</strong> | A few hundred dollars per month |
| <strong>Frontend</strong> | Zod schemas in </code>lib/validation |
| <strong>Function</strong> | <code>health-check</code> |
| <strong>Goal</strong> | New user creates account and sets up their organization |
| <strong>HACCP Compliance</strong> | Audit trails, corrective action tracking, and compliance reporting |
| <strong>Hash chaining</strong> | Events include <code>previous_hash</code> for tamper detection |
| <strong>Hashing</strong> | bcrypt with cost factor (Supabase managed) |
| <strong>Headers</strong> | \| Header \| Value \| |
| <strong>Hierarchical Configuration</strong> | Settings cascade: Organization â†’ Site â†’ Area â†’ Unit |
| <strong>Immutable design</strong> | Append-only logging tables |
| <strong>Implication</strong> | Always consider failure modes |
| <strong>Important</strong> | <code>ready</code> must be <code>true</code>! |
| <strong>Indexes</strong> | - <code>organizations_slug_key</code> (unique) |
| <strong>Key Features</strong> | - RLS policies for multi-tenancy |
| <strong>Layout</strong> | - Hero section with value proposition |
| <strong>Location configuration</strong> | 15-30 minutes per site |
| <strong>Manual Logging</strong> | UI â†’ Supabase direct â†’ <code>manual_temperature_logs</code> table |
| <strong>Manual Temperature Logging</strong> | Offline-capable manual entry with automatic sync |
| <strong>Masking pattern</strong> | ``<code>typescript |
| <strong>MFA not implemented</strong> | Planned for future release |
| <strong>Migrations</strong> | 100+ files in </code>supabase/migrations/<code> |
| <strong>Minimal Permissions</strong> | Application API keys only have rights needed for sensor management |
| <strong>Monitor</strong> | Check FreshTrack's sensor data to see incoming readings |
| <strong>Name</strong> | </code>FreshTrack Admin Key<code> |
| <strong>Never log</strong> | - Full phone numbers (mask: </code>+1555<em><strong>4567<code>) |
| </strong>Notes<strong> | - Returns 202 for unknown devices to prevent TTN retries |
| </strong>Notifications<strong> | </code>process-unit-states<code> â†’ </code>process-escalations<code> â†’ email/SMS/push |
| </strong>Offline Behavior<strong> | - Logs stored in IndexedDB |
| </strong>Outcome<strong> | In less than an hour, FreshTrack Pro is monitoring all refrigeration units and the whole team has access |
| </strong>Plans<strong> | \| Plan \| Price \| Sensors \| Features \| |
| </strong>Preconditions<strong> | User is not authenticated |
| </strong>Predictive Maintenance<strong> | Battery forecasts and calibration reminders |
| </strong>Provisioning<strong> | Registered in both our DB and TTN |
| </strong>Purpose<strong> | LoRa sensor network connectivity |
| </strong>Query Keys<strong> | Structured for cache invalidation |
| </strong>Query Parameters<strong> | - </code>organization_id<code> (required) |
| </strong>Quick Setup<strong> | If your credentials are already configured, see <a href="#index">TTN_PRODUCTION_SETUP |
| </strong>Ransomware Scenario<strong> | Supabase account access compromised |
| </strong>Rate limiting visibility<strong> | Platform-level, not application-configurable |
| </strong>Recovery<strong> | - Retry button for failed queries |
| </strong>Relationships<strong> | - </code>organization_id<code> â†’ </code>organizations |
| </strong>Report Types<strong> | \| Report \| Description \| |
| </strong>Request Body<strong> | None (processes all active units) |
| </strong>Resolution<strong> | - If webhook issue: Regenerate secret, update TTN |
| </strong>Response<strong> | CSV or JSON data |
| </strong>Responsibilities<strong> | - User interface rendering |
| </strong>Result<strong> | Faster inspections |
| </strong>Retention<strong> | Configurable per compliance requirements |
| </strong>Returns<strong> | Merged alert rules with cascade priority (Unit > Site > Org) |
| </strong>Rights<strong> | Select the following: |
| </strong>RLS Policy Bypass<strong> | Customer reports seeing another org's data |
| </strong>ROI Example<strong> | One prevented incident = 12â€“24 months of subscription cost avoided |
| </strong>Route<strong> | <code>/dashboard</code> |
| </strong>Salt<strong> | Unique per password (bcrypt built-in) |
| </strong>Savings<strong> | 5â€“10 hours per week in staff time across a typical multi-unit operation |
| </strong>Secrets<strong> | Managed via Supabase dashboard |
| </strong>Sensor Data Ingestion<strong> | TTN â†’ <code>ttn-webhook</code> â†’ <code>sensor_readings</code> table |
| </strong>Sensor installation<strong> | 5-10 minutes per unit (just stick to wall) |
| </strong>Sequence Diagram<strong> | [See SEQUENCES |
| </strong>Severity<strong> | <code>warning</code> or <code>critical</code> |
| </strong>Shift Handoff<strong> | Staff can acknowledge and hand off alerts with notes |
| </strong>Solution<strong> | Install the Supabase CLI: |
| </strong>Source<strong> | <code>src/lib/statusConfig |
| </strong>Staff training<strong> | 15-30 minutes |
| </strong>State Processing<strong> | </code>ingest-readings<code> â†’ </code>process-unit-states<code> â†’ creates/resolves alerts |
| </strong>Status<strong> | </code>triggered<code> â†’ </code>acknowledged<code> â†’ </code>resolved<code> |
| </strong>Status Codes<strong> | \| Code \| Meaning \| |
| </strong>Status Computation<strong> | Frontend uses </code>computeUnitStatus()<code> for consistency with backend logic |
| </strong>Steps<strong> | \| Step \| Actor \| Action \| System Response \| |
| </strong>Stripe<strong> | Check Settings â†’ Billing tab loads plans |
| </strong>Supabase Dashboard<strong> | Go to Project Settings â†’ API |
| </strong>Symptoms<strong> | All sensors in an organization show offline status |
| </strong>System automatically<strong> | - Validates API key permissions (</code>ttn-gateway-preflight<code>) |
| </strong>Table<strong> | </code>event_logs<code> |
| </strong>TBD<strong> | Configure Supabase cron jobs for: |
| </strong>Tenant Isolation<strong> | Each org's TTN traffic is isolated via unique webhook secrets |
| </strong>Test Data Flow<strong> | Send test uplinks to verify webhook delivery |
| </strong>Timeline of events<strong> | Detection time |
| </strong>Timestamps<strong> | </code>created_at<code>, </code>updated_at<code> on most tables |
| </strong>Trace Operations<strong> | Click correlation ID link to filter related |
| </strong>Trigger<strong> | Scheduled (cron) or manual |
| </strong>TTN User ID<strong> | </code>frostguard<code> |
| </strong>Twilio<strong> | Check SMS delivery in Settings â†’ Notification History |
| </strong>Types<strong> | </code>temp_excursion<code>, </code>monitoring_interrupted<code>, </code>door_open<code>, </code>low_battery<code>, etc |
| </strong>Unique<strong> | </code>(user_id, organization_id)<code> |
| </strong>Unique Constraints<strong> | Scoped to organization (e |
| </strong>URL<strong> | </code>https://YOUR_PROJECT |
| </strong>URL Parameters<strong> | <code>siteId</code> (UUID) |
| </strong>Usage<strong> | Called by <code>process-escalations</code> for critical alerts |
| </strong>Use appropriate levels<strong> | <code>debug</code>: Verbose, development only |
| </strong>UUID Primary Keys<strong> | All tables use UUID <code>id</code> columns |
| </strong>Value<strong> | (paste your TTN admin API key from Step 1) |
| </strong>Verify webhook<strong> | - TTN Application â†’ Webhooks â†’ Should show <code>freshtrack-webhook</code> |
| </strong>Webhook Secret Exposure<strong> | TTN webhook secret found in public log |
| </strong>Webhook secret rotation<strong> | No automated rotation |
| </strong>What happened<strong> | Freezer door was propped open for cleaning |
| </strong>Who responded<strong> | Kitchen manager acknowledged within 8 minutes |
| </strong>Write first critical path tests<strong> | <code>process-unit-states</code> alert logic |</p><p>---</p><p><h2>Adding Terms</h2></p><p>To add new terms to this glossary:</p><p><li>Edit <code>/docs/_meta/glossary-seed.yml</code></li>
<li>Run <code>npm run docs:build</code></li>
<li>Terms are automatically extracted from bold definitions in documentation</li></p><p><h2>Related Documents</h2></p><p><li>[INDEX.md</a> â€” Complete documentation index</li>
<li><a href="#onboarding-getting_started">GETTING_STARTED.md</a> â€” Onboarding guide</li></p><p>
---</p><p><div class="page-break"></div></p><p><a id="ci_checklist"></a></p><p><h1>Documentation CI Checklist</h1></p><p><blockquote>Validation rules enforced by the documentation pipeline</blockquote></p><p>---</p><p><h2>Overview</h2></p><p>This document describes the automated checks run by <code>npm run docs:lint</code> and the CI workflow. All checks must pass before documentation changes can be merged.</p><p>---</p><p><h2>Automated Checks</h2></p><p><h3>âœ… Structure Validation</h3></p><p>| Check | Severity | Description |
|-------|----------|-------------|
| </strong>H1 Title Required<strong> | Error | Every document must have exactly one H1 (<code>#</code>) title |
| </strong>Heading Hierarchy<strong> | Warning | Heading levels should not skip (e.g., H2 â†’ H4) |
| </strong>Description Block<strong> | Warning | Documents should have a description blockquote after title |
| </strong>Related Documents<strong> | Warning | Documents should link to related content |</p><p><h3>âœ… Link Validation</h3></p><p>| Check | Severity | Description |
|-------|----------|-------------|
| </strong>Broken Internal Links<strong> | Error | All <code><a href="#path">text</a></code> links must resolve to existing files |
| </strong>Orphaned Documents<strong> | Warning | All docs should be linked from INDEX.md |
| </strong>Anchor Links<strong> | Info | Links to specific sections are validated |</p><p><h3>âœ… Content Validation</h3></p><p>| Check | Severity | Description |
|-------|----------|-------------|
| </strong>Placeholder Text<strong> | Error | No <code>[TBD]</code>, <code>[TODO]</code>, or <code>[PLACEHOLDER]</code> in content |
| </strong>TODO Markers<strong> | Warning | <code>TODO</code>, <code>FIXME</code>, <code>XXX</code> should be resolved |
| </strong>Empty Code Blocks<strong> | Warning | Code blocks should contain content |
| </strong>Minimum Length<strong> | Warning | Documents should have meaningful content (>100 chars) |
| </strong>Table Formatting<strong> | Warning | Table rows should have consistent column counts |</p><p><h3>âœ… Diagram Validation</h3></p><p>| Check | Severity | Description |
|-------|----------|-------------|
| </strong>Mermaid Syntax<strong> | Error | Mermaid diagrams must have valid syntax |
| </strong>Diagram Type<strong> | Error | Must start with valid diagram type (graph, flowchart, etc.) |</p><p><h3>âœ… Required Files</h3></p><p>| File | Required | Purpose |
|------|----------|---------|
| <code>README.md</code> | Yes | Project overview |
| <code>INDEX.md</code> | Yes | Documentation navigation |
| <code>GLOSSARY.md</code> | Yes | Term definitions |
| <code>architecture/ARCHITECTURE.md</code> | Yes | System architecture |
| <code>engineering/API.md</code> | Yes | API documentation |
| <code>engineering/DATA_MODEL.md</code> | Yes | Data model documentation |</p><p>---</p><p><h2>CI Workflow</h2></p><p><h3>Trigger Conditions</h3></p><p>The documentation CI runs on:
<li>Push to <code>main</code> or <code>develop</code> branches (docs/</strong> changes)</li>
<li>Pull requests touching <code>docs/<strong></code> files</li>
<li>Manual workflow dispatch</li></p><p><h3>Pipeline Steps</h3></p><p><pre><code class="yaml">1. Checkout repository
<li>Setup Node.js</li>
<li>Install dependencies</li>
<li>Run docs:lint</li>
<li>Run docs:generate</li>
<li>Verify no uncommitted changes</li>
<li>Upload artifacts (if build step)</li>
</code></pre></p><p><h3>Exit Codes</h3></p><p>| Code | Meaning |
|------|---------|
| 0 | All checks passed |
| 1 | One or more errors found |</p><p>---</p><p><h2>Local Validation</h2></p><p><h3>Before Committing</h3></p><p>Run the full documentation pipeline locally:</p><p><pre><code class="bash"><h1>Full pipeline (generate + lint + build)</h1>
npm run docs:all</p><p><h1>Just validate</h1>
npm run docs:lint</p><p><h1>Just regenerate index/glossary</h1>
npm run docs:generate
</code></pre></p><p><h3>Pre-commit Hook (Recommended)</h3></p><p>Add to <code>.husky/pre-commit</code>:</p><p><pre><code class="bash">#!/bin/sh
. "$(dirname "$0")/_/husky.sh"</p><p><h1>Check if docs changed</h1>
if git diff --cached --name-only | grep -q "^docs/"; then
  npm run docs:lint || exit 1
fi
</code></pre></p><p>---</p><p><h2>Fixing Common Issues</h2></p><p><h3>Broken Link</h3></p><p><pre><code class="markdown"><h1>Error: Broken link: ./missing.md</h1></p><p><h1>Fix: Update the link to correct path</h1>
<a href="#correct-path">Text</a>
</code></pre></p><p><h3>Missing Title</h3></p><p><pre><code class="markdown"><h1>Error: Document missing H1 title</h1></p><p><h1>Fix: Add title at top of document</h1>
<h1>My Document Title</h1></p><p>Content here...
</code></pre></p><p><h3>Heading Skip</h3></p><p><pre><code class="markdown"><h1>Warning: Heading level jumps from H2 to H4</h1></p><p><h1>Bad:</h1>
<h2>Section</h2>
#### Subsection</p><p><h1>Good:</h1>
<h2>Section</h2>
<h3>Subsection</h3>
</code></pre></p><p><h3>Placeholder Text</h3></p><p><pre><code class="markdown"><h1>Error: Contains placeholder text: [TBD]</h1></p><p><h1>Fix: Replace with actual content</h1>
[TBD] â†’ The actual implementation details...
</code></pre></p><p><h3>Invalid Mermaid</h3></p><p><pre><code class="markdown"><h1>Error: Mermaid diagram: Missing diagram type</h1></p><p><h1>Bad:</h1>
\<code>\</code>\<code>mermaid
A --> B
\</code>\<code>\</code></p><p><h1>Good:</h1>
\<code>\</code>\<code>mermaid
graph LR
    A --> B
\</code>\<code>\</code>
</code></pre></p><p>---</p><p><h2>Severity Levels</h2></p><p>| Level | CI Impact | Action Required |
|-------|-----------|-----------------|
| </strong>Error<strong> | Fails CI | Must fix before merge |
| </strong>Warning<strong> | Passes CI | Should fix, not blocking |
| </strong>Info</em><em> | Passes CI | Optional improvement |</p><p>---</p><p><h2>Adding New Checks</h2></p><p>To add new validation rules:</p><p><li>Edit <code>scripts/docs/lint-docs.js</code></li>
<li>Add validation function</li>
<li>Call from <code>lintDocs()</code> function</li>
<li>Update this checklist</li></p><p>Example:</p><p><pre><code class="javascript">async function validateNewRule(filePath, content) {
  const relativePath = path.relative(DOCS_ROOT, filePath);</p><p>  if (/</em> condition */) {
    errors.push({
      file: relativePath,
      type: 'new-rule',
      message: 'Description of the issue'
    });
  }
}
</code></pre></p><p>---</p><p><h2>Bypassing Checks</h2></p><p><h3>Emergency Merge</h3></p><p>If you must merge with failing checks (not recommended):</p><p><li>Add <code>[skip docs-ci]</code> to commit message</li>
<li>Create follow-up issue to fix documentation</li>
<li>Fix within 24 hours</li></p><p><h3>Suppressing Warnings</h3></p><p>Some warnings can be suppressed per-file:</p><p><pre><code class="markdown"><!-- docs-lint-disable missing-related -->
<h1>Document Without Related Section</h1></p><p>This document intentionally has no related documents section.
</code></pre></p><p>---</p><p><h2>Metrics</h2></p><p>Track documentation health over time:</p><p>| Metric | Target | Current |
|--------|--------|---------|
| Broken links | 0 | - |
| Orphaned docs | 0 | - |
| TODO markers | 0 | - |
| Coverage | 100% | - |</p><p>Run <code>npm run docs:lint</code> to see current counts.</p><p>---</p><p><h2>Related Documents</h2></p><p><li><a href="#index">INDEX.md</a> â€” Documentation navigation</li>
<li><a href="#glossary">GLOSSARY.md</a> â€” Term definitions</li>
<li><a href="#readme">README.md</a> â€” Project overview</li></p><p>
---</p><p><div class="page-break"></div></p><p></p>
</body>
</html>